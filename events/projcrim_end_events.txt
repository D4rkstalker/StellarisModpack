namespace = projcrim_end

# Triggers when Afflicted World is destroyed + cure is found
country_event = {
	id = projcrim_end.0
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = {
			has_global_flag = projcrim_final_world_created
		}
		has_global_flag = projcrim_in_progress
		any_playable_country = {
			has_country_flag = projcrim_plague_cured
		}
		check_variable = {
			which = projcrim_throng_worlds
			value <= 20
		}
	}

	immediate = {
		set_global_flag = projcrim_final_world_created
		random_country = {
			limit = {
				is_country_type = global_event
			}
			country_event = {
				id = projcrim_end.10
			}
		}
	}
}

# Decides if even actually goes off/time has passed enough
country_event = {
	id = projcrim_end.10
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		has_global_flag = projcrim_in_progress
	}

	immediate = {
		if = {
			limit = {
				NOT = {
					has_global_flag = projcrim_end_forced
				}
			} 
			random_list = {
				50 = {
					modifier = {
						factor = 0
						check_variable = {
							which = projcrim_throng_worlds
							value >= 15
						}
					}
					modifier = {
						factor = 0.25
						check_variable = {
							which = projcrim_throng_worlds
							value > 10
						}
						check_variable = {
							which = projcrim_throng_worlds
							value < 15
						}
					}
					modifier = {
						factor = 0.75
						check_variable = {
							which = projcrim_throng_worlds
							value > 5
						}
						check_variable = {
							which = projcrim_throng_worlds
							value <= 10
						}
					}
					random_galaxy_planet = {
						solar_system = {
							spawn_system = {
								min_jumps = 1
								max_jumps = 3
								initializer = projcrim_throng_homesystem
								hyperlane = yes
								is_discovered = yes
							}
						}
					}
					event_target:throng_capital = {
						set_owner = event_target:crimson_throng_country
						set_controller = event_target:crimson_throng_country
						while = {
							count = 25
							create_pop = {
								species = event_target:crimson_throng_species
								ethos = random
							}
						}
					}
					event_target:throng_world3 = {
						create_small_throng_fleet = yes
					} 
					event_target:throng_world2 = {
						create_small_throng_fleet = yes
					} 
					event_target:throng_world1 = {
						create_small_throng_fleet = yes
					} 
					every_playable_country = {
						country_event = {
							id = projcrim_end.1
							days = 10
						}
					}
				}
				50 = {
					modifier = {
						factor = 0.5
						check_variable = {
							which = projcrim_throng_worlds
							value <= 5
						}
					}
					modifier = {
						factor = 0.25
						check_variable = {
							which = projcrim_throng_worlds
							value <= 3
						}
					}
					modifier = {
						factor = 0
						check_variable = {
							which = projcrim_throng_worlds
							value = 0
						}
					}
					# Nothing
				}
			}
		}
		else = {
			random_galaxy_planet = {
						solar_system = {
							spawn_system = {
								min_jumps = 1
								max_jumps = 3
								initializer = projcrim_throng_homesystem
								hyperlane = yes
								is_discovered = yes
							}
						}
					}
					event_target:throng_capital = {
						set_owner = event_target:crimson_throng_country
						set_controller = event_target:crimson_throng_country
						while = {
							count = 25
							create_pop = {
								species = event_target:crimson_throng_species
								ethos = random
							}
						}
					}
					event_target:throng_world3 = {
						create_small_throng_fleet = yes
					} 
					event_target:throng_world2 = {
						create_small_throng_fleet = yes
					} 
					event_target:throng_world1 = {
						create_small_throng_fleet = yes
					} 
			every_playable_country = {
				country_event = {
					id = projcrim_end.1
				}
			}
		}
	}
}

# Forces the end chain to begin after 30 years passes
country_event = {
	id = projcrim_end.15
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		has_global_flag = projcrim_in_progress
	}

	immediate = {
		set_global_flag = projcrim_end_forced
		country_event = {
			id = projcrim_end.10
		}
	}
}

# Crimson Throng Homesystem Found
country_event = {
	id = projcrim_end.1
	title = "projcrim_end.1.name"
	desc = "projcrim_end.1.desc"
	picture = GFX_evt_star_chart
	show_sound = event_activating_unknown_technology
	location = event_target:throng_capital

	is_triggered_only = yes

	immediate = {
	}
	
	option = {
		name = "projcrim_end.1.a"
		custom_tooltip = projcrim_throng_capital_found
		event_target:throng_capital = {
			enable_special_project = {
				name = projcrim_capital_landing
				location = this
				owner = root.owner
			}
		}
	}
}

# Throng Queen Defeated - 1
country_event = {
	id = projcrim_end.2
	title = "projcrim_diplo.0.name"
	desc = "projcrim_end.2.desc"

	diplomatic = yes
	custom_gui = "crimson_throng_window"
	custom_gui_option = "crimson_throng_option"
	force_open = yes
	is_triggered_only = yes
	
	picture_event_data = {
		room = no_video_feed_room
	}

	immediate = {
		set_country_flag = throng_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = throng_diplomacy_engaged }
	}
	
	option = {
		name = "projcrim_end.2.a"
		hidden_effect = {
			country_event = {
				id = projcrim_end.3
			}
		}
	}
}

# Throng Queen Defeated - 2
country_event = {
	id = projcrim_end.3
	title = "projcrim_diplo.0.name"
	desc = "projcrim_end.3.desc"

	diplomatic = yes
	custom_gui = "crimson_throng_window"
	custom_gui_option = "crimson_throng_option"
	force_open = yes
	is_triggered_only = yes
	
	picture_event_data = {
		portrait = event_target:crimson_throng_country
		planet_background = pc_projcrim_afflicted
		room = organic_room
	}

	immediate = {
		set_country_flag = throng_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = throng_diplomacy_engaged }
	}
	
	option = {
		name = "projcrim_end.3.a"
		response_text = projcrim_end.3.a_reply
		is_dialog_only = yes
	}

	option = {
		name = "projcrim_end.3.b"
		response_text = projcrim_end.3.b_reply
		is_dialog_only = yes
	}

	option = {
		name = "projcrim_end.3.c"
		response_text = projcrim_end.3.c_reply
		is_dialog_only = yes
	}

	option = {
		name = "projcrim_end.3.d"
		hidden_effect = {
			country_event = {
				id = projcrim_end.4
			}
		}
	}
}

# Throng Queen Defeated - 3
country_event = {
	id = projcrim_end.4
	title = "projcrim_diplo.0.name"
	desc = "projcrim_end.4.desc"

	diplomatic = yes
	custom_gui = "crimson_throng_window"
	custom_gui_option = "crimson_throng_option"
	force_open = yes
	is_triggered_only = yes
	
	picture_event_data = {
		portrait = event_target:crimson_throng_country
		planet_background = pc_projcrim_afflicted
		room = organic_room
	}

	immediate = {
		save_global_event_target_as = throng_victor
		set_country_flag = throng_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = throng_diplomacy_engaged }
	}
	
	option = {
		name = "projcrim_end.4.a"		# Rip and tear
		custom_tooltip = projcrim_end.4.a_tt
		hidden_effect = {
			country_event = {
				id = projcrim_end.5
			}
			set_country_flag = throng_killed
		}
	}

	# option = {	# TODO: Add back in once permitted!
	# 	name = "projcrim_end.4.b"		# You will heed us
	# 	custom_tooltip = projcrim_end.4.b_tt
	# 	hidden_effect = {
	# 		country_event = {
	# 			id = projcrim_end.5
	# 		}
	# 		set_country_flag = throng_subjugated
	# 	}
	# }

	option = {
		name = "projcrim_end.4.c"		# We can offer something useful
		custom_tooltip = projcrim_end.4.c_tt
		hidden_effect = {
			country_event = {
				id = projcrim_end.5
			}
			set_country_flag = throng_protected
		}
		trigger = {
			OR = {
				is_xenophile = yes
				is_pacifist = yes
				is_egalitarian = yes
			}
		}
	}
}

# The End - Victor
country_event = {
	id = projcrim_end.5
	title = "projcrim_end.5.name"
	desc = {
		text = projcrim_end.5.desc1
		trigger = {
			has_country_flag = throng_killed
		}
	}
	desc = {
		text = projcrim_end.5.desc2
		trigger = {
			has_country_flag = throng_subjugated
		}
	}
	desc = {
		text = projcrim_end.5.desc3
		trigger = {
			has_country_flag = throng_protected
		}
	}
	picture = GFX_evt_grand_speech
	
	is_triggered_only = yes

	trigger = {
	}
	
	immediate = {
		save_global_event_target_as = throng_defeaters
		remove_global_flag = projcrim_in_progress
		remove_global_flag = midgame_crisis_ongoing
		every_playable_country = {
			country_event = {
				id = projcrim_end.6
				days = 3
			}
		}
		every_playable_country = {
			limit = {
				has_special_project = projcrim_capital_landing
			}
			remove_modifier = projcrim_story_bonus
			abort_special_project = { type = projcrim_capital_landing location = event_target:throng_capital }
		}
	}
	
	option = {
		name = "projcrim_end.5.a"
		custom_tooltip = throng_defeated1
		add_relic = r_throng_queen_synapse
		add_resource = {
			unity = 2500
			energy = 5000
		}
		if = {
			limit = {
				is_gestalt = no
			}
			add_modifier = {
				modifier = projcrim_throng_defeated
				days = 1800
			}
		}
		else = {
			add_modifier = {
				modifier = projcrim_throng_defeated_gestalt
				days = 1800
			}
		}
		trigger = {
			has_country_flag = throng_killed
		}
		hidden_effect = {
			remove_throng = yes
			event_target:throng_capital = {
				change_pc = pc_toxic
			}
		}
	}
	option = {
		name = "projcrim_end.5.b"
		custom_tooltip = throng_defeated2
		add_resource = {
			unity = 2500
			energy = 5000
		}
		if = {
			limit = {
				is_gestalt = no
			}
			add_modifier = {
				modifier = projcrim_throng_defeated
				days = 1800
			}
		}
		else = {
			add_modifier = {
				modifier = projcrim_throng_defeated_gestalt
				days = 1800
			}
		}
		trigger = {
			has_country_flag = throng_subjugated
		}
		hidden_effect = {
			subjugate_throng = yes
		}
	}
	option = {
		name = "projcrim_end.5.c"
		custom_tooltip = throng_defeated3
		add_resource = {
			unity = 2500
			physics_research = 3000
			society_research = 3000
			engineering_research = 3000
		}
		if = {
			limit = {
				is_gestalt = no
			}
			add_modifier = {
				modifier = projcrim_throng_defeated
				days = 1800
			}
		}
		else = {
			add_modifier = {
				modifier = projcrim_throng_defeated_gestalt
				days = 1800
			}
		}
		trigger = {
			has_country_flag = throng_protected
		}
		hidden_effect = {
			protect_throng = yes
			event_target:throng_capital = {
				change_pc = pc_toxic
			}
		}
	}
}

# Dream No More - The End
country_event = {
	id = projcrim_end.6
	title = "projcrim_end.6.name"
	desc = "projcrim_end.6.desc"
	picture = GFX_evt_crisis_defeated
	
	is_triggered_only = yes

	trigger = {
	}
	
	immediate = {
		set_country_flag = projcrim_plague_cured
		set_global_flag = throng_parasite_boon
	}
	
	option = {
		name = "projcrim_end.6.a"
		end_event_chain = projcrim_main_chain
		trigger = {
			has_country_flag = projcrim_plague_cured
		}
	}
	option = {
		name = "projcrim_end.6.b"
		end_event_chain = projcrim_main_chain
		capital_scope = {
			enable_special_project = {
				name = projcrim_heal_nation
				location = this
				owner = root.owner
			}
		}
		trigger = {
			NOT = { has_country_flag = projcrim_plague_cured }
		}
	}
}

# Population Healed
country_event = {
	id = projcrim_end.7
	title = "projcrim_end.7.name"
	desc = "projcrim_end.7.desc"
	picture = GFX_evt_crisis_defeated
	
	is_triggered_only = yes

	trigger = {
	}
	
	immediate = {
	}
	
	after = {
		if = {
			limit = {
				any_playable_country = {
					OR = {
						has_country_flag = projcrim_plague_cured
						NOT = { has_country_flag = plague_present }
					}
				}
			}
			remove_global_flag = projcrim_spread_active
			set_global_flag = projcrim_plague_eradicated
		}
	}
	
	option = {
		name = "projcrim_end.7.a"
		add_modifier = {
			modifier = projcrim_plague_cured
			days = 1800
		}
		projcrim_remove_negative_effects = yes
		every_owned_species	= {
			limit = {
				OR = {
					has_trait = trait_crimson_infected
					has_species_flag = crimson_infected_species
				}
			}
			change_species_characteristics = {
				remove_trait = trait_crimson_infected
				add_trait = trait_crimson_recovered
			}
		}
	}
}