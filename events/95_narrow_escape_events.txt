
namespace = narrow_escape

# Narrow Escape Origin Start
country_event = {
	id = narrow_escape.1

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		has_origin = origin_narrow_escape
	}

	immediate = {
		# Set the country type
		this = {
			set_country_type = country_type_narrow_escape_origin
		}

		# Save the primary species
		this = {
			every_owned_pop = {
				limit = {
					species = { is_same_value = root.species }
				}
				if = {
					limit = {
						NOT = { has_trait = trait_narrow_escape_species }
					}
					modify_species = {
						add_trait = trait_narrow_escape_species
					}
				}
			}
			species = {
				if = {
					limit = {
						NOT = { has_trait = trait_narrow_escape_species }
					}
					modify_species = {
						add_trait = trait_narrow_escape_species
					}
				}
				create_country = {
					name = "country_type_narrow_escape_origin_primary_species"
					type = country_type_narrow_escape_origin_primary_species
					species = this
					effect = {
						set_country_flag = country_type_narrow_escape_origin_primary_species@root
						species = { save_event_target_as = narrow_escape_origin_primary_species }
					}
				}
			}
		}

		# Save the secondary species
		this = {
			every_owned_pop = {
				limit = {
					species = { NOT = { is_same_value = root.species } }
				}
				if = {
					limit = {
						NOT = { has_trait = trait_narrow_escape_species }
					}
					modify_species = {
						add_trait = trait_narrow_escape_species
					}
				}
			}
			random_owned_pop = {
				limit = {
					species = { NOT = { is_same_value = root.species } }
				}
				species = {
					create_country = {
						name = "country_type_narrow_escape_origin_secondary_species"
						type = country_type_narrow_escape_origin_secondary_species
						species = this
						effect = {
							set_country_flag = country_type_narrow_escape_origin_secondary_species@root
							species = { save_event_target_as = narrow_escape_origin_secondary_species }
						}
					}
				}
			}
		}

		# Setup fleets and destroy homeworld
		this = {
			every_owned_fleet = {
				if = {
					limit = { exists = leader }
					kill_leader = { show_notification = no }
				}
				delete_fleet = {
					target = this
					kill_leader = no
					destroy_template = yes
				}
			}
			capital_scope = {
				save_event_target_as = narrow_escape_origin_homeworld
				solar_system = {
					while = {
						count = 2
						create_fleet = {
							name = "Explorer"
							effect = {
								set_owner = root
								if = {
									limit = {
										any_system = {
											distance = {
												source = prevprev
												max_distance <= 50
												max_jumps = 4
												type = euclidean
											}
											NOT = { is_same_value = prevprev }
											NOT = { any_system_planet = { is_colonizable = yes } }
											NOT = { any_fleet_in_system = { owner = { is_hostile = root } } }
										}
									}
									random_system = {
										limit = {
											distance = {
												source = prevprev
												max_distance <= 50
												max_jumps = 4
												type = euclidean
											}
											NOT = { is_same_value = prevprev }
											NOT = { any_system_planet = { is_colonizable = yes } }
											NOT = { any_fleet_in_system = { owner = { is_hostile = root } } }
										}
										random_system_planet = {
											prevprev = {
												set_location = prev
											}
										}
									}
								}
								else = {
									prev = {
										random_neighbor_system = {
											limit = {
												NOT = { any_system_planet = { is_colonizable = yes } }
												NOT = { any_fleet_in_system = { owner = { is_hostile = root } } }
											}
											random_system_planet = {
												prevprevprev = {
													set_location = prev
												}
											}
										}
									}
								}
								create_ship = {
									name = random
									random_existing_design = science
									prefix = yes
								}
								owner = {
									create_leader = {
										class = scientist
										skill = 2
									}
								}
								assign_leader = last_created_leader
								set_fleet_stance = evasive
							}
						}
					}
					while = {
						count = 3
						create_fleet = {
							name = "Last Hope"
							settings = {
								can_disband = no
							}
							effect = {
								set_owner = root
								set_location = prevprev
								create_ship = {
									name = random
									random_existing_design = colonizer
									prefix = yes
								}
								add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
								set_fleet_stance = evasive
							}
						}
					}
					create_fleet = {
						name = "Starbase Constructor"
						settings = {
							can_disband = no
						}
						effect = {
							set_owner = root
							set_location = prevprev
							create_ship = {
								name = random
								random_existing_design = constructor
								prefix = yes
							}
							add_modifier = { modifier = narrow_escape_origin_construction_ship }
							set_fleet_stance = evasive
						}
					}
				}
				every_owned_pop = { kill_pop = yes }
				destroy_colony = yes
				change_pc = rl_narrow_escape_unhabitable_planets
				set_planet_flag = narrow_escape_homeworld@root
			}
		}

		# Setup variables
		this = {
			set_variable = {
				which = narrow_escape_origin_colony_pops_left
				value = 32
			}
			set_variable = {
				which = narrow_escape_origin_first_colony_pops
				value = 16
			}
			set_variable = {
				which = narrow_escape_origin_second_colony_pops
				value = 10
			}
			set_variable = {
				which = narrow_escape_origin_third_colony_pops
				value = 6
			}
		}

		# Give modifiers
		this = {
			add_modifier = { modifier = narrow_escape_origin_need_capital }
			add_modifier = { modifier = narrow_escape_origin_need_outpost }
			if = {
				limit = {
					is_gestalt = no
					is_megacorp = no
					is_lithoid_empire = no
				}
				set_country_flag = narrow_escape_origin_colony_ships
				add_modifier = { modifier = narrow_escape_origin_colony_ships_32 }
			}
			else_if = {
				limit = {
					is_hive_empire = yes
					is_lithoid_empire = no
				}
				set_country_flag = narrow_escape_origin_colony_ships_hive
				add_modifier = { modifier = narrow_escape_origin_colony_ships_hive_32 }
			}
			else_if = {
				limit = {
					is_machine_empire = yes
					NOR = {
						has_valid_civic = civic_machine_assimilator
						has_valid_civic = civic_machine_servitor
					}
				}
				set_country_flag = narrow_escape_origin_colony_ships_machine
				add_modifier = { modifier = narrow_escape_origin_colony_ships_machine_32 }
			}
			else_if = {
				limit = {
					is_machine_empire = yes
					has_valid_civic = civic_machine_assimilator
					event_target:narrow_escape_origin_secondary_species = { species = { is_lithoid = no } }
				}
				set_country_flag = narrow_escape_origin_colony_ships_assimilator
				add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_32 }
			}
			else_if = {
				limit = {
					is_machine_empire = yes
					has_valid_civic = civic_machine_assimilator
					event_target:narrow_escape_origin_secondary_species = { species = { is_lithoid = yes } }
				}
				set_country_flag = narrow_escape_origin_colony_ships_assimilator_lithoid
				add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_32 }
			}
			else_if = {
				limit = {
					is_machine_empire = yes
					has_valid_civic = civic_machine_servitor
					event_target:narrow_escape_origin_secondary_species = { species = { is_lithoid = no } }
				}
				set_country_flag = narrow_escape_origin_colony_ships_servitor
				add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_32 }
			}
			else_if = {
				limit = {
					is_machine_empire = yes
					has_valid_civic = civic_machine_servitor
					event_target:narrow_escape_origin_secondary_species = { species = { is_lithoid = yes } }
				}
				set_country_flag = narrow_escape_origin_colony_ships_servitor_lithoid
				add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_lithoid_32 }
			}
			else_if = {
				limit = {
					is_lithoid_empire = yes
					is_hive_empire = no
				}
				set_country_flag = narrow_escape_origin_colony_ships_lithoid
				add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_32 }
			}
			else_if = {
				limit = {
					is_lithoid_empire = yes
					is_hive_empire = yes
				}
				set_country_flag = narrow_escape_origin_colony_ships_lithoid_hive
				add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_hive_32 }
			}
			else_if = {
				limit = {
					is_megacorp = yes
					is_lithoid_empire = no
				}
				set_country_flag = narrow_escape_origin_colony_ships_megacorp
				add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_32 }
			}
			else_if = {
				limit = {
					is_megacorp = yes
					is_lithoid_empire = yes
				}
				set_country_flag = narrow_escape_origin_colony_ships_megacorp_lithoid
				add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_32 }
			}
		}

		# Give additional resources
		this = {
			add_resource = {
				energy = 1500
				minerals = 1500
				influence = 200
				alloys = 1000
			}
			switch = {
				trigger = has_country_flag
				narrow_escape_origin_colony_ships = {
					add_resource = {
						food = 4000
						consumer_goods = 800
					}
				}
				narrow_escape_origin_colony_ships_hive = {
					add_resource = {
						food = 4000
					}
				}
				narrow_escape_origin_colony_ships_machine = {
					add_resource = {
						energy = 3500
					}
				}
				narrow_escape_origin_colony_ships_assimilator = {
					add_resource = {
						energy = 2250
						food = 1250
					}
				}
				narrow_escape_origin_colony_ships_assimilator_lithoid = {
					add_resource = {
						energy = 2250
						minerals = 750
					}
				}
				narrow_escape_origin_colony_ships_servitor = {
					add_resource = {
						energy = 3500
						food = 625
						consumer_goods = 625
					}
				}
				narrow_escape_origin_colony_ships_servitor_lithoid = {
					add_resource = {
						energy = 3500
						minerals = 125
						consumer_goods = 625
					}
				}
				narrow_escape_origin_colony_ships_lithoid = {
					add_resource = {
						minerals = 3500
						consumer_goods = 800
					}
				}
				narrow_escape_origin_colony_ships_lithoid_hive = {
					add_resource = {
						minerals = 3500
					}
				}
				narrow_escape_origin_colony_ships_megacorp = {
					add_resource = {
						food = 4250
						consumer_goods = 850
					}
				}
				narrow_escape_origin_colony_ships_megacorp_lithoid = {
					add_resource = {
						minerals = 3750
						consumer_goods = 850
					}
				}
			}
		}

		# Give additional techs
		this = {
			give_technology = { tech = tech_physics_1 message = no }
			give_technology = { tech = tech_society_1 message = no }
			give_technology = { tech = tech_engineering_1 message = no }
		}

		# Survey nearby systems
		this = {
			every_system = {
				limit = {
					distance = {
						source = event_target:narrow_escape_origin_homeworld
						max_distance <= 50
						max_jumps = 4
						type = euclidean
					}
				}
				random_list = {
					2 = {
						star = {
							surveyed = { set_surveyed = yes surveyor = root }
						}
						if = {
							limit = {
								NOT = { NOT = { any_fleet_in_system = { owner = { is_hostile = root } } } }
							}
							every_system_planet = {
								limit = {
									is_colonizable = no
								}
								random_list = {
									4 = { surveyed = { set_surveyed = yes surveyor = root } }
									1 = {}
								}
							}
							# set_star_flag = surveyed
						}
					}
					5 = {
						star = {
							surveyed = { set_surveyed = yes surveyor = root }
						}
						# set_star_flag = explored
					}
					3 = {}
				}
			}
		}

		# Setup deficit
		this = {
			country_event = { id = narrow_escape.2 }
		}

		# If AI
		this = {
			country_event = { id = narrow_escape.3 }
		}
	}
}

# Destroy country if it has a deficit
country_event = {
	id = narrow_escape.2

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_country_type = country_type_narrow_escape_origin
	}

	immediate = {
		if = {
			limit = {
				OR = {
					has_deficit = energy
					has_deficit = minerals
					has_deficit = food
					has_deficit = physics_research
					has_deficit = society_research
					has_deficit = engineering_research
					has_deficit = influence
					has_deficit = unity
					has_deficit = alloys
					has_deficit = consumer_goods
					has_deficit = volatile_motes
					has_deficit = exotic_gases
					has_deficit = rare_crystals
					has_deficit = sr_living_metal
					has_deficit = sr_zro
					has_deficit = sr_dark_matter
					has_deficit = nanites
					has_deficit = minor_artifacts
					AND = {
						has_modifier = narrow_escape_origin_need_outpost
						NOT = {
							any_owned_ship = {
								OR = {
									is_ship_class = shipclass_constructor
									is_ship_class = shipclass_starbase
								}
							}
						}
					}
					NOR = {
						any_owned_ship = {
							is_ship_class = shipclass_science_ship
						}
						any_system = {
							is_surveyed = { who = root status = yes }
						}
					}
				}
			}
			destroy_country = yes
		}
		else = {
			country_event = { id = narrow_escape.2 days = 30 }
		}
	}
}

# AI control
country_event = {
	id = narrow_escape.3

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_country_type = country_type_narrow_escape_origin
	}

	immediate = {
		if = {
			limit = {
				is_ai = yes
			}
			if = {
				limit = {
					any_owned_starbase = {
						solar_system = {
							NOT = {
								any_system_planet = {
									OR = {
										is_colonizable = yes
										is_under_colonization = yes
									}
								}
							}
						}
					}
				}
				every_owned_starbase = { delete_fleet = fleet }
			}
			if = {
				limit = {
					NOT = {
						any_planet = {
							is_colonizable = yes
							solar_system = {
								is_surveyed = {
									who = root
									status = yes
								}
							}
						}
					}
				}
				every_owned_ship = {
					limit = {
						is_ship_class = shipclass_constructor
					}
					fleet = { set_event_locked = yes }
					closest_system = {
						limit = {
							NOT = { has_star_flag = narrow_escape_origin_unsuitable_system@root }
							any_system_planet = {
								is_colonizable = yes
								habitability = {
									who = event_target:narrow_escape_origin_primary_species
									value >= 0.6
								}
								OR = {
									NOT = { exists = event_target:narrow_escape_origin_secondary_species }
									habitability = {
										who = event_target:narrow_escape_origin_secondary_species
										value >= 0.6
									}
								}
							}
							NOT = {
								any_fleet_in_system = {
									owner = {
										is_hostile = root
									}
								}
							}
						}
						random_list = {
							1 = {
								random_system_planet = {
									limit = {
										is_surveyed = {
											who = root
											status = no
										}
									}
									surveyed = {
										surveyor = root
										set_surveyed = yes
									}
								}
								if = {
									limit = {
										NOT = {
											any_system_planet = {
												is_surveyed = {
													who = root
													status = no
												}
											}
										}
									}
									save_event_target_as = narrow_escape_origin_target_system
									root = {
										random_owned_ship = {
											limit = {
												is_ship_class = shipclass_constructor
											}
											create_fleet = {
												name = "Explorer"
												settings = {
													can_disband = no
													can_change_composition = no
													can_change_leader = no
													can_upgrade = no
													spawn_debris = no
													uses_naval_capacity = no
												}
												effect = {
													set_owner = root
													set_location = prev.solar_system.star
													create_ship = {
														name = random
														random_existing_design = science
														prefix = yes
													}
													owner = {
														create_leader = {
															class = scientist
														}
													}
													assign_leader = last_created_leader
													set_fleet_stance = evasive
													add_modifier = { modifier = narrow_escape_origin_scout_ship }
													set_timed_fleet_flag = { flag = narrow_escape_travelling_fleet days = 3 }
													fleet_event = { id = narrow_escape.7 }
												}
											}
										}
									}
								}
							}
							59 = {}
						}
					}
				}
			}
			else_if = {
				limit = {
					any_owned_ship = {
						is_ship_class = shipclass_constructor
						exists = solar_system
						solar_system = {
							NOT = {
								any_system_planet = {
									is_colonizable = yes
								}
							}
						}
						fleet = {
							NOR = {
								has_fleet_order = move_to
								has_fleet_order = move_to_order
								has_fleet_order = orbit_planet
								has_fleet_order = orbit_planet_order
							}
						}
					}
				}
				random_owned_ship = {
					limit = {
						is_ship_class = shipclass_constructor
					}
					closest_system = {
						limit = {
							NOT = { has_star_flag = narrow_escape_origin_unsuitable_system@root }
							any_system_planet = { is_colonizable = yes }
							is_surveyed = { who = root status = yes }
						}
						prev.fleet = {
							set_event_locked = no
							clear_fleet_actions = this
							queue_actions = {
								orbit_planet = prev.star
							}
							fleet_event = { id = narrow_escape.6 days = 1 }
						}
					}
				}
			}
			else_if = {
				limit = {
					any_owned_ship = {
						is_ship_class = shipclass_constructor
						exists = orbit
						orbit = {
							is_same_value = solar_system.star
							solar_system = {
								any_system_planet = { is_colonizable = yes }
								is_surveyed = { who = root status = yes }
							}
						}
						NOT = { has_ship_flag = narrow_escape_origin_queued_starbase_ai }
					}
				}
				random_owned_ship = {
					limit = {
						is_ship_class = shipclass_constructor
						exists = orbit
						orbit = {
							is_same_value = solar_system.star
							solar_system = {
								any_system_planet = { is_colonizable = yes }
								is_surveyed = { who = root status = yes }
							}
						}
						NOT = { has_ship_flag = narrow_escape_origin_queued_starbase_ai }
					}
					set_timed_ship_flag = {
						flag = narrow_escape_origin_queued_starbase_ai
						days = 30
					}
					save_event_target_as = narrow_escape_origin_construction_ship
					orbit = {
						planet_event = { id = narrow_escape.4 days = 30 }
					}
					fleet = {
						set_event_locked = yes
					}
				}
			}
			else_if = {
				limit = {
					any_owned_ship = {
						is_ship_class = shipclass_constructor
						exists = solar_system
						solar_system = {
							any_system_planet = { is_colonizable = yes }
							is_surveyed = { who = root status = yes }
						}
						OR = {
							NOT = { exists = orbit }
							AND = {
								exists = orbit
								orbit = {
									NOT = { is_same_value = prev.solar_system.star }
								}
							}
						}
					}
				}
				random_owned_ship = {
					limit = {
						is_ship_class = shipclass_constructor
						solar_system = {
							any_system_planet = { is_colonizable = yes }
							is_surveyed = { who = root status = yes }
						}
						OR = {
							NOT = { exists = orbit }
							AND = {
								exists = orbit
								orbit = {
									NOT = { is_same_value = prev.solar_system.star }
								}
							}
						}
					}
					fleet = {
						set_event_locked = no
						clear_fleet_actions = this
						queue_actions = {
							orbit_planet = solar_system.star
						}
					}
				}
			}
			if = {
				limit = {
					NOT = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 0
						}
					}
					NAND = {
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 0
						}
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 0
						}
					}
				}
				change_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = narrow_escape_origin_second_colony_pops
				}
				change_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = narrow_escape_origin_third_colony_pops
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 0
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 0
				}
				while = {
					limit = {
						count_owned_ship = {
							count > 1
							limit = {
								has_modifier = narrow_escape_origin_populated_colony_ship
							}
						}
					}
					random_owned_ship = {
						limit = {
							has_modifier = narrow_escape_origin_populated_colony_ship
						}
						delete_ship = this
					}
				}
			}
			else_if = {
				limit = {
					check_variable = {
						which = narrow_escape_origin_first_colony_pops
						value = 0
					}
					NOT = {
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 0
						}
					}
					NOT = {
						check_variable = {
							which = narrow_escape_origin_third_colony_pops
							value = 0
						}
					}
				}
				change_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = narrow_escape_origin_third_colony_pops
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 0
				}
				while = {
					limit = {
						count_owned_ship = {
							count > 1
							limit = {
								has_modifier = narrow_escape_origin_populated_colony_ship
							}
						}
					}
					random_owned_ship = {
						limit = {
							has_modifier = narrow_escape_origin_populated_colony_ship
						}
						delete_ship = this
					}
				}
			}
			if = {
				limit = {
					any_planet_within_border = {
						is_colonizable = yes
					}
					NOT = {
						any_planet_within_border = {
							is_under_colonization = yes
						}
					}
					NOT = {
						any_owned_ship = {
							has_modifier = narrow_escape_origin_populated_colony_ship
							OR = {
								has_fleet_order = orbit_planet
								has_fleet_order = orbit_planet_order
								AND = {
									exists = orbit
									orbit = {
										is_colonizable = yes
									}
								}
							}
						}
					}
				}
				if = {
					limit = {
						any_planet_within_border = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.8
							}
						}
					}
					random_planet_within_border = {
						limit = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.8
							}
						}
						root = {
							random_owned_ship = {
								limit = {
									has_modifier = narrow_escape_origin_populated_colony_ship
								}
								fleet = {
									queue_actions = {
										orbit_planet = prevprevprev
									}
								}
							}
						}
					}
				}
				else_if = {
					limit = {
						any_planet_within_border = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.6
							}
						}
					}
					random_planet_within_border = {
						limit = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.6
							}
						}
						root = {
							random_owned_ship = {
								limit = {
									has_modifier = narrow_escape_origin_populated_colony_ship
								}
								fleet = {
									queue_actions = {
										orbit_planet = prevprevprev
									}
								}
							}
						}
					}
				}
				else_if = {
					limit = {
						any_planet_within_border = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.4
							}
						}
					}
					random_planet_within_border = {
						limit = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.4
							}
						}
						root = {
							random_owned_ship = {
								limit = {
									has_modifier = narrow_escape_origin_populated_colony_ship
								}
								fleet = {
									queue_actions = {
										orbit_planet = prevprevprev
									}
								}
							}
						}
					}
				}
				else_if = {
					limit = {
						any_planet_within_border = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.2
							}
						}
					}
					random_planet_within_border = {
						limit = {
							is_colonizable = yes
							habitability = {
								who = event_target:narrow_escape_origin_primary_species
								value >= 0.2
							}
						}
						root = {
							random_owned_ship = {
								limit = {
									has_modifier = narrow_escape_origin_populated_colony_ship
								}
								fleet = {
									queue_actions = {
										orbit_planet = prevprevprev
									}
								}
							}
						}
					}
				}
				else = {
					random_planet_within_border = {
						limit = {
							is_colonizable = yes
						}
						root = {
							random_owned_ship = {
								limit = {
									has_modifier = narrow_escape_origin_populated_colony_ship
								}
								fleet = {
									queue_actions = {
										orbit_planet = prevprevprev
									}
								}
							}
						}
					}
				}
			}
			else_if = {
				limit = {
					any_owned_ship = {
						has_modifier = narrow_escape_origin_populated_colony_ship
						exists = orbit
						orbit = {
							is_colonizable = yes
						}
					}
				}
				random_owned_ship = {
					limit = {
						has_modifier = narrow_escape_origin_populated_colony_ship
						exists = orbit
						orbit = {
							is_colonizable = yes
						}
					}
					orbit = {
						planet_event = { id = narrow_escape_start_colony.1 }
						prev = { ship_event = { id = narrow_escape.9 } }
						planet_event = { id = narrow_escape.8 days = 1 }
					}
					delete_fleet = fleet
				}
			}
		}
		else_if = {
			limit = {
				is_ai = no
			}
			every_owned_ship = {
				limit = {
					is_ship_class = shipclass_constructor
				}
				fleet = {
					set_event_locked = no
				}
			}
		}
		country_event = { id = narrow_escape.3 days = 1 }
	}
}

# Setup scopes
planet_event = {
	id = narrow_escape.4

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		event_target:narrow_escape_origin_construction_ship.owner = { is_ai = yes }
	}

	immediate = {
		event_target:narrow_escape_origin_construction_ship = {
			ship_event = { id = narrow_escape.5 }
			ship_event = { id = narrow_escape.10 }
		}
	}
}

# Build outpost for AI
ship_event = {
	id = narrow_escape.5

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		owner = { is_ai = yes }
	}

	immediate = {
		from.solar_system = {
			create_starbase = {
				owner = root.owner
				size = starbase_outpost
			}
		}
	}
}

# Set event locked
fleet_event = {
	id = narrow_escape.6

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		owner = { is_ai = yes }
	}

	immediate = {
		set_event_locked = yes
	}
}

# Create a scout ship to find a path to the planet
fleet_event = {
	id = narrow_escape.7

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = {
			limit = {
				solar_system = {
					is_same_value = event_target:narrow_escape_origin_target_system
				}
			}
			leader = {
				kill_leader = {
					show_notification = no
				}
			}
			delete_fleet = this
		}
		else = {
			if = {
				limit = {
					NOR = {
						has_fleet_order = orbit_planet
						has_fleet_order = orbit_planet_order
					}
				}
				change_variable = {
					which = narrow_escape_origin_unsuitable_system
					value = 1
				}
			}
			else = {
				set_variable = {
					which = narrow_escape_origin_unsuitable_system
					value = 0
				}
			}
			if = {
				limit = {
					check_variable = {
						which = narrow_escape_origin_unsuitable_system
						value >= 3
					}
				}
				event_target:narrow_escape_origin_target_system = {
					set_star_flag = narrow_escape_origin_unsuitable_system@root.owner
				}
				delete_fleet = this
				break = yes
			}
			queue_actions = {
				orbit_planet = event_target:narrow_escape_origin_target_system.star
			}
			fleet_event = { id = narrow_escape.7 days = 1 }
		}
	}
}

# Check if colony is complete (for start_colony effect)
planet_event = {
	id = narrow_escape.8

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_under_colonization = yes
	}

	immediate = {
		if = {
			limit = {
				has_colony_progress >= 1
			}
			planet_event = { id = narrow_escape_create_colony.1 }
		}
		else = {
			planet_event = { id = narrow_escape.8 days = 1 }
		}
	}
}

# Setup the from scope (for on_colonization_started events)
ship_event = {
	id = narrow_escape.9

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		orbit = {
			planet_event = { id = advisor.17 }
			planet_event = { id = progress.3 }
			planet_event = { id = progress.7 }
			planet_event = { id = distar.300 }
			planet_event = { id = mega.110 }
			planet_event = { id = origin.3010 }
			planet_event = { id = origin.3101 }
			planet_event = { id = federations3.120 }
			planet_event = { id = narrow_escape.30 }
		}
	}
}

# Destroy the construction ship when an outpost is built
ship_event = {
	id = narrow_escape.10

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		owner = { is_country_type = country_type_narrow_escape_origin }
	}

	immediate = {
		owner = {
			save_event_target_as = narrow_escape_constructor_owner
		}
		from = {
			planet_event = { id = narrow_escape.11 days = 1 }
		}
		if = {
			limit = {
				owner = { has_modifier = narrow_escape_origin_need_outpost }
			}
			owner = {
				remove_modifier = narrow_escape_origin_need_outpost
				every_owned_ship = {
					limit = {
						is_ship_class = shipclass_constructor
						has_modifier = narrow_escape_origin_construction_ship
					}
					remove_modifier = narrow_escape_origin_construction_ship
				}
			}
			delete_ship = this
		}
	}
}

# Rebuild the construction ship when the outpost is dismantled
planet_event = {
	id = narrow_escape.11

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		event_target:narrow_escape_constructor_owner = { is_country_type = country_type_narrow_escape_origin }
	}

	immediate = {
		if = {
			limit = {
				NOT = {
					exists = starbase
				}
				event_target:narrow_escape_constructor_owner = {
					NOR = {
						any_owned_ship = {
							is_ship_class = shipclass_starbase
						}
						any_owned_ship = {
							is_ship_class = shipclass_constructor
							has_modifier = narrow_escape_origin_construction_ship
						}
					}
				}
			}
			create_fleet = {
				name = "Starbase Constructor"
				settings = {
					can_disband = no
				}
				effect = {
					set_owner = event_target:narrow_escape_constructor_owner
					set_location = root
					create_ship = {
						name = random
						random_existing_design = constructor
						prefix = yes
					}
					add_modifier = { modifier = narrow_escape_origin_construction_ship }
					set_fleet_stance = evasive
				}
			}
			event_target:narrow_escape_constructor_owner = {
				add_modifier = { modifier = narrow_escape_origin_need_outpost }
			}
		}
		else_if = {
			limit = {
				exists = starbase
			}
			planet_event = { id = narrow_escape.11 days = 1 }
		}
	}
}

# Consolidation menu
country_event = {
	id = narrow_escape.20
	title = narrow_escape_origin_consolidation_menu
	desc = {
		text = narrow_escape.20.desc.a
		exclusive_trigger = {
			check_variable = {
				which = narrow_escape_origin_first_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_second_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_third_colony_pops
				value > 0
			}
		}
	}
	desc = {
		text = narrow_escape.20.desc.b
		exclusive_trigger = {
			check_variable = {
				which = narrow_escape_origin_first_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_second_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_third_colony_pops
				value <= 0
			}
		}
	}
	desc = {
		text = narrow_escape.20.desc.c
		exclusive_trigger = {
			check_variable = {
				which = narrow_escape_origin_first_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_second_colony_pops
				value <= 0
			}
			check_variable = {
				which = narrow_escape_origin_third_colony_pops
				value <= 0
			}
		}
	}
	desc = {
		text = narrow_escape.20.desc.d
		exclusive_trigger = {
			check_variable = {
				which = narrow_escape_origin_first_colony_pops
				value <= 0
			}
			check_variable = {
				which = narrow_escape_origin_second_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_third_colony_pops
				value > 0
			}
		}
	}
	desc = {
		text = narrow_escape.20.desc.e
		exclusive_trigger = {
			check_variable = {
				which = narrow_escape_origin_first_colony_pops
				value <= 0
			}
			check_variable = {
				which = narrow_escape_origin_second_colony_pops
				value > 0
			}
			check_variable = {
				which = narrow_escape_origin_third_colony_pops
				value <= 0
			}
		}
	}
	desc = {
		text = narrow_escape.20.desc.f
		exclusive_trigger = {
			check_variable = {
				which = narrow_escape_origin_first_colony_pops
				value <= 0
			}
			check_variable = {
				which = narrow_escape_origin_second_colony_pops
				value <= 0
			}
			check_variable = {
				which = narrow_escape_origin_third_colony_pops
				value > 0
			}
		}
	}

	picture = GFX_evt_colony_settlement

	is_triggered_only = yes
	force_open = yes

	immediate = {
		random_owned_ship = {
			limit = {
				has_modifier = narrow_escape_origin_populated_colony_ship
			}
			save_event_target_as = narrow_escape_origin_colony_ship_1
		}
		random_owned_ship = {
			limit = {
				has_modifier = narrow_escape_origin_populated_colony_ship
				NOT = { is_same_value = event_target:narrow_escape_origin_colony_ship_1 }
			}
			save_event_target_as = narrow_escape_origin_colony_ship_2
		}
		random_owned_ship = {
			limit = {
				has_modifier = narrow_escape_origin_populated_colony_ship
				NOT = { is_same_value = event_target:narrow_escape_origin_colony_ship_1 }
				NOT = { is_same_value = event_target:narrow_escape_origin_colony_ship_2 }
			}
			save_event_target_as = narrow_escape_origin_colony_ship_3
		}
	}

	option = {
		name = narrow_escape.20.a

		hidden_effect = { country_event = { id = narrow_escape.21 } }

		allow = {
			custom_tooltip = {
				fail_text = "No ships to consolidate"
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value > 0
				}
				OR = {
					check_variable = {
						which = narrow_escape_origin_first_colony_pops
						value > 0
					}
					check_variable = {
						which = narrow_escape_origin_third_colony_pops
						value > 0
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape.20.b

		hidden_effect = { country_event = { id = narrow_escape.23 } }

		allow = {
			custom_tooltip = {
				fail_text = "No ships to deconsolidate"
				OR = {
					check_variable = {
						which = narrow_escape_origin_first_colony_pops
						value > 16
					}
					check_variable = {
						which = narrow_escape_origin_second_colony_pops
						value > 10
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape_origin_cancel
	}
}

# Consolidate which ship
country_event = {
	id = narrow_escape.21
	title = narrow_escape_origin_consolidation_menu
	desc = narrow_escape.21.desc
	picture = GFX_evt_colony_settlement

	is_triggered_only = yes
	force_open = yes

	option = {
		name = narrow_escape_ship_1_get_name

		hidden_effect = {
			event_target:narrow_escape_origin_colony_ship_1 = { ship_event = { id = narrow_escape.22 } }
		}

		trigger = {
			exists = event_target:narrow_escape_origin_colony_ship_1
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = event_target:narrow_escape_origin_colony_ship_1
			}
			if = {
				limit = { exists = event_target:narrow_escape_origin_colony_ship_1 }
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					event_target:narrow_escape_origin_colony_ship_1 = {
						solar_system = {
							any_ship_in_system = {
								OR = {
									AND = {
										exists = event_target:narrow_escape_origin_colony_ship_2
										is_same_value = event_target:narrow_escape_origin_colony_ship_2
										is_in_combat = no
									}
									AND = {
										exists = event_target:narrow_escape_origin_colony_ship_3
										is_same_value = event_target:narrow_escape_origin_colony_ship_3
										is_in_combat = no
									}
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					event_target:narrow_escape_origin_colony_ship_1 = {
						is_in_combat = no
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape_ship_2_get_name

		hidden_effect = {
			event_target:narrow_escape_origin_colony_ship_2 = { ship_event = { id = narrow_escape.22 } }
		}

		trigger = {
			exists = event_target:narrow_escape_origin_colony_ship_2
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = event_target:narrow_escape_origin_colony_ship_2
			}
			if = {
				limit = { exists = event_target:narrow_escape_origin_colony_ship_2 }
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					event_target:narrow_escape_origin_colony_ship_2 = {
						solar_system = {
							any_ship_in_system = {
								OR = {
									AND = {
										exists = event_target:narrow_escape_origin_colony_ship_1
										is_same_value = event_target:narrow_escape_origin_colony_ship_1
										is_in_combat = no
									}
									AND = {
										exists = event_target:narrow_escape_origin_colony_ship_3
										is_same_value = event_target:narrow_escape_origin_colony_ship_3
										is_in_combat = no
									}
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					event_target:narrow_escape_origin_colony_ship_2 = {
						is_in_combat = no
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape_ship_3_get_name

		hidden_effect = {
			event_target:narrow_escape_origin_colony_ship_3 = { ship_event = { id = narrow_escape.22 } }
		}

		trigger = {
			exists = event_target:narrow_escape_origin_colony_ship_3
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = event_target:narrow_escape_origin_colony_ship_3
			}
			if = {
				limit = { exists = event_target:narrow_escape_origin_colony_ship_3 }
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					event_target:narrow_escape_origin_colony_ship_3 = {
						solar_system = {
							any_ship_in_system = {
								OR = {
									AND = {
										exists = event_target:narrow_escape_origin_colony_ship_1
										is_same_value = event_target:narrow_escape_origin_colony_ship_1
										is_in_combat = no
									}
									AND = {
										exists = event_target:narrow_escape_origin_colony_ship_2
										is_same_value = event_target:narrow_escape_origin_colony_ship_2
										is_in_combat = no
									}
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					event_target:narrow_escape_origin_colony_ship_3 = {
						is_in_combat = no
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape_origin_go_back

		hidden_effect = { country_event = { id = narrow_escape.20 } }
	}
}

# Consolidate how many pops
ship_event = {
	id = narrow_escape.22
	title = narrow_escape_origin_consolidation_menu
	desc = narrow_escape.22.desc
	picture = GFX_evt_colony_settlement

	location = root

	is_triggered_only = yes
	force_open = yes

	option = {
		name = narrow_escape.22.a

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 32
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 0
				}
				delete_ship = root
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 26
				}
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 6
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to consolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 26
						}
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 6
						}
					}
				}
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					solar_system = {
						any_ship_in_system = {
							OR = {
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_1
									is_same_value = event_target:narrow_escape_origin_colony_ship_1
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_2
									is_same_value = event_target:narrow_escape_origin_colony_ship_2
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_3
									is_same_value = event_target:narrow_escape_origin_colony_ship_3
									is_in_combat = no
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.22.b

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 32
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 0
				}
				delete_ship = root
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 22
				}
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 10
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to consolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 22
						}
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 10
						}
					}
				}
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					solar_system = {
						any_ship_in_system = {
							OR = {
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_1
									is_same_value = event_target:narrow_escape_origin_colony_ship_1
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_2
									is_same_value = event_target:narrow_escape_origin_colony_ship_2
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_3
									is_same_value = event_target:narrow_escape_origin_colony_ship_3
									is_in_combat = no
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.22.c

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 32
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 0
				}
				delete_ship = root
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 16
				}
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 16
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to consolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 16
						}
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 16
						}
					}
				}
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					solar_system = {
						any_ship_in_system = {
							OR = {
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_1
									is_same_value = event_target:narrow_escape_origin_colony_ship_1
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_2
									is_same_value = event_target:narrow_escape_origin_colony_ship_2
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_3
									is_same_value = event_target:narrow_escape_origin_colony_ship_3
									is_in_combat = no
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.22.d

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 26
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 6
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 0
				}
				delete_ship = root
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 16
				}
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 10
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to consolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 16
						}
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 10
						}
					}
				}
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					solar_system = {
						any_ship_in_system = {
							OR = {
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_1
									is_same_value = event_target:narrow_escape_origin_colony_ship_1
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_2
									is_same_value = event_target:narrow_escape_origin_colony_ship_2
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_3
									is_same_value = event_target:narrow_escape_origin_colony_ship_3
									is_in_combat = no
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.22.e

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 22
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 0
				}
				delete_ship = root
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 16
				}
				check_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 6
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to consolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 16
						}
						check_variable = {
							which = narrow_escape_origin_third_colony_pops
							value = 6
						}
					}
				}
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					solar_system = {
						any_ship_in_system = {
							OR = {
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_1
									is_same_value = event_target:narrow_escape_origin_colony_ship_1
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_2
									is_same_value = event_target:narrow_escape_origin_colony_ship_2
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_3
									is_same_value = event_target:narrow_escape_origin_colony_ship_3
									is_in_combat = no
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.22.f

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 16
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 0
				}
				delete_ship = root
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 10
				}
				check_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 6
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to consolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 10
						}
						check_variable = {
							which = narrow_escape_origin_third_colony_pops
							value = 6
						}
					}
				}
				custom_tooltip = {
					fail_text = "No ship to consolidate to!"
					solar_system = {
						any_ship_in_system = {
							OR = {
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_1
									is_same_value = event_target:narrow_escape_origin_colony_ship_1
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_2
									is_same_value = event_target:narrow_escape_origin_colony_ship_2
									is_in_combat = no
								}
								AND = {
									NOT = { is_same_value = prevprev }
									exists = event_target:narrow_escape_origin_colony_ship_3
									is_same_value = event_target:narrow_escape_origin_colony_ship_3
									is_in_combat = no
								}
							}
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot consolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape_origin_go_back

		hidden_effect = {
			from = { country_event = { id = narrow_escape.21 } }
		}
	}
}

# Deconsolidate which ship
country_event = {
	id = narrow_escape.23
	title = narrow_escape_origin_consolidation_menu
	desc = narrow_escape.23.desc
	picture = GFX_evt_colony_settlement

	is_triggered_only = yes
	force_open = yes

	option = {
		name = narrow_escape_ship_1_get_name

		hidden_effect = {
			event_target:narrow_escape_origin_colony_ship_1 = { ship_event = { id = narrow_escape.24 } }
		}

		trigger = {
			exists = event_target:narrow_escape_origin_colony_ship_1
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = event_target:narrow_escape_origin_colony_ship_1
			}
			if = {
				limit = { exists = event_target:narrow_escape_origin_colony_ship_1 }
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					event_target:narrow_escape_origin_colony_ship_1 = {
						is_in_combat = no
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape_ship_2_get_name

		hidden_effect = {
			event_target:narrow_escape_origin_colony_ship_2 = { ship_event = { id = narrow_escape.24 } }
		}

		trigger = {
			exists = event_target:narrow_escape_origin_colony_ship_2
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = event_target:narrow_escape_origin_colony_ship_2
			}
			if = {
				limit = { exists = event_target:narrow_escape_origin_colony_ship_2 }
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					event_target:narrow_escape_origin_colony_ship_2 = {
						is_in_combat = no
					}
				}
			}
		}
	}

	option = {
		name = narrow_escape_origin_go_back

		hidden_effect = { country_event = { id = narrow_escape.20 } }
	}
}

# Deconsolidate how many pops
ship_event = {
	id = narrow_escape.24
	title = narrow_escape_origin_consolidation_menu
	desc = narrow_escape.24.desc
	picture = GFX_evt_colony_settlement

	location = root

	is_triggered_only = yes
	force_open = yes

	option = {
		name = narrow_escape.24.a

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 26
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 6
				}
				create_fleet = {
					name = "Last Hope"
					settings = {
						can_disband = no
					}
					effect = {
						set_owner = from
						set_location = root
						create_ship = {
							name = random
							random_existing_design = colonizer
							prefix = yes
						}
						add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
						set_fleet_stance = evasive
					}
				}
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 32
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to deconsolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 32
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.24.b

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 22
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 10
				}
				create_fleet = {
					name = "Last Hope"
					settings = {
						can_disband = no
					}
					effect = {
						set_owner = from
						set_location = root
						create_ship = {
							name = random
							random_existing_design = colonizer
							prefix = yes
						}
						add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
						set_fleet_stance = evasive
					}
				}
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 32
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to deconsolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 32
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.24.c

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 16
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 16
				}
				create_fleet = {
					name = "Last Hope"
					settings = {
						can_disband = no
					}
					effect = {
						set_owner = from
						set_location = root
						create_ship = {
							name = random
							random_existing_design = colonizer
							prefix = yes
						}
						add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
						set_fleet_stance = evasive
					}
				}
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 32
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to deconsolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 32
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.24.d

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 16
				}
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 10
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 6
				}
				create_fleet = {
					name = "Last Hope"
					settings = {
						can_disband = no
					}
					effect = {
						set_owner = from
						set_location = root
						create_ship = {
							name = random
							random_existing_design = colonizer
							prefix = yes
						}
						add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
						set_fleet_stance = evasive
					}
				}
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 26
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to deconsolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 26
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.24.e

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 16
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 6
				}
				create_fleet = {
					name = "Last Hope"
					settings = {
						can_disband = no
					}
					effect = {
						set_owner = from
						set_location = root
						create_ship = {
							name = random
							random_existing_design = colonizer
							prefix = yes
						}
						add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
						set_fleet_stance = evasive
					}
				}
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value = 22
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to deconsolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 22
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape.24.f

		hidden_effect = {
			from = {
				set_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 10
				}
				set_variable = {
					which = narrow_escape_origin_third_colony_pops
					value = 6
				}
				create_fleet = {
					name = "Last Hope"
					settings = {
						can_disband = no
					}
					effect = {
						set_owner = from
						set_location = root
						create_ship = {
							name = random
							random_existing_design = colonizer
							prefix = yes
						}
						add_modifier = { modifier = narrow_escape_origin_populated_colony_ship }
						set_fleet_stance = evasive
					}
				}
			}
		}

		trigger = {
			from = {
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value = 16
				}
			}
		}

		allow = {
			custom_tooltip = {
				fail_text = "Ship doesn't exist!"
				exists = root
			}
			if = {
				limit = { exists = root }
				custom_tooltip = {
					fail_text = "Not enough pops to deconsolidate!"
					from = {
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 16
						}
					}
				}
				custom_tooltip = {
					fail_text = "Cannot deconsolidate while in combat!"
					is_in_combat = no
				}
			}
		}
	}

	option = {
		name = narrow_escape_origin_go_back

		hidden_effect = {
			from = { country_event = { id = narrow_escape.23 } }
		}
	}
}

# Add planet modifiers when colonization is started
planet_event = {
	id = narrow_escape.30

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		owner = {
			check_variable = {
				which = narrow_escape_origin_colony_pops_left
				value > 0
			}
		}
		from = {
			has_modifier = narrow_escape_origin_populated_colony_ship
		}
	}

	immediate = {
		if = {
			limit = {
				owner = {
					check_variable = {
						which = narrow_escape_origin_first_colony_pops
						value > 0
					}
				}
			}
			if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 16
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_16 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_16 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_16 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_16 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_16 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_16 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_16 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_16 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_first_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_first_colony_pops
						value = 0
					}
				}
			}
			else_if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 22
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_22 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_22 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_22 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_22 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_22 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_22 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_22 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_22 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_first_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_first_colony_pops
						value = 0
					}
				}
			}
			else_if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 26
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_26 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_26 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_26 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_26 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_26 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_26 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_26 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_26 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_first_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_first_colony_pops
						value = 0
					}
				}
			}
			else_if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_first_colony_pops
							value = 32
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_32 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_32 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_32 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_32 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
								is_megacorp = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_32 }
					}
					else_if = {
						limit = {
							owner = { has_valid_civic = civic_machine_servitor }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_32 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_32 }
					}
					else_if = {
						limit = {
							owner = { is_megacorp = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_32 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_first_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_first_colony_pops
						value = 0
					}
				}
			}
		}
		else_if = {
			limit = {
				owner = {
					check_variable = {
						which = narrow_escape_origin_second_colony_pops
						value > 0
					}
				}
			}
			if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 10
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_10 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_machine_10 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_ap_10 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_machine_ap_10 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_second_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_second_colony_pops
						value = 0
					}
				}
			}
			else_if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_second_colony_pops
							value = 16
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_16 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_machine_16 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_ap_16 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_second_colonization_machine_ap_16 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_second_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_second_colony_pops
						value = 0
					}
				}
			}
		}
		else_if = {
			limit = {
				owner = {
					check_variable = {
						which = narrow_escape_origin_third_colony_pops
						value > 0
					}
				}
			}
			if = {
				limit = {
					owner = {
						check_variable = {
							which = narrow_escape_origin_third_colony_pops
							value = 6
						}
					}
				}
				if = {
					limit = {
						NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
					}
					if = {
						limit = {
							owner = {
								is_machine_empire = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_third_colonization_6 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_third_colonization_machine_6 }
					}
				}
				else = {
					if = {
						limit = {
							owner = {
								is_machine_empire = no
							}
						}
						add_modifier = { modifier = narrow_escape_origin_third_colonization_ap_6 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						add_modifier = { modifier = narrow_escape_origin_third_colonization_machine_ap_6 }
					}
				}
				owner = {
					subtract_variable = {
						which = narrow_escape_origin_colony_pops_left
						value = narrow_escape_origin_third_colony_pops
					}
					set_variable = {
						which = narrow_escape_origin_third_colony_pops
						value = 0
					}
				}
			}
		}

		if = {
			limit = {
				NOT = { owner = { has_tradition = tr_expansion_colonization_fever } }
			}
			planet_event = { id = narrow_escape.31 days = 1 }
		}
	}
}

# Change modifier if Colonization Fever tradition is picked
planet_event = {
	id = narrow_escape.31

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_under_colonization = yes
	}

	immediate = {
		if = {
			limit = {
				owner = { has_tradition = tr_expansion_colonization_fever }
			}
			switch = {
				trigger = has_modifier
				narrow_escape_origin_capital_colonization_16 = {
					remove_modifier = narrow_escape_origin_capital_colonization_16
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_16 }
				}
				narrow_escape_origin_capital_colonization_22 = {
					remove_modifier = narrow_escape_origin_capital_colonization_22
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_22 }
				}
				narrow_escape_origin_capital_colonization_26 = {
					remove_modifier = narrow_escape_origin_capital_colonization_26
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_26 }
				}
				narrow_escape_origin_capital_colonization_32 = {
					remove_modifier = narrow_escape_origin_capital_colonization_32
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_ap_32 }
				}
				narrow_escape_origin_capital_colonization_machine_16 = {
					remove_modifier = narrow_escape_origin_capital_colonization_machine_16
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_16 }
				}
				narrow_escape_origin_capital_colonization_machine_22 = {
					remove_modifier = narrow_escape_origin_capital_colonization_machine_22
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_22 }
				}
				narrow_escape_origin_capital_colonization_machine_26 = {
					remove_modifier = narrow_escape_origin_capital_colonization_machine_26
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_26 }
				}
				narrow_escape_origin_capital_colonization_machine_32 = {
					remove_modifier = narrow_escape_origin_capital_colonization_machine_32
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_machine_ap_32 }
				}
				narrow_escape_origin_capital_colonization_servitor_16 = {
					remove_modifier = narrow_escape_origin_capital_colonization_servitor_16
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_16 }
				}
				narrow_escape_origin_capital_colonization_servitor_22 = {
					remove_modifier = narrow_escape_origin_capital_colonization_servitor_22
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_22 }
				}
				narrow_escape_origin_capital_colonization_servitor_26 = {
					remove_modifier = narrow_escape_origin_capital_colonization_servitor_26
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_26 }
				}
				narrow_escape_origin_capital_colonization_servitor_32 = {
					remove_modifier = narrow_escape_origin_capital_colonization_servitor_32
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_servitor_ap_32 }
				}
				narrow_escape_origin_capital_colonization_megacorp_16 = {
					remove_modifier = narrow_escape_origin_capital_colonization_megacorp_16
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_16 }
				}
				narrow_escape_origin_capital_colonization_megacorp_22 = {
					remove_modifier = narrow_escape_origin_capital_colonization_megacorp_22
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_22 }
				}
				narrow_escape_origin_capital_colonization_megacorp_26 = {
					remove_modifier = narrow_escape_origin_capital_colonization_megacorp_26
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_26 }
				}
				narrow_escape_origin_capital_colonization_megacorp_32 = {
					remove_modifier = narrow_escape_origin_capital_colonization_megacorp_32
					add_modifier = { modifier = narrow_escape_origin_capital_colonization_megacorp_ap_32 }
				}
				narrow_escape_origin_second_colonization_10 = {
					remove_modifier = narrow_escape_origin_second_colonization_10
					add_modifier = { modifier = narrow_escape_origin_second_colonization_ap_10 }
				}
				narrow_escape_origin_second_colonization_16 = {
					remove_modifier = narrow_escape_origin_second_colonization_16
					add_modifier = { modifier = narrow_escape_origin_second_colonization_ap_16 }
				}
				narrow_escape_origin_second_colonization_machine_10 = {
					remove_modifier = narrow_escape_origin_second_colonization_machine_10
					add_modifier = { modifier = narrow_escape_origin_second_colonization_machine_ap_10 }
				}
				narrow_escape_origin_second_colonization_machine_16 = {
					remove_modifier = narrow_escape_origin_second_colonization_machine_16
					add_modifier = { modifier = narrow_escape_origin_second_colonization_machine_ap_16 }
				}
				narrow_escape_origin_third_colonization_6 = {
					remove_modifier = narrow_escape_origin_third_colonization_6
					add_modifier = { modifier = narrow_escape_origin_third_colonization_ap_6 }
				}
				narrow_escape_origin_third_colonization_machine_6 = {
					remove_modifier = narrow_escape_origin_third_colonization_machine_6
					add_modifier = { modifier = narrow_escape_origin_third_colonization_machine_ap_6 }
				}
			}
		}
		else = {
			planet_event = { id = narrow_escape.31 days = 1 }
		}
	}
}

# Finalize colony
planet_event = {
	id = narrow_escape.32

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		OR = {
			has_modifier = narrow_escape_origin_capital_colonization_16
			has_modifier = narrow_escape_origin_capital_colonization_22
			has_modifier = narrow_escape_origin_capital_colonization_26
			has_modifier = narrow_escape_origin_capital_colonization_32
			has_modifier = narrow_escape_origin_capital_colonization_machine_16
			has_modifier = narrow_escape_origin_capital_colonization_machine_22
			has_modifier = narrow_escape_origin_capital_colonization_machine_26
			has_modifier = narrow_escape_origin_capital_colonization_machine_32
			has_modifier = narrow_escape_origin_capital_colonization_servitor_16
			has_modifier = narrow_escape_origin_capital_colonization_servitor_22
			has_modifier = narrow_escape_origin_capital_colonization_servitor_26
			has_modifier = narrow_escape_origin_capital_colonization_servitor_32
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_16
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_22
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_26
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_32
			has_modifier = narrow_escape_origin_capital_colonization_ap_16
			has_modifier = narrow_escape_origin_capital_colonization_ap_22
			has_modifier = narrow_escape_origin_capital_colonization_ap_26
			has_modifier = narrow_escape_origin_capital_colonization_ap_32
			has_modifier = narrow_escape_origin_capital_colonization_machine_ap_16
			has_modifier = narrow_escape_origin_capital_colonization_machine_ap_22
			has_modifier = narrow_escape_origin_capital_colonization_machine_ap_26
			has_modifier = narrow_escape_origin_capital_colonization_machine_ap_32
			has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_16
			has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_22
			has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_26
			has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_32
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_16
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_22
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_26
			has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_32
			has_modifier = narrow_escape_origin_second_colonization_10
			has_modifier = narrow_escape_origin_second_colonization_16
			has_modifier = narrow_escape_origin_second_colonization_machine_10
			has_modifier = narrow_escape_origin_second_colonization_machine_16
			has_modifier = narrow_escape_origin_second_colonization_ap_10
			has_modifier = narrow_escape_origin_second_colonization_ap_16
			has_modifier = narrow_escape_origin_second_colonization_machine_ap_10
			has_modifier = narrow_escape_origin_second_colonization_machine_ap_16
			has_modifier = narrow_escape_origin_third_colonization_6
			has_modifier = narrow_escape_origin_third_colonization_machine_6
			has_modifier = narrow_escape_origin_third_colonization_ap_6
			has_modifier = narrow_escape_origin_third_colonization_machine_ap_6
		}
	}

	immediate = {
		random_country = {
			limit = {
				has_country_flag = country_type_narrow_escape_origin_primary_species@root.owner
			}
			save_event_target_as = narrow_escape_origin_primary_species
		}
		random_country = {
			limit = {
				has_country_flag = country_type_narrow_escape_origin_secondary_species@root.owner
			}
			save_event_target_as = narrow_escape_origin_secondary_species
		}
		if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_capital_colonization_16
					has_modifier = narrow_escape_origin_capital_colonization_hive_16
					has_modifier = narrow_escape_origin_capital_colonization_machine_16
					has_modifier = narrow_escape_origin_capital_colonization_servitor_16
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_16
					has_modifier = narrow_escape_origin_capital_colonization_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_22
					has_modifier = narrow_escape_origin_capital_colonization_hive_22
					has_modifier = narrow_escape_origin_capital_colonization_machine_22
					has_modifier = narrow_escape_origin_capital_colonization_servitor_22
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_22
					has_modifier = narrow_escape_origin_capital_colonization_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_26
					has_modifier = narrow_escape_origin_capital_colonization_hive_26
					has_modifier = narrow_escape_origin_capital_colonization_machine_26
					has_modifier = narrow_escape_origin_capital_colonization_servitor_26
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_26
					has_modifier = narrow_escape_origin_capital_colonization_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_32
					has_modifier = narrow_escape_origin_capital_colonization_hive_32
					has_modifier = narrow_escape_origin_capital_colonization_machine_32
					has_modifier = narrow_escape_origin_capital_colonization_servitor_32
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_32
					has_modifier = narrow_escape_origin_capital_colonization_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_32
				}
			}
			owner = {
				remove_modifier = narrow_escape_origin_need_capital

				this = {
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = energy
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_energy
							value = 10000000
						}
						add_resource = { energy = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = energy
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_energy
							value = 10000
						}
						add_resource = { energy = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = energy
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_energy
							value = 10
						}
						add_resource = { energy = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = energy
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_energy
							value = 0.00001
						}
						add_resource = { energy = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minerals
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_minerals
							value = 10000000
						}
						add_resource = { minerals = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minerals
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_minerals
							value = 10000
						}
						add_resource = { minerals = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minerals
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_minerals
							value = 10
						}
						add_resource = { minerals = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minerals
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_minerals
							value = 0.00001
						}
						add_resource = { minerals = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = food
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_food
							value = 10000000
						}
						add_resource = { food = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = food
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_food
							value = 10000
						}
						add_resource = { food = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = food
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_food
							value = 10
						}
						add_resource = { food = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = food
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_food
							value = 0.00001
						}
						add_resource = { food = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = influence
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_influence
							value = 10000000
						}
						add_resource = { influence = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = influence
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_influence
							value = 10000
						}
						add_resource = { influence = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = influence
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_influence
							value = 10
						}
						add_resource = { influence = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = influence
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_influence
							value = 0.00001
						}
						add_resource = { influence = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = unity
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_unity
							value = 10000000
						}
						add_resource = { unity = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = unity
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_unity
							value = 10000
						}
						add_resource = { unity = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = unity
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_unity
							value = 10
						}
						add_resource = { unity = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = unity
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_unity
							value = 0.00001
						}
						add_resource = { unity = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = alloys
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_alloys
							value = 10000000
						}
						add_resource = { alloys = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = alloys
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_alloys
							value = 10000
						}
						add_resource = { alloys = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = alloys
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_alloys
							value = 10
						}
						add_resource = { alloys = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = alloys
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_alloys
							value = 0.00001
						}
						add_resource = { alloys = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = consumer_goods
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 10000000
						}
						add_resource = { consumer_goods = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = consumer_goods
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 10000
						}
						add_resource = { consumer_goods = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = consumer_goods
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 10
						}
						add_resource = { consumer_goods = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = consumer_goods
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 0.00001
						}
						add_resource = { consumer_goods = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = volatile_motes
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 10000000
						}
						add_resource = { volatile_motes = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = volatile_motes
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 10000
						}
						add_resource = { volatile_motes = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = volatile_motes
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 10
						}
						add_resource = { volatile_motes = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = volatile_motes
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 0.00001
						}
						add_resource = { volatile_motes = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = exotic_gases
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 10000000
						}
						add_resource = { exotic_gases = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = exotic_gases
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 10000
						}
						add_resource = { exotic_gases = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = exotic_gases
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 10
						}
						add_resource = { exotic_gases = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = exotic_gases
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 0.00001
						}
						add_resource = { exotic_gases = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = rare_crystals
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 10000000
						}
						add_resource = { rare_crystals = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = rare_crystals
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 10000
						}
						add_resource = { rare_crystals = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = rare_crystals
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 10
						}
						add_resource = { rare_crystals = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = rare_crystals
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 0.00001
						}
						add_resource = { rare_crystals = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_living_metal
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 10000000
						}
						add_resource = { sr_living_metal = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_living_metal
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 10000
						}
						add_resource = { sr_living_metal = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_living_metal
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 10
						}
						add_resource = { sr_living_metal = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_living_metal
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 0.00001
						}
						add_resource = { sr_living_metal = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_zro
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_zro
							value = 10000000
						}
						add_resource = { sr_zro = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_zro
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_zro
							value = 10000
						}
						add_resource = { sr_zro = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_zro
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_zro
							value = 10
						}
						add_resource = { sr_zro = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_zro
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_zro
							value = 0.00001
						}
						add_resource = { sr_zro = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_dark_matter
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 10000000
						}
						add_resource = { sr_dark_matter = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_dark_matter
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 10000
						}
						add_resource = { sr_dark_matter = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_dark_matter
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 10
						}
						add_resource = { sr_dark_matter = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = sr_dark_matter
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 0.00001
						}
						add_resource = { sr_dark_matter = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = nanites
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_nanites
							value = 10000000
						}
						add_resource = { nanites = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = nanites
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_nanites
							value = 10000
						}
						add_resource = { nanites = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = nanites
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_nanites
							value = 10
						}
						add_resource = { nanites = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = nanites
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_nanites
							value = 0.00001
						}
						add_resource = { nanites = -0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minor_artifacts
								value >= 10000000
							}
						}
						change_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 10000000
						}
						add_resource = { minor_artifacts = -10000000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minor_artifacts
								value >= 10000
							}
						}
						change_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 10000
						}
						add_resource = { minor_artifacts = -10000 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minor_artifacts
								value >= 10
							}
						}
						change_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 10
						}
						add_resource = { minor_artifacts = -10 }
					}
					while = {
						count = 1000000
						limit = {
							resource_stockpile_compare = {
								resource = minor_artifacts
								value >= 0.00001
							}
						}
						change_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 0.00001
						}
						add_resource = { minor_artifacts = -0.00001 }
					}
				}

				set_country_type = default

				this = {
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_energy
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_energy
							value = 10000000
						}
						add_resource = { energy = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_energy
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_energy
							value = 10000
						}
						add_resource = { energy = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_energy
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_energy
							value = 10
						}
						add_resource = { energy = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_energy
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_energy
							value = 0.00001
						}
						add_resource = { energy = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minerals
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minerals
							value = 10000000
						}
						add_resource = { minerals = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minerals
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minerals
							value = 10000
						}
						add_resource = { minerals = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minerals
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minerals
							value = 10
						}
						add_resource = { minerals = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minerals
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minerals
							value = 0.00001
						}
						add_resource = { minerals = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_food
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_food
							value = 10000000
						}
						add_resource = { food = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_food
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_food
							value = 10000
						}
						add_resource = { food = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_food
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_food
							value = 10
						}
						add_resource = { food = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_food
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_food
							value = 0.00001
						}
						add_resource = { food = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_influence
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_influence
							value = 10000000
						}
						add_resource = { influence = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_influence
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_influence
							value = 10000
						}
						add_resource = { influence = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_influence
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_influence
							value = 10
						}
						add_resource = { influence = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_influence
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_influence
							value = 0.00001
						}
						add_resource = { influence = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_unity
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_unity
							value = 10000000
						}
						add_resource = { unity = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_unity
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_unity
							value = 10000
						}
						add_resource = { unity = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_unity
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_unity
							value = 10
						}
						add_resource = { unity = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_unity
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_unity
							value = 0.00001
						}
						add_resource = { unity = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_alloys
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_alloys
							value = 10000000
						}
						add_resource = { alloys = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_alloys
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_alloys
							value = 10000
						}
						add_resource = { alloys = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_alloys
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_alloys
							value = 10
						}
						add_resource = { alloys = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_alloys
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_alloys
							value = 0.00001
						}
						add_resource = { alloys = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_consumer_goods
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 10000000
						}
						add_resource = { consumer_goods = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_consumer_goods
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 10000
						}
						add_resource = { consumer_goods = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_consumer_goods
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 10
						}
						add_resource = { consumer_goods = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_consumer_goods
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_consumer_goods
							value = 0.00001
						}
						add_resource = { consumer_goods = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_volatile_motes
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 10000000
						}
						add_resource = { volatile_motes = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_volatile_motes
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 10000
						}
						add_resource = { volatile_motes = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_volatile_motes
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 10
						}
						add_resource = { volatile_motes = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_volatile_motes
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_volatile_motes
							value = 0.00001
						}
						add_resource = { volatile_motes = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_exotic_gases
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 10000000
						}
						add_resource = { exotic_gases = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_exotic_gases
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 10000
						}
						add_resource = { exotic_gases = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_exotic_gases
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 10
						}
						add_resource = { exotic_gases = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_exotic_gases
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_exotic_gases
							value = 0.00001
						}
						add_resource = { exotic_gases = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_rare_crystals
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 10000000
						}
						add_resource = { rare_crystals = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_rare_crystals
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 10000
						}
						add_resource = { rare_crystals = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_rare_crystals
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 10
						}
						add_resource = { rare_crystals = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_rare_crystals
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_rare_crystals
							value = 0.00001
						}
						add_resource = { rare_crystals = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_living_metal
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 10000000
						}
						add_resource = { sr_living_metal = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_living_metal
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 10000
						}
						add_resource = { sr_living_metal = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_living_metal
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 10
						}
						add_resource = { sr_living_metal = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_living_metal
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_living_metal
							value = 0.00001
						}
						add_resource = { sr_living_metal = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_zro
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_zro
							value = 10000000
						}
						add_resource = { sr_zro = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_zro
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_zro
							value = 10000
						}
						add_resource = { sr_zro = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_zro
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_zro
							value = 10
						}
						add_resource = { sr_zro = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_zro
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_zro
							value = 0.00001
						}
						add_resource = { sr_zro = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_dark_matter
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 10000000
						}
						add_resource = { sr_dark_matter = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_dark_matter
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 10000
						}
						add_resource = { sr_dark_matter = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_dark_matter
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 10
						}
						add_resource = { sr_dark_matter = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_sr_dark_matter
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_sr_dark_matter
							value = 0.00001
						}
						add_resource = { sr_dark_matter = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_nanites
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_nanites
							value = 10000000
						}
						add_resource = { nanites = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_nanites
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_nanites
							value = 10000
						}
						add_resource = { nanites = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_nanites
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_nanites
							value = 10
						}
						add_resource = { nanites = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_nanites
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_nanites
							value = 0.00001
						}
						add_resource = { nanites = 0.00001 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minor_artifacts
								value >= 10000000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 10000000
						}
						add_resource = { minor_artifacts = 10000000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minor_artifacts
								value >= 10000
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 10000
						}
						add_resource = { minor_artifacts = 10000 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minor_artifacts
								value >= 10
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 10
						}
						add_resource = { minor_artifacts = 10 }
					}
					while = {
						count = 1000000
						limit = {
							check_variable = {
								which = narrow_escape_origin_minor_artifacts
								value >= 0.00001
							}
						}
						subtract_variable = {
							which = narrow_escape_origin_minor_artifacts
							value = 0.00001
						}
						add_resource = { minor_artifacts = 0.00001 }
					}
				}

				every_country = {
					limit = {
						has_country_flag = narrow_escape_met_country_immediate@prev
					}
					establish_communications = prev
				}
			}

			set_capital = yes

			owner = {
				every_owned_ship = {
					limit = {
						is_ship_class = shipclass_constructor
					}
					fleet = { set_event_locked = no }
					remove_modifier = narrow_escape_origin_construction_ship
				}
				remove_modifier = narrow_escape_origin_need_outpost
			}
		}
		if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_capital_colonization_16
					has_modifier = narrow_escape_origin_capital_colonization_hive_16
					has_modifier = narrow_escape_origin_capital_colonization_machine_16
					has_modifier = narrow_escape_origin_capital_colonization_servitor_16
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_16
					has_modifier = narrow_escape_origin_capital_colonization_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_16
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_16
				}
			}
			remove_modifier = narrow_escape_origin_capital_colonization_16
			remove_modifier = narrow_escape_origin_capital_colonization_hive_16
			remove_modifier = narrow_escape_origin_capital_colonization_machine_16
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_16
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_16
			remove_modifier = narrow_escape_origin_capital_colonization_ap_16
			remove_modifier = narrow_escape_origin_capital_colonization_hive_ap_16
			remove_modifier = narrow_escape_origin_capital_colonization_machine_ap_16
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_ap_16
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_16
			while = {
				limit = {
					count_pops = { count > 16 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 16 }
				}
				create_pop = { species = event_target:narrow_escape_origin_primary_species }
			}
			if = {
				limit = {
					owner = { has_authority = auth_hive_mind }
				}
				while = {
					count = 4
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { is_megacorp = yes }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = {
						is_machine_empire = yes
						NOT = { has_valid_civic = civic_machine_servitor }
					}
				}
				while = {
					count = 1
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 5
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 5
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_servitor }
				}
				while = {
					count = 5
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.34 }
			add_planet_devastation = 50
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_16 }
					}
					narrow_escape_origin_colony_ships_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_hive_16 }
					}
					narrow_escape_origin_colony_ships_machine_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_machine_16 }
					}
					narrow_escape_origin_colony_ships_assimilator_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_16 }
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_16 }
					}
					narrow_escape_origin_colony_ships_servitor_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_16 }
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_lithoid_16 }
					}
					narrow_escape_origin_colony_ships_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_16 }
					}
					narrow_escape_origin_colony_ships_lithoid_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_hive_16 }
					}
					narrow_escape_origin_colony_ships_megacorp_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_16 }
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_16 }
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.37 days = 2 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_capital_colonization_22
					has_modifier = narrow_escape_origin_capital_colonization_hive_22
					has_modifier = narrow_escape_origin_capital_colonization_machine_22
					has_modifier = narrow_escape_origin_capital_colonization_servitor_22
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_22
					has_modifier = narrow_escape_origin_capital_colonization_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_22
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_22
				}
			}
			remove_modifier = narrow_escape_origin_capital_colonization_22
			remove_modifier = narrow_escape_origin_capital_colonization_hive_22
			remove_modifier = narrow_escape_origin_capital_colonization_machine_22
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_22
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_22
			remove_modifier = narrow_escape_origin_capital_colonization_ap_22
			remove_modifier = narrow_escape_origin_capital_colonization_hive_ap_22
			remove_modifier = narrow_escape_origin_capital_colonization_machine_ap_22
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_ap_22
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_22
			while = {
				limit = {
					count_pops = { count > 22 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 22 }
				}
				create_pop = { species = owner }
			}
			if = {
				limit = {
					owner = { has_authority = auth_hive_mind }
				}
				while = {
					count = 4
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { is_megacorp = yes }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = {
						is_machine_empire = yes
						NOT = { has_valid_civic = civic_machine_servitor }
					}
				}
				while = {
					count = 1
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 7
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 7
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_servitor }
				}
				while = {
					count = 5
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.34 }
			add_planet_devastation = 50
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_10 }
					}
					narrow_escape_origin_colony_ships_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_hive_10 }
					}
					narrow_escape_origin_colony_ships_machine_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_machine_10 }
					}
					narrow_escape_origin_colony_ships_assimilator_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_10 }
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_10 }
					}
					narrow_escape_origin_colony_ships_servitor_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_10 }
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_lithoid_10 }
					}
					narrow_escape_origin_colony_ships_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_10 }
					}
					narrow_escape_origin_colony_ships_lithoid_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_hive_10 }
					}
					narrow_escape_origin_colony_ships_megacorp_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_10 }
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_10 }
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.37 days = 2 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_capital_colonization_26
					has_modifier = narrow_escape_origin_capital_colonization_hive_26
					has_modifier = narrow_escape_origin_capital_colonization_machine_26
					has_modifier = narrow_escape_origin_capital_colonization_servitor_26
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_26
					has_modifier = narrow_escape_origin_capital_colonization_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_26
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_26
				}
			}
			remove_modifier = narrow_escape_origin_capital_colonization_26
			remove_modifier = narrow_escape_origin_capital_colonization_hive_26
			remove_modifier = narrow_escape_origin_capital_colonization_machine_26
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_26
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_26
			remove_modifier = narrow_escape_origin_capital_colonization_ap_26
			remove_modifier = narrow_escape_origin_capital_colonization_hive_ap_26
			remove_modifier = narrow_escape_origin_capital_colonization_machine_ap_26
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_ap_26
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_26
			while = {
				limit = {
					count_pops = { count > 26 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 26 }
				}
				create_pop = { species = owner }
			}
			if = {
				limit = {
					owner = { has_authority = auth_hive_mind }
				}
				while = {
					count = 6
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { is_megacorp = yes }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = {
						is_machine_empire = yes
						NOT = { has_valid_civic = civic_machine_servitor }
					}
				}
				while = {
					count = 1
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 8
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 8
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_servitor }
				}
				while = {
					count = 5
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.33 }
			add_planet_devastation = 50
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_6 }
					}
					narrow_escape_origin_colony_ships_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_hive_6 }
					}
					narrow_escape_origin_colony_ships_machine_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_machine_6 }
					}
					narrow_escape_origin_colony_ships_assimilator_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_6 }
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_servitor_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_6 }
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_lithoid_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_hive_6 }
					}
					narrow_escape_origin_colony_ships_megacorp_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_6 }
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_32
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_6 }
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.37 days = 2 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_capital_colonization_32
					has_modifier = narrow_escape_origin_capital_colonization_hive_32
					has_modifier = narrow_escape_origin_capital_colonization_machine_32
					has_modifier = narrow_escape_origin_capital_colonization_servitor_32
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_32
					has_modifier = narrow_escape_origin_capital_colonization_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_hive_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_machine_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_servitor_ap_32
					has_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_32
				}
			}
			remove_modifier = narrow_escape_origin_capital_colonization_32
			remove_modifier = narrow_escape_origin_capital_colonization_hive_32
			remove_modifier = narrow_escape_origin_capital_colonization_machine_32
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_32
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_32
			remove_modifier = narrow_escape_origin_capital_colonization_ap_32
			remove_modifier = narrow_escape_origin_capital_colonization_hive_ap_32
			remove_modifier = narrow_escape_origin_capital_colonization_machine_ap_32
			remove_modifier = narrow_escape_origin_capital_colonization_servitor_ap_32
			remove_modifier = narrow_escape_origin_capital_colonization_megacorp_ap_32
			while = {
				limit = {
					count_pops = { count > 32 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 32 }
				}
				create_pop = { species = owner }
			}
			if = {
				limit = {
					owner = { has_authority = auth_hive_mind }
				}
				while = {
					count = 6
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { is_megacorp = yes }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = {
						is_machine_empire = yes
						NOT = { has_valid_civic = civic_machine_servitor }
					}
				}
				while = {
					count = 1
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 10
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 10
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_servitor }
				}
				while = {
					count = 5
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.33 }
			add_planet_devastation = 50
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_32
					}
					narrow_escape_origin_colony_ships_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_32
					}
					narrow_escape_origin_colony_ships_machine_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_32
					}
					narrow_escape_origin_colony_ships_assimilator_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_32
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_32
					}
					narrow_escape_origin_colony_ships_servitor_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_32
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_32
					}
					narrow_escape_origin_colony_ships_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_32
					}
					narrow_escape_origin_colony_ships_lithoid_hive_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_32
					}
					narrow_escape_origin_colony_ships_megacorp_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_32
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_32 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_32
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.37 days = 2 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_second_colonization_10
					has_modifier = narrow_escape_origin_second_colonization_hive_10
					has_modifier = narrow_escape_origin_second_colonization_machine_10
					has_modifier = narrow_escape_origin_second_colonization_ap_10
					has_modifier = narrow_escape_origin_second_colonization_hive_ap_10
					has_modifier = narrow_escape_origin_second_colonization_machine_ap_10
				}
			}
			remove_modifier = narrow_escape_origin_second_colonization_10
			remove_modifier = narrow_escape_origin_second_colonization_hive_10
			remove_modifier = narrow_escape_origin_second_colonization_machine_10
			remove_modifier = narrow_escape_origin_second_colonization_ap_10
			remove_modifier = narrow_escape_origin_second_colonization_hive_ap_10
			remove_modifier = narrow_escape_origin_second_colonization_machine_ap_10
			while = {
				limit = {
					count_pops = { count > 10 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 10 }
				}
				create_pop = { species = owner }
			}
			if = {
				limit = {
					owner = { has_authority = auth_hive_mind }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 3
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 3
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.35 }
			add_planet_devastation = 20
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_6 }
					}
					narrow_escape_origin_colony_ships_hive_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_hive_6 }
					}
					narrow_escape_origin_colony_ships_machine_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_machine_6 }
					}
					narrow_escape_origin_colony_ships_assimilator_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_6 }
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_servitor_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_6 }
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_servitor_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_lithoid_hive_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_lithoid_hive_6 }
					}
					narrow_escape_origin_colony_ships_megacorp_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_6 }
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_16
						add_modifier = { modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_6 }
					}
					narrow_escape_origin_colony_ships_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_10
					}
					narrow_escape_origin_colony_ships_hive_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_10
					}
					narrow_escape_origin_colony_ships_machine_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_10
					}
					narrow_escape_origin_colony_ships_assimilator_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_10
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_10
					}
					narrow_escape_origin_colony_ships_servitor_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_10
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_10
					}
					narrow_escape_origin_colony_ships_lithoid_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_10
					}
					narrow_escape_origin_colony_ships_lithoid_hive_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_10
					}
					narrow_escape_origin_colony_ships_megacorp_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_10
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_10 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_10
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.38 days = 2 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_second_colonization_16
					has_modifier = narrow_escape_origin_second_colonization_hive_16
					has_modifier = narrow_escape_origin_second_colonization_machine_16
					has_modifier = narrow_escape_origin_second_colonization_ap_16
					has_modifier = narrow_escape_origin_second_colonization_hive_ap_16
					has_modifier = narrow_escape_origin_second_colonization_machine_ap_16
				}
			}
			remove_modifier = narrow_escape_origin_second_colonization_16
			remove_modifier = narrow_escape_origin_second_colonization_hive_16
			remove_modifier = narrow_escape_origin_second_colonization_machine_16
			remove_modifier = narrow_escape_origin_second_colonization_ap_16
			remove_modifier = narrow_escape_origin_second_colonization_hive_ap_16
			remove_modifier = narrow_escape_origin_second_colonization_machine_ap_16
			while = {
				limit = {
					count_pops = { count > 16 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 16 }
				}
				create_pop = { species = owner }
			}
			if = {
				limit = {
					owner = { has_authority = auth_hive_mind }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_primary_species }
				}
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 5
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 5
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.35 }
			add_planet_devastation = 20
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_16
					}
					narrow_escape_origin_colony_ships_hive_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_16
					}
					narrow_escape_origin_colony_ships_machine_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_16
					}
					narrow_escape_origin_colony_ships_assimilator_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_16
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_16
					}
					narrow_escape_origin_colony_ships_servitor_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_16
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_16
					}
					narrow_escape_origin_colony_ships_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_16
					}
					narrow_escape_origin_colony_ships_lithoid_hive_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_16
					}
					narrow_escape_origin_colony_ships_megacorp_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_16
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_16 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_16
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.38 days = 2 }
			}
		}
		else_if = {
			limit = {
				OR = {
					has_modifier = narrow_escape_origin_third_colonization_6
					has_modifier = narrow_escape_origin_third_colonization_machine_6
					has_modifier = narrow_escape_origin_third_colonization_ap_6
					has_modifier = narrow_escape_origin_third_colonization_machine_ap_6
				}
			}
			remove_modifier = narrow_escape_origin_third_colonization_6
			remove_modifier = narrow_escape_origin_third_colonization_machine_6
			remove_modifier = narrow_escape_origin_third_colonization_ap_6
			remove_modifier = narrow_escape_origin_third_colonization_machine_ap_6
			while = {
				limit = {
					count_pops = { count > 6 }
				}
				random_pop = { kill_pop = yes }
			}
			while = {
				limit = {
					count_pops = { count < 6 }
				}
				create_pop = { species = owner }
			}
			if = {
				limit = {
					owner = { has_valid_civic = civic_machine_assimilator }
				}
				while = {
					count = 2
					random_pop = { kill_pop = yes }
				}
				while = {
					count = 2
					create_pop = { species = event_target:narrow_escape_origin_secondary_species }
				}
			}
			planet_event = { id = narrow_escape.36 }
			add_planet_devastation = 10
			owner = {
				switch = {
					trigger = has_modifier
					narrow_escape_origin_colony_ships_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_6
					}
					narrow_escape_origin_colony_ships_hive_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_hive_6
					}
					narrow_escape_origin_colony_ships_machine_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_machine_6
					}
					narrow_escape_origin_colony_ships_assimilator_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_6
					}
					narrow_escape_origin_colony_ships_assimilator_lithoid_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_assimilator_lithoid_6
					}
					narrow_escape_origin_colony_ships_servitor_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_6
					}
					narrow_escape_origin_colony_ships_servitor_lithoid_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_servitor_lithoid_6
					}
					narrow_escape_origin_colony_ships_lithoid_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_6
					}
					narrow_escape_origin_colony_ships_lithoid_hive_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_lithoid_hive_6
					}
					narrow_escape_origin_colony_ships_megacorp_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_6
					}
					narrow_escape_origin_colony_ships_megacorp_lithoid_6 = {
						remove_modifier = narrow_escape_origin_colony_ships_megacorp_lithoid_6
					}
				}
			}

			if = {
				limit = {
					owner = { is_ai = yes }
				}
				planet_event = { id = narrow_escape.39 days = 2 }
			}
		}
	}
}

planet_event = {
	id = narrow_escape.33
	title = narrow_escape.33.name
	desc = narrow_escape.33.desc

	picture = GFX_evt_colony_settlement
	show_sound = event_construction

	is_triggered_only = yes

	option = {
		name = narrow_escape.33.a

		add_modifier = { modifier = narrow_escape_origin_capital_colonized_2 days = 360 }

		owner = {
			custom_tooltip = narrow_escape_colonization_fever_1_added
			hidden_effect = {
				switch = {
					trigger = years_passed
					10 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3600 } }
					9 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3420 } }
					8 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3240 } }
					7 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3060 } }
					6 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2880 } }
					5 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2700 } }
					4 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2520 } }
					3 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2340 } }
					2 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2160 } }
					1 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 1980 } }
					default = { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 1800 } }
				}
			}
		}
	}
}

planet_event = {
	id = narrow_escape.34
	title = narrow_escape.34.name
	desc = narrow_escape.34.desc

	picture = GFX_evt_colony_settlement
	show_sound = event_construction

	is_triggered_only = yes

	option = {
		name = narrow_escape.34.a

		add_modifier = { modifier = narrow_escape_origin_capital_colonized days = 360 }

		owner = {
			custom_tooltip = narrow_escape_colonization_fever_1_added
			hidden_effect = {
				switch = {
					trigger = years_passed
					10 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3600 } }
					9 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3420 } }
					8 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3240 } }
					7 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 3060 } }
					6 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2880 } }
					5 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2700 } }
					4 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2520 } }
					3 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2340 } }
					2 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 2160 } }
					1 >= { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 1980 } }
					default = { add_modifier = { modifier = narrow_escape_colonization_fever_1 days = 1800 } }
				}
			}
		}
	}
}

planet_event = {
	id = narrow_escape.35
	title = narrow_escape.35.name
	desc = narrow_escape.35.desc

	picture = GFX_evt_colony_settlement
	show_sound = event_construction

	is_triggered_only = yes

	option = {
		name = narrow_escape.35.a

		add_modifier = { modifier = narrow_escape_origin_second_colonized days = 360 }

		owner = {
			custom_tooltip = narrow_escape_colonization_fever_2_added
			hidden_effect = {
				switch = {
					trigger = years_passed
					10 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1800 } }
					9 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1692 } }
					8 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1584 } }
					7 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1476 } }
					6 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1368 } }
					5 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1260 } }
					4 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1152 } }
					3 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 1044 } }
					2 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 936 } }
					1 >= { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 828 } }
					default = { add_modifier = { modifier = narrow_escape_colonization_fever_2 days = 720 } }
				}
			}
		}
	}
}

planet_event = {
	id = narrow_escape.36
	title = narrow_escape.36.name
	desc = narrow_escape.36.desc

	picture = GFX_evt_colony_settlement
	show_sound = event_construction

	is_triggered_only = yes

	option = {
		name = narrow_escape.36.a

		add_modifier = { modifier = narrow_escape_origin_third_colonized days = 360 }

		owner = {
			custom_tooltip = narrow_escape_colonization_fever_3_added
			hidden_effect = {
				switch = {
					trigger = years_passed
					10 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 900 } }
					9 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 846 } }
					8 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 792 } }
					7 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 738 } }
					6 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 684 } }
					5 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 630 } }
					4 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 576 } }
					3 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 522 } }
					2 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 468 } }
					1 >= { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 414 } }
					default = { add_modifier = { modifier = narrow_escape_colonization_fever_3 days = 360 } }
				}
			}
		}
	}
}

planet_event = {
	id = narrow_escape.37

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = {
			limit = {
				owner = { is_machine_empire = no }
			}
			add_building = building_capital
		}
		else = {
			add_building = building_machine_capital
		}
		if = {
			limit = {
				owner = {
					country_uses_food = yes
					NOT = { has_valid_civic = civic_machine_servitor }
					NOT = { has_valid_civic = civic_machine_assimilator }
				}
			}
			add_district = district_farming
			add_district = district_farming
			add_district = district_farming
		}
		else_if = {
			limit = {
				owner = { has_valid_civic = civic_machine_assimilator }
			}
			if = {
				limit = {
					owner = { any_owned_species = { is_lithoid = yes } }
				}
				add_district = district_mining
				add_district = district_mining
			}
			else = {
				add_district = district_farming
				add_district = district_farming
			}
			add_district = district_generator
		}
		else_if = {
			limit = {
				owner = { has_valid_civic = civic_machine_servitor }
			}
			if = {
				limit = {
					owner = { any_owned_species = { is_lithoid = yes } }
				}
				add_district = district_mining
			}
			else = {
				add_district = district_farming
			}
			add_district = district_generator
			add_district = district_generator
		}
		else_if = {
			limit = {
				owner = { is_machine_empire = yes }
			}
			add_district = district_mining
			add_district = district_generator
			add_district = district_generator
		}
		else_if = {
			limit = {
				owner = { is_lithoid_empire = yes }
			}
			add_district = district_mining
			add_district = district_mining
			add_district = district_mining
		}
		add_district = district_mining
		add_district = district_mining
		add_district = district_generator
		add_district = district_city
		add_district = district_city
		add_district = district_city
		change_variable = {
			which = narrow_escape_builds_completed
			value = 10
		}
	}
}

planet_event = {
	id = narrow_escape.38

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		add_building = building_capital
		add_district = district_city
		add_district = district_mining

		change_variable = {
			which = narrow_escape_builds_completed
			value = 3
		}
	}
}

planet_event = {
	id = narrow_escape.39

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		add_district = district_city
		add_district = district_mining

		change_variable = {
			which = narrow_escape_builds_completed
			value = 2
		}
	}
}

# Remove starting modifiers when too many things have been built
planet_event = {
	id = narrow_escape.40

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		OR = {
			has_modifier = narrow_escape_origin_capital_colonized_2
			has_modifier = narrow_escape_origin_capital_colonized
			has_modifier = narrow_escape_origin_second_colonized
			has_modifier = narrow_escape_origin_third_colonized
		}
	}

	immediate = {
		change_variable = {
			which = narrow_escape_builds_completed
			value = 1
		}
		switch = {
			trigger = has_modifier
			narrow_escape_origin_capital_colonized_2 = {
				if = {
					limit = {
						check_variable = {
							which = narrow_escape_builds_completed
							value >= 18
						}
					}
					remove_modifier = narrow_escape_origin_capital_colonized_2
				}
			}
			narrow_escape_origin_capital_colonized = {
				if = {
					limit = {
						check_variable = {
							which = narrow_escape_builds_completed
							value >= 15
						}
					}
					remove_modifier = narrow_escape_origin_capital_colonized
				}
			}
			narrow_escape_origin_second_colonized = {
				if = {
					limit = {
						check_variable = {
							which = narrow_escape_builds_completed
							value >= 5
						}
					}
					remove_modifier = narrow_escape_origin_second_colonized
				}
			}
			narrow_escape_origin_third_colonized = {
				if = {
					limit = {
						check_variable = {
							which = narrow_escape_builds_completed
							value >= 4
						}
					}
					remove_modifier = narrow_escape_origin_third_colonized
				}
			}
		}
	}
}

# Reduce pop variables when a starting colony ship is destroyed
country_event = {
	id = narrow_escape.50

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		fromfrom = { has_modifier = narrow_escape_origin_populated_colony_ship }
	}

	immediate = {
		if = {
			limit = {
				check_variable = {
					which = narrow_escape_origin_third_colony_pops
					value > 0
				}
			}
			subtract_variable = {
				which = narrow_escape_origin_colony_pops_left
				value = narrow_escape_origin_third_colony_pops
			}
			set_variable = {
				which = narrow_escape_origin_third_colony_pops
				value = 0
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = narrow_escape_origin_second_colony_pops
					value > 0
				}
			}
			subtract_variable = {
				which = narrow_escape_origin_colony_pops_left
				value = narrow_escape_origin_second_colony_pops
			}
			set_variable = {
				which = narrow_escape_origin_second_colony_pops
				value = 0
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = narrow_escape_origin_first_colony_pops
					value > 0
				}
			}
			subtract_variable = {
				which = narrow_escape_origin_colony_pops_left
				value = narrow_escape_origin_first_colony_pops
			}
			set_variable = {
				which = narrow_escape_origin_first_colony_pops
				value = 0
			}
		}
	}
}

# Establish communications
country_event = {
	id = narrow_escape.100

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_country_type = country_type_narrow_escape_origin
	}

	immediate = {
		from = { set_country_flag = narrow_escape_met_country_immediate@root }
	}
}

event = {
	id = narrow_escape.1000

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		every_country = {
			random_country = {
				limit = {
					has_country_flag = country_type_narrow_escape_origin_primary_species@prev
				}
				prev = {
					every_owned_pop = {
						limit = {
							is_same_species = prevprev.species
							NOT = { has_trait = trait_narrow_escape_species }
						}
						modify_species = {
							add_trait = trait_narrow_escape_species
						}
					}
				}
			}
			random_country = {
				limit = {
					has_country_flag = country_type_narrow_escape_origin_secondary_species@prev
				}
				prev = {
					every_owned_pop = {
						limit = {
							is_same_species = prevprev.species
							NOT = { has_trait = trait_narrow_escape_species }
						}
						modify_species = {
							add_trait = trait_narrow_escape_species
						}
					}
				}
			}
		}
	}
}
