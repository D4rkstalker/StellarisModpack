namespace = nep_inva

#Create cluster,portal
country_event = {
	id = nep_inva.1
	title = "nep_inva.1.name"
	desc = "nep_inva.1.desc"	
	picture = GFX_evt_drifting_gateway

	is_triggered_only = yes
	
	fire_only_once = yes

	trigger = {
		is_ai = no
		has_global_flag = nep_dragon_end
		has_country_flag = nep_dragon_summoner
	}

	immediate = {
		#cluster
		set_spawn_system_batch = begin
		no_scope = {
			spawn_system = {
				min_distance >= 565
				max_distance <= 575
				min_orientation_angle = 314
				max_orientation_angle = 316
				hyperlane = no
				initializer = nep_Central_init
			}
		}
		random_system = { 
			limit = { has_star_flag = nep_Central_system }
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Centaury_init
			}
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Magellan_init
			}
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Orion_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Tra_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Aurora_init
			}
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Andromeda_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Persei_init
			}
			spawn_system = {
				min_distance >= 30
				max_distance <= 50
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Exterior_init
			}
		}
		while = {
			limit = {
				any_system = {
					has_star_flag = nep_Krahen_cluster
					check_variable = { which = hyperlane_num value < 3 }
				}
			}
			random_system = {
				limit = {
					has_star_flag = nep_Krahen_cluster
					check_variable = { which = hyperlane_num value < 3 }
				}
				random_system = {
					limit = {
						NOT = { 
							is_same_value = prev 
							has_hyperlane_to = prev
						}
						has_star_flag = nep_Krahen_cluster
						check_variable = { which = hyperlane_num value < 3 }
					}
					add_hyperlane = {
						from = this
						to = prev
					}
					change_variable = { which = hyperlane_num value = 1 }
				}
				change_variable = { which = hyperlane_num value = 1 }
			}
		}
		set_spawn_system_batch = end
		random_galaxy_planet = {
			limit = {
				has_planet_flag = nep_seal_2
			}
			save_event_target_as = nep_seal_2
			solar_system = {
				spawn_megastructure = {
					name = "NAME_nep_Seal_Gate"
					type = nep_sealgate_ruined
					planet = event_target:nep_seal_2
					orbit_angle = 1
					orbit_distance = 1
				}
				if = {
					limit = { exists = space_owner }
					random_system_megastructure = {
						limit = { is_megastructure_type = nep_sealgate_ruined }
						set_owner = space_owner
					}
				}
			}
		}
		set_global_flag = nep_sealgate_appeared
		country_event = { id = nep_inva.1001 days = 7200 random =  1080} 
		
	}
	
	option = {
		name = nep_inva.1.a
	}
}

country_event = {
	id = nep_inva.1001
	hide_window = yes
	
	is_triggered_only = yes
	
	fire_only_once = yes
	
	immediate = {
		if = {
			limit = {
				has_global_flag = nep_sealgate_appeared
			}
			event_target:nep_grand_seal_planet = {
				planet_event = { id = nep_finalweapon.4001 days = 7200 random = 1800 }
			}
		}
	}
}

#on_megastructure_upgraded
country_event = {
	id = nep_inva.1002	
	title = "nep_inva.1002.name"
	desc = "nep_inva.1002.desc"	
	picture = GFX_evt_drifting_gateway
	location = FROMFROM
	
	is_triggered_only = yes
	
	fire_only_once = yes
	
	trigger = {
		has_global_flag = nep_sealgate_appeared
		has_country_flag = nep_dragon_summoner
		From = {
			OR = {
				is_megastructure_type = nep_sealgate_ruined
				is_megastructure_type = nep_sealgate_restored
			}
		}
	}
	
	immediate = {
		From = { activate_gateway = this }
		random_system = {
			limit = {
				has_star_flag = nep_Krahen_cluster
				NOT = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system
				}
			}
			random_system_planet = {
				limit = { is_star = yes }
				save_event_target_as = nep_gate_temp_poi
				solar_system = {
					#root = { set_visited = prev }
					spawn_megastructure = {
						name = "NAME_nep_Seal_Gate"
						type = nep_sealgate_restored
						planet = event_target:nep_gate_temp_poi
						orbit_angle = 186
						orbit_distance = 150
					}
				}
			}
			every_system_megastructure = {
				limit = {
					is_megastructure_type = nep_sealgate_restored
				}
				activate_gateway = this
			}
		}
	}
	
	option = {
		name = nep_inva.1002.a
	}
}

#Create Krahen,on_entering_nepsealgate
fleet_event = {
	id = nep_inva.2
	title = "nep_inva.2.name"
	desc = "nep_inva.2.desc"	
	picture = GFX_evt_unidentified_ship
	location = FROM

	fire_only_once = yes
	
	is_triggered_only = yes
	
	trigger = {
		owner = { has_country_flag = nep_dragon_summoner }
		FROM = { has_star_flag = nep_Krahen_cluster }
		NOT = { has_global_flag = nep_Krahen_begin }
	}
	
	immediate = {
		create_species = {
			name = "NAME_nep_Krahen"
			class = random_non_machine
			portrait = mol4
			traits = {
				trait = trait_Krahen
			}
		}
		create_country = {
			name = "NAME_nep_Krahen_Empire"
			species = last_created_species
			type = nep_Krahen_country
			auto_delete = no
			name_list = MOL_Krahen
			authority = auth_imperial
			ethos = {
				ethic = ethic_militarist
				ethic = ethic_fanatic_xenophobe
			}
			civics = {
				civic = civic_fanatic_purifiers
				civic = civic_cutthroat_politics
			}
			flag = {
				icon = {
					category = "domination"
					file = "domination_12.dds"
				}
				background= {
					category = "backgrounds"
					file = "new_dawn.dds"
				}
				colors={
					"red"
					"black"
					"null"
					"null"
				}
			}
		}
		last_created_country = {
			create_leader = {
				class = governor
				species = owner_main_species
				name = "NAME_nep_Imperator"
				randomize_traits = yes
				skill = 10
			}
			set_leader = last_created_leader
			set_policy = {
				policy = orbital_bombardment
				option = orbital_bombardment_armageddon
				cooldown = no
			}
			set_country_flag = nep_Krahen_country
			save_global_event_target_as = nep_Krahen_country
			if = {
				limit = { NOT = { has_global_flag = nep_SEoOC_easy } }
				add_modifier = {
					modifier = nep_Krahen_buff
					days = -1
				}
			}
			nep_easy_mod = yes
		}
		set_global_flag = nep_Krahen_begin
		remove_global_flag = nep_sealgate_appeared
		FROM = {
			random_system_planet = {
				create_Krahen_follower = yes
			}
			last_created_fleet = {
				auto_follow_fleet = { target = root attack_fleet = yes }
			}
		}
	}
	
	option = {
		name = nep_inva.2.a
	}
}

country_event = {
	id = nep_inva.210
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_begin
		NOT = { has_global_flag = nep_Krahen_crisis }
		From = {
			has_country_flag = nep_Krahen_country
		}
	}
	
	immediate = {
		From = { country_event = { id = nep_inva.21 days = 5 random = 5 } }
	}
}

#Krah'en crisis begin (Warning,to debug using nep_test.16)
country_event = {
	id = nep_inva.21
	hide_window = yes
	
	is_triggered_only = yes
	
	fire_only_once = yes
		
	immediate = {
		set_global_flag = nep_Krahen_crisis
		set_global_flag = nep_Krahen_stage_1
		
		#Wait for retreat
		every_system = {
			limit = { has_star_flag = nep_Krahen_cluster }
			every_fleet_in_system = {
				limit = {
					exists = owner
				}
				set_event_locked = yes
			}
		}
		
		#inva system
		set_spawn_system_batch = begin
		if = {
			limit = {
				count_country = {
					count >=4
					limit = {
						any_system = {
							is_neighbor_of = prev
							is_rim_system = yes
							any_neighbor_system = {
								is_within_borders_of = prevprev
							}
							nep_st_is_not_outer_or_fe_system = yes
						}
					}
				}
			}
			random_country = {
				limit = { 
					is_ai = no
					any_system = {
						is_neighbor_of = prev
						is_rim_system = yes
						any_neighbor_system = {
							is_within_borders_of = prevprev
						}
						nep_st_is_not_outer_or_fe_system = yes
					}	
				}
				save_event_target_as = nep_Krahen_victim_1
			}
			if = {
				limit = { NOT = { exists = event_target:nep_Krahen_victim_1 } }
				random_country = {
					limit = {
						any_system = {
							is_neighbor_of = prev
							is_rim_system = yes
							any_neighbor_system = {
								is_within_borders_of = prevprev
							}
							nep_st_is_not_outer_or_fe_system = yes
						}
					}
					save_event_target_as = nep_Krahen_victim_1
				}
			}
			random_country = {
				limit = {
					NOT = { is_same_value = event_target:nep_Krahen_victim_1 }
					any_system = {
						is_neighbor_of = prev
						is_rim_system = yes
						any_neighbor_system = {
							is_within_borders_of = prevprev
						}						
						nep_st_is_not_outer_or_fe_system = yes
					}
				}
				save_event_target_as = nep_Krahen_victim_2
			}
			random_country = {
				limit = {
					NOT = { is_same_value = event_target:nep_Krahen_victim_1 }
					NOT = { is_same_value = event_target:nep_Krahen_victim_2 }
					any_system = {
						is_neighbor_of = prev
						is_rim_system = yes
						any_neighbor_system = {
							is_within_borders_of = prevprev
						}
						nep_st_is_not_outer_or_fe_system = yes
					}
				}
				save_event_target_as = nep_Krahen_victim_3
			}			
			random_country = {
				limit = {
					NOT = { is_same_value = event_target:nep_Krahen_victim_1 }
					NOT = { is_same_value = event_target:nep_Krahen_victim_2 }
					NOT = { is_same_value = event_target:nep_Krahen_victim_3 }
					any_system = {
						is_neighbor_of = prev
						is_rim_system = yes
						any_neighbor_system = {
							is_within_borders_of = prevprev
						}
						nep_st_is_not_outer_or_fe_system = yes
					}
				}
				save_event_target_as = nep_Krahen_victim_4
			}
			random_rim_system = {
				limit = {
					is_neighbor_of = event_target:nep_Krahen_victim_1
					any_neighbor_system = {
						is_within_borders_of = event_target:nep_Krahen_victim_1
					}
					nep_st_is_not_outer_or_fe_system = yes
				}
				spawn_system = {
					min_distance >= 10
					max_distance <= 20
					initializer = "nep_inva_system_init"
					hyperlane = no
				}
				save_event_target_as = nep_inva_temp_1
			}
			random_rim_system = {
				limit = {
					is_neighbor_of = event_target:nep_Krahen_victim_2
					any_neighbor_system = {
						is_within_borders_of = event_target:nep_Krahen_victim_2
					}
					nep_st_is_not_outer_or_fe_system = yes
					NOT = {
						distance = {
							source = event_target:nep_inva_temp_1
							min_distance >= 1
							max_distance < 150
						}
					}
				}
				save_event_target_as = nep_inva_temp_2
				spawn_system = {
					min_distance >= 10
					max_distance <= 20
					initializer = "nep_inva_system_init"
					hyperlane = no
				}
			}
			random_rim_system = {
				limit = {
					is_neighbor_of = event_target:nep_Krahen_victim_3
					any_neighbor_system = {
						is_within_borders_of = event_target:nep_Krahen_victim_3
					}
					nep_st_is_not_outer_or_fe_system = yes
					NOR = {
						distance = {
							source = event_target:nep_inva_temp_1
							min_distance >= 1
							max_distance < 150
						}
						distance = {
							source = event_target:nep_inva_temp_2
							min_distance >= 1
							max_distance < 150
						}
					}
				}
				save_event_target_as = nep_inva_temp_3
				spawn_system = {
					min_distance >= 10
					max_distance <= 20
					initializer = "nep_inva_system_init"
					hyperlane = no
				}
			}		
			random_rim_system = {
				limit = {
					is_neighbor_of = event_target:nep_Krahen_victim_4
					any_neighbor_system = {
						is_within_borders_of = event_target:nep_Krahen_victim_4
					}
					nep_st_is_not_outer_or_fe_system = yes
					NOR = {
						distance = {
							source = event_target:nep_inva_temp_1
							min_distance >= 1
							max_distance < 150
						}
						distance = {
							source = event_target:nep_inva_temp_2
							min_distance >= 1
							max_distance < 150
						}					
						distance = {
							source = event_target:nep_inva_temp_3
							min_distance >= 1
							max_distance < 150
						}
					}
				}
				spawn_system = {
					min_distance >= 10
					max_distance <= 20
					initializer = "nep_inva_system_init"
					hyperlane = no
				}
			}
		}		
		else = {
			random_country = {
				limit = { 
					is_ai = no
					any_system = {
						is_neighbor_of = prev
						is_rim_system = yes
					}
				}
				save_event_target_as = nep_Krahen_victim_1
			}
			if = {
				limit = { NOT = { exists = event_target:nep_Krahen_victim_1 } }
				random_country = {
					limit = {
						any_system = {
							is_neighbor_of = prev
							is_rim_system = yes
						}
					}
					save_event_target_as = nep_Krahen_victim_1
				}
			}
			if = {
				limit = { exists = event_target:nep_Krahen_victim_1 }
				random_rim_system = {
					limit = {
						is_neighbor_of = event_target:nep_Krahen_victim_1
						any_neighbor_system = {
							is_within_borders_of = event_target:nep_Krahen_victim_1
						}
						nep_st_is_not_outer_or_fe_system = yes
					}
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
					save_event_target_as = nep_inva_temp_1
				}
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
						NOT = {
							distance = {
								source = event_target:nep_inva_temp_1
								min_distance >= 1
								max_distance < 250
							}
						}
					}
					save_event_target_as = nep_inva_temp_2
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
				}
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
						NOR = {
							distance = {
								source = event_target:nep_inva_temp_1
								min_distance >= 1
								max_distance < 250
							}
							distance = {
								source = event_target:nep_inva_temp_2
								min_distance >= 1
								max_distance < 250
							}
						}
					}
					save_event_target_as = nep_inva_temp_3
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
				}		
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
						NOR = {
							distance = {
								source = event_target:nep_inva_temp_1
								min_distance >= 1
								max_distance < 250
							}
							distance = {
								source = event_target:nep_inva_temp_2
								min_distance >= 1
								max_distance < 250
							}					
							distance = {
								source = event_target:nep_inva_temp_3
								min_distance >= 1
								max_distance < 250
							}
						}
					}
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
				}
			}
			else = {
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
					}
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
					save_event_target_as = nep_inva_temp_1
				}
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
						NOT = {
							distance = {
								source = event_target:nep_inva_temp_1
								min_distance >= 1
								max_distance < 250
							}
						}
					}
					save_event_target_as = nep_inva_temp_2
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
				}
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
						NOR = {
							distance = {
								source = event_target:nep_inva_temp_1
								min_distance >= 1
								max_distance < 250
							}
							distance = {
								source = event_target:nep_inva_temp_2
								min_distance >= 1
								max_distance < 250
							}
						}
					}
					save_event_target_as = nep_inva_temp_3
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
				}		
				random_rim_system = {
					limit = {
						nep_st_is_not_outer_or_fe_system = yes
						NOR = {
							distance = {
								source = event_target:nep_inva_temp_1
								min_distance >= 1
								max_distance < 250
							}
							distance = {
								source = event_target:nep_inva_temp_2
								min_distance >= 1
								max_distance < 250
							}					
							distance = {
								source = event_target:nep_inva_temp_3
								min_distance >= 1
								max_distance < 250
							}
						}
					}
					spawn_system = {
						min_distance >= 10
						max_distance <= 20
						initializer = "nep_inva_system_init"
						hyperlane = no
					}
				}
			}
		}
		
		every_system = {
			limit = { has_star_flag = nep_inva_system }
			random_system_planet = {
				limit = { is_star = yes }
				save_global_event_target_as = nep_mega_temp_poi
				solar_system = {
					spawn_megastructure = {
						name = "NAME_nep_Seal_Gate"
						type = nep_sealgate_restored
						planet = event_target:nep_mega_temp_poi
						orbit_angle = 24
						orbit_distance = 169
					}
				}
				clear_global_event_target = nep_mega_temp_poi
			}
			every_system_megastructure = {
				limit = {
					is_megastructure_type = nep_sealgate_restored
				}
				activate_gateway = this
			}
			random_neighbor_system_euclidean = {
				limit = {
					AND = {
						exists = space_owner
						space_owner = {
							OR = {
								AND = {
									exists = event_target:nep_Krahen_victim_1
									is_same_value = event_target:nep_Krahen_victim_1
								}
								AND = {
									exists = event_target:nep_Krahen_victim_2
									is_same_value = event_target:nep_Krahen_victim_2
								}
								AND = {
									exists = event_target:nep_Krahen_victim_3
									is_same_value = event_target:nep_Krahen_victim_3
								}
								AND = {
									exists = event_target:nep_Krahen_victim_4
									is_same_value = event_target:nep_Krahen_victim_4
								}
							}
						}
					}
					NOT = {	has_hyperlane_to = prev }
					nep_st_is_not_outer_system = yes
				}
				add_hyperlane = { from = this to = prev }
			}
			while = {
				count = 2
				random_neighbor_system_euclidean = {
					limit = {
						NOT = { has_hyperlane_to = prev }
						nep_st_is_not_outer_system = yes
					}
					add_hyperlane = { from = this to = prev }
				}
			}
		}
		set_spawn_system_batch = end
		
		#create Krahen colony&invader force
		event_target:nep_Krahen_country = {
			create_ship_design = { 
				design = "NAME_Krahen_heavy_spacebase"
			}
			add_ship_design = last_created_design
			create_ship_design = { 
				design = "NAME_nep_Krahen_Colonizer"
			}
			add_ship_design = last_created_design
			create_ship_design = { 
				design = "NAME_nep_Krahen_Constructor"
			}
			add_ship_design = last_created_design
		}
		every_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
			}
			every_fleet_in_system = {
				limit = {
					is_ship_class = shipclass_starbase
				}
				destroy_fleet = this
			}
			every_system_planet = {
				limit = {
					is_colony = yes
					is_under_colonization = yes
				}
				destroy_colony = yes
			}
			create_starbase = {
				size = nep_heavy_spacebase
				owner = event_target:nep_Krahen_country
			}
			if = {
				limit = { NOT = { has_star_flag = nep_Exterior_system } }
				random_system_planet = {
					limit = {
						is_colony = no
						is_colonizable = yes
					}
					if = {
						limit = { planet_size < 12 }
						change_planet_size = 12
						reroll_planet = yes
					}
					create_colony = {
						owner = event_target:nep_Krahen_country
						species = event_target:nep_Krahen_country
						ethos = owner
					}
					create_Krahen_buildings = yes
					create_Krahen_invader = yes
					create_Krahen_invader = yes
				}
				random_system_planet = {
					limit = {
						is_colony = no
						is_colonizable = yes
					}
					if = {
						limit = { planet_size < 12 }
						change_planet_size = 12
						reroll_planet = yes
					}
					create_colony = {
						owner = event_target:nep_Krahen_country
						species = event_target:nep_Krahen_country
						ethos = owner
					}
					create_Krahen_buildings = yes
					create_Krahen_buildings = yes
					create_Krahen_invader = yes
				}
			}
		}
		
		#create Krahen portal*4&defender force*2
		random_system = {
			limit = { has_star_flag = nep_Central_system }
			set_star_flag = nep_Krahen_portal_system
			random_system_planet = {
				create_fleet = {
					name = "NAME_nep_Portal_to_Emperor-God"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_nep_Portal_to_Emperor-God"
							design = "NAME_nep_Krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_Krahen_portal_1
							}
						}
						set_location = {
							target = prev
							distance = 150
							angle = random
						}
						set_event_locked = yes
						set_fleet_flag = nep_Krahen_portal_1
					}
				}
				create_Krahen_defender = yes
				create_Krahen_defender = yes
				create_Krahen_constructor = yes
				create_Krahen_follower = yes
				create_Krahen_colonizer = yes
				create_Krahen_colonizer = yes
			}
		}
		random_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
				NOR = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system	
				}
			}
			set_star_flag = nep_Krahen_portal_system
			random_system_planet = {
				create_fleet = {
					name = "NAME_nep_Portal_to_Emperor-God"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_nep_Portal_to_Emperor-God"
							design = "NAME_nep_Krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_Krahen_portal_2
							}
						}
						set_location = {
							target = prev
							distance = 150
							angle = random
						}
						set_event_locked = yes
						set_fleet_flag = nep_Krahen_portal_2
					}
				}
				create_Krahen_defender = yes
				create_Krahen_defender = yes
				create_Krahen_constructor = yes
				create_Krahen_follower = yes
			}
		}
		random_system = {
			limit = {
				has_star_flag = nep_Krahen_cluster
				NOR = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system	
					has_star_flag = nep_Krahen_portal_system
				}
			}
			set_star_flag = nep_Krahen_portal_system
			random_system_planet = {
				create_fleet = {
					name = "NAME_nep_Portal_to_Emperor-God"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_nep_Portal_to_Emperor-God"
							design = "NAME_nep_Krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_Krahen_portal_3
							}
						}
						set_location = {
							target = prev
							distance = 150
							angle = random
						}
						set_event_locked = yes
						set_fleet_flag = nep_Krahen_portal_3
					}
				}
				create_Krahen_defender = yes
				create_Krahen_defender = yes
				create_Krahen_constructor = yes
				create_Krahen_follower = yes
			}
		}
		random_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
				NOR = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system	
					has_star_flag = nep_Krahen_portal_system
				}
			}
			set_star_flag = nep_Krahen_portal_system
			random_system_planet = {
				create_fleet = {
					name = "NAME_nep_Portal_to_Emperor-God"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_nep_Portal_to_Emperor-God"
							design = "NAME_nep_Krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_Krahen_portal_4
							}
						}
						set_location = {
							target = prev
							distance = 150
							angle = random
						}
						set_event_locked = yes
						set_fleet_flag = nep_Krahen_portal_4
					}
				}
				create_Krahen_defender = yes
				create_Krahen_defender = yes
				create_Krahen_constructor = yes
				create_Krahen_follower = yes
			}
		}
		
		#sealgate
		while = {
			count = 2
			random_system = {
				limit = {
					has_star_flag = nep_Krahen_cluster
					NOR = { 
						has_star_flag = nep_Central_system 
						has_star_flag = nep_Exterior_system
						any_system_megastructure = {
							OR = { 
								is_megastructure_type = nep_sealgate_ruined
								is_megastructure_type = nep_sealgate_restored
							}
						}
					}
				}
				random_system_planet = {
					limit = { is_star = yes }
					save_event_target_as = nep_mega_temp_poi
					solar_system = {
						spawn_megastructure = {
							name = "NAME_nep_Seal_Gate"
							type = nep_sealgate_restored
							planet = event_target:nep_mega_temp_poi
							orbit_angle = 128
							orbit_distance = 176
						}
					}
				}
				every_system_megastructure = {
					limit = {
						is_megastructure_type = nep_sealgate_restored
					}
					activate_gateway = this
				}
			}
		}
	}
	
	after = {
		every_owned_planet = {
			limit = {
				is_colony = yes
				has_ground_combat = no
			}
			while = {
				limit = {
					count_planet_army = {
						limit = { army_type = nep_Krahen_heavy_fortress }
						count < 8
					}
				}
				create_army = {
					name = "NAME_nep_Krahen_heavy_fortress"
					owner = event_target:nep_Krahen_country
					species = event_target:nep_Krahen_country
					type = nep_Krahen_heavy_fortress
				}
			}
			while = {
				limit = {
					count_planet_army = {
						limit = { army_type = nep_Krahen_heavy_fortress_2 }
						count < 8
					}
				}
				create_army = {
					name = "NAME_nep_Krahen_heavy_fortress"
					owner = event_target:nep_Krahen_country
					species = event_target:nep_Krahen_country
					type = nep_Krahen_heavy_fortress_2
				}
			}
			save_event_target_as = nep_inva_temp_planet
			create_fleet = {
				name = "NAME_nep_planetary_gun_invisible"
				settings = {
					spawn_debris = no 
				}
				effect = {
					set_owner = event_target:nep_Krahen_country	
					set_fleet_flag = nep_planetary_gun@event_target:nep_inva_temp_planet
					create_ship = {
						name = "NAME_nep_planetary_gun_invisible"
						design = "NAME_nep_planetary_gun_design"
					}
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
					set_fleet_stance = aggressive
					set_aggro_range = 250
					set_aggro_range_measure_from = self

					queue_actions = {	
						orbit_planet = prev
					}
				}
			}
		}
		#diplomatic
		every_country = {
			establish_communications_no_message = event_target:nep_Krahen_country
			event_target:nep_Krahen_country = {
				establish_communications_no_message = prev
			}
			if = {			
				limit = {
					OR = {
						is_country_type = default
						is_country_type = fallen_empire
						is_country_type = awakened_fallen_empire
					}
				}
				country_event = { id = nep_inva.31 }
			}
		}
		# every_country = {
			# limit = {
				# any_owned_planet = { is_colony = yes }
				# is_overlord = yes
				# is_federation_leader = yes
				# NOT = { is_at_war_with = event_target:nep_Krahen_country }
			# }
			# event_target:nep_Krahen_country	= {
				# declare_war = {
					# target = prev
					# name = "NAME_nep_Krahen_invasion_war"
					# attacker_war_goal = wg_nep_Krahen_invasion_war
				# }
			# }
		# }
		# every_playable_country = {
			# limit = {				
				# any_owned_planet = { is_colony = yes }
				# NOT = { is_at_war_with = event_target:nep_Krahen_country }
			# }
			# event_target:nep_Krahen_country	= {
				# declare_war = {
					# target = prev
					# name = "NAME_nep_Krahen_invasion_war"
					# attacker_war_goal = wg_nep_Krahen_invasion_war
				# }
			# }
		# }
	}
}

#Retreat from Krahen cluster
country_event = {
	id = nep_inva.22
	title = "nep_inva.22.name"
	desc = "nep_inva.22.desc"	
	picture = GFX_evt_unknown_ships
	
	is_triggered_only = yes
	
	immediate = {
		every_owned_fleet = {
			limit = {
				exists = solar_system
				solar_system = { has_star_flag = nep_Krahen_cluster }
			}
			clear_fleet_actions = this
			set_location = event_target:nep_grand_seal_planet
			set_event_locked = no
			order_forced_return = yes
			clear_fleet_actions = this
		}
		random_system = {
			limit = { has_star_flag = nep_seal_system }
			every_system_megastructure = {
				limit = { is_megastructure_type = nep_sealgate_restored }
				remove_megastructure = this
			}
			random_galaxy_planet = {
				limit = {
					has_planet_flag = nep_seal_2
				}
				save_event_target_as = nep_seal_2
			}
			spawn_megastructure = {
				name = "NAME_nep_Seal_Gate"
				type = nep_sealgate_ruined
				planet = event_target:nep_seal_2
				orbit_angle = 1
				orbit_distance = 1
			}#No activate_gateway
		}
	}
	
	option = {
		name = nep_inva.22.a
	}
}

#3X:diplomatics
#Krah'en crisis diplomatics - crisis begin
country_event = {
	id = nep_inva.31
	title = "nep_inva.31.name"
	desc = "nep_inva.31.desc"

	diplomatic = yes
	
	is_triggered_only = yes
		
	picture_event_data = {
		portrait = event_target:nep_Krahen_country
		planet_background = event_target:nep_Krahen_country
		graphical_culture = event_target:nep_Krahen_country
		city_level = event_target:nep_Krahen_country
		room = event_target:nep_Krahen_country
	}
	
	immediate = {
		random_system = {
			limit = {
				has_star_flag = nep_inva_system
			}
			save_event_target_as = nep_Krahen_doors_1
		}
		random_system = {
			limit = {
				has_star_flag = nep_inva_system
				NOT = { is_same_value = event_target:nep_Krahen_doors_1 }
			}
			save_event_target_as = nep_Krahen_doors_2
		}
		random_system = {
			limit = {
				has_star_flag = nep_inva_system
				NOT = { is_same_value = event_target:nep_Krahen_doors_1 }
				NOT = { is_same_value = event_target:nep_Krahen_doors_2 }
			}
			save_event_target_as = nep_Krahen_doors_3
		}				
		random_system = {
			limit = {
				has_star_flag = nep_inva_system
				NOT = { is_same_value = event_target:nep_Krahen_doors_1 }
				NOT = { is_same_value = event_target:nep_Krahen_doors_2 }
				NOT = { is_same_value = event_target:nep_Krahen_doors_3 }
			}
			save_event_target_as = nep_Krahen_doors_4
		}
		event_target:nep_Krahen_country = {
			random_owned_fleet = {
				limit = {
					has_fleet_flag = nep_Krahen_portal_1
				}
				save_event_target_as = nep_Krahen_portal_1
			}
			random_owned_fleet = {
				limit = {
					has_fleet_flag = nep_Krahen_portal_2
				}
				save_event_target_as = nep_Krahen_portal_2
			}		
			random_owned_fleet = {
				limit = {
					has_fleet_flag = nep_Krahen_portal_3
				}
				save_event_target_as = nep_Krahen_portal_3
			}		
			random_owned_fleet = {
				limit = {
					has_fleet_flag = nep_Krahen_portal_4
				}
				save_event_target_as = nep_Krahen_portal_4
			}
		}
	}
	
	option = {
		name = nep_inva.31.a
		response_text = nep_inva.31.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.31.b
		response_text = nep_inva.31.b.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.31.c
		default_hide_option = yes
		begin_event_chain = {
			event_chain = "nep_Krahen_invasion_chain"
			target = this
		}
		create_point_of_interest = {
			id = nep_Krahen_portals_poi.1
			name = nep_Krahen_portals_poi_title
			desc = nep_Krahen_portals_poi_desc
			event_chain = nep_Krahen_invasion_chain
			category = nep_Krahen_portals_cat
			location = event_target:nep_Krahen_portal_1
		}
		create_point_of_interest = {
			id = nep_Krahen_doors_poi.1
			name = nep_Krahen_doors_poi_title
			desc = nep_Krahen_doors_poi_desc
			event_chain = nep_Krahen_invasion_chain
			category = nep_Krahen_doors_cat
			location = event_target:nep_Krahen_doors_1
		}
		hidden_effect = {
			create_point_of_interest = {
				id = nep_Krahen_portals_poi.2
				name = nep_Krahen_portals_poi_title
				desc = nep_Krahen_portals_poi_desc
				event_chain = nep_Krahen_invasion_chain
				category = nep_Krahen_portals_cat
				location = event_target:nep_Krahen_portal_2
			}
			create_point_of_interest = {
				id = nep_Krahen_portals_poi.3
				name = nep_Krahen_portals_poi_title
				desc = nep_Krahen_portals_poi_desc
				event_chain = nep_Krahen_invasion_chain
				category = nep_Krahen_portals_cat
				location = event_target:nep_Krahen_portal_3
			}
			create_point_of_interest = {
				id = nep_Krahen_portals_poi.4
				name = nep_Krahen_portals_poi_title
				desc = nep_Krahen_portals_poi_desc
				event_chain = nep_Krahen_invasion_chain
				category = nep_Krahen_portals_cat
				location = event_target:nep_Krahen_portal_4
			}
			create_point_of_interest = {
				id = nep_Krahen_doors_poi.2
				name = nep_Krahen_doors_poi_title
				desc = nep_Krahen_doors_poi_desc
				event_chain = nep_Krahen_invasion_chain
				category = nep_Krahen_doors_cat
				location = event_target:nep_Krahen_doors_2
			}
			create_point_of_interest = {
				id = nep_Krahen_doors_poi.3
				name = nep_Krahen_doors_poi_title
				desc = nep_Krahen_doors_poi_desc
				event_chain = nep_Krahen_invasion_chain
				category = nep_Krahen_doors_cat
				location = event_target:nep_Krahen_doors_3
			}
			create_point_of_interest = {
				id = nep_Krahen_doors_poi.4
				name = nep_Krahen_doors_poi_title
				desc = nep_Krahen_doors_poi_desc
				event_chain = nep_Krahen_invasion_chain
				category = nep_Krahen_doors_cat
				location = event_target:nep_Krahen_doors_4
			}
			event_target:nep_Krahen_country = {
				every_owned_planet = {
					limit = { is_colony = yes }
					root = {
						add_event_chain_counter = {
							event_chain = "nep_Krahen_invasion_chain"
							counter = "occupied_worlds"
							amount = 1			
						}
					}
				}
			}
			add_event_chain_counter = {
				event_chain = "nep_Krahen_invasion_chain"
				counter = "Krahen_portals_num"
				amount = 4
			}
			if = {
				limit = {
					any_owned_ship = {
						exists = solar_system
						solar_system = { has_star_flag = nep_Krahen_cluster }
					}
				}
				country_event = { id = nep_inva.22 }
			}
		}
	}
}

#Krah'en diplomatics - before crisis
country_event = {
	id = nep_inva.32
	title = "nep_inva.32.name"
	desc = "nep_inva.32.desc"
		
	diplomatic = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_country_flag = nep_Krahen_country
			NOT = { has_global_flag = nep_Krahen_crisis }
		}
	}
	
	picture_event_data = {
		room = no_video_feed_room
	}
	
	option = {
		name = nep_inva.32.a
		response_text = nep_inva.32.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.32.b
		response_text = nep_inva.32.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.32.c
	}
}

#Krah'en diplomatics - after crisis
country_event = {
	id = nep_inva.33
	title = "nep_inva.33.name"
	desc = "nep_inva.33.desc"
		
	diplomatic = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_country_flag = nep_Krahen_country
			has_global_flag = nep_Krahen_crisis
		}
	}
	
	picture_event_data = {
		portrait = event_target:nep_Krahen_country
		planet_background = event_target:nep_Krahen_country
		graphical_culture = event_target:nep_Krahen_country
		city_level = event_target:nep_Krahen_country
		room = event_target:nep_Krahen_country
	}
	
	option = {
		name = nep_inva.33.a
		response_text = nep_inva.33.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.33.b
	}
}


#4X:Krahen actions
#Krahen get a colony,on_planet_attackers_win this = Krahen
country_event = {
	id = nep_inva.41
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_country_flag = nep_Krahen_country
	}
	
	immediate = {
		FromFrom = {
			set_owner = event_target:nep_Krahen_country
			every_owned_pop = {
				limit = { NOT = { is_same_species = event_target:nep_Krahen_country } }
				random_list = {
					98 = { kill_pop = yes }
					2 = { pop_event = { id = nep_refugees.4 } }
				}
			}
			create_Krahen_buildings = yes
			every_country = {
				limit = { has_event_chain = "nep_Krahen_invasion_chain" }
				add_event_chain_counter = {
					event_chain = "nep_Krahen_invasion_chain"
					counter = "occupied_worlds"
					amount = 1
				}
			}
		}
	}
}

#Krahen lost a colony,on_planet_attackers_win this = NOT = Krahen
country_event = {
	id = nep_inva.42
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		NOT = { has_country_flag = nep_Krahen_country }
		FROM = { has_country_flag = nep_Krahen_country }
	}
	
	immediate = {
		fromfrom = {
			every_owned_pop = {
				limit = { is_same_species = event_target:nep_Krahen_country } 
				kill_pop = yes
			}
			set_owner = root
			remove_building = nep_adv_tank_factory
			remove_building = nep_heavy_fortress
			remove_building = nep_heavy_fortress_2
			remove_building = nep_planetary_gun
			add_deposit = "d_bomb_crater"
			add_deposit = "d_bomb_crater"
			add_deposit = "d_bomb_crater"
			add_deposit = "d_bomb_crater"
			every_country = {
				limit = { has_event_chain = "nep_Krahen_invasion_chain" }
				add_event_chain_counter = {
					event_chain = "nep_Krahen_invasion_chain"
					counter = "occupied_worlds"
					amount = -1
				}
				add_event_chain_counter = {
					event_chain = "nep_Krahen_invasion_chain"
					counter = "liberated_worlds"
					amount = 1
				}
			}
		}
		if = {
			limit = {
				NOT = { has_country_flag = nep_krahan_kill_themselves_met }
			}
			FromFrom = { planet_event = { id = nep_inva.421 } }
		}
	}
}

planet_event = {
	id = nep_inva.421
	hide_window = yes

	is_triggered_only = yes
	
	immediate = {
		From = {
			set_country_flag = nep_krahan_kill_themselves_met
			country_event = { id = nep_inva.420 }
		}
	}
}

country_event = {
	id = nep_inva.420	
	title = "nep_inva.420.name"
	desc = "nep_inva.420.desc"	
	picture = GFX_evt_burning_settlement
	
	is_triggered_only = yes
	
	immediate = {
		log = "inva.420 fired"
		print_scope_effect = yes
	}
	
	option = {
		name = nep_inva.420.a
	}
	
	option = {
		name = nep_inva.420.b
	}
}

# Krahen Kill Count (HIDDEN)
country_event = {
	id = nep_inva.43
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = nep_Krahen_country
		exists = from
	}
	
	immediate = {
		if = {
			limit = {
				FROM = { has_event_chain = "nep_Krahen_invasion_chain" }
			}
			FROM = {
				add_event_chain_counter = { 
					event_chain = "nep_Krahen_invasion_chain" 
					counter = "Krahen_overrun_us" 
					amount = 1 
				}
			}
		}
		every_country = {
			limit = { 
				has_event_chain = "nep_Krahen_invasion_chain" 
				NOT = { is_same_value = FROM }
			}
			add_event_chain_counter = { 
				event_chain = "nep_Krahen_invasion_chain" 
				counter = "Krahen_overrun_others" 
				amount = 1 
			}
		}
	}
}

# Krahen Victims (HIDDEN)
country_event = {
	id = nep_inva.44
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = nep_Krahen_country
	}
	
	immediate = {
		from = { set_country_flag = nep_Krahen_victim }
		every_country = {
			limit = { has_event_chain = "nep_Krahen_invasion_chain" }
			add_event_chain_counter = { 
				event_chain = "nep_Krahen_invasion_chain" 
				counter = "Krahen_overruns" 
				amount = 1 
			}
		}
	}
}


#Krahen get a colony,on_colonized
planet_event = {
	id = nep_inva.45
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		owner = { has_country_flag = nep_Krahen_country }
	}
	
	immediate = {
		create_Krahen_buildings = yes
		every_country = {
			limit = { has_event_chain = "nep_Krahen_invasion_chain" }
			add_event_chain_counter = {
				event_chain = "nep_Krahen_invasion_chain"
				counter = "occupied_worlds"
				amount = 1
			}
		}
	}
}

#Krahen force spawn,on_yearly_pulse
event = {
	id = nep_inva.46
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
	}
	
	immediate = {
		event_target:nep_Krahen_country = { change_variable = { which = "Krahen_years_comes" value = 1 } }
		if = {
			limit = {
				event_target:nep_Krahen_country = {
					check_variable = {
						which = "Krahen_years_comes" 
						value > 5
					}
				}
			}			
			remove_global_flag = nep_Krahen_stage_1
			set_global_flag = nep_Krahen_stage_2
		}
		if = {
			limit = {
				event_target:nep_Krahen_country = {
					check_variable = { 
						which = "Krahen_years_comes" 
						value > 10
					}
				}
			}
			remove_global_flag = nep_Krahen_stage_2
			set_global_flag = nep_Krahen_stage_3
		}
		if = {
			limit = {
				event_target:nep_Krahen_country = {
					check_variable = { 
						which = "Krahen_years_comes" 
						value > 15
					}
				}
			}
			remove_global_flag = nep_Krahen_stage_3
			set_global_flag = nep_Krahen_stage_4
		}
		switch = {
			trigger = has_global_flag
			nep_Krahen_stage_1 = {
				if = {
					limit = {
						count_galaxy_fleet = {
							count < 15
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								is_ship_size = nep_Krahen_battleship
							}
						}
					}
					while = {
						count = 4
						random_system = {
							limit = {
								has_star_flag = nep_Krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_Krahen_portal_1
										has_fleet_flag = nep_Krahen_portal_2
										has_fleet_flag = nep_Krahen_portal_3
										has_fleet_flag = nep_Krahen_portal_4
									}
								}
								create_Krahen_invader = yes
							}
						}
					}
				}
			}
			nep_Krahen_stage_2 = {
				if = {
					limit = {
						count_galaxy_fleet = {
							count < 20
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								is_ship_size = nep_Krahen_battleship
							}
						}
					}
					while = {
						count = 5
						random_system = {
							limit = {
								has_star_flag = nep_Krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_Krahen_portal_1
										has_fleet_flag = nep_Krahen_portal_2
										has_fleet_flag = nep_Krahen_portal_3
										has_fleet_flag = nep_Krahen_portal_4
									}
								}
								create_Krahen_invader = yes
							}
						}
					}
				}
			}
			nep_Krahen_stage_3 = {
				if = {
					limit = {
						count_galaxy_fleet = {
							count < 27
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								is_ship_size = nep_Krahen_battleship
							}
						}
					}
					while = {
						count = 6
						random_system = {
							limit = {
								has_star_flag = nep_Krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_Krahen_portal_1
										has_fleet_flag = nep_Krahen_portal_2
										has_fleet_flag = nep_Krahen_portal_3
										has_fleet_flag = nep_Krahen_portal_4
									}
								}
								create_Krahen_invader = yes
							}
						}
					}
				}
			}
			nep_Krahen_stage_4 = {
				if = {
					limit = {
						count_galaxy_fleet = {
							count < 40
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								is_ship_size = nep_Krahen_battleship
							}
						}
					}
					while = {
						count = 7
						random_system = {
							limit = {
								has_star_flag = nep_Krahen_portal_system
								NOT = {
									any_ship_in_system = {
										is_in_combat = yes
									}
								}
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_Krahen_portal_1
										has_fleet_flag = nep_Krahen_portal_2
										has_fleet_flag = nep_Krahen_portal_3
										has_fleet_flag = nep_Krahen_portal_4
									}
								}
								create_Krahen_invader = yes
							}
						}
					}
				}
			}
		}
		every_system = {
			limit = {
				has_star_flag = nep_Krahen_portal_system
			}
			if = {
				limit = {
					count_ship_in_system = {
						limit = { is_ship_size = nep_Krahen_battleship }
						count < 60
					}
				}
				random_fleet_in_system = {
					limit = {
						OR = {
							has_fleet_flag = nep_Krahen_portal_2
							has_fleet_flag = nep_Krahen_portal_3
							has_fleet_flag = nep_Krahen_portal_4
						}
					}
					if = { 
						limit = { exists = this } 
						create_Krahen_defender = yes
					}
				}
			}
			if = {
				limit = {
					count_ship_in_system = {
						limit = { is_ship_size = nep_Krahen_battleship }
						count < 90
					}
				}
				random_fleet_in_system = {
					limit = {
						has_fleet_flag = nep_Krahen_portal_1
					}
					if = { 
						limit = { exists = this } 
						create_Krahen_defender = yes
					}
				}
			}
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_Krahen_portal_1
						has_fleet_flag = nep_Krahen_portal_2
						has_fleet_flag = nep_Krahen_portal_3
						has_fleet_flag = nep_Krahen_portal_4
					}
				}
				create_Krahen_constructor = yes
				if = {
					limit = {
						owner = {
							count_owned_fleet = {
								limit = { has_fleet_order = follow_order }
								count < 9
							}
						}
					}
					create_Krahen_follower = yes
				}
			}
		}
		
		every_system = {
			limit = {
				has_star_flag = nep_inva_system
				exists = starbase
				starbase = { owner = { has_country_flag = nep_Krahen_country } }
				NOT = {
					any_fleet_in_system = { has_fleet_flag = nep_Krahen_defender }
				}
			}
			starbase = { create_Krahen_defender_gate = yes }
		}
		
		event_target:nep_Krahen_country = {
			every_owned_planet = {
				limit = {
					is_colony = yes
					has_ground_combat = no
					OR = {
						has_building = "nep_heavy_fortress"
						has_building = "nep_heavy_fortress_2"
					}
				}
				if = {
					limit = {
						has_building = "nep_heavy_fortress"
						count_planet_army = {
							limit = { army_type = nep_Krahen_heavy_fortress }
							count < 8
						}
					}
					while = {
						limit = {
							count_planet_army = {
								limit = { army_type = nep_Krahen_heavy_fortress }
								count < 8
							}
						}
						create_army = {
							name = "NAME_nep_Krahen_heavy_fortress"
							owner = event_target:nep_Krahen_country
							species = event_target:nep_Krahen_country
							type = nep_Krahen_heavy_fortress
						}
					}
				}
				if = {
					limit = {
						has_building = "nep_heavy_fortress_2"
						count_planet_army = {
							limit = { army_type = nep_Krahen_heavy_fortress_2 }
							count < 8
						}
					}
					while = {
						limit = {
							count_planet_army = {
								limit = { army_type = nep_Krahen_heavy_fortress_2 }
								count < 8
							}
						}
						create_army = {
							name = "NAME_nep_Krahen_heavy_fortress"
							owner = event_target:nep_Krahen_country
							species = event_target:nep_Krahen_country
							type = nep_Krahen_heavy_fortress_2
						}
					}
				}
			}
			every_owned_planet = {
				limit = {
					is_colony = yes
					has_ground_combat = no
					has_building = "nep_planetary_gun"
				}
				planet_event = { id = nep_inva.4600 }
			}
		}
		# while = {
			# count = 3
			# random_galaxy_planet = {
				# limit = {
					# is_colony = yes
					# exists = owner
					# owner = { has_country_flag = nep_Krahen_country }
					# has_ground_combat = no
					# solar_system = {
						# NOT = {
							# any_ship_in_system = {
								# exists = owner
								# owner = { NOT = { has_country_flag = nep_Krahen_country } }
							# }
						# }
					# }
				# }
				# create_Krahen_constructor = yes
			# }
		# }
		while = {
			count = 2
			random_galaxy_planet = {
				limit = {
					is_colony = yes
					exists = owner
					owner = { has_country_flag = nep_Krahen_country }
					has_ground_combat = no
					solar_system = {
						NOT = {
							any_ship_in_system = {
								exists = owner
								owner = { NOT = { has_country_flag = nep_Krahen_country } }
							}
						}
					}
				}
				create_Krahen_colonizer = yes
			}
		}
		# while = {
			# count = 5
			# random_planet = {
				# limit = {
					# is_colony = yes
					# exists = owner
					# owner = { has_country_flag = nep_Krahen_country }
					# has_ground_combat = no
					# solar_system = {
						# NOT = {
							# any_ship_in_system = {
								# exists = owner
								# owner = { NOT = { has_country_flag = nep_Krahen_country } }
							# }
						# }
					# }
					# has_building = nep_adv_tank_factory
				# }
				# create_Krahen_transport = yes
			# }
		# }
	}
}

planet_event = {
	id = nep_inva.4600
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				NOT = { solar_system = { any_fleet_in_system  = { has_fleet_flag = nep_planetary_gun@root } } }
			}				
			create_fleet = {
				name = "NAME_nep_planetary_gun_invisible"
				settings = {
					spawn_debris = no 
				}
				effect = {
					set_owner = event_target:nep_Krahen_country
					set_fleet_flag = nep_planetary_gun@root
					create_ship = {
						name = "NAME_nep_planetary_gun_invisible"
						design = "NAME_nep_planetary_gun_design"
					}
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
					#set_fleet_stance = aggressive
					set_aggro_range = 250
					set_aggro_range_measure_from = self

					queue_actions = {	
						orbit_planet = prev
					}
				}
			}
		}
	}
}
#unlock portal,on_space_battle_won
country_event = {
	id = nep_inva.47
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		has_global_flag = nep_Krahen_crisis
		from = { has_country_flag = nep_Krahen_country }
		fromfrom = {
			solar_system = {
				has_star_flag = nep_Krahen_portal_system
				NOR = { 
					has_star_flag = nep_Krahen_portal_system_unlocked
					any_system_planet = {
						exists = owner
						owner = { has_country_flag = nep_Krahen_country }
						is_colony = yes
					}
				}
			}
		}
	}
	
	immediate = {
	
	}
	
	after = {
		fromfrom = { fleet_event = { id = nep_inva.470 } }
	}
}

fleet_event = {
	id = nep_inva.470
	hide_window = yes

	is_triggered_only = yes
	
	trigger = {
		solar_system = {
			NOT = {
				any_ship_in_system = {
					is_ship_size = nep_Krahen_battleship
				}
			}
		}
	}
	
	immediate = {
		solar_system = {
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_Krahen_portal_1
						has_fleet_flag = nep_Krahen_portal_2
						has_fleet_flag = nep_Krahen_portal_3
						has_fleet_flag = nep_Krahen_portal_4
					}
				}
				set_event_locked = no
			}
			set_star_flag = nep_Krahen_portal_system_unlocked
		}
	}
}

#unlock portal,on_planet_attackers_win
country_event = {
	id = nep_inva.471
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		has_global_flag = nep_Krahen_crisis
		from = { has_country_flag = nep_Krahen_country }
		fromfrom = {
			solar_system = {
				has_star_flag = nep_Krahen_portal_system
				NOR = { 
					has_star_flag = nep_Krahen_portal_system_unlocked
					any_ship_in_system = {
						is_ship_size = nep_Krahen_battleship
					}
					any_system_planet = {
						NOT = { is_same_value = root.fromfrom }
						exists = owner
						owner = { has_country_flag = nep_Krahen_country }
						is_colony = yes
					}
				}
			}
		}
	}

	immediate = {
		fromfrom = {
			solar_system = {
				random_fleet_in_system = {
					limit = {
						OR = {
							has_fleet_flag = nep_Krahen_portal_1
							has_fleet_flag = nep_Krahen_portal_2
							has_fleet_flag = nep_Krahen_portal_3
							has_fleet_flag = nep_Krahen_portal_4
						}
					}
					set_event_locked = no
				}
				set_star_flag = nep_Krahen_portal_system_unlocked
			}
		}
	}
}

#unlock portal,on_planet_zero_pops
planet_event = {
	id = nep_inva.472
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		has_global_flag = nep_Krahen_crisis
		solar_system = {
			has_star_flag = nep_Krahen_portal_system
			NOR = { 
				has_star_flag = nep_Krahen_portal_system_unlocked
				any_ship_in_system = {
					is_ship_size = nep_Krahen_battleship
				}
				any_system_planet = {
					NOT = { is_same_value = root }
					exists = owner
					owner = { has_country_flag = nep_Krahen_country }
					is_colony = yes
				}
			}
		}
	}

	immediate = {
		solar_system = {
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_Krahen_portal_1
						has_fleet_flag = nep_Krahen_portal_2
						has_fleet_flag = nep_Krahen_portal_3
						has_fleet_flag = nep_Krahen_portal_4
					}
				}
				set_event_locked = no
			}
			set_star_flag = nep_Krahen_portal_system_unlocked
		}
	}
}

#unlock portal,on_monthly_pulse
event = {
	id = nep_inva.473
	hide_window = yes

	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
	}
	
	immediate = {
		every_system = {
			limit = {
				has_star_flag = nep_Krahen_portal_system
				NOR = {
					has_star_flag = nep_Krahen_portal_system_unlocked
					any_ship_in_system = {
						is_ship_size = nep_Krahen_battleship
					}
					any_system_planet = {
						exists = owner
						owner = { has_country_flag = nep_Krahen_country }
						is_colony = yes
					}
				}
			}
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_Krahen_portal_1
						has_fleet_flag = nep_Krahen_portal_2
						has_fleet_flag = nep_Krahen_portal_3
						has_fleet_flag = nep_Krahen_portal_4
					}
				}
				set_event_locked = no
			}
			set_star_flag = nep_Krahen_portal_system_unlocked
		}
	}
}

#lock portal,on_entering_system
ship_event = {
	id = nep_inva.474
	hide_window = yes

	is_triggered_only = yes
	
	trigger = {
		is_ship_class = shipclass_military
		FromFrom = { has_country_flag = nep_Krahen_country }
		From = { 
			has_star_flag = nep_Krahen_portal_system
			has_star_flag = nep_Krahen_portal_system_unlocked
		}
	}
	
	immediate = {
		From = {
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_Krahen_portal_1
						has_fleet_flag = nep_Krahen_portal_2
						has_fleet_flag = nep_Krahen_portal_3
						has_fleet_flag = nep_Krahen_portal_4
					}
				}
				set_event_locked = yes
			}
			remove_star_flag = nep_Krahen_portal_system_unlocked
		}
	}
}

#lock portal,on_monthly_pulse
event = {
	id = nep_inva.475
	hide_window = yes

	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
	}
	
	immediate = {
		every_system = {
			limit = {
				has_star_flag = nep_Krahen_portal_system
				has_star_flag = nep_Krahen_portal_system_unlocked
				any_ship_in_system = {
					is_ship_size = nep_Krahen_battleship
					is_in_combat = no
				}
				any_system_planet = {
					exists = owner
					owner = { has_country_flag = nep_Krahen_country }
					is_colony = yes
				}
			}
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_Krahen_portal_1
						has_fleet_flag = nep_Krahen_portal_2
						has_fleet_flag = nep_Krahen_portal_3
						has_fleet_flag = nep_Krahen_portal_4
					}
				}
				set_event_locked = yes
			}
			remove_star_flag = nep_Krahen_portal_system_unlocked
		}
	}
}

#5X:crisis ends
#portal destoryed,on_ship_destroyed_victim
country_event = {
	id = nep_inva.51
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = nep_Krahen_country
		FromFrom = {
			OR = {
				has_ship_flag = nep_Krahen_portal_1
				has_ship_flag = nep_Krahen_portal_2
				has_ship_flag = nep_Krahen_portal_3
				has_ship_flag = nep_Krahen_portal_4			
			}
		}
	}
	
	immediate = {
		FromFrom = {
			switch = {
				trigger = has_ship_flag
				nep_Krahen_portal_1 = {
					set_global_flag = nep_Krahen_portal_1_destroyed
					every_country = {
						limit = { has_event_chain = "nep_Krahen_invasion_chain" }
						remove_point_of_interest = nep_Krahen_portals_poi.1
					}
				}
				nep_Krahen_portal_2 = {
					set_global_flag = nep_Krahen_portal_2_destroyed
					every_country = {
						limit = { has_event_chain = "nep_Krahen_invasion_chain" }
						remove_point_of_interest = nep_Krahen_portals_poi.2
					}
				}
				nep_Krahen_portal_3 = {
					set_global_flag = nep_Krahen_portal_3_destroyed
					every_country = {
						limit = { has_event_chain = "nep_Krahen_invasion_chain" }
						remove_point_of_interest = nep_Krahen_portals_poi.3
					}
				}
				nep_Krahen_portal_4 = {
					set_global_flag = nep_Krahen_portal_4_destroyed					
					every_country = {
						limit = { has_event_chain = "nep_Krahen_invasion_chain" }
						remove_point_of_interest = nep_Krahen_portals_poi.4
					}
				}
			}
		}
		every_country = {
			limit = { has_event_chain = "nep_Krahen_invasion_chain" }
			add_event_chain_counter = {
				event_chain = "nep_Krahen_invasion_chain"
				counter = "Krahen_portals_num"
				amount = -1
			}
		}
		if = {
			limit = {
				has_global_flag = nep_Krahen_portal_1_destroyed
				has_global_flag = nep_Krahen_portal_2_destroyed
				has_global_flag = nep_Krahen_portal_3_destroyed
				has_global_flag = nep_Krahen_portal_4_destroyed
			}
			country_event = { id = nep_inva.52 }
		}
	}
}

#check all portal destoryed to prevent bugs,on_yearly_pulse
event = {
	id = nep_inva.511
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		NOT = {
			any_system = {
				has_star_flag = nep_Krahen_portal_system
				any_ship_in_system = {
					OR = {
						has_ship_flag = nep_Krahen_portal_1
						has_ship_flag = nep_Krahen_portal_2
						has_ship_flag = nep_Krahen_portal_3
						has_ship_flag = nep_Krahen_portal_4
					}
				}
			}
		}
	}
	
	immediate = {
		event_target:nep_Krahen_country = {
			country_event = { id = nep_inva.52 }
		}
	}
}

#all portal destoryed
country_event = {
	id = nep_inva.52
	hide_window = yes
	
	is_triggered_only = yes
	
	fire_only_once = yes
	
	immediate = {
		every_owned_fleet = {
			destroy_fleet = this
		}
		every_owned_planet = {
			every_owned_pop = {
				kill_pop = yes
			}
			remove_building = nep_adv_tank_factory
			remove_building = nep_heavy_fortress
			remove_building = nep_heavy_fortress_2
			remove_building = nep_planetary_gun
			add_deposit = "d_bomb_crater"
			add_deposit = "d_bomb_crater"
			add_deposit = "d_bomb_crater"
			add_deposit = "d_bomb_crater"
			destroy_colony = yes
		}
		destroy_country = yes
		remove_global_flag = nep_Krahen_begin
		remove_global_flag = nep_Krahen_crisis
		remove_global_flag = nep_Krahen_portal_1_destroyed
		remove_global_flag = nep_Krahen_portal_2_destroyed
		remove_global_flag = nep_Krahen_portal_3_destroyed
		remove_global_flag = nep_Krahen_portal_4_destroyed
		set_global_flag = nep_Krahen_end
		every_system = {
			limit = {
				has_star_flag = nep_Krahen_portal_system
			}
			remove_star_flag = nep_Krahen_portal_system
		}
		every_system = {
			limit = {
				has_star_flag = nep_Krahen_portal_system_unlocked
			}
			remove_star_flag = nep_Krahen_portal_system_unlocked
		}
		random_system = {
			limit = { has_star_flag = nep_seal_system }
			every_system_megastructure = {
				limit = { is_megastructure_type = nep_sealgate_restored }
				activate_gateway = this
			}
		}
		every_playable_country = {
			country_event = { id = nep_inva.53 }
		}
	}
}

#Krahen Empire has been defeated.
country_event = {
	id = nep_inva.53
	title = nep_inva.53.name
	desc = nep_inva.53.desc
	picture = GFX_evt_federation_fleet
	show_sound = event_celebration
	
	is_triggered_only = yes
	
	immediate = {
		remove_country_flag = nep_Krahen_country
	}
	
	option = {
		name = nep_inva.53.a
		add_monthly_resource_mult = {
			resource = unity
			value = 100
			max = 25000
		}
		end_event_chain = nep_Krahen_invasion_chain
	}
}

country_event = {
	id = nep_inva.54
	title = nep_inva.54.name
	desc = nep_inva.54.desc
	picture = GFX_evt_physics_research
	
	fire_only_once = yes
	
	trigger = {
		has_global_flag = nep_Krahen_end
		has_country_flag = nep_dragon_summoner
	}
	
	mean_time_to_happen = {
		days = 360
	}
	
	immediate = {
	
	}
	
	option = {
		name = nep_inva.54.a
		add_monthly_resource_mult = {
			resource = minerals
			value = 2
		}
		add_monthly_resource_mult = {
			resource = energy
			value = 2
		}
		enable_special_project = {
			name = "nep_Krahen_explore"
			location = capital_scope
			owner = root
		}
	}
}

country_event = {
	id = nep_inva.6
	title = nep_inva.6.name
	desc = nep_inva.6.desc
	picture = GFX_evt_hangar_bay
	
	is_triggered_only = yes
	
	immediate = {
		set_country_flag = nep_Krahen_orb_get
	}
	
	option = {
		name = nep_inva.6.a
		custom_tooltip = nep_inva.6.a.tooltip
		add_monthly_resource_mult = {
			resource = physics_research
			value = @tier3researchreward
		}
		add_monthly_resource_mult = {
			resource = society_research
			value = @tier3researchreward
		}
		add_monthly_resource_mult = {
			resource = engineering_research
			value = @tier3researchreward
		}
		add_research_option = tech_nep_destructor_ray
		add_tech_progress = {
			tech = tech_nep_destructor_ray
			progress = 0.30
		}
		remove_relic = r_nep_orb_x1
		add_relic = r_nep_orb_x2
		set_country_flag = nep_orb_2_can_active
	}
}

##7X:keep in war
country_event = {
	id = nep_inva.71
	title = "nep_inva.71.name"
	desc = "nep_inva.71.desc"

	diplomatic = yes
	
	is_triggered_only = yes

	picture_event_data = {
		portrait = event_target:nep_Krahen_country
		planet_background = event_target:nep_Krahen_country
		graphical_culture = event_target:nep_Krahen_country
		city_level = event_target:nep_Krahen_country
		room = event_target:nep_Krahen_country
	}
	
	option = {
		name = nep_inva.71.a
		event_target:nep_Krahen_country	= {
			leader = { kill_leader = { show_notification = no } }
			create_leader = {
				class = governor
				species = owner_main_species
				name = "NAME_nep_Imperator"
				randomize_traits = yes
				skill = 10
			}
			set_leader = last_created_leader
			declare_war = {
				target = prev
				name = "NAME_nep_Krahen_invasion_war"
				attacker_war_goal = wg_nep_Krahen_invasion_war
			}
		}
	}
}

#on_first_contact
country_event = {
	id = nep_inva.72
	title = "nep_inva.72.name"
	desc = "nep_inva.72.desc"

	diplomatic = yes
	
	is_triggered_only = yes
	
	trigger = {
		is_country_type = default
		exists = capital_scope
		FROM = {
			has_country_flag = nep_Krahen_country
		}
		NOT = { has_country_flag = has_communications@from }
	}
	
	picture_event_data = {
		portrait = event_target:nep_Krahen_country
		planet_background = event_target:nep_Krahen_country
		graphical_culture = event_target:nep_Krahen_country
		city_level = event_target:nep_Krahen_country
		room = event_target:nep_Krahen_country
	}
	
	option = {
		name = nep_inva.72.a
		# event_target:nep_Krahen_country	= {
			# declare_war = {
				# target = prev
				# name = "NAME_nep_Krahen_invasion_war"
				# attacker_war_goal = wg_nep_Krahen_invasion_war
			# }
		# }
	}
}