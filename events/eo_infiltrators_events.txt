namespace = eo_infiltrators

@InfiltrateTimer = 1460

#First stage
espionage_operation_event = {
	id = eo_infiltrators.1
	title = eo_infiltrators.1.name
	desc = eo_infiltrators.1.desc
	espionage_operation = yes
	picture = GFX_evt_decryption
    location = target.capital_scope
	show_sound = event_default
	is_triggered_only = yes

	immediate = {
		infiltration_choose_target_types = yes
		set_espionage_operation_progress_locked = yes
	}

	option = {
		name = eo_infiltrators.1.option
        hidden_effect = {
            owner = {
                country_event = { id = eo_infiltrators.2 }
            }
        }
	}
}

#First stage (follow-up)
country_event = {
	id = eo_infiltrators.2
	title = eo_infiltrators.2.name
	desc = eo_infiltrators.2.desc
	picture = GFX_evt_intelligence_report
    location = from.target.capital_scope
	show_sound = event_default
	is_triggered_only = yes

	# Government
	option = { # Official
		name = eo_infiltrators.2.a.asset_infilitrator_official
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_official.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_official
			}
		}
		from = {
			clear_non_government_asset_flags = yes
		}
	}
	option = { # Noble
		name = eo_infiltrators.2.a.asset_infilitrator_noble
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_noble.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_noble
			}
		}
		from = {
			clear_non_government_asset_flags = yes
		}
	}
	option = { # Officer
		name = eo_infiltrators.2.a.asset_infilitrator_officer 
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_officer.tt 
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_officer
			}
		}
		from = {
			clear_non_government_asset_flags = yes
		}
	}
	option = { # Politician
		name = eo_infiltrators.2.a.asset_infilitrator_politican 
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_politican.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_politican
			}
		}
		from = {
			clear_non_government_asset_flags = yes
		}
	}

	# Diplomacy
	option = { # Diplomat
		name = eo_infiltrators.2.a.asset_infilitrator_diplomat
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_diplomat.tt 
		trigger = {
			from = {
				OR = {
					has_espionage_operation_flag = asset_infilitrator_diplomat
					has_espionage_operation_flag = asset_infilitrator_diplomat_backchannel
				}
			}
		}
		from = {
			clear_non_diplomacy_asset_flags = yes
		}
	}
	option = { # Spy
		name = eo_infiltrators.2.a.asset_infilitrator_spy
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_spy.tt 
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_spy
			}
		}
		from = {
			clear_non_diplomacy_asset_flags = yes
		}
	}
	option = { # Journalist
		name = eo_infiltrators.2.a.asset_infilitrator_journalist
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_journalist.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_journalist
			}
		}
		from = {
			clear_non_diplomacy_asset_flags = yes
		}
	}

	# Economy
	option = { # CEO
		name = eo_infiltrators.2.a.asset_infilitrator_ceo
		custom_tooltip =eo_infiltrators.2.a.asset_infilitrator_ceo.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_ceo
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Manager
		name = eo_infiltrators.2.a.asset_infilitrator_manager
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_manager.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_manager
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Executive
		name = eo_infiltrators.2.a.asset_infilitrator_executive
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_executive.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_executive
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Labor Organizer
		name = eo_infiltrators.2.a.asset_infilitrator_labor_organizer
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_labor_organizer.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_labor_organizer
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Resource Coordinator
		name = eo_infiltrators.2.a.asset_infilitrator_resource_coordinator
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_resource_coordinator.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_resource_coordinator
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Economist
		name = eo_infiltrators.2.a.asset_infilitrator_economist
		custom_tooltip eo_infiltrators.2.a.asset_infilitrator_economist.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_economist
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Banker
		name = eo_infiltrators.2.a.asset_infilitrator_banker
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_banker.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_banker
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Regulator
		name = eo_infiltrators.2.a.asset_infilitrator_regulator
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_regulator.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_regulator
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}
	option = { # Lobbyist
		name = eo_infiltrators.2.a.asset_infilitrator_lobbyist
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_lobbyist.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_lobbyist
			}
		}
		from = {
			clear_non_economy_asset_flags = yes
		}
	}

	# Technology
	option = { # Scientist
		name = eo_infiltrators.2.a.asset_infilitrator_scientist
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_scientist.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_scientist
			}
		}
		from = {
			clear_non_technology_asset_flags = yes
		}
	}
	option = { # Academic
		name = eo_infiltrators.2.a.asset_infilitrator_academic
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_academic.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_academic
			}
		}
		from = {
			clear_non_technology_asset_flags = yes
		}
	}

	# Military
	option = { # Fleet commander
		name = eo_infiltrators.2.a.asset_infilitrator_fleet_commander
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_fleet_commander.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_fleet_commander
			}
		}
		from = {
			clear_non_military_asset_flags = yes
		}
	}
	option = { # Army commander
		name = eo_infiltrators.2.a.asset_infilitrator_army_commander
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_army_commander.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_army_commander
			}
		}
		from = {
			clear_non_military_asset_flags = yes
		}
	}
	option = { # Military advisor
		name = eo_infiltrators.2.a.asset_infilitrator_military_advisor
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_military_advisor.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_military_advisor
			}
		}
		from = {
			clear_non_military_asset_flags = yes
		}
	}
	option = { # Security contractor
		name = eo_infiltrators.2.a.asset_infilitrator_security_contractor
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_security_contractor.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_security_contractor
			}
		}
		from = {
			clear_non_military_asset_flags = yes
		}
	}
	option = { # Civilian official
		name = eo_infiltrators.2.a.asset_infilitrator_civilian_official
		custom_tooltip = eo_infiltrators.2.a.asset_infilitrator_civilian_official.tt
		trigger = {
			from = {
				has_espionage_operation_flag = asset_infilitrator_civilian_official
			}
		}
		from = {
			clear_non_military_asset_flags = yes
		}
	}

    after = {
		from = {
			set_espionage_operation_progress_locked = no
		}
    }
}

#Second stage
espionage_operation_event = {
	id = eo_infiltrators.3
	title = eo_infiltrators.3.title
	show_sound = event_default

	espionage_operation = yes
    location = target.capital_scope
	is_triggered_only = yes

	desc = {
		trigger = {
			switch = {
				trigger = has_espionage_operation_flag
				asset_infilitrator_official = { text = eo_infiltrators.3.asset_infilitrator_official.desc }
				asset_infilitrator_noble = { text = eo_infiltrators.3.asset_infilitrator_officer.desc }
				asset_infilitrator_officer = { text = eo_infiltrators.3.asset_infilitrator_officer.desc }
				asset_infilitrator_politican = { text = eo_infiltrators.3.asset_infilitrator_politican.desc }
				asset_infilitrator_spy = { text = eo_infiltrators.3.asset_infilitrator_spy.desc }
				asset_infilitrator_diplomat = { text = eo_infiltrators.3.asset_infilitrator_diplomat.desc }
				asset_infilitrator_diplomat_backchannel = { text = eo_infiltrators.3.asset_infilitrator_diplomat_backchannel.desc }
				asset_infilitrator_journalist = { text = eo_infiltrators.3.asset_infilitrator_journalist.desc }
				asset_infilitrator_ceo = { text = eo_infiltrators.3.asset_infilitrator_ceo.desc }
				asset_infilitrator_manager = { text = eo_infiltrators.3.asset_infilitrator_manager.desc }
				asset_infilitrator_executive = { text = eo_infiltrators.3.asset_infilitrator_executive.desc }
				asset_infilitrator_labor_organizer = { text = eo_infiltrators.3.asset_infilitrator_labor_organizer.desc }
				asset_infilitrator_resource_coordinator = { text = eo_infiltrators.3.asset_infilitrator_resource_coordinator.desc }
				asset_infilitrator_economist = { text = eo_infiltrators.3.asset_infilitrator_economist.desc }
				asset_infilitrator_banker = { text = eo_infiltrators.3.asset_infilitrator_banker.desc }
				asset_infilitrator_regulator = { text = eo_infiltrators.3.asset_infilitrator_regulator.desc }
				asset_infilitrator_lobbyist = { text = eo_infiltrators.3.asset_infilitrator_lobbyist.desc }
				asset_infilitrator_scientist = { text = eo_infiltrators.3.asset_infilitrator_scientist.desc }
				asset_infilitrator_academic = { text = eo_infiltrators.3.asset_infilitrator_academic.desc }
				asset_infilitrator_fleet_commander = { text = eo_infiltrators.3.asset_infilitrator_fleet_commander.desc }
				asset_infilitrator_army_commander = { text = eo_infiltrators.3.asset_infilitrator_army_commander.desc }
				asset_infilitrator_military_advisor = { text = eo_infiltrators.3.asset_infilitrator_military_advisor.desc }
				asset_infilitrator_security_contractor = { text = eo_infiltrators.3.asset_infilitrator_security_contractor.desc }
				asset_infilitrator_civilian_official = { text = eo_infiltrators.3.asset_infilitrator_civilian_official.desc }
			}
		}
	}

	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_official
		}
		picture = GFX_evt_conclave
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_noble
		}
		picture = GFX_evt_animal_wildlife
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_officer
		}
		picture = GFX_evt_salute
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_politican
		}
		picture = GFX_evt_voting
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_diplomat
		}
		picture = GFX_evt_hand_shake
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_diplomat_backchannel
		}
		picture = GFX_evt_tradedeal
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_spy
		}
		picture = GFX_evt_spymaster
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_journalist
		}
		picture = GFX_evt_acquire_asset
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_ceo
		}
		picture = GFX_evt_board_meeting
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_manager
		}
		picture = GFX_evt_financial_instruments
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_executive
		}
		picture = GFX_evt_diplomatic_visit
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_labor_organizer
		}
		picture = GFX_evt_decryption
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_resource_coordinator
		}
		picture = GFX_evt_resource_cache
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_economist
		}
		picture = GFX_evt_tradestation_interior
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_banker
		}
		picture = GFX_evt_smugglers_in_bar
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_regulator
		}
		picture = GFX_evt_gunrunning
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_lobbyist
		}
		picture = GFX_evt_tradedeal
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_scientist
		}
		picture = GFX_evt_landing_ship_2
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_academic
		}
		picture = GFX_evt_voting
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_fleet_commander
		}
		picture = GFX_evt_federation_fleet
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_army_commander
		}
		picture = GFX_evt_ground_combat
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_military_advisor
		}
		picture = GFX_evt_acquire_asset
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_security_contractor
		}
		picture = GFX_evt_engineering_research
	}
	picture = {
		trigger = {
			has_espionage_operation_flag = asset_infilitrator_civilian_official
		}
		picture = GFX_evt_acquire_asset
	}

	immediate = {
		set_espionage_operation_progress_locked = yes
	}

	option = {
		name = LAUNCH_OPERATION
        hidden_effect = {
            owner = {
                country_event = { id = eo_infiltrators.4 days = 15 }
            }
        }
	}

    after = {
        set_espionage_operation_progress_locked = no
    }
}

#Conclusion
country_event = {
	id = eo_infiltrators.4
	title = eo_infiltrators.4.title

	location = from.target.capital_scope
	is_triggered_only = yes

	desc = {
		trigger = {
			hidden:from = {
				switch = {
					trigger = has_espionage_operation_flag
					asset_infilitrator_official = { text = eo_infiltrators.4.asset_infilitrator_official.desc }
					asset_infilitrator_noble = { text = eo_infiltrators.4.asset_infilitrator_noble.desc }
					asset_infilitrator_officer = { text = eo_infiltrators.4.asset_infilitrator_officer.desc }
					asset_infilitrator_politican = { text = eo_infiltrators.4.asset_infilitrator_politican.desc }
					asset_infilitrator_diplomat = { text = eo_infiltrators.4.asset_infilitrator_diplomat.desc }
					asset_infilitrator_diplomat_backchannel = { text = eo_infiltrators.4.asset_infilitrator_diplomat_backchannel.desc }
					asset_infilitrator_spy = { text = eo_infiltrators.4.asset_infilitrator_spy.desc }
					asset_infilitrator_journalist = { text = eo_infiltrators.4.asset_infilitrator_journalist.desc }
					asset_infilitrator_ceo = { text = eo_infiltrators.4.asset_infilitrator_ceo.desc }
					asset_infilitrator_manager = { text = eo_infiltrators.4.asset_infilitrator_manager.desc }
					asset_infilitrator_executive = { text = eo_infiltrators.4.asset_infilitrator_executive.desc }
					asset_infilitrator_labor_organizer = { text = eo_infiltrators.4.asset_infilitrator_labor_organizer.desc }
					asset_infilitrator_resource_coordinator = { text = eo_infiltrators.4.asset_infilitrator_resource_coordinator.desc }
					asset_infilitrator_economist = { text = eo_infiltrators.4.asset_infilitrator_economist.desc }
					asset_infilitrator_banker = { text = eo_infiltrators.4.asset_infilitrator_banker.desc }
					asset_infilitrator_regulator = { text = eo_infiltrators.4.asset_infilitrator_regulator.desc }
					asset_infilitrator_lobbyist = { text = eo_infiltrators.4.asset_infilitrator_lobbyist.desc }
					asset_infilitrator_scientist = { text = eo_infiltrators.4.asset_infilitrator_scientist.desc }
					asset_infilitrator_academic = { text = eo_infiltrators.4.asset_infilitrator_academic.desc }
					asset_infilitrator_fleet_commander = { text = eo_infiltrators.4.asset_infilitrator_fleet_commander.desc }
					asset_infilitrator_army_commander = { text = eo_infiltrators.4.asset_infilitrator_army_commander.desc }
					asset_infilitrator_military_advisor = { text = eo_infiltrators.4.asset_infilitrator_military_advisor.desc }
					asset_infilitrator_security_contractor = { text = eo_infiltrators.4.asset_infilitrator_security_contractor.desc }
					asset_infilitrator_civilian_official = { text = eo_infiltrators.4.asset_infilitrator_civilian_official.desc }
				}
			}
		}
	}

	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_official }
		}
		picture = GFX_evt_vivisection
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_noble }
		}
		picture = GFX_evt_alien_abduction
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_officer }
		}
		picture = GFX_evt_interior_battle
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_politican }
		}
		picture = GFX_evt_smear_campaign
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_diplomat }
		}
		picture = GFX_evt_diplomatic_visit
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_diplomat_backchannel }
		}
		picture = GFX_evt_ship_under_attack
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_spy }
		}
		picture = GFX_evt_cover_blown
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_journalist }
		}
		picture = GFX_evt_vivisection
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_ceo }
		}
		picture = GFX_evt_vivisection
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_manager }
		}
		picture = GFX_evt_acquire_asset
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_executive }
		}
		picture = GFX_evt_vivisection
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_labor_organizer }
		}
		picture = GFX_evt_dark_alley
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_resource_coordinator }
		}
		picture = GFX_evt_vivisection
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_economist }
		}
		picture = GFX_evt_spy_network
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_banker }
		}
		picture = GFX_evt_dark_alley
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_regulator }
		}
		picture = GFX_evt_ship_offloading_cargo
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_lobbyist }
		}
		picture = GFX_evt_hand_shake
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_scientist }
		}
		picture = GFX_evt_worrying_signal
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_academic }
		}
		picture = GFX_evt_operative_chase
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_fleet_commander }
		}
		picture = GFX_evt_face_off_in_space
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_army_commander }
		}
		picture = GFX_evt_surrender
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_military_advisor }
		}
		picture = GFX_evt_vivisection
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_security_contractor }
		}
		picture = GFX_evt_interior_battle
	}
	picture = {
		trigger = {
			from = { has_espionage_operation_flag = asset_infilitrator_civilian_official }
		}
		picture = GFX_evt_vivisection
	}

	option = {
		name = eo_infiltrators.4.a
        set_infiltrator_asset_flags_for_check = yes
        from.spynetwork = {
            add_spy_network_level = -10
			save_event_target_as = infiltrated_spynetwork
        }
		if = {
			limit = {
				from = {
					has_espionage_operation_flag = government_infiltrator_intel
				}
			}
			add_intel_report = { category = government level = 2 days = 360 who = from.target }
		}
		if = {
			limit = {
				from = {
					has_espionage_operation_flag = diplomacy_infiltrator_intel
				}
			}
			add_intel_report = { category = diplomacy level = 2 days = 360 who = from.target }
		}
		if = {
			limit = {
				from = {
					has_espionage_operation_flag = economy_infiltrator_intel
				}
			}
			add_intel_report = { category = economy level = 2 days = 360 who = from.target }
		}
		if = {
			limit = {
				from = {
					has_espionage_operation_flag = technology_infiltrator_intel
				}
			}
			add_intel_report = { category = technology level = 2 days = 360 who = from.target }
		}
		if = {
			limit = {
				from = {
					has_espionage_operation_flag = military_infiltrator_intel
				}
			}
			add_intel_report = { category = military level = 2 days = 360 who = from.target }
		}
		hidden_effect = {
			random_list = {
				70 = {
					country_event = { id = eo_infiltrators.5 days = 30 }
				}
				30 = {
					modifier = {
						factor = 0
						NOT = {
							any_country = {
								NOT = { is_same_value = prev }
								has_origin = origin_infiltrators
								any_spynetwork = {
									target = {
										is_same_value = from.target
									}
									has_same_asset_type = yes
								}
							}
						}
					}
					random_country = {
						limit = {
							NOT = { is_same_value = prev }
							has_origin = origin_infiltrators
							any_spynetwork = {
								target = {
									is_same_value = from.target
								}
								has_same_asset_type = yes
							}
						}
						save_event_target_as = parallel_infiltrator
					}
					country_event = { id = eo_infiltrators.6 days = 30 }
				}
			}
		}
		from.spynetwork = {
			set_saved_date = {
				key = recently_infiltrated
				days_from_present = @InfiltrateTimer
				expires = @InfiltrateTimer
			}
		}
        destroy_espionage_operation = from
	}
}

#Follow-up 1 (get espionage asset)
country_event = {
	id = eo_infiltrators.5
	title = eo_infiltrators.5.title

	location = from.target.capital_scope
	is_triggered_only = yes

	desc = eo_infiltrators.5.desc

	picture = GFX_evt_vivisection

	option = {
		name = EXCELLENT
        event_target:infiltrated_spynetwork = {
			create_infiltrator_asset = yes
		}
	}
}

#Follow-up 2 (get espionage asset)
country_event = {
	id = eo_infiltrators.6
	title = eo_infiltrators.6.title

	location = from.target.capital_scope
	is_triggered_only = yes

	desc = eo_infiltrators.6.desc

	picture = GFX_evt_vivisection

	option = {
		name = eo_infiltrators.6.a
        event_target:infiltrated_spynetwork = {
			create_infiltrator_asset = yes
		}
		random_spynetwork = {
			limit = { target = { is_same_value = event_target:parallel_infiltrator } }
			create_espionage_asset = { type = asset_internal_organs }
		}
	}
}

country_event = {
	id = eo_infiltrators.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_origin = origin_infiltrators
		from = {
			has_country_flag = infiltrators_parent_of@prev
		}
	}

	immediate = {
		country_event = { id = eo_infiltrators.8 days = 90 random = 30 }
	}
}

country_event = {
	id = eo_infiltrators.8
	title = eo_infiltrators.8.title

	is_triggered_only = yes

	desc = eo_infiltrators.8.desc

	picture = GFX_evt_spymaster

	option = {
		name = eo_infiltrators.8.a
	}
	option = {
		name = eo_infiltrators.8.b
	}
}

###############################################
## The Veil situation
###############################################
country_event = {
	id = eo_infiltrators.9
	title = eo_infiltrators.9.title
	location = capital_scope
	desc = eo_infiltrators.9.desc
	picture = GFX_evt_alien_abduction
	show_sound = event_encrypted_comms
	is_triggered_only = yes

	trigger = {
		has_origin = origin_infiltrators
	}

	immediate = {
		random_owned_species = {
			limit = {
				NOT = { is_same_species = prev.owner_species }
			}
			save_event_target_as = infiltrated_species
		}
		start_situation = {
			type = situation_eo_infiltrators
			effect = {
				save_event_target_as = the_veil_situation
			}
		}
	}

	option = {
		name = eo_infiltrators.9.a
		#custom_tooltip = eo_infiltrators.9.a.tooltip
		icon = {
			icon = GFX_situation_approach_secrecy
			icon_background = GFX_situation_approach_bg_yellow
			text = set_situation_approach_icon_text
		}
		event_target:the_veil_situation = {
			set_situation_approach = situation_eo_infiltrators_maintain_secrecy
		}
	}
	option = {
		name = eo_infiltrators.9.b
		#custom_tooltip = eo_infiltrators.9.b.tooltip
		icon = {
			icon = GFX_situation_approach_handshake
			icon_background = GFX_situation_approach_bg_yellow
			text = set_situation_approach_icon_text
		}
		event_target:the_veil_situation = {
			set_situation_approach = situation_eo_infiltrators_reveal_presence
		}
	}
	after = {
		remove_country_flag = main_species_concealed
	}
}

###############################################
## Situation events
###############################################
situation_event = {
	id = eo_infiltrators.10
	title = eo_infiltrators.10.title
	desc = eo_infiltrators.10.desc.a
	picture = GFX_evt_emergency_workers
	show_sound = event_cityscape

	is_triggered_only = yes

	trigger = {
		owner = {
			has_origin = origin_infiltrators
			any_owned_pop = {
				NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
				is_being_purged = no
			}
		}
	}
	weight_multiplier = {
		factor = 1
		modifier = {
			factor = 2
			owner = {
				any_owned_leader = {
					OR = {
						has_trait = leader_trait_maimed
						has_trait = leader_trait_traumatized
						has_trait = leader_trait_substance_abuser
					}
				}
			}
		}
	}

	immediate = {
		owner = {
			save_event_target_as = infiltrator_country
		########################## Select leader
			random_owned_leader = {
				limit = {
					is_same_species = owner
				}
				weights = {
					base = 1
					modifier = {
						mult = 5
						OR = {
							has_trait = leader_trait_maimed
							has_trait = leader_trait_traumatized
							has_trait = leader_trait_substance_abuser
						}
					}
					modifier = { # Can't happen to people outside our borders
						mult = 0
						exists = fleet
						fleet = {
							space_owner = {
								NOT = { is_same_value = event_target:infiltrator_country }
							}
						}
					}
					modifier = { # Can't happen to governors who don't rule over any normal pops
						mult = 0
						leader_class = governor
						is_idle = no
						NOT = {
							sector = {
								any_owned_pop = {
									NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
									is_being_purged = no
								}
							}
						}
					}
					modifier = { # Can't happen to rulers and scientists on the capital if the capital doesn't have any normal pops
						mult = 0
						OR = {
							is_ruler = yes
							leader_class = scientist
						}
						is_idle = no
						NOT = {
							owner.capital_scope = {
								any_owned_pop = {
									NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
									is_being_purged = no
								}
							}
						}
					}
					modifier = {
						factor = 0
						leader_class = general
						NOT = { exists = fleet }
						solar_system = {
							NOT = {
								any_system_planet = {
									owner = {
										is_same_value = event_target:infiltrator_country
									}
									any_owned_pop = {
										NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
										is_being_purged = no
									}
								}
							}
						}
					}
				}
				save_event_target_as = affected_leader
			}
		########################## Select event locations
			if = { # Idle leader
				limit = {
					event_target:affected_leader = {
						is_idle = yes
					}
				}
				random_owned_planet = {
					save_event_target_as = affected_leader_task_location
				}
				random_list = {
					10 = {
						modifier = {
							factor = 0
							capital_scope = {
								any_owned_pop = {
									NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
									is_being_purged = no
								}
							}
						}
						capital_scope = {
							save_event_target_as = medical_emergency_world
						}
					}
					10 = {
						reroll_random = yes
						random_owned_planet = {
							limit = {
								any_owned_pop = {
									NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
									is_being_purged = no
								}
							}
							save_event_target_as = medical_emergency_world
						}
					}
				}
			}
			else_if = { # Ruler
				limit = {
					event_target:affected_leader = {
						is_ruler = yes
					}
				}
				save_event_target_as = affected_leader_task_location
			}
			else_if = { # Admiral, General, or Scientist leading fleet
				limit = {
					event_target:affected_leader = {
						exists = fleet
					}
				}
				event_target:affected_leader = {
					fleet = {
						save_event_target_as = affected_leader_task_location
						solar_system = {
							if = {
								limit = {
									any_system_planet = {
										owner = {
											is_same_value = event_target:infiltrator_country
										}
										any_owned_pop = {
											NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
											is_being_purged = no
										}
									}
								}
								random_system_planet = {
									limit = {
										owner = {
											is_same_value = event_target:infiltrator_country
										}
										any_owned_pop = {
											NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
											is_being_purged = no
										}
									}
									save_event_target_as = medical_emergency_world
								}
							}
							else = {
								closest_system = {
									limit = {
										any_system_planet = {
											owner = {
												is_same_value = event_target:infiltrator_country
											}
											any_owned_pop = {
												NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
												is_being_purged = no
											}
										}
									}
									random_system_planet = {
										limit = {
											owner = {
												is_same_value = event_target:infiltrator_country
											}
											any_owned_pop = {
												NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
												is_being_purged = no
											}
										}
										save_event_target_as = medical_emergency_world
									}
								}
							}
						}
					}
				}
			}
			else_if = { # Governor
				limit = {
					event_target:affected_leader = {
						leader_class = governor
						exists = sector
					}
				}
				event_target:affected_leader = {
					sector = {
						sector_capital = {
							save_event_target_as = affected_leader_task_location
							if = {
								limit = {
									any_owned_pop = {
										NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
										is_being_purged = no
									}
								}
								save_event_target_as = medical_emergency_world
							}
							else = {
								prev = {
									random_owned_planet = {
										limit = {
											any_owned_pop = {
												NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
												is_being_purged = no
											}
										}
									save_event_target_as = medical_emergency_world
									}
								}
							}
						}
					}
				}
			}
			if = { # All other leaders should be stationed at the capital
				limit = {
					NOT = { exists = event_target:affected_leader_task_location }
				}
				capital_scope = {
					save_event_target_as = affected_leader_task_location
				}
			}
			if = { # All other leaders should be located at the capital
				limit = {
					NOT = { exists = event_target:medical_emergency_world }
				}
				capital_scope = {
					save_event_target_as = medical_emergency_world
				}
			}
		##########################
		}
		event_target:medical_emergency_world = {
			random_owned_pop = {
				limit = {
					NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
					is_being_purged = no
				}
				save_event_target_as = first_medical_worker_species
			}
			reroll_random = yes
			random_owned_pop = {
				limit = {
					NOT = { has_citizenship_type = { type = citizenship_concealment country = event_target:infiltrator_country } }
					is_being_purged = no
				}
				save_event_target_as = second_medical_worker_species
			}
		}
		owner = {
			#create_leader = { #TODO
			#	class = scientist
			#	species = event_target:first_medical_worker_species
			#	name = random
			#}
			last_created_leader = {
				random_list = {
					10 = { add_trait = leader_trait_eager }
					10 = { add_trait = leader_trait_expertise_biology }
				}
				exile_leader_as = first_medical_worker
				save_event_target_as = first_medical_worker
				save_global_event_target_as = first_medical_worker_of_@prev
			}
			reroll_random = yes
			#create_leader = { #TODO
			#	class = scientist
			#	species = event_target:second_medical_worker_species
			#	name = random
			#}
			last_created_leader = {
				random_list = {
					10 = { add_trait = leader_trait_eager }
					10 = { add_trait = leader_trait_expertise_biology }
				}
				exile_leader_as = second_medical_worker
				save_event_target_as = second_medical_worker
				save_global_event_target_as = second_medical_worker_of_@prev
			}

		}
	}

	option = {
		name = eo_infiltrators.10.a
		begin_event_chain = {
			event_chain = "infiltrators_loose_ends_chain"
			target = owner
		}
	}

	option = {
		name = eo_infiltrators.10.b
	}
}