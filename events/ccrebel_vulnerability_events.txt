
namespace = rebellionscript

####Vulnerability (monthly trigger)

#monthly
event = {
	id = rebellionscript.15
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		years_passed > 50
	}
	
	immediate = {
		every_playable_country = {
			change_variable = {
				which = ccrebel_vulnerability_variable
				value = 1
			}
			if = {
				limit = {
					check_variable = {
						which = ccrebel_vulnerability_variable
						value > 3			
					}
				}
				set_variable = {
					which = ccrebel_vulnerability_variable
					value = 0
				}
				if = {
					limit = {
						NOR = {
							has_modifier = vulnerable_state_1
							has_modifier = vulnerable_state_2
							has_modifier = lost_war_vulnerable_state
						}
						used_naval_capacity_percent < 0.9
						any_neighbor_country = {
							has_communications = prev
							is_country_type = default
							OR = {
								is_hostile_to = prev
								is_angry_to = prev
								is_domineering_to = prev
								is_rival = prev
							}
							relative_power = {
								who = prev
								category = fleet
								value = overwhelming
							}
							NOT = {
								prev = {
									any_relation = {
										OR = {
											has_defensive_pact = prev
											is_in_federation_with = prev
										}
										prevprev = {
											NOT = {
												relative_power = {
													who = prev
													category = fleet
													value = overwhelming
												}
											}
										}
									}
								}
							}
						}
					}
					country_event = { id = rebellionscript.16 }	
				}
				else_if = {
					limit = {
						OR = {
							has_modifier = vulnerable_state_1
							has_modifier = vulnerable_state_2
						}
					}
					if = {
						limit = {
							OR = {
								NOT = { used_naval_capacity_percent < 0.9 }

								NOT = {
									any_neighbor_country = {
										has_communications = prev
										is_country_type = default
										OR = {
											is_hostile_to = prev
											is_angry_to = prev
											is_domineering_to = prev
											is_rival = prev
										}
										relative_power = {
											who = prev
											category = fleet
											value = overwhelming
										}
										NOT = {
											prev = {
												any_relation = {
													OR = {
														has_defensive_pact = prev
														is_in_federation_with = prev
													}
													prevprev = {
														NOT = {
															relative_power = {
																who = prev
																category = fleet
																value = overwhelming
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						if = {
							limit = {
								has_modifier = vulnerable_state_1
							}
							remove_modifier = vulnerable_state_1
						}
						if = {
							limit = {
								has_modifier = vulnerable_state_2
							}
							remove_modifier = vulnerable_state_2
						}
						every_owned_pop = { 
							if = {
								limit = {
									has_modifier = chance_to_force_change_1
								}
								remove_modifier = chance_to_force_change_1
							}
							if = {
								limit = {
									has_modifier = chance_to_force_change_2
								}
								remove_modifier = chance_to_force_change_2
							}
							if = {
								limit = {
									has_modifier = feel_vulnerable_1
								}
								remove_modifier = feel_vulnerable_1
							}
							if = {
								limit = {
									has_modifier = feel_vulnerable_2
								}
								remove_modifier = feel_vulnerable_2
							}
							if = {
								limit = {
									has_modifier = chance_to_revolt_1
								}
								remove_modifier = chance_to_revolt_1
							}
							if = {
								limit = {
									has_modifier = chance_to_revolt_2
								}
								remove_modifier = chance_to_revolt_2
							}
						}
						remove_country_flag = vulnerable
						if = {
							limit = {
								is_ai = no
							}
							country_event = { id = rebellionscript.251 } #notify them
						}
					}
					else_if = {
						limit = {
							OR = {
								AND = {
									has_modifier = vulnerable_state_1
									used_naval_capacity_percent < 0.5
								}
								AND = {
									has_modifier = vulnerable_state_2
									NOT = { used_naval_capacity_percent < 0.5 }
								}
							}
						}
						if = {
							limit = {
								has_modifier = vulnerable_state_1
							}
							remove_modifier = vulnerable_state_1
						}
						if = {
							limit = {
								has_modifier = vulnerable_state_2
							}
							remove_modifier = vulnerable_state_2
						}
						every_owned_pop = { 
							if = {
								limit = {
									has_modifier = chance_to_force_change_1
								}
								remove_modifier = chance_to_force_change_1
							}
							if = {
								limit = {
									has_modifier = chance_to_force_change_2
								}
								remove_modifier = chance_to_force_change_2
							}
							if = {
								limit = {
									has_modifier = feel_vulnerable_1
								}
								remove_modifier = feel_vulnerable_1
							}
							if = {
								limit = {
									has_modifier = feel_vulnerable_2
								}
								remove_modifier = feel_vulnerable_2
							}
							if = {
								limit = {
									has_modifier = chance_to_revolt_1
								}
								remove_modifier = chance_to_revolt_1
							}
							if = {
								limit = {
									has_modifier = chance_to_revolt_2
								}
								remove_modifier = chance_to_revolt_2
							}
						}
						country_event = { id = rebellionscript.16 }	
					}
				}
			}
		}
	}
}


country_event = {
	id = rebellionscript.16
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		NOT = { has_modifier = lost_war_vulnerable_state }
		is_subject = no
		
		any_owned_pop = { cc_has_happiness = yes }
		
	}
	
			
	immediate = {
		random_neighbor_country = {
			limit = {
				has_communications = root
				is_country_type = default
				OR = {
					is_hostile_to = root
					is_angry_to = root
					is_domineering_to = root
					is_rival = root
				}
				relative_power = {
					who = root
					category = fleet
					value = overwhelming
				}
			}
			save_event_target_as = threat_state1
		}
		if = {
			limit = {
				NOT = { used_naval_capacity_percent < 0.5 }
				used_naval_capacity_percent < 0.9
			}
			add_modifier = {
				modifier = vulnerable_state_1
				days = -1
			}
			
			every_owned_pop = {
				if = {
					limit = {
						cc_has_happiness = yes
						OR = {
							AND = {
								is_same_species = root
								is_enslaved = no
							}
							AND = {
								NOT = { is_same_species = root }
								is_enslaved = no
								NOR = {
									has_ethic = ethic_xenophobe
									has_ethic = ethic_fanatic_xenophobe
								}
								root = {
									OR = {
										has_ethic = ethic_xenophile
										has_ethic = ethic_fanatic_xenophile
									}
								}
							}
						}
					}
					if = {
						limit = {
							cc_has_happiness = yes
							pop_opposite_ethic_to_empire = yes
						}
						add_modifier = {
							modifier = chance_to_force_change_1
							days = -1
						}
					}
					else = {
						add_modifier = { 
							modifier = feel_vulnerable_1
							days = -1
						}
					}
				}
				if = {
					limit = {
						cc_has_happiness = yes
						OR = {
							NOT = { is_same_species = root }
							AND = {
								is_same_species = root
								is_enslaved = yes
							}
						}
						NAND = {
							NOT = { is_same_species = root }
							is_enslaved = no
							NOR = {
								has_ethic = ethic_xenophobe
								has_ethic = ethic_fanatic_xenophobe
							}
							root = {
								OR = {
									has_ethic = ethic_xenophile
									has_ethic = ethic_fanatic_xenophile
								}
							}
						}
					}
					add_modifier = {
						modifier = chance_to_revolt_1
						days = -1
					}
				}
			}
		}
		if = {
			limit = {
				used_naval_capacity_percent < 0.5
			}

			add_modifier = {
				modifier = vulnerable_state_2
				days = -1
			}
			
			every_owned_pop = {
				if = {
					limit = {
						cc_has_happiness = yes
						OR = {
							AND = {
								is_same_species = root
								is_enslaved = no
							}
							AND = {
								NOT = { is_same_species = root }
								is_enslaved = no
								NOR = {
									has_ethic = ethic_xenophobe
									has_ethic = ethic_fanatic_xenophobe
								}
								root = {
									OR = {
										has_ethic = ethic_xenophile
										has_ethic = ethic_fanatic_xenophile
									}
								}
							}
						}
					}
					if = {
						limit = {
							cc_has_happiness = yes
							pop_opposite_ethic_to_empire = yes
						}
						add_modifier = {
							modifier = chance_to_force_change_2
							days = -1
						}
					}	
					else = {
						add_modifier = { 
							modifier = feel_vulnerable_2
							days = -1
						}
					}
				}
				if = {
					limit = {
						cc_has_happiness = yes
						OR = {
							NOT = { is_same_species = root }
							AND = {
								is_same_species = root
								is_enslaved = yes
							}
						}
						NAND = {
							NOT = { is_same_species = root }
							is_enslaved = no
							NOR = {
								has_ethic = ethic_xenophobe
								has_ethic = ethic_fanatic_xenophobe
							}
							root = {
								OR = {
									has_ethic = ethic_xenophile
									has_ethic = ethic_fanatic_xenophile
								}
							}
						}
					}
					add_modifier = {
						modifier = chance_to_revolt_2
						days = -1
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { has_country_flag = vulnerable }
			}
			country_event = { id = rebellionscript.19 }
		}
	}
}


# A war has been lost
# Root = Loser Warleader
# From = Winner Warleader
# FromFrom = War
country_event = {
	id = rebellionscript.17
	title = rebellionscript.17.name
	desc = {
		trigger = { NOT = { has_ethic = ethic_gestalt_consciousness } }
		text = rebellionscript.17.desc
	}
	desc = {
		trigger = { OR = {has_ascension_perk = ap_synthetic_evolution has_ethic = ethic_gestalt_consciousness} }
		text = rebellionscript.17.desc.gestalt
	}
	picture = GFX_evt_fleet_evil
	is_triggered_only = yes
	
	trigger = {
		used_naval_capacity_percent < 0.15
		NOT = { any_owned_fleet = { fleet_size > 150 } }
		is_subject = no
		
		any_owned_pop = { cc_has_happiness = yes }
	}
	
	immediate = {
		country_event = { id = rebellionscript.171 days = 5 }
		
		country_event = { id = rebellionscript.25 days = 721 }

		if = {
			limit = {
				has_modifier = vulnerable_state_1
			}
			remove_modifier = vulnerable_state_1
		}
		if = {
			limit = {
				has_modifier = vulnerable_state_2
			}
			remove_modifier = vulnerable_state_2
		}
		every_owned_pop = { 
			if = {
				limit = {
					has_modifier = chance_to_force_change_1
				}
				remove_modifier = chance_to_force_change_1
			}
			if = {
				limit = {
					has_modifier = chance_to_force_change_2
				}
				remove_modifier = chance_to_force_change_2
			}
			if = {
				limit = {
					has_modifier = feel_vulnerable_1
				}
				remove_modifier = feel_vulnerable_1
			}
			if = {
				limit = {
					has_modifier = feel_vulnerable_2
				}
				remove_modifier = feel_vulnerable_2
			}
			if = {
				limit = {
					has_modifier = chance_to_revolt_1
				}
				remove_modifier = chance_to_revolt_1
			}
			if = {
				limit = {
					has_modifier = chance_to_revolt_2
				}
				remove_modifier = chance_to_revolt_2
			}
		}


		add_modifier = {
			modifier = lost_war_vulnerable_state
			days = 720
		}	
		set_country_flag = vulnerable

		every_owned_pop = {
			limit = { cc_has_happiness = yes }
			if = {
				limit = {
					OR = {
						AND = {
							is_same_species = root
							is_enslaved = no
						}
						AND = {
							NOT = { is_same_species = root }
							is_enslaved = no
							NOR = {
								has_ethic = ethic_xenophobe
								has_ethic = ethic_fanatic_xenophobe
							}
							root = {
								OR = {
									has_ethic = ethic_xenophile
									has_ethic = ethic_fanatic_xenophile
								}
							}
						}
					}
				}
				if = {
					limit = { pop_opposite_ethic_to_empire = yes }
					add_modifier = {
						modifier = lost_war_chance_to_force_change
						days = 720
					}
				}	
				else = {
					add_modifier = { 
						modifier = lost_war_feel_vulnerable
						days = 720
					}
				}
			}
			if = {
				limit = {
					OR = {
						NOT = { is_same_species = root }
						AND = {
							is_same_species = root
							is_enslaved = yes
						}
					}
					NAND = {
						NOT = { is_same_species = root }
						is_enslaved = no
						NOR = {
							has_ethic = ethic_xenophobe
							has_ethic = ethic_fanatic_xenophobe
						}
						root = {
							OR = {
								has_ethic = ethic_xenophile
								has_ethic = ethic_fanatic_xenophile
							}
						}
					}
				}
				add_modifier = {
					modifier = lost_war_chance_to_revolt
					days = 720
				}
			}
		}
	}
	option = {
		name = UNFORTUNATE
	}
}

country_event = {
	id = rebellionscript.171
	is_triggered_only = yes
	hide_window = yes
	
	trigger = { is_subject = yes }
	
	immediate = {
		if = {
			limit = { has_modifier = lost_war_vulnerable_state }
			remove_modifier = lost_war_vulnerable_state
		}
		if = {
			limit = { has_country_flag = vulnerable }
			remove_country_flag = vulnerable
		}
		every_owned_pop = {
			limit = { cc_has_happiness = yes }
			if = {
				limit = { has_modifier = lost_war_chance_to_force_change }
				remove_modifier = lost_war_chance_to_force_change
			}
			if = {
				limit = { has_modifier = lost_war_feel_vulnerable }
				remove_modifier = lost_war_feel_vulnerable
			}
			if = {
				limit = { has_modifier = lost_war_chance_to_revolt }
				remove_modifier = lost_war_chance_to_revolt
			}
		}
	}
}

country_event = {
	id = rebellionscript.19
	title = rebellionscript.16.name
	desc = {
		trigger = { NOT = { has_ethic = ethic_gestalt_consciousness } }
		text = rebellionscript.16.desc
	}
	desc = {
		trigger = { OR = {has_ascension_perk = ap_synthetic_evolution has_ethic = ethic_gestalt_consciousness} }
		text = rebellionscript.16.desc.gestalt
	}
	picture = GFX_evt_alien_propaganda
	
	is_triggered_only = yes
	
	immediate = {
		set_country_flag = vulnerable
	}

	option = {
		name = UNFORTUNATE
		
		tooltip = {
			if = {
				limit = {
					used_naval_capacity_percent < 0.5
				}
				add_modifier = {
					modifier = vulnerable_state_2
					days = -1
				}
			}
			else = {
				add_modifier = {
					modifier = vulnerable_state_1
					days = -1
				}
			}
		}
		custom_tooltip = cc_vulnerability_pops_tooltip
		custom_tooltip = cc_vulnerability_tooltip
	}
}

country_event = {
	id = rebellionscript.25
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		is_subject = no
		any_owned_pop = { cc_has_happiness = yes }
	}

	immediate = {
		if = { 
			limit = {
				used_naval_capacity_percent < 0.9

				any_neighbor_country = {
					has_communications = prev
					is_country_type = default
					OR = {
						is_hostile_to = prev
						is_angry_to = prev
						is_domineering_to = prev
						is_rival = prev
					}
					relative_power = {
						who = prev
						category = fleet
						value = overwhelming
					}
				}
			}
			country_event = { id = rebellionscript.16 }
		}
		else = {
			remove_country_flag = vulnerable
			if = {
				limit = {
					is_ai = no
				}
				country_event = { id = rebellionscript.251 } #notify them
			}
		}
	}
}

country_event = {
	id = rebellionscript.251
	title = rebellionscript.25.name
	desc = {
		trigger = {
			NOT = { has_ethic = ethic_gestalt_consciousness }
			NOT = {
				any_neighbor_country = {
					has_communications = root
					is_country_type = default
					OR = {
						is_hostile_to = root
						is_angry_to = root
						is_domineering_to = root
						is_rival = root
					}
					relative_power = {
						who = root
						category = fleet
						value = overwhelming
					}
				}
			}
		}
		text = rebellionscript.25.desc
	}
	desc = {
		trigger = {
			NOT = { has_ethic = ethic_gestalt_consciousness }
			any_neighbor_country = {
				has_communications = root
				is_country_type = default
				OR = {
					is_hostile_to = root
					is_angry_to = root
					is_domineering_to = root
					is_rival = root
				}
				relative_power = {
					who = root
					category = fleet
					value = overwhelming
				}
			}
		}
		text = rebellionscript.25.desc.ally
	}
	desc = {
		trigger = {
			OR = {has_ascension_perk = ap_synthetic_evolution has_ethic = ethic_gestalt_consciousness}
			NOT = {
				any_neighbor_country = {
					has_communications = root
					is_country_type = default
					OR = {
						is_hostile_to = root
						is_angry_to = root
						is_domineering_to = root
						is_rival = root
					}
					relative_power = {
						who = root
						category = fleet
						value = overwhelming
					}
				}
			}
		}
		text = rebellionscript.25.desc.gestalt
	}
	desc = {
		trigger = {
			OR = {has_ascension_perk = ap_synthetic_evolution has_ethic = ethic_gestalt_consciousness}
			any_neighbor_country = {
				has_communications = root
				is_country_type = default
				OR = {
					is_hostile_to = root
					is_angry_to = root
					is_domineering_to = root
					is_rival = root
				}
				relative_power = {
					who = root
					category = fleet
					value = overwhelming
				}
			}
		}
		text = rebellionscript.25.desc.gestalt.ally
	}

	picture = GFX_evt_fleet_good
	
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				any_neighbor_country = {
					has_communications = root
					is_country_type = default
					OR = {
						is_hostile_to = root
						is_angry_to = root
						is_domineering_to = root
						is_rival = root
					}
					relative_power = {
						who = root
						category = fleet
						value = overwhelming
					}
				}
			}
			random_neighbor_country = {
				limit = {
					has_communications = root
					is_country_type = default
					OR = {
						is_hostile_to = root
						is_angry_to = root
						is_domineering_to = root
						is_rival = root
					}
					relative_power = {
						who = root
						category = fleet
						value = overwhelming
					}
				}
				root = {
					random_relation = {
						limit = {
							NOT = {
								prevprev = {
									relative_power = {
										who = prev
										category = fleet
										value = overwhelming
									}
								}
							}
						}
						save_event_target_as = cc_strong_ally
					}
				}
			}
		}
	}
	
	option = {
		name = rebellionscript.25.option
		
		custom_tooltip = cc_state_vulnerability_removed
	}
}

#migration ended
pop_event = {
	id = rebellionscript.1599
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		OR = {
			has_modifier = chance_to_force_change_1
			has_modifier = chance_to_force_change_2
			has_modifier = feel_vulnerable_1
			has_modifier = feel_vulnerable_2
			has_modifier = chance_to_revolt_1
			has_modifier = chance_to_revolt_2
		}
		OR = {
			AND = {
				exists = owner
				owner = {
					NOR = {
						has_modifier = vulnerable_state_1
						has_modifier = vulnerable_state_2
					}
				}
			}
			NOT = { exists = owner }
		}
	}
	immediate = {
		if = {
			limit = {
				has_modifier = chance_to_force_change_1
			}
			remove_modifier = chance_to_force_change_1
		}
		if = {
			limit = {
				has_modifier = chance_to_force_change_2
			}
			remove_modifier = chance_to_force_change_2
		}
		if = {
			limit = {
				has_modifier = feel_vulnerable_1
			}
			remove_modifier = feel_vulnerable_1
		}
		if = {
			limit = {
				has_modifier = feel_vulnerable_2
			}
			remove_modifier = feel_vulnerable_2
		}
		if = {
			limit = {
				has_modifier = chance_to_revolt_1
			}
			remove_modifier = chance_to_revolt_1
		}
		if = {
			limit = {
				has_modifier = chance_to_revolt_2
			}
			remove_modifier = chance_to_revolt_2
		}
	}
}

#planet transfer
planet_event = {
	id = rebellionscript.1598
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		every_owned_pop = {
			if = {
				limit = {
					has_modifier = chance_to_force_change_1
				}
				remove_modifier = chance_to_force_change_1
			}
			if = {
				limit = {
					has_modifier = chance_to_force_change_2
				}
				remove_modifier = chance_to_force_change_2
			}
			if = {
				limit = {
					has_modifier = feel_vulnerable_1
				}
				remove_modifier = feel_vulnerable_1
			}
			if = {
				limit = {
					has_modifier = feel_vulnerable_2
				}
				remove_modifier = feel_vulnerable_2
			}
			if = {
				limit = {
					has_modifier = chance_to_revolt_1
				}
				remove_modifier = chance_to_revolt_1
			}
			if = {
				limit = {
					has_modifier = chance_to_revolt_2
				}
				remove_modifier = chance_to_revolt_2
			}
		}
	}
}