namespace = IG-NuclearFire

# Event 01: Planet is turned into tomb world by Armageddon bombing stance
planet_event = {
	id = IG-NuclearFire.01
	hide_window = yes
	is_triggered_only = yes

	trigger = { # Using PDX original trigger conditions
		has_orbital_bombardment_stance = armageddon
		from = {
			OR = {
				is_country_type = default
				is_country_type = fallen_empire
				is_country_type = awakened_fallen_empire
				is_country_type = vol
			}
		}
		habitable_planet = yes
	}

	immediate = {
		if = { # If desert AND homeworld, set Kharak flag
			limit = {
				is_planet_class = pc_desert
				is_homeworld = yes
			}
			set_planet_flag = ig_nuclear_fire_kharak # Special flag for Kharak texture
		}
		planet_event = { id = IG-NuclearFire.02 days = 1 } # set an event firing one day after, otherwise texture might be be overwritten
	}
}

# Event 02: Changing tomb texture to armageddon style
planet_event = {
	id = IG-NuclearFire.02
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				has_planet_flag = ig_nuclear_fire_kharak
			}
			set_planet_entity = { entity = nuked_planet_kharak_entity }	# Kharak is burning
		}
		else = {
			set_planet_entity = { entity = nuked_planet_armageddon_entity }	# Armageddon texture
		}
		set_planet_flag = ig_nuclear_fire_nuked_special # Tag planet for texture swap
	}
}

# Event 10: On armageddon planet colonization, set up a coutdown to change texture
planet_event = {
	id = IG-NuclearFire.10
	hide_window = yes
	is_triggered_only = yes

	trigger = { # Using PDX trigger conditions
		has_planet_flag = ig_nuclear_fire_nuked_special
	}

	immediate = {
		planet_event = { id = IG-NuclearFire.11 days = 1800 random = 3600 } # firing 5 to 15 years after colonization, event to change the texture
		random_list = { # Set a random timed flag now for the randomized rewards later
			6 = { set_planet_flag = ig_nuclear_fire_reward_mineral } # Strict mineral gain or leader gain industrialist trait
			6 = { set_planet_flag = ig_nuclear_fire_reward_energy } # Strict energy gain or leader gain champion of people trait
			9 = { set_planet_flag = ig_nuclear_fire_reward_tile_energy_mineral } # Choice between a new mineral or energy tile
			9 = { set_planet_flag = ig_nuclear_fire_reward_tile_physics_society } # Choice between a new physic or society tile
			6 = { set_planet_flag = ig_nuclear_fire_reward_tile_engineering } # Old factoy for engineering
			2 = { set_planet_flag = ig_nuclear_fire_reward_betharian } # Found a betharian deposit
			4 = { set_planet_flag = ig_nuclear_fire_reward_robots } # Found a bunch of useful robots
			1 = { set_planet_flag = ig_nuclear_fire_reward_killer_robots } # Found robots, but ... they're bad !
		}
	}
}

# Event 11: Firestorm subsides, set new texture and random rewards
planet_event = {
	id = IG-NuclearFire.11
 	title = "IG-NuclearFire.11.title"
	desc = { # Desc if normal empire
		text = "IG-NuclearFire.11.desc.a"
		trigger = {
			owner = {
				NOR = {
					has_authority = auth_machine_intelligence
					has_authority = auth_hive_mind
				}
			}
		}
	}
	desc = { # Desc if machine empire
		text = "IG-NuclearFire.11.desc.b"
		trigger = {
			owner = {
				has_authority = "auth_machine_intelligence"
			}
		}
	}
	desc = { # Desc if hive mind
		text = "IG-NuclearFire.11.desc.c"
		trigger = {
			owner = {
				has_authority = "auth_hive_mind"
			}
		}
	}
 	picture = GFX_evt_ig_nuclear_fire
 	show_sound = event_scanner
 	location = root
	is_triggered_only = yes

	trigger = {
		has_owner = yes # Must be colonized
		is_planet_class = pc_nuked # Must be a tomb world, in case of terraforming
		has_planet_flag = ig_nuclear_fire_nuked_special # Double check flag
	}

	immediate = {
		random_list = { # Using random list, if hiting a non present entity, will default to entity 01
			1 = { set_planet_entity = { entity = nuked_planet_01_entity } } # Vanilla
			1 = { set_planet_entity = { entity = nuked_planet_02_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_03_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_04_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_05_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_06_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_07_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_08_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_09_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_10_entity } } # Planet vatiety
			1 = { set_planet_entity = { entity = nuked_planet_11_entity } } # Planet vatiety
		}
	}

# Old lame option
#	option = {
#		name = "IG-NuclearFire.11.a"
#		custom_tooltip = "IG-NuclearFire.11.a.tooltip"
#	}

	option = { # We found minerals
		name = "IG-NuclearFire.11.a"
		custom_tooltip = "IG-NuclearFire.11.a.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_mineral }
		owner = {
			add_minerals = 1500
		}
	}

	option = { # Invest the minerals found
		name = "IG-NuclearFire.11.b"
		custom_tooltip = "IG-NuclearFire.11.b.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_mineral }
		owner = { # Scope to country
			leader = { # Scope to leader of country
				if = { # Max number of trait is 3 for option to appear
					limit = {
						num_traits < 4
					}
				}
				add_trait = trait_ruler_industrialist
			}
		}
	}

	option = { # We found credits
		name = "IG-NuclearFire.11.c"
		custom_tooltip = "IG-NuclearFire.11.c.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_energy }
		owner = {
			add_energy = 500
		}
	}

	option = { # Distribute the credits found
		name = "IG-NuclearFire.11.d"
		custom_tooltip = "IG-NuclearFire.11.d.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_energy }
		owner = { # Scope to country
			leader = { # Scope to leader of country
				if = { # Max number of trait is 3 for option to appear
					limit = {
						num_traits < 4
					}
				}
				add_trait = trait_ruler_champion_of_the_people
			}
		}
	}

	option = { # Mineral Tile
		name = "IG-NuclearFire.11.e"
		custom_tooltip = "IG-NuclearFire.11.e.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_tile_energy_mineral }
		if = { # IF there's a tile without deposit or building
			limit = {
				any_tile = {
					has_deposit = no
				}
			}
			random_tile = {
				limit = {
					has_deposit = no
				}
				add_deposit = d_rich_mineral_deposit
			}
		}
		else = { # Otherwise, just some minerals
			owner = {
				add_minerals = 1500
			}
		}
	}

	option = { # Energy Tile
		name = "IG-NuclearFire.11.f"
		custom_tooltip = "IG-NuclearFire.11.f.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_tile_energy_mineral }
		if = { # IF there's a tile without deposit or building
			limit = {
				any_tile = {
					has_deposit = no
					has_building = no
				}
			}
			random_tile = {
				limit = {
					has_deposit = no
					has_building = no
				}
				add_deposit = d_rich_energy_deposit
			}
		}
		else = { # Otherwise, just some credits
			owner = {
				add_energy = 750
			}
		}
	}

	option = { # Society Tile
		name = "IG-NuclearFire.11.g"
		custom_tooltip = "IG-NuclearFire.11.g.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_tile_physics_society }
		if = { # IF there's a tile without deposit or building
			limit = {
				any_tile = {
					has_deposit = no
					has_building = no
				}
			}
			random_tile = {
				limit = {
					has_deposit = no
					has_building = no
				}
				add_deposit = d_rich_society_deposit
			}
		}
		else = { # Otherwise, just some society research
			owner = {
				add_society_research = 300
			}
		}
	}

	option = { # Physics Tile
		name = "IG-NuclearFire.11.h"
		custom_tooltip = "IG-NuclearFire.11.h.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_tile_physics_society }
		if = { # IF there's a tile without deposit or building
			limit = {
				any_tile = {
					has_deposit = no
					has_building = no
				}
			}
			random_tile = {
				limit = {
					has_deposit = no
					has_building = no
				}
				add_deposit = d_rich_physics_deposit
			}
		}
		else = { # Otherwise, just some physics research
			owner = {
			add_physics_research = 300
			}
		}
	}

	option = { # Engineering Tile
		name = "IG-NuclearFire.11.i"
		custom_tooltip = "IG-NuclearFire.11.i.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_tile_engineering }
		if = { # IF there's a tile without deposit or building
			limit = {
				any_tile = {
					has_deposit = no
					has_building = no
				}
			}
			random_tile = {
				limit = {
					has_deposit = no
					has_building = no
				}
				add_deposit = d_rich_engineering_deposit
			}
		}
		else = { # Otherwise, just some engineering research
			owner = {
				add_engineering_research = 300
			}
		}
	}

	option = { # Betharian Stone Tile
		name = "IG-NuclearFire.11.j"
		custom_tooltip = "IG-NuclearFire.11.j.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_betharian }
		random_tile = {
			limit = {
				NOR = {
					has_building = building_colony_shelter
					has_building = building_capital_1
					has_building = building_capital_2
					has_building = building_capital_3
				}
			}
			clear_deposits = yes
			add_deposit = d_betharian_deposit
		}
	}

	option = { # Found some old sturdy robots
		name = "IG-NuclearFire.11.k"
		custom_tooltip = "IG-NuclearFire.11.k.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_robots }
		if = { # IF species doesn't exist, create it
			limit = {
				NOT = {
					has_global_flag = ig_nuclear_fire_sturdy_robots
				}
			}
			hidden_effect = { ig_nuclear_fire_create_robot_species = yes }
			set_global_flag = ig_nuclear_fire_sturdy_robots
		}
		hidden_effect = {
			random_tile = { # Spawn a robot pop on the planet
				limit = {
					has_blocker = no
					has_pop = no
					has_growing_pop = no
					has_grown_pop = no
				}
				create_pop = {
					species = event_target:ig_nuclear_fire_sturdy_robots
				}
			}
		}
	}

	option = { # Found some mean robots
		name = "IG-NuclearFire.11.l"
		custom_tooltip = "IG-NuclearFire.11.l.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } has_planet_flag = ig_nuclear_fire_reward_killer_robots }
		if = { # IF species & country don't exist, create them
			limit = {
				NOT = {
					has_global_flag = ig_nuclear_fire_killer_robots
				}
			}
			hidden_effect = { ig_nuclear_fire_killer_robots_country = yes }
			set_global_flag = ig_nuclear_fire_killer_robots
		}
		hidden_effect = {
			random_list = { # Either 1 army or 2, 1 army should only scare, 2 should take an undefended planet
				1 = {
					create_army = {
						name = "44414541544820544f20414c4c"
						owner = event_target:ig_nuclear_fire_killer_robots_country
						species = event_target:ig_nuclear_fire_killer_robots
						type = "robotic_army"
					}
				}
				1 = {
					create_army = {
						name = "44414541544820544f20414c4c"
						owner = event_target:ig_nuclear_fire_killer_robots_country
						species = event_target:ig_nuclear_fire_killer_robots
						type = "robotic_army"
					}
					create_army = {
						name = "44414541544820544f20414c4c"
						owner = event_target:ig_nuclear_fire_killer_robots_country
						species = event_target:ig_nuclear_fire_killer_robots
						type = "robotic_army"
					}
				}
			}
		}
	}

	option = { # Dismantle the robots
		name = "IG-NuclearFire.11.m"
		custom_tooltip = "IG-NuclearFire.11.m.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } OR = { has_planet_flag = ig_nuclear_fire_reward_killer_robots has_planet_flag = ig_nuclear_fire_reward_robots } }
		owner = {
			add_minerals = 500
			add_engineering_research = 300
		}
	}

	option = { # Sell the robots
		name = "IG-NuclearFire.11.n"
		custom_tooltip = "IG-NuclearFire.11.n.tooltip"
		trigger = { owner = { NOR = { has_authority = auth_machine_intelligence has_authority = auth_hive_mind } } OR = { has_planet_flag = ig_nuclear_fire_reward_killer_robots has_planet_flag = ig_nuclear_fire_reward_robots } }
		owner = {
			add_energy = 1500
		}
	}

	option = { # Fallback option - SHOULD NOT APPEAR
		name = "IG-NuclearFire.11.o"
		custom_tooltip = "IG-NuclearFire.11.o.tooltip"
		trigger = {
			owner = {
				NOR = {
					has_authority = auth_machine_intelligence
					has_authority = auth_hive_mind
				}
			}
			NOR = {
				has_planet_flag = ig_nuclear_fire_reward_mineral
				has_planet_flag = ig_nuclear_fire_reward_energy
				has_planet_flag = ig_nuclear_fire_reward_tile_energy_mineral
				has_planet_flag = ig_nuclear_fire_reward_tile_physics_society
				has_planet_flag = ig_nuclear_fire_reward_tile_engineering
				has_planet_flag = ig_nuclear_fire_reward_betharian
				has_planet_flag = ig_nuclear_fire_reward_robots
				has_planet_flag = ig_nuclear_fire_reward_killer_robots
			}
		}
		owner = {
			add_minerals = 1000
			add_energy = 500
		}
	}

	option = { # Hive mind option only
		name = "IG-NuclearFire.11.p"
		# custom_tooltip = "IG-NuclearFire.11.p.tooltip"
		trigger = { owner = { has_authority = "auth_hive_mind" } }
		owner = {
			add_minerals = 1000
			add_energy = 500
		}
	}

	option = { # Machine option only
		name = "IG-NuclearFire.11.q"
		# custom_tooltip = "IG-NuclearFire.11.p.tooltip"
		trigger = { owner = { has_authority = "auth_machine_intelligence" } }
		owner = {
			add_minerals = 1000
			add_energy = 500
		}
	}

	after = {
		remove_planet_flag = ig_nuclear_fire_nuked_special
		remove_planet_flag = ig_nuclear_fire_reward_mineral
		remove_planet_flag = ig_nuclear_fire_reward_energy
		remove_planet_flag = ig_nuclear_fire_reward_tile_energy_mineral
		remove_planet_flag = ig_nuclear_fire_reward_tile_physics_society
		remove_planet_flag = ig_nuclear_fire_reward_tile_engineering
		remove_planet_flag = ig_nuclear_fire_reward_betharian
		remove_planet_flag = ig_nuclear_fire_reward_robots
		remove_planet_flag = ig_nuclear_fire_reward_killer_robots
	}
}