namespace = fallenplanetcraft

#trigger the event on all FEs
country_event = {
	id = fallenplanetcraft.1
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		every_country = {
			limit = {
				is_country_type = fallen_empire
			}
			country_event = { id = fallenplanetcraft.2 days = 1 } #for AE
			country_event = { id = fallenplanetcraft.3 days = 1 } #give moons to FEs
		}
	}
}

#locate suitable planets within FE space and transform them into dormant attack moons
#Between 2 and 4 per FE
country_event = {
	id = fallenplanetcraft.2
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		random_list = {
			50 = {
				every_planet = {
					limit = {
						OR = {
							has_planet_flag = holy_world_1
							has_planet_flag = holy_world_2
							has_planet_flag = holy_world_3
							has_planet_flag = holy_world_4
						}
					}
					set_planet_flag = dormant_war_planet
				}
			}
			50 = {}
		}
		random_list = {
			75 = {} #no moons
			50 = { #3 moons
				while = {
					count < 3
					random_planet_within_border = {
						limit = {
							NOT = {
								has_planet_flag = dormant_war_moon
							}
							is_colony = no
							OR = {
								is_planet_class = pc_molten
								is_planet_class = pc_barren
								is_planet_class = pc_barren_cold
								is_planet_class = pc_frozen
							}
							is_moon = yes
						}
						while = {
							limit = {
								planet_size < 6
							}
							change_planet_size = -1
						}
						set_planet_flag = dormant_war_moon
					}
				}
			}
			50 = { #5 moons
				while = {
					count < 5
					random_planet_within_border = {
						limit = {
							NOT = {
								has_planet_flag = dormant_war_moon
							}
							is_colony = no
							OR = {
								is_planet_class = pc_molten
								is_planet_class = pc_barren
								is_planet_class = pc_barren_cold
								is_planet_class = pc_frozen
							}
							is_moon = yes
						}
						while = {
							limit = {
								planet_size < 6
							}
							change_planet_size = -1
						}
						set_planet_flag = dormant_war_moon
					}
				}
			}
			50 = { #6 moons
				while = {
					count < 6
					random_planet_within_border = {
						limit = {
							NOT = {
								has_planet_flag = dormant_war_moon
							}
							is_colony = no
							OR = {
								is_planet_class = pc_molten
								is_planet_class = pc_barren
								is_planet_class = pc_barren_cold
								is_planet_class = pc_frozen
							}
							is_moon = yes
						}
						while = {
							limit = {
								planet_size < 6
							}
							change_planet_size = -1
						}
						set_planet_flag = dormant_war_moon
					}
				}
			}
			50 = { #5 moons and a planet (bad time)
				while = {
					count < 5
					random_planet_within_border = {
						limit = {
							NOT = {
								has_planet_flag = dormant_war_moon
							}
							is_colony = no
							OR = {
								is_planet_class = pc_molten
								is_planet_class = pc_barren
								is_planet_class = pc_barren_cold
								is_planet_class = pc_frozen
							}
							is_moon = yes
						}
						while = {
							limit = {
								planet_size < 6
							}
							change_planet_size = -1
						}
						set_planet_flag = dormant_war_moon
					}
				}
				random_planet_within_border = {
					limit = {
						NOT = {
							has_planet_flag = dormant_war_planet
						}
						is_moon = no
						has_anomaly = no
						is_colony = no
						OR = {
							is_planet_class = pc_barren
							is_planet_class = pc_barren_cold
							is_planet_class = pc_molten
							is_planet_class = pc_toxic
							is_planet_class = pc_frozen
						}
					}
					set_planet_flag = dormant_war_planet
					while = {
						limit = {
							planet_size < 25
						}
						change_planet_size = 1
					}
					change_pc = pc_barren
					if = {
						limit = {
							space_owner = {
								has_ethic = ethic_fanatic_spiritualist
							}
						}
						remove_planet_flag = dormant_war_planet #spiritualists get their holy worlds as planetcrafts
					}
				}
			}
		}
	}
}

###Give existing FEs 1 or 2 moons
country_event = {
	id = fallenplanetcraft.3
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		random_planet_within_border = { #capital
			limit = {
				is_capital = yes
			}
			save_event_target_as = fe_moon_location
		}
		random_planet_within_border = { #random planet in the capital system
			limit = {
				is_capital = no
				solar_system = {
					any_planet = {
						is_capital = yes
					}
				}
			}
			save_event_target_as = fe_moon_location_2
		}
		random_list = {
			50 = {} #no starting moons
			50 = { #1 starting moon
				create_fleet = {
					name = "Attack Moon"
					settings = { 
						spawn_debris = no  
					}
					effect = {
						set_owner = ROOT
						create_ship = {
							name = "Celestial Defender"
							design = "Ancient AI Planetoid"
							effect = {
								set_ship_flag = attack_moon_ship
							}
						}
						set_location = event_target:fe_moon_location
					}
				}
			}
			25 = { #2 starting moons
				create_fleet = {
					name = "Attack Moon"
					settings = { 
						spawn_debris = no  
					}
					effect = {
						set_owner = ROOT
						create_ship = {
							name = "Celestial Defender Alpha"
							design = "Ancient AI Planetoid"
							effect = {
								set_ship_flag = attack_moon_ship
							}
						}
						set_location = event_target:fe_moon_location
					}
				}
				create_fleet = {
					name = "Attack Moon"
					settings = { 
						spawn_debris = no  
					}
					effect = {
						set_owner = ROOT
						create_ship = {
							name = "Celestial Defender Beta"
							design = "Ancient AI Planetoid"
							effect = {
								set_ship_flag = attack_moon_ship
							}
						}
						set_location = event_target:fe_moon_location_2
					}
				}
			}
		}
	}
}

###every year check if a FE became an AE and awaken their dormant moons and planets###
event = {
	id = fallenplanetcraft.4
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		every_country = {
			limit = {
				is_country_type = awakened_fallen_empire
				NOT = {
					has_country_flag = fe_war_moons_activated
				}
			}
			if = { #inform the player of how screwed they might be
				limit = {
					any_planet_within_border = {
						OR = {
							has_planet_flag = dormant_war_moon
							has_planet_flag = dormant_war_planet
						}
					}
				}
				every_country = { 
					limit = {
						is_ai = no
					}
					country_event = { id = fallenplanetcraft.10 days = 30 random = 2 }
				}
			}
			every_planet_within_border = { #activate war moons
				limit = {
					has_planet_flag = dormant_war_moon
				}
				planet_event = { id = fallenplanetcraft.5 days = 1 }
			}
			every_planet_within_border = { #activate war planets
				limit = {
					has_planet_flag = dormant_war_planet
				}
				planet_event = { id = fallenplanetcraft.7 days = 1 }
			}
			if = {
				limit = {
					has_ethic = ethic_fanatic_spiritualist
				}
				save_event_target_as = war_planet_spiritualist_fallen_empire
				random_planet = { #activate war planets (holy world)
					limit = {
						has_planet_flag = dormant_war_planet
						is_colony = no
						OR = {
							has_planet_flag = holy_world_1
							has_planet_flag = holy_world_2
							has_planet_flag = holy_world_3
							has_planet_flag = holy_world_4
						}
					}
					planet_event = { id = fallenplanetcraft.6 days = 1 }
				}
			}
			set_country_flag = fe_war_moons_activated
		}
	}
}

planet_event = {
	id = fallenplanetcraft.5
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		space_owner = {
			create_fleet = {
				name = "Attack Moon"
				settings = { 
					spawn_debris = no 
				}
				effect = {
					set_owner = ROOT.space_owner
					create_ship = {
						name = "Celestial Attacker"
						design = "Ancient AI Planetoid"
						effect = {
							set_ship_flag = attack_moon_ship
						}
					}
					set_location = ROOT
				}
			}
		}
		ROOT = {
			remove_planet = yes
		}
	}
}

planet_event = {
	id = fallenplanetcraft.6
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		every_country = { 
			limit = {
				is_ai = no
			}
			country_event = { id = fallenplanetcraft.11 days = 60 } #inform the player of how really screwed they might be
		}
		event_target:war_planet_spiritualist_fallen_empire = {
			random_planet_within_border = {
				limit = {
					is_colony = yes
				}
				save_event_target_as = fecapitalplanetcraft
			}
			create_fleet = {
				name = "The Protector of Faith"
				settings = { 
					spawn_debris = no
					is_boss = yes
				}
				effect = {
					set_owner = event_target:war_planet_spiritualist_fallen_empire
					assign_leader = last_created_leader
					create_ship = {
						name = "Protector of Faith"
						design = "Ancient Holy Planetcraft"
						effect = {
							set_ship_flag = behemoth_planet_ship
							save_event_target_as = gaia_planetcraft
						}
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
					set_location = ROOT
				}
			}
		}
		ROOT = {
			remove_planet = yes
		}
	}
}

planet_event = {
	id = fallenplanetcraft.7
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		space_owner = {
			create_fleet = {
				name = "The Grand Defender"
				settings = { 
					spawn_debris = no 
				}
				effect = {
					set_owner = ROOT.space_owner
					create_ship = {
						name = "The Grand Defender"
						design = "Ancient Planetcraft"
						effect = {
							set_ship_flag = behemoth_planet_ship
						}
					}
					set_location = ROOT
				}
			}
		}
		ROOT = {
			remove_planet = yes
		}
	}
}

#popup about war moons
country_event = {
	id = fallenplanetcraft.10
	title = fallenplanetcraft.10.name
	desc = fallenplanetcraft.10.desc
	is_triggered_only = yes
	picture = GFX_evt_cold_barren
	show_sound = event_air_raid_siren
	
	option = {
		name = fallenplanetcraft.10.a
	}
}

#popup about war gaia world
country_event = {
	id = fallenplanetcraft.11
	title = fallenplanetcraft.11.name
	desc = fallenplanetcraft.11.desc
	is_triggered_only = yes
	picture = GFX_evt_automated_dreadnought
	show_sound = event_air_raid_siren
	
	option = {
		name = fallenplanetcraft.11.a
	}
}