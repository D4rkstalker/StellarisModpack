namespace = ag_research

country_event = {
	id = ag_research.1
	title = "ag_research.1.name"
	desc = "ag_research.1.desc"
	diplomatic = yes
	custom_gui = "ag_research_window"
	custom_gui_option = "ag_research_option"
	picture_event_data = {
		room = ag_event_physics_research_room
		portrait = root.species
	}
	show_sound = event_default
	
	is_triggered_only = yes
	
	trigger = { NOT = { has_country_flag = ag_research_window_opened } }
	immediate = {
		set_country_flag = ag_research_window_opened
		if = {
			limit = { check_variable = { which = ag_research_current_page value = 0 } }
			set_variable = { which = ag_research_current_page value = 1 }
		}
		if = {
			limit = { check_variable = { which = ag_research_total_pages value = 0 } }
			set_variable = { which = ag_research_total_pages value = 1 }
		}
		ag_load_page = yes
		# Prevent some bugs with unknown reasons...
		ag_check_locate_ancient_system_project_state = yes
		if = {
			limit = {
				NOR = {
					has_country_flag = ag_lost_ancient_ship_locked
					has_country_flag = ag_lost_ancient_ship_restored
				}
				has_country_flag = ag_has_research_project_2501
				NOT = { exists = event_target:ag_starlight_2_ship }
			}
			random_owned_ship = {
				limit = { OR = {
					is_ship_size = ag_lost_ancient_ship_battleship_form
					is_ship_size = ag_lost_ancient_ship_science_ship_form
				} }
				save_global_event_target_as = ag_starlight_2_ship
			}
		}
	}
	after = { remove_country_flag = ag_research_window_opened }
	option = { name = "ag_research.1.a" default_hide_option = yes hidden_effect = { remove_country_flag = ag_research_window_opened } }
}

# Notification for the first project.
country_event = {
	id = ag_research.2
	title = "ag_research.2.name"
	desc = "ag_research.2.desc"
	diplomatic = yes
	custom_gui = "ag_ancient_event_window"
	custom_gui_option = "ag_ancient_event_option"
	picture_event_data = { room = ag_event_throne_room }
	show_sound = event_mystic_reveal
	
	is_triggered_only = yes
	
	option = {
		name = "ag_research.2.a"
		custom_tooltip = "ag_research.2.a.tooltip"
	}
}

# Fire research projects' completed events.
event = {
	id = ag_research.3
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_playable_country = {
			limit = { is_ai = no has_country_flag = ag_research_project_ongoing }
			country_event = { id = ag_research.4 days = 2 }
		}
	}
}
country_event = {
	id = ag_research.4
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_ai = no }
	immediate = {
		switch = {
			trigger = has_country_flag
			# New Research Project: (11) Create research project cmpleted effect.
			ag_research_project_1_completed = { country_event = { id = ag_spawn.31 } remove_country_flag = ag_research_project_1_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_2_completed = { country_event = { id = ag_ancient_knowledge.15 } remove_country_flag = ag_research_project_2_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_3_completed = { country_event = { id = ag_ancient_knowledge.16 } remove_country_flag = ag_research_project_3_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_203_completed = { country_event = { id = ag_beta.126 } remove_country_flag = ag_research_project_203_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_206_completed = { country_event = { id = ag_beta.61 } remove_country_flag = ag_research_project_206_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_302_completed = { country_event = { id = ag_gamma.101 } remove_country_flag = ag_research_project_302_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_403_completed = { country_event = { id = ag_delta.61 } remove_country_flag = ag_research_project_403_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_801_completed = { country_event = { id = ag_theta.22 } remove_country_flag = ag_research_project_801_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_802_completed = { country_event = { id = ag_theta.42 } remove_country_flag = ag_research_project_802_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_2501_completed = { country_event = { id = ag_side.35 } remove_country_flag = ag_research_project_2501_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_2601_completed = { country_event = { id = ag_wanderer.112 } remove_country_flag = ag_research_project_2601_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_2602_completed = { country_event = { id = ag_wanderer.102 } remove_country_flag = ag_research_project_2602_completed remove_country_flag = ag_research_project_ongoing }
			ag_research_project_9999_completed = { country_event = { id = ag_interaction.113 } remove_country_flag = ag_research_project_9999_completed remove_country_flag = ag_research_project_ongoing }
		}
	}
}
# Enters battle, end research project
country_event = {
	id = ag_research.5
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			AND = {
				check_variable = { which = ag_current_research value = @ag_repair_starfish_ship_project_id }
				fromfrom = { any_owned_ship = { is_same_value = event_target:ag_ancient_starfish_ship } }
			}
			AND = {
				check_variable = { which = ag_current_research value = @ag_repair_starlight_2_project_id }
				fromfrom = { any_owned_ship = { is_same_value = event_target:ag_starlight_2_ship } }
			}
			AND = {
				OR = {
					check_variable = { which = ag_current_research value = @ag_reverse_engineering_wandering_ship_project_id }
					check_variable = { which = ag_current_research value = @ag_wandering_ship_unlock_project_id }
				}
				fromfrom = { any_owned_ship = { has_ship_flag = ag_ancient_wandering_ship_player } }
			}
		}
	}
	immediate = {
		if = {
			limit = { check_variable = { which = ag_current_research value = @ag_repair_starfish_ship_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_repair_starfish_ship_project_battle_message_desc"
				days = 20
				target = this
			}
		}
		else_if = {
			limit = { check_variable = { which = ag_current_research value = @ag_repair_starlight_2_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_repair_starlight_2_project_battle_message_desc"
				days = 20
				target = this
			}
		}
		else_if = {
			limit = { check_variable = { which = ag_current_research value = @ag_reverse_engineering_wandering_ship_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_reverse_engineering_wandering_ship_project_battle_message_desc"
				days = 20
				target = this
			}
		}
		else_if = {
			limit = { check_variable = { which = ag_current_research value = @ag_wandering_ship_unlock_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_wandering_ship_unlock_project_battle_message_desc"
				days = 20
				target = this
			}
		}
	}
}
country_event = {
	id = ag_research.6
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			last_increased_tech = tech_ag_beta_station_type1
			last_increased_tech = tech_ag_beta_station_type2
			last_increased_tech = tech_ag_gamma_station
			last_increased_tech = tech_ag_delta_titan
			last_increased_tech = tech_ag_delta_platform
		}
	}
	immediate = {
		if = {
			limit = { has_country_flag = ag_has_research_project_2601 }
			ag_iota_data_research_buff = { ag_project_id = 2601 ag_no_change_difficulty = yes }
		}
	}
}