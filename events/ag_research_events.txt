namespace = ag_research

country_event = {
	id = ag_research.1
	title = "ag_research.1.name"
	desc = "ag_research.1.desc"
	diplomatic = yes
	custom_gui = "ag_research_window"
	custom_gui_option = "ag_research_option"
	picture_event_data = {
		room = ag_event_physics_research_room
		portrait = root.species
	}
	show_sound = event_default
	
	is_triggered_only = yes
	
	trigger = { NOT = { has_country_flag = ag_research_window_opened } }
	immediate = {
		set_country_flag = ag_research_window_opened
		ag_initialize_research_variables = yes
		if = {
			limit = { check_variable = { which = ag_research_current_page value = 0 } }
			set_variable = { which = ag_research_current_page value = 1 }
		}
		if = {
			limit = { check_variable = { which = ag_research_total_pages value = 0 } }
			set_variable = { which = ag_research_total_pages value = 1 }
		}
		ag_load_page = yes
		# Prevent some bugs with unknown reasons...
		ag_check_locate_ancient_system_project_state = yes
		if = {
			limit = {
				NOR = {
					has_country_flag = ag_lost_ancient_ship_locked
					has_country_flag = ag_lost_ancient_ship_restored
				}
				has_country_flag = ag_has_research_project_2501
				NOT = { exists = event_target:ag_starlight_2_ship }
			}
			random_controlled_ship = {
				limit = { OR = {
					is_ship_size = ag_lost_ancient_ship_battleship_form
					is_ship_size = ag_lost_ancient_ship_science_ship_form
				} }
				save_global_event_target_as = ag_starlight_2_ship
			}
		}
	}
	after = { remove_country_flag = ag_research_window_opened }
	option = { name = "ag_research.1.a" default_hide_option = yes hidden_effect = { remove_country_flag = ag_research_window_opened } }
}

# Notification for the first project.
country_event = {
	id = ag_research.2
	title = "ag_research.2.name"
	desc = "ag_research.2.desc"
	diplomatic = yes
	custom_gui = "ag_ancient_event_window"
	custom_gui_option = "ag_ancient_event_option"
	picture_event_data = { room = ag_event_throne_room }
	show_sound = event_mystic_reveal
	
	is_triggered_only = yes
	
	option = {
		name = "ag_research.2.a"
		custom_tooltip = "ag_research.2.a.tooltip"
	}
}

# Research project round effects
ship_event = {
	id = ag_research.3
	hide_window = yes
	is_triggered_only = yes
	immediate = { owner = {
		switch = {
			trigger = has_country_flag
			ag_rp_round_area_physics = { remove_country_flag = ag_rp_round_area_physics }
			ag_rp_round_area_society = { remove_country_flag = ag_rp_round_area_society }
			ag_rp_round_area_engineering = { remove_country_flag = ag_rp_round_area_engineering }
		}
		ag_calculate_research_progress = yes
		# New Research Project: (11) Create research project round effect.
		switch = {
			trigger = has_country_flag
			ag_rp_round_ag_locate_ancient_system_project = {
				remove_country_flag = ag_rp_round_ag_locate_ancient_system_project
				ag_finished_research_round = {
					ag_event_chain = ag_locate_ancient_system_project_chain
					ag_project = ag_locate_ancient_system_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_1_completed
					if = {
						limit = { has_country_flag = ag_locate_ancient_system_project_actived }
						remove_country_flag = ag_locate_ancient_system_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_ag_ship_hull_upgrade_project = {
				remove_country_flag = ag_rp_round_ag_ship_hull_upgrade_project
				ag_finished_research_round = {
					ag_event_chain = ag_ship_hull_upgrade_project_chain
					ag_project = ag_ship_hull_upgrade_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_2_completed
					if = {
						limit = { has_country_flag = ag_ship_hull_upgrade_project_actived }
						remove_country_flag = ag_ship_hull_upgrade_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_ship_bow_upgrade_project = {
				remove_country_flag = ag_rp_round_ship_bow_upgrade_project
				ag_finished_research_round = {
					ag_event_chain = ag_ship_bow_upgrade_project_chain
					ag_project = ag_ship_bow_upgrade_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_3_completed
					if = {
						limit = { has_country_flag = ag_ship_bow_upgrade_project_actived }
						remove_country_flag = ag_ship_bow_upgrade_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_advanced_fortress_project = {
				remove_country_flag = ag_rp_round_advanced_fortress_project
				ag_finished_research_round = {
					ag_event_chain = ag_advanced_fortress_project_chain
					ag_project = ag_advanced_fortress_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_4_completed
					if = {
						limit = { has_country_flag = ag_advanced_fortress_project_actived }
						remove_country_flag = ag_advanced_fortress_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_advanced_auras_project = {
				remove_country_flag = ag_rp_round_advanced_auras_project
				ag_finished_research_round = {
					ag_event_chain = ag_advanced_auras_project_chain
					ag_project = ag_advanced_auras_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_5_completed
					if = {
						limit = { has_country_flag = ag_advanced_auras_project_actived }
						remove_country_flag = ag_advanced_auras_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_construction_sections_project = {
				remove_country_flag = ag_rp_round_construction_sections_project
				ag_finished_research_round = {
					ag_event_chain = ag_construction_sections_project_chain
					ag_project = ag_construction_sections_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_6_completed
					if = {
						limit = { has_country_flag = ag_construction_sections_project_actived }
						remove_country_flag = ag_construction_sections_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_alpha_psionic_container_project = {
				remove_country_flag = ag_rp_round_alpha_psionic_container_project
				ag_finished_research_round = {
					ag_event_chain = ag_alpha_psionic_container_project_chain
					ag_project = ag_alpha_psionic_container_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_101_completed
					if = {
						limit = { has_country_flag = ag_alpha_psionic_container_project_actived }
						remove_country_flag = ag_alpha_psionic_container_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_alpha_psionic_star_project = {
				remove_country_flag = ag_rp_round_alpha_psionic_star_project
				ag_finished_research_round = {
					ag_event_chain = ag_alpha_psionic_star_project_chain
					ag_project = ag_alpha_psionic_star_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_102_completed
					if = {
						limit = { has_country_flag = ag_alpha_psionic_star_project_actived }
						remove_country_flag = ag_alpha_psionic_star_project_actived
					}
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_beta_psionic_source_project = {
				remove_country_flag = ag_rp_round_beta_psionic_source_project
				ag_finished_research_round = {
					ag_event_chain = ag_beta_psionic_source_project_chain
					ag_project = ag_beta_psionic_source_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_206_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_beta_psionic_station_project = {
				remove_country_flag = ag_rp_round_beta_psionic_station_project
				ag_finished_research_round = {
					ag_event_chain = ag_beta_psionic_station_project_chain
					ag_project = ag_beta_psionic_station_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_207_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_epsilon_first_building_unlock_project = {
				remove_country_flag = ag_rp_round_epsilon_first_building_unlock_project
				ag_finished_research_round = {
					ag_event_chain = ag_epsilon_first_building_unlock_project_chain
					ag_project = ag_epsilon_first_building_unlock_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_501_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_eta_control_station_project = {
				remove_country_flag = ag_rp_round_eta_control_station_project
				ag_finished_research_round = {
					ag_event_chain = ag_eta_control_station_project_chain
					ag_project = ag_eta_control_station_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					remove_country_flag = ag_current_research_completed
					set_country_flag = ag_research_project_601_completed
				}
			}
			ag_rp_round_eta_gateway_project = {
				remove_country_flag = ag_rp_round_eta_gateway_project
				ag_finished_research_round = {
					ag_event_chain = ag_eta_gateway_project_chain
					ag_project = ag_eta_gateway_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_603_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_disable_ancient_shield_project = {
				remove_country_flag = ag_rp_round_disable_ancient_shield_project
				ag_finished_research_round = {
					ag_event_chain = ag_disable_ancient_shield_project_chain
					ag_project = ag_disable_ancient_shield_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					remove_country_flag = ag_current_research_completed
					set_country_flag = ag_research_project_801_completed
				}
			}
			ag_rp_round_repair_starfish_ship_project = {
				remove_country_flag = ag_rp_round_repair_starfish_ship_project
				ag_finished_research_round = {
					ag_event_chain = ag_repair_starfish_ship_project_chain
					ag_project = ag_repair_starfish_ship_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_802_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_repair_starlight_2_project = {
				remove_country_flag = ag_rp_round_repair_starlight_2_project
				ag_finished_research_round = {
					ag_event_chain = ag_repair_starlight_2_project_chain
					ag_project = ag_repair_starlight_2_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_2501_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_reverse_engineering_wandering_ship_project = {
				remove_country_flag = ag_rp_round_reverse_engineering_wandering_ship_project
				ag_finished_research_round = {
					ag_event_chain = ag_reverse_engineering_wandering_ship_project_chain
					ag_project = ag_reverse_engineering_wandering_ship_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_2601_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_reverse_engineering_anchor_station_project = {
				remove_country_flag = ag_rp_round_reverse_engineering_anchor_station_project
				ag_finished_research_round = {
					ag_event_chain = ag_reverse_engineering_anchor_station_project_chain
					ag_project = ag_reverse_engineering_anchor_station_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_2603_completed
					remove_country_flag = ag_current_research_completed
				}
			}
			ag_rp_round_kag_annihilator_project = {
				remove_country_flag = ag_rp_round_kag_annihilator_project
				ag_finished_research_round = {
					ag_event_chain = ag_kag_annihilator_project_chain
					ag_project = ag_kag_annihilator_project
				}
				if = {
					limit = { has_country_flag = ag_current_research_completed }
					set_country_flag = ag_research_project_9999_completed
					remove_country_flag = ag_current_research_completed
				}
			}
		}
	} }
}

# Fire research projects' completed events.
country_event = {
	id = ag_research.4
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		switch = {
			trigger = has_country_flag
			# New Research Project: (12) Create research project completed effect.
			ag_research_project_1_completed = { country_event = { id = ag_spawn.31 } ag_research_project_after_event_effect = { ag_project_id = 1 } }
			ag_research_project_2_completed = { country_event = { id = ag_ancient_knowledge.15 } ag_research_project_after_event_effect = { ag_project_id = 2 } }
			ag_research_project_3_completed = { country_event = { id = ag_ancient_knowledge.16 } ag_research_project_after_event_effect = { ag_project_id = 3 } }
			ag_research_project_4_completed = { country_event = { id = ag_ancient_knowledge.17 } ag_research_project_after_event_effect = { ag_project_id = 4 } }
			ag_research_project_5_completed = { country_event = { id = ag_ancient_knowledge.18 } ag_research_project_after_event_effect = { ag_project_id = 5 } }
			ag_research_project_6_completed = { country_event = { id = ag_ancient.204 } ag_research_project_after_event_effect = { ag_project_id = 6 } }
			ag_research_project_101_completed = { country_event = { id = ag_alpha.31 } ag_research_project_after_event_effect = { ag_project_id = 101 } }
			ag_research_project_102_completed = { country_event = { id = ag_alpha.64 } ag_research_project_after_event_effect = { ag_project_id = 102 } }
			ag_research_project_206_completed = { country_event = { id = ag_beta.61 } ag_research_project_after_event_effect = { ag_project_id = 206 } }
			ag_research_project_207_completed = { country_event = { id = ag_beta.140 } ag_research_project_after_event_effect = { ag_project_id = 207 } }
			ag_research_project_501_completed = { country_event = { id = ag_epsilon.12 } ag_research_project_after_event_effect = { ag_project_id = 501 } }
			ag_research_project_601_completed = { country_event = { id = ag_eta.102 } ag_research_project_after_event_effect = { ag_project_id = 601 } }
			ag_research_project_603_completed = { country_event = { id = ag_eta.172 } ag_research_project_after_event_effect = { ag_project_id = 603 } }
			ag_research_project_801_completed = { country_event = { id = ag_theta.22 } ag_research_project_after_event_effect = { ag_project_id = 801 } }
			ag_research_project_802_completed = { country_event = { id = ag_theta.42 } ag_research_project_after_event_effect = { ag_project_id = 802 } }
			ag_research_project_2501_completed = { country_event = { id = ag_side.35 } ag_research_project_after_event_effect = { ag_project_id = 2501 } }
			ag_research_project_2601_completed = { country_event = { id = ag_wanderer.112 } ag_research_project_after_event_effect = { ag_project_id = 2601 } }
			ag_research_project_2603_completed = { country_event = { id = ag_ancient_knowledge.19 } ag_research_project_after_event_effect = { ag_project_id = 2603 } }
			ag_research_project_9999_completed = { country_event = { id = ag_interaction.113 } ag_research_project_after_event_effect = { ag_project_id = 9999 } }
		}
	}
}
# Enters battle, end research project
country_event = {
	id = ag_research.5
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			AND = {
				check_variable = { which = ag_current_research value = @ag_repair_starfish_ship_project_id }
				fromfrom = { any_controlled_ship = { is_same_value = event_target:ag_ancient_starfish_ship } }
			}
			AND = {
				check_variable = { which = ag_current_research value = @ag_repair_starlight_2_project_id }
				fromfrom = { any_controlled_ship = { is_same_value = event_target:ag_starlight_2_ship } }
			}
			AND = {
				check_variable = { which = ag_current_research value = @ag_reverse_engineering_wandering_ship_project_id }
				fromfrom = { any_controlled_ship = { has_ship_flag = ag_ancient_wandering_ship_player } }
			}
		}
	}
	immediate = {
		if = {
			limit = { check_variable = { which = ag_current_research value = @ag_repair_starfish_ship_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_repair_starfish_ship_project_battle_message_desc"
				days = 20
				target = this
			}
		}
		else_if = {
			limit = { check_variable = { which = ag_current_research value = @ag_repair_starlight_2_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_repair_starlight_2_project_battle_message_desc"
				days = 20
				target = this
			}
		}
		else_if = {
			limit = { check_variable = { which = ag_current_research value = @ag_reverse_engineering_wandering_ship_project_id } }
			remove_country_flag = ag_research_project_ongoing
			if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_1_id } }
				set_variable = { which = ag_research_1_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_2_id } }
				set_variable = { which = ag_research_2_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_3_id } }
				set_variable = { which = ag_research_3_status value = 1 }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_research value = ag_research_4_id } }
				set_variable = { which = ag_research_4_status value = 1 }
			}
			ag_save_current_progress = { clear_current_research = yes }
			create_message = {
				type = "message_ag_research_project_abort"
				localization = "ag_reverse_engineering_wandering_ship_project_battle_message_desc"
				days = 20
				target = this
			}
		}
	}
}
country_event = {
	id = ag_research.6
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			last_increased_tech = tech_ag_beta_station_type1
			last_increased_tech = tech_ag_beta_station_type2
			last_increased_tech = tech_ag_gamma_station
			last_increased_tech = tech_ag_delta_titan
			last_increased_tech = tech_ag_delta_platform
		}
	}
	immediate = {
		if = {
			limit = { has_country_flag = ag_has_research_project_2601 }
			ag_iota_data_research_buff = { ag_project_id = 2601 ag_no_change_difficulty = yes }
		}
	}
}
