# Filename:		scluster_event_overwrites.txt
# Contributors:	SirBlackAxe

##########################################
# galactic_features_events.txt
##########################################
namespace = galactic_features

# MODJAM manager overwrites galactic_features.400, making it require has_global_flag = space_storms_allowed to start a storm

# Make space storms spawn in the storm cluster nebula?

# The Storm Ends
country_event = {
	id = galactic_features.403
	hide_window = yes

	is_triggered_only = yes
	# trigger = { NOT = { has_global_flag = scluster_in_progress } } # Not added

	immediate = {
	### Added
		if = { # Storm can't end while crisis is active
			limit = { has_global_flag = scluster_in_progress }
			set_global_flag = scluster_in_overtime
			# event_target:global_event_country = {
			# 	country_event = { id = scluster.403 }
			# 	days = 360
			# }
		}
		else = {
			remove_global_flag = scluster_in_overtime
	### End added
			remove_global_flag = ongoing_space_storm
			set_timed_global_flag = { flag = space_storm_cooldown years = 20 }
			every_system = {
				limit = {
					has_star_flag = storm_system
					NOR = { # Added 
						has_star_flag = scluster
						has_star_flag = scluster_entrance
					}
				}
				random_system_ambient_object = {
					limit = { has_ambient_object_flag = space_storm_object }
					destroy_ambient_object = this
				}
				remove_star_flag = storm_system
				remove_modifier = space_storm
				# if = { # Added (scluster)
				# 	limit = {
				# 		NOR = {
				# 			has_star_flag = storm_system
				# 		}
				# 	}
				# }
			}
			if = {
				limit = { is_galactic_community_formed = yes }
				every_playable_country = {
					limit = { is_ai = no }
					country_event = { id = galactic_features.406 }
				}
			}
			else = {
				every_playable_country = {
					limit = { is_ai = no }
					country_event = { id = galactic_features.404 }
				}
			}
		}
	}
}

##########################################
# fallen_empires_awakening_events.txt
##########################################
namespace = fallen_empires_awakening

# Required to prevent the Deep Sleepers from being chosen as the target of a War in Heaven.

# Sleepers Awake
country_event = {
	id = fallen_empires_awakening.1
	title = OK
	desc = OK
	hide_window = yes
	trigger = {
		is_country_type = fallen_empire
		NOT = { has_country_flag = awakening_not_allowed } # Added
		OR = {
			# Fragged a holy world
			has_country_flag = holy_world_killed
			# Original trigger
			AND = {
				NOR = {
					has_global_flag = sleepers_awake_happened 
					has_global_flag = guardians_of_the_galaxy_happened 
				}
				end_game_years_passed >= 0
				NOT = { has_ethic = ethic_gestalt_consciousness }
				is_at_war = no
				fleet_power > 60000
				# Wake up if regular empire is growing too strong or has started to conquer other fallen empires
				any_playable_country = {
					OR = {
						fleet_power > 70000
						AND = {
							has_federation = yes
							federation = {
								fleet_power > 90000
							}
						}
						any_owned_planet = {
							has_planet_flag = fallen_empire_world
						}
					}
				}
			}
		}
	}

	mean_time_to_happen = {
		years = 50
		modifier = {
			factor = 0.5
			any_playable_country = {
				fleet_power > 120000
			}
		}
		modifier = {
			factor = 1.5
			num_fallen_empires > 1
			num_fallen_empires < 3
		}
		modifier = {
			factor = 2.0
			num_fallen_empires > 2
			num_fallen_empires < 4
		}
		modifier = {
			factor = 2.5
			num_fallen_empires > 3
		}
		modifier = {
			factor = 0.1
			any_playable_country = {
				any_owned_planet = {
					has_planet_flag = fallen_empire_world
					NOT = { is_original_owner = root }
				}
			}
		}
	}

	immediate = {
		set_global_flag = sleepers_awake_happened

		country_event = { id = fallen_empires_awakening.3 }

		# Notify players
		every_playable_country = {
			limit = {
				is_ai = no
			}
			country_event = { id = fallen_empires_awakening.2 }
		}
		observer_event = { id = observer.73 }

		# Fragged a holy world
		if = {
			limit = {
				has_country_flag = holy_world_killed
			}
			country_event = { id = planet_destruction.611 days = 5 }
		}

		# War in Heaven
		if = {
			limit = { has_leviathans = yes }
			random_list = {
				40 = { # War in Heaven with Fallen Empire of opposing ethos
					random_country = {
						limit = {
							NOT = { is_same_value = root }
							is_country_type = fallen_empire
							NOT = { has_ethic = ethic_gestalt_consciousness }
							OR = {
								AND = {
									has_ethic = ethic_fanatic_xenophobe
									root = { has_ethic = ethic_fanatic_xenophile }
								}
								AND = {
									has_ethic = ethic_fanatic_xenophile
									root = { has_ethic = ethic_fanatic_xenophobe }
								}
								AND = {
									has_ethic = ethic_fanatic_spiritualist
									root = { has_ethic = ethic_fanatic_materialist }
								}
								AND = {
									has_ethic = ethic_fanatic_materialist
									root = { has_ethic = ethic_fanatic_spiritualist }
								}
							}
						}
						set_country_flag = sleepers_awake_ancient_rival
						set_timed_country_flag = { flag = timed_ancient_rival days = 3650 }
						set_timed_country_flag = { flag = ai_no_wars days = 3650 }
						root = { set_timed_country_flag = { flag = ai_no_wars days = 3650 } }
						every_playable_country = {
							limit = { }
							set_timed_country_flag = { flag = ai_no_wars days = 3650 }
						}
					}
				}
				20 = { # War in Heaven with Fallen Empire of different ethos
					random_country = {
						limit = {
							NOT = { is_same_value = root }
							is_country_type = fallen_empire
							NOR = {
								has_ethic = ethic_gestalt_consciousness 
								has_ethic = ethic_fanatic_pacifist 
							} # Added
						}
						set_country_flag = sleepers_awake_ancient_rival
						set_timed_country_flag = { flag = timed_ancient_rival days = 3650 }
						set_timed_country_flag = { flag = ai_no_wars days = 3650 }
						root = { set_timed_country_flag = { flag = ai_no_wars days = 3650 } }
						every_playable_country = {
							limit = {
								}
							set_timed_country_flag = { flag = ai_no_wars days = 3650 }
						}
					}
				}
				40 = { # No War in Heaven
					set_global_flag = no_war_in_heaven
				}
			}
		}
		else = { set_global_flag = no_war_in_heaven }
	}
}

### Space Monster respawn #######################################
# Issue: spy orb blocks space critter respawns
# event = { id = galactic_features.362
