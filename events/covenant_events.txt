#MODIFIED
namespace = covenant_events
@extension_time = 720

country_event = {#Bound soul also causes some psychics, like latent psionic
    id=covenant_events.1
    is_triggered_only = yes
    hide_window=yes

    trigger = {
        from = {
            species = {
                OR = {
                    has_trait = trait_bound_soul
                    has_trait = trait_severed_bond
                }
            }
        }
    }

    immediate = {
		from = {
			if = {
				limit = { leader_class = admiral }
				add_trait = leader_trait_admiral_psionic
				add_ruler_trait = leader_trait_ruler_psionic
				break = yes
			}
			if = {
				limit = { leader_class = general }
				add_trait = leader_trait_general_psionic
				add_ruler_trait = leader_trait_ruler_psionic
				break = yes
			}
			if = {
				limit = { leader_class = governor }
				add_trait = leader_trait_governor_psionic
				add_ruler_trait = leader_trait_ruler_psionic
				break = yes
			}
			if = {
				limit = { leader_class = scientist }
				add_trait = leader_trait_scientist_psionic
				add_ruler_trait = leader_trait_ruler_psionic
				break = yes
			}
			if = {
				limit = { leader_class = ruler }
				add_trait = leader_trait_ruler_psionic
				add_ruler_trait = leader_trait_ruler_psionic
				break = yes
			}
		}
	}
}

planet_event = {
    id=covenant_events.2
    is_triggered_only = yes
    hide_window=yes

    trigger = {
        owner = {
			OR = {
				has_modifier = covenant_end_of_the_cycle
				AND = {
					is_subject = yes
					overlord = { has_modifier = covenant_end_of_the_cycle }
				}				
			}	
		}
		NOT = { has_modifier = covenant_shroud_marked }
    }

    immediate = {
        add_modifier = { modifier = covenant_shroud_marked days = -1 }
    }
}

country_event = {
	id=covenant_events.3
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		if = {
			limit = {
				check_variable = {
					which = sacrifices
					value >0
				}
			}
			subtract_variable = {
				which = sacrifices
				value = 1
			}
			add_event_chain_counter = {
				event_chain = "cycle_sacrifices_chain"
				counter = sacrifices_consumed
				amount = 1
			}
			if ={
				limit = {
					OR = {
						check_variable = {
							which = sacrifices
							value <1
						}
						NOT = {has_country_flag = borrowed_time}
					}
				}
				country_event = {id = covenant_events.4}
			}
			add_modifier = {
				modifier = covenant_end_of_the_cycle
				days = @extension_time
			}
			country_event = {id = covenant_events.3 days = @extension_time}
		}
		else = {
			end_event_chain = "cycle_sacrifices_chain"
			country_event = {id = utopia.3320}
		}
	}
}

country_event = {
	id = covenant_events.4
	is_triggered_only = yes
	title = "covenant_events.4.name"
	picture = GFX_evt_unspeakable_horror

	desc = {
		text = "covenant_events.4.desc.a"
		trigger = {
			NOT = {has_country_flag = borrowed_time}
			check_variable = {
				which = sacrifices
				value >0
			}
		}
	}
	desc = {
		text = "covenant_events.4.desc.b"
		trigger = {
			NOT = {has_country_flag = borrowed_time}
			check_variable = {
				which = sacrifices
				value <1
			}
		}
	}

	desc = {
		text = "covenant_events.4.desc.c"
		trigger = {
			has_country_flag = borrowed_time
			check_variable = {
				which = sacrifices
				value <1
			}
		}
	}

	option = {
		name = "covenant_events.4.opt.a"
		hidden_effect = {
			if = {
				limit = {NOT = {has_country_flag = borrowed_time}}
				set_country_flag = borrowed_time
			}
		}
	}
}
planet_event = {
	id = covenant.100
	is_triggered_only = yes
	hide_window = yes


	immediate = {
		from.owner = { country_event = { id = covenant.101 } }
		

		# Contingency Machine World
		if = {
			limit = { 
				is_planet_class = pc_ai 
				NOT = { has_planet_flag = machine_lair }
			}
			set_planet_flag = destroyed_by_colossus
			set_planet_flag = planet_cracked
			planet_event = { id = crisis.2040 }
		}

		# Contingency Final Machine World
		if = {
			limit = { 
				is_planet_class = pc_ai 
				has_planet_flag = machine_lair
			}
			set_planet_flag = destroyed_by_colossus
			set_planet_flag = planet_cracked
			from.owner = { save_event_target_as = final_machine_world_destroyer }
			planet_event = { id = crisis.2043 }
		}

		# Swarm Situation Log counter
		if = {
			limit = {
				owner = { is_country_type = swarm }
			}
			every_country = {
				limit = { has_event_chain = "prethoryn_scourge_chain" }
				add_event_chain_counter = {
					event_chain = "prethoryn_scourge_chain"
					counter = "infested_worlds"
					amount = -1 
				}
				add_event_chain_counter = {
					event_chain = "prethoryn_scourge_chain"
					counter = "infested_worlds_cleansed"
					amount = 1 
				}
			}
		}
		
		# Exterminatus Achievement
		if = {
			limit = { is_capital = yes }
			from.owner = { set_country_flag = exterminatus }
		}
		if = {
			limit = {
				exists = owner
				owner = {
					NOT = { is_same_value = from.owner }
					OR = {
						is_country_type = default
						is_country_type = fallen_empire
						is_country_type = awakened_fallen_empire
					}
				}
			}
			# Generate threat
			if = {
				limit = {
					is_colony = yes
				}
				add_threat = { who = from.owner amount = 3 }
				# modifier for allies + those upset by genocide
				every_country = {
					limit = {
						NOR = {
							is_same_value = from.owner
							is_same_value = root.owner
							AND = {
								has_federation = yes
								is_in_federation_with = from.owner
							}
						}
						OR = {
							has_communications = from.owner
							has_communications = root.owner
						}
						OR = {
							AND = {
								has_federation = yes
								is_in_federation_with = root.owner
							}
							has_ai_personality = awakened_fallen_empire_xenophile
							AND = {
								is_country_type = default
								OR = {
									is_egalitarian = yes
									is_xenophile = yes
								}
							}
						}
					}
					if = {
						limit = { root = { is_colony = no } }
						add_opinion_modifier = {
							modifier = opinion_shroud_an_uninhabited_world
							who = from.owner
						}
					}
					else = {
						add_opinion_modifier = {
							modifier = opinion_shroud_a_world
							who = from.owner
						}
					}
				}
			}
			else = {
				add_threat = { who = from.owner amount = 1 }
			}
			# modifiers for victim
			owner = {
				if = {
					limit = { root = { is_colony = no } }
					add_opinion_modifier = {
						modifier = opinion_shroud_my_uninhabited_world
						who = from.owner
					}
				}
				else = {
					add_opinion_modifier = {
						modifier = opinion_shroud_my_world
						who = from.owner
					}
				}
				if = {
					limit = { NOT = { has_ethic = ethic_gestalt_consciousness } }
					add_modifier = {
						modifier = colossus_victim
						days = 10800 # 30 years
					}
				}
			}
			if = {
				limit = {
					exists = owner
					owner = { is_country_type = primitive }
				}
				# modifier for allies + those upset by genocide
				every_country = {
					limit = {
						NOT = { is_same_value = from.owner }
						OR = {
							has_communications = from.owner
							has_communications = root.owner
						}
						OR = {
							has_ai_personality = awakened_fallen_empire_xenophile
							AND = {
								is_country_type = default
								NOR = {
									is_xenophobe = yes
									is_homicidal = yes
									is_xenophile = yes
								}
							}
						}
					}
					add_opinion_modifier = {
						modifier = opinion_shroud_a_primitive_world
						who = from.owner
					}
				}
				every_country = {
					limit = {
						NOT = { is_same_value = from.owner }
						OR = {
							has_communications = from.owner
							has_communications = root.owner
						}
						OR = {
							has_ai_personality = awakened_fallen_empire_xenophile
							AND = {
								is_country_type = default
								is_xenophile = yes
							}
						}
					}
					add_opinion_modifier = {
						modifier = opinion_shroud_a_primitive_world_phile
						who = from.owner
					}
				}
			}
		}
		# Add war exhaustion to planet owner 
		if = {
			limit = {
				exists = owner
			}
			owner = {
				add_static_war_exhaustion = {
					attacker = from.fleet.owner
					location = root
					value_for_planet_destruction = 1.0
				}
			}			
		}
		every_owned_pop = {
			kill_pop = yes
		}
		remove_all_buildings = yes
		# destroy habitats and ringworlds
		if = {
			limit = {
				is_planet_class = pc_habitat
			}
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = {
				is_planet_class = pc_ringworld_habitable
			}
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
		}
		else_if = {
			limit = { habitable_planet = yes }
			change_pc = pc_shrouded
			clear_deposits = yes
			random_list = {
				1 = {
					add_deposit = d_energy_4
					add_deposit = d_energy_4
					add_deposit = d_energy_4
					add_deposit = d_energy_4
				}
				1 = {
					add_deposit = d_energy_4
					add_deposit = d_energy_4
					add_deposit = d_energy_4
				}
				1 = {
					add_deposit = d_energy_4
					add_deposit = d_energy_4
				}
				1 = {
					add_deposit = d_energy_4
				}
			}
		}
		else = {
			change_pc = pc_shrouded
			clear_deposits = yes
		}
	}
}

country_event = {
	id = covenant.101
	title = covenant.101.name
	desc = covenant.101.desc
	picture = GFX_evt_planet_beam
	show_sound = event_solar_fusion
	location = from
	

	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = fired_lustre }
	}

	immediate = {
		set_country_flag = fired_lustre
	}

	option = {
		name = covenant.101.a
		trigger = {
			NOR = {
				has_valid_civic = civic_fanatic_purifiers
				has_valid_civic = civic_machine_terminator
			}
		}
	}

	option = {
		name = covenant.101.a
		trigger = {
			OR = {
				has_valid_civic = civic_fanatic_purifiers
				has_valid_civic = civic_machine_terminator
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = 60
			min = 600
			max = 3000
		}
	}
}