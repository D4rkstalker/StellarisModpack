namespace = eo_immortal_messiah

#####Setup Immortal Messiah
country_event = {
	id = eo_immortal_messiah.1
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		has_origin = origin_immortal_messiah
	}
	
	immediate = {
		ruler = {
			set_age = 2200
			set_immortal = yes
			add_trait_no_notify = leader_trait_chosen
			add_trait_no_notify = leader_trait_immortal_messiah
			set_skill = 4
			set_leader_flag = immortal_messiah
			set_leader_flag = legendary_leader
			#set_leader_flag = immune_to_negative_traits
			if = {
				limit = { has_paragon_dlc = yes }
				switch = {
					trigger = leader_class
					admiral = {
						add_trait_no_notify = subclass_admiral_strategist
					}
					general = {
						add_trait_no_notify = subclass_general_marshall
					}
					governor = {
						add_trait_no_notify = subclass_governor_visionary
					}
					scientist = {
						add_trait_no_notify = subclass_scientist_researcher
					}
				}
			}
		}
	}
}

#####Messiah dies
country_event = {
	id = eo_immortal_messiah.2
	title = eo_immortal_messiah.2.name
	desc = eo_immortal_messiah.2.desc
	picture = GFX_evt_civil_action
	show_sound = event_public_unrest

	is_triggered_only = yes
	
	trigger = {
		has_origin = origin_immortal_messiah
		from = { has_leader_flag = immortal_messiah }
	}
	immediate = {
		clone_leader = {
			target = from
			effect = {
				save_event_target_as = immortal_messiah
				exile_leader_as = immortal_messiah
			}
		}
	}

	option = {
		name = eo_immortal_messiah.2.a
		add_modifier = {
			modifier = messiah_dead
			days = -1
		}
		add_modifier = {
			modifier = grieving_messiah
			days = 3600
		}
		if = {
			limit = {
				has_modifier = messiah_resurrected
			}
			remove_modifier = messiah_resurrected
		}
	}
	after = {
		country_event = { id = eo_immortal_messiah.3 days = 30 }
	}
}

#####Messiah funeral
country_event = {
	id = eo_immortal_messiah.3
	title = eo_immortal_messiah.3.name
	desc = eo_immortal_messiah.3.desc
	picture = GFX_evt_space_funeral
	show_sound = event_mystic_reveal

	is_triggered_only = yes

	option = {
		name = eo_immortal_messiah.3.a
		add_modifier = {
			modifier = guidance_from_beyond
			days = -1
		}
	}
	after = {
		hidden_effect = {
			country_event = { id = eo_immortal_messiah.4 days = 5 } # 3650 }
		}
	}
}

##### Messiah resurrection check
country_event = {
	id = eo_immortal_messiah.4
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		save_event_target_as = immortal_messiah_country
		if = {
			limit = {
				any_country = {
					is_country_type = shroud
					has_communications = event_target:immortal_messiah_country
				}
			}
			country_event = { id = eo_immortal_messiah.5 days = 5 } # 1825 random = 1825 }
		}
		else = {
			country_event = { id = eo_immortal_messiah.4 days = 5 } # 3650 }
		}
	}
}

##### Psionic Pulse
country_event = {
	id = eo_immortal_messiah.5
	title = eo_immortal_messiah.5.name
	desc = eo_immortal_messiah.5.desc
	picture = GFX_evt_surreal_visions
	show_sound = event_mystic_reveal

	is_triggered_only = yes

	option = {
		name = eo_immortal_messiah.5.a
	}
	after = {
		hidden_effect = {
			country_event = { id = eo_immortal_messiah.6 }
		}
	}
}

# The Messiah returns!
country_event = {
	id = eo_immortal_messiah.6
	title = eo_immortal_messiah.6.name
	desc = {
		text = eo_immortal_messiah.6.desc
		trigger = {
			NOT = { has_country_flag = messiah_challenged }
		}
	}
	desc = {
		text = eo_immortal_messiah.6.desc.challenged_passed
		trigger = {
			has_country_flag = messiah_challenged_passed
		}
	}
	desc = {
		text = eo_immortal_messiah.6.desc.challenged_questionable
		trigger = {
			has_country_flag = messiah_challenged_questionable
		}
	}
	desc = {
		text = eo_immortal_messiah.6.desc.challenged_doubtful
		trigger = {
			has_country_flag = messiah_challenged_doubtful
		}
	}
	diplomatic_title = eo_immortal_messiah.6.title
	diplomatic = yes

	picture_event_data = {
		portrait = event_target:immortal_messiah
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				NOT = { has_country_flag = messiah_resurrection_rolled }
			}
			random_list = {
				90 = { }
				10 = { set_country_flag = messiah_shroud_impostor }
			}
			set_country_flag = messiah_resurrection_rolled
		}
	}

	option = { # How did you survive?
		name = eo_immortal_messiah.6.d
		custom_tooltip = messiah_trustworthiness
		response_text = eo_immortal_messiah.6.d.desc
		is_dialog_only = yes
	}
	option = { # What was it like?
		name = eo_immortal_messiah.6.f
		custom_tooltip = messiah_trustworthiness
		response_text = eo_immortal_messiah.6.f.desc
		is_dialog_only = yes
	}
	option = { # Prove it's you
		name = eo_immortal_messiah.6.e
		custom_tooltip = eo_immortal_messiah.6.e.tooltip
		hidden_effect = {
			set_country_flag = messiah_challenged
			set_country_flag = messiah_challenged_conversation
			random_list = {
				30 = { # Probably them
					set_country_flag = messiah_challenged_passed
					country_event = { id = eo_immortal_messiah.6 }
					modifier = {
						factor = 2
						AND = {
							has_country_flag = messiah_resurrected_bad_outcome
							NOT = { has_country_flag = messiah_shroud_impostor }
						}
					}
					modifier = {
						factor = 0
						has_country_flag = messiah_shroud_impostor
					}
				}
				30 = { # Maybe them
					set_country_flag = messiah_challenged_questionable
					country_event = { id = eo_immortal_messiah.6 }
					modifier = {
						factor = 0.5
						NOT = { has_country_flag = messiah_shroud_impostor }
					}
				}
				30 = { # Probably not them
					set_country_flag = messiah_challenged_doubtful
					country_event = { id = eo_immortal_messiah.6 }
					modifier = {
						factor = 0.2
						NOT = { has_country_flag = messiah_shroud_impostor }
					}
					modifier = {
						factor = 2
						has_country_flag = messiah_resurrected_bad_outcome
					}
				}
				10 = { # Not them
					country_event = { id = eo_immortal_messiah.8 }
					modifier = {
						factor = 0
						NOT = { has_country_flag = messiah_shroud_impostor }
					}
					modifier = {
						factor = 2
						has_country_flag = messiah_resurrected_bad_outcome
					}
				}
			}
		}
		allow = {
			custom_tooltip = {
				fail_text = eo_immortal_messiah.6.e.messiah_challenged
				NOT = { has_country_flag = messiah_challenged }
			}
		}
	}
	option = { # Yes, please be emperor again
		name = eo_immortal_messiah.6.b
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.6.b.tooltip
		tooltip = {
			if = {
				limit = {
					NOR = {
						has_authority = auth_dictatorial
						has_authority = auth_imperial
					}
				}
				change_government = {
					authority = auth_imperial
					cooldown = no
					remove_invalid_civics = yes
				}
			}
			messiah_resurrection_cleanup = yes
		}
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.9 }
			}
			else = {
				set_leader = event_target:immortal_messiah
				event_target:immortal_messiah = {
					set_leader_flag = immortal_messiah
				}
				if = {
					limit = {
						NOR = {
							has_authority = auth_dictatorial
							has_authority = auth_imperial
						}
					}
					change_government = {
						authority = auth_imperial
						cooldown = no
						remove_invalid_civics = yes
					}
				}
				messiah_resurrection_cleanup = yes
			}
		}
	}
	option = { # We have moved on
		name = eo_immortal_messiah.6.c
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.6.c.tooltip
		hidden_effect = {
			country_event = { id = eo_immortal_messiah.7 }
		}
	}
	option = { # This is not our Messiah
		name = eo_immortal_messiah.6.g
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.6.g.tooltip
		hidden_effect = {
			messiah_conversation_cleanup = yes
			country_event = { id = eo_immortal_messiah.4 days = 3650 }
		}
	}
}

# The Messiah returns (rejected)
country_event = {
	id = eo_immortal_messiah.7
	title = eo_immortal_messiah.6.name
	desc = eo_immortal_messiah.7.desc
	diplomatic_title = eo_immortal_messiah.6.title
	diplomatic = yes

	picture_event_data = {
		portrait = event_target:immortal_messiah
		room = shroud_room
	}

	is_triggered_only = yes

	option = { # Governor
		name = eo_immortal_messiah.7.a
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.7.a.tooltip
		tooltip = {
			messiah_resurrection_cleanup = yes
		}
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.9 }
			}
			else = {
				clone_leader = {
					target = event_target:immortal_messiah
					class = governor
					traits = {
						trait = leader_trait_chosen
						trait = leader_trait_army_veteran
						trait = leader_trait_intellectual
					}
					effect = {
						set_leader_flag = immortal_messiah
					}
				}
				event_target:immortal_messiah = {
					kill_leader = { show_notification = no }
				}
				messiah_resurrection_cleanup = yes
			}
		}
	}
	option = { # Scientist
		name = eo_immortal_messiah.7.b
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.7.b.tooltip
		tooltip = {
			messiah_resurrection_cleanup = yes
		}
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.9 }
			}
			else = {
				clone_leader = {
					target = event_target:immortal_messiah
					class = scientist
					traits = {
						trait = leader_trait_hosen
						trait = leader_trait_spark_of_genius
						trait = leader_trait_maniacal
						trait = leader_trait_expertise_psionics
					}
					effect = {
						set_leader_flag = immortal_messiah
					}
				}
				event_target:immortal_messiah = {
					kill_leader = { show_notification = no }
				}
				messiah_resurrection_cleanup = yes
			}
		}
	}
	option = { # Admiral
		name = eo_immortal_messiah.7.c
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.7.c.tooltip
		tooltip = {
			messiah_resurrection_cleanup = yes
		}
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.9 }
			}
			else = {
				clone_leader = {
					target = event_target:immortal_messiah
					class = admiral
					traits = {
						trait = leader_trait_chosen
						trait = leader_trait_aggressive
						trait = leader_trait_gale_speed
					}
					effect = {
						set_leader_flag = immortal_messiah
					}
				}
				event_target:immortal_messiah = {
					kill_leader = { show_notification = no }
				}
				messiah_resurrection_cleanup = yes
			}
		}
	}
	option = { # General
		name = eo_immortal_messiah.7.d
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.7.d.tooltip
		tooltip = {
			messiah_resurrection_cleanup = yes
		}
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.9 }
			}
			else = {
				clone_leader = {
					target = event_target:immortal_messiah
					class = general
					traits = {
						trait = leader_trait_chosen
						trait = leader_trait_charismatic
						trait = leader_trait_butcher
					}
					effect = {
						set_leader_flag = immortal_messiah
					}
				}
				event_target:immortal_messiah = {
					kill_leader = { show_notification = no }
				}
				messiah_resurrection_cleanup = yes
			}
		}
	}
	option = { # Perhaps we should reconsider
		custom_tooltip = messiah_trustworthiness
		name = eo_immortal_messiah.7.e
		hidden_effect = {
			country_event = { id = eo_immortal_messiah.6 }
		}
	}
	option = { # No, your time is over
		custom_tooltip = messiah_trustworthiness
		name = eo_immortal_messiah.7.f
		tooltip = {
			messiah_resurrection_cleanup = yes
		}
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.9 }
			}
			else = {
				messiah_resurrection_cleanup = yes
			}
		}
	}
	option = { # This is not our Messiah
		name = eo_immortal_messiah.6.g
		custom_tooltip = messiah_trustworthiness
		custom_tooltip = eo_immortal_messiah.6.g.tooltip
		hidden_effect = {
			messiah_conversation_cleanup = yes
			country_event = { id = eo_immortal_messiah.4 days = 3650 }
		}
	}
	after = {
		remove_country_flag = messiah_challenged_conversation
	}
}

# An impostor is revealed!
country_event = {
	id = eo_immortal_messiah.8
	title = eo_immortal_messiah.8.name
	desc = eo_immortal_messiah.8.desc
	diplomatic_title = eo_immortal_messiah.8.title
	diplomatic = yes

	picture_event_data = {
		portrait = event_target:immortal_messiah
		room = shroud_room
	}

	is_triggered_only = yes

	option = {
		name = eo_immortal_messiah.8.a
	}
	after = {
		messiah_conversation_cleanup = yes
		hidden_effect = {
			if = {
				limit = {
					has_country_flag = messiah_shroud_impostor
				}
				country_event = { id = eo_immortal_messiah.4 days = 3650 }
			}
		}
	}
}

##### Shroud Impostor
country_event = {
	id = eo_immortal_messiah.9
	title = eo_immortal_messiah.9.name
	desc = eo_immortal_messiah.9.desc
	picture = GFX_evt_space_monster
	show_sound = event_red_alert

	is_triggered_only = yes

	immediate = {
		set_country_flag = messiah_resurrected_bad_outcome
		hidden_effect = {
			capital_scope = {
				random_owned_pop = {
					limit = {
						is_being_purged = no
					}
					kill_pop = yes
				}
				random_owned_pop = {
					limit = {
						is_being_purged = no
					}
					kill_pop = yes
				}
				random_owned_pop = {
					limit = {
						is_being_purged = no
					}
					kill_pop = yes
				}
			}
			if = {
				limit = { NOT = { exists = event_target:shroud_country } }
				create_country = {
					name = "NAME_Creatures_of_the_Shroud"
					type = shroud_spirits
					flag = {
						icon = {
							category = "special"
							file = "the_shroud.dds"
						}
						background= {
							category = "backgrounds"
							file = "00_solid.dds"
						}
						colors={
							"dark_purple"
							"black"
							"null"
							"null"
						}
					}
				}
				last_created_country = {
					establish_communications_no_message = root
					save_global_event_target_as = shroud_country
				}
			}
			else = {
				event_target:shroud_country = {
					establish_communications_no_message = root
				}
			}
			create_fleet = {
				name = "NAME_Psionic_Entity"
				settings = {
					spawn_debris = no
					is_boss = yes
				}
				effect = {
					set_owner = event_target:shroud_country
					create_ship = {
						name = "NAME_Psionic_Entity"
						design = "NAME_Corrupted_Avatar"
					}
					set_location = root.capital_scope
					set_fleet_stance = aggressive
					set_aggro_range_measure_from = return_point
					set_aggro_range = 2000
					set_fleet_flag = immortal_messiah_shroud_entity_incursion
				}
			}
		}
	}

	option = {
		name = eo_immortal_messiah.9.a
		custom_tooltip = eo_immortal_messiah.9.a.tooltip
		tooltip = {
			capital_scope = {
				random_owned_pop = {
					limit = {
						is_being_purged = no
					}
					kill_pop = yes
				}
				random_owned_pop = {
					limit = {
						is_being_purged = no
					}
					kill_pop = yes
				}
				random_owned_pop = {
					limit = {
						is_being_purged = no
					}
					kill_pop = yes
				}
			}
		}
		hidden_effect = {
			country_event = { id = eo_immortal_messiah.4 days = 3650 }
		}
	}
}

##### Shroud Impostor defeated
country_event = {
	id = eo_immortal_messiah.10
	title = eo_immortal_messiah.10.name
	desc = eo_immortal_messiah.10.desc
	picture = GFX_evt_space_monster
	show_sound = event_red_alert

	is_triggered_only = yes
	
	trigger = {
		has_origin = origin_immortal_messiah
		FromFromFrom = {
			has_fleet_flag = immortal_messiah_shroud_entity_incursion
		}
	}

	option = {
		name = eo_immortal_messiah.10.a
	}
}

##### The people celebrate
country_event = {
	id = eo_immortal_messiah.11
	title = eo_immortal_messiah.11.name
	desc = {
		text = eo_immortal_messiah.11.desc.ruler
		trigger = {
			ruler = {
				has_leader_flag = immortal_messiah
			}
		}
	}
	desc = {
		text = eo_immortal_messiah.11.desc.leader
		trigger = {
			any_owned_leader = {
				has_leader_flag = immortal_messiah
				is_ruler = no
			}
		}
	}
	desc = {
		text = eo_immortal_messiah.11.desc.citizen
		trigger = {
			NOT = {
				any_owned_leader = {
					has_leader_flag = immortal_messiah
				}
			}
		}
	}
	picture = {
		trigger = {
			ruler = {
				has_leader_flag = immortal_messiah
			}
		}
		picture = GFX_evt_coronation
	}
	picture = {
		trigger = {
			any_owned_leader = {
				has_leader_flag = immortal_messiah
				is_ruler = no
			}
		}
		picture = GFX_evt_crisis_defeated
	}
	picture = {
		trigger = {
			NOT = {
				any_owned_leader = {
					has_leader_flag = immortal_messiah
				}
			}
		}
		picture = GFX_evt_alien_propaganda
	}
	show_sound = event_celebration

	is_triggered_only = yes

	immediate = {
		random_owned_leader = {
			limit = {
				has_leader_flag = immortal_messiah
			}
			save_event_target_as = immortal_messiah
		}
	}

	option = {
		name = {
			text = eo_immortal_messiah.11.a
			trigger = {
				ruler = {
					has_leader_flag = immortal_messiah
				}
			}
		}
		name = {
			text = eo_immortal_messiah.11.c
			trigger = {
				any_owned_leader = {
					has_leader_flag = immortal_messiah
					is_ruler = no
				}
			}
		}
		name = {
			text = eo_immortal_messiah.11.b
			trigger = {
				NOT = {
					any_owned_leader = {
						has_leader_flag = immortal_messiah
					}
				}
			}
		}
		add_modifier = {
			modifier = messiah_resurrected
			days = 3600
		}
	}
}