namespace = projcrim_situation

## Situation 1
# Analysing the Parasite - Outcome
country_event = { 
	id = projcrim_situation.1
	title = "projcrim_situation.1.name"
	desc = "projcrim_situation.1.desc"
	picture = GFX_evt_board_meeting
	show_sound = event_activating_unknown_technology

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.1.a"
		custom_tooltip = projcrim_sit1_end
		add_research_option = tech_projcrim_mist_filtration
		add_tech_progress = {
			tech = tech_projcrim_mist_filtration
			progress = 0.15
		}
		add_research_option = tech_projcrim_genetic_processing
		add_tech_progress = {
			tech = tech_projcrim_genetic_processing
			progress = 0.15
		}
	}
}

# Analysing the Parasite - Part 2 Start
situation_event = { 
	id = projcrim_situation.2
	title = "projcrim_situation.2.name"
	desc = "projcrim_situation.2.desc"
	picture = GFX_evt_two_sided_deal
	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
		owner = {
			add_resource = {
				energy = 2500
				consumer_goods = 2000
			}
		}
	}

	option = {
		name = "projcrim_situation.2.a"
		owner = {
			add_resource = {
				energy = 2500
				consumer_goods = 2000
			}
		}
	}
}

# Analysing the Parasite - Part 3 Start
situation_event = { 
	id = projcrim_situation.3
	title = "projcrim_situation.2.name"
	desc = "projcrim_situation.3.desc"
	picture = GFX_evt_engineering_research
	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.2.a"
		owner = {
			add_tech_option_or_research_effect = {
				TECH = tech_advanced_metallurgy_1
				PROGRESS = 0.50
				CATEGORY = engineering_research
			}
		}
	}
}

## Situation 2
# Finding a Cure - Outcome
country_event = { 
	id = projcrim_situation.4
	title = "projcrim_situation.4.name"
	desc = "projcrim_situation.4.desc"
	picture = GFX_evt_scientific_experiments
	show_sound = event_activating_unknown_technology

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.4.a"
		custom_tooltip = projcrim_sit2_end
			add_resource = {
				energy = 2500
				minerals = 5000
			}
			capital_scope = {
				enable_special_project = {
					name = projcrim_cure_finalisation
					location = this
					owner = root.owner
				}
			}
	}
}

# Finding a Cure - Part 2 Start
situation_event = { 
	id = projcrim_situation.5
	title = "projcrim_situation.2.name"
	desc = "projcrim_situation.5.desc"
	picture = GFX_evt_partition
	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.5.a"
		owner = {
			random_owned_pop = {
				kill_pop = yes
			}
			add_resource = {
				society_research = 750
			}
		}
	}
}

# Finding a Cure - Part 3 Start
situation_event = { 
	id = projcrim_situation.6
	title = "projcrim_situation.2.name"
	desc = "projcrim_situation.6.desc"
	picture = GFX_evt_partition
	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.6.a"
		owner = {
			add_resource = {
				unity = 2500
				influence = 100
			}
		}
	}
}

## Other Events
# Researching the Techs
country_event = { 
	id = projcrim_situation.7
	title = "projcrim_situation.7.name"
	desc = "projcrim_situation.7.desc"
	picture = GFX_evt_society_research
	show_sound = event_activating_unknown_technology

	is_triggered_only = yes

	trigger = {
		has_technology = tech_projcrim_mist_filtration
		has_technology = tech_projcrim_genetic_processing
		OR = {
			last_increased_tech = tech_projcrim_mist_filtration
			last_increased_tech = tech_projcrim_genetic_processing
		}
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
		set_country_flag = projcrim_techs_done
	}

	option = {
		name = "projcrim_situation.7.a"
		if = {
			limit = {
				NOT = {
					has_country_flag = projcrim_sit2_started
				}
			}
			set_country_flag = projcrim_sit2_started
			start_situation = {
				type = projcrim_cure_research
				target = root
				effect = {
					save_event_target_as = projcrim_sit2
				}
			}
		}
		icon = {
			icon = GFX_situation_approach_research
			icon_background = GFX_situation_approach_bg_green
			text = set_situation_approach_icon_text
		}
		event_target:projcrim_sit2 = {
			set_situation_approach = approach_projcrim_research
		}
	}
	option = {
		name = "projcrim_situation.7.b"
		if = {
			limit = {
				NOT = {
					has_country_flag = projcrim_sit2_started
				}
			}
			set_country_flag = projcrim_sit2_started
			start_situation = {
				type = projcrim_cure_research
				target = root
				effect = {
					save_event_target_as = projcrim_sit2
				}
			}
		}
		icon = {
			icon = GFX_situation_approach_handshake
			icon_background = GFX_situation_approach_bg_yellow
			text = set_situation_approach_icon_text
		}
		event_target:projcrim_sit2 = {
			set_situation_approach = approach_projcrim_balanced
		}
	}
	option = {
		name = "projcrim_situation.7.c"
		if = {
			limit = {
				NOT = {
					has_country_flag = projcrim_sit2_started
				}
			}
			set_country_flag = projcrim_sit2_started
			start_situation = {
				type = projcrim_cure_research
				target = root
				effect = {
					save_event_target_as = projcrim_sit2
				}
			}
		}
		icon = {
			icon = GFX_situation_approach_suspicious
			icon_background = GFX_situation_approach_bg_red
			text = set_situation_approach_icon_text
		}
		event_target:projcrim_sit2 = {
			set_situation_approach = approach_projcrim_cessation
		}
	}
}

# Finalising the Cure - 50% done
country_event = { 
	id = projcrim_situation.8
	title = "projcrim_situation.8.name"
	desc = "projcrim_situation.8.desc"
	picture = GFX_evt_society_cache

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.8.a"
		add_modifier = {
			modifier = projcrim_science_focus
			days = 900
		}
	}
	option = {
		name = "projcrim_situation.8.b"
		add_modifier = {
			modifier = projcrim_society_focus
			days = 900
		}
	}
}

# Finalising the Cure - Completed
country_event = { 
	id = projcrim_situation.9
	title = "projcrim_situation.9.name"
	desc = "projcrim_situation.9.desc"
	picture = GFX_evt_ship_in_orbit_3

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.9.a"
		if = {
			limit = {
				NOT = {
					has_country_flag = projcrim_sit3_started
				}
			}
			set_country_flag = projcrim_sit3_started
			start_situation = {
				type = projcrim_cure_distribution
				target = root
				effect = {
					save_event_target_as = projcrim_sit3
				}
			}
		}
	}
}

# Population Protected
country_event = { 
	id = projcrim_situation.10
	title = "projcrim_situation.10.name"
	desc = {
		trigger = {
			host_has_dlc = "Apocalypse"
			NOT = { has_country_flag = colossus_project }
		}
		text = "projcrim_situation.10.apoc.desc"
	}
	desc = {
		trigger = {
			host_has_dlc = "Apocalypse"
			has_country_flag = colossus_project
		}
		text = "projcrim_situation.10.apoc.colossus.desc"
	}
	desc = {
		trigger = {
			NOT = { host_has_dlc = "Apocalypse" }
		}
		text = "projcrim_situation.10.noapoc.desc"
	}
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	after = {
		if = {
			limit = {
				any_playable_country = {
					OR = {
						has_country_flag = projcrim_plague_cured
						NOT = { has_country_flag = plague_present }
					}
				}
			}
			set_global_flag = projcrim_plague_eradicated
		}
	}

	immediate = {
		every_playable_country = {
			limit = { has_event_chain = "projcrim_main_chain" }
			set_variable = {
				which = projcrim_pops_changed
				value = value:projcrim_afflicted_pops_local_variable
			}
			set_variable = {
				which = projcrim_pops_changed2
				value = value:projcrim_afflicted_pops_local_variable2
			}
		}
		# add_event_chain_counter = {
		# 	event_chain = projcrim_main_chain
		# 	counter = afflicted_pops_national
		# 	amount = projcrim_afflicted_pops_local_variable2
		# }
		
		every_playable_country = {
			limit = { has_event_chain = "projcrim_main_chain" }
			add_event_chain_counter = {
				event_chain = projcrim_main_chain
				counter = cured_nations
				amount = 1
			}
			add_event_chain_counter = {
				event_chain = projcrim_main_chain
				counter = afflicted_pops_galaxy
				amount = projcrim_afflicted_pops_local_variable2
			}
		}
	}

	option = {
		name = "projcrim_situation.10.a"
		trigger = {
			NOT = { host_has_dlc = "Apocalypse" }
		}
			set_country_flag = projcrim_plague_cured
			remove_country_flag = plague_present
			projcrim_remove_negative_effects = yes	#Removes bad modifiers/deposits
			if = {
				limit = { is_gestalt = yes }
				add_modifier = {
					modifier = projcrim_plague_cured_g
					days = 1800
				}
			}
			else = {
				add_modifier = {
					modifier = projcrim_plague_cured
					days = 1800
				}
			}
			# every_owned_species	= {
			# 	limit = {
			# 		OR = {
			# 			has_trait = trait_crimson_infected
			# 			has_species_flag = crimson_infected_species
			# 		}
			# 	}
			# 	change_species_characteristics = {
			# 		remove_trait = trait_crimson_infected
			# 		add_trait = trait_crimson_recovered
			# 	}
			# }

			every_owned_pop = {
				limit = {
					pop_has_trait = trait_crimson_infected
					pop.planet = {
						is_controlled_by = root
					}
				}
				pop = {
					species = {
						if = {
							limit = {
								# Cured variant exists
								any_galaxy_species = {
									is_subspecies = prev
									has_trait = trait_crimson_recovered
								}
							}
							random_galaxy_species = {
								limit = {
									is_subspecies = prev
									has_trait = trait_crimson_recovered
								}
								prevprevprev.planet = {
									if = {
										limit = {
											root = {
												is_same_value = prev.controller
											}
										}
										create_pop = {
											species = prev
											ethos = random
										}
									}
								}
							}
						}
						else = {
							modify_species = {
								species = this
								base = auto
								add_trait = trait_crimson_recovered
								remove_trait = trait_crimson_infected
								add_traits_at_start_of_list = yes
								change_scoped_species = yes
								effect = {
									prevprevprev.planet = {
										if = {
											limit = {
												root = {
													is_same_value = prev.controller
												}
											}
											create_pop = {
												species = prev
												ethos = random
											}
										}
									}
								}
							}
						}
						prev.planet = {
							if = {
								limit = {
									root = {
										is_same_value = prev.controller
									}
								}
								random_owned_pop = {
									limit = {
										is_same_species = prevprev
										pop_has_trait = trait_crimson_infected
									}
									kill_pop = yes
								}
							}
						}
					}
				}
			}
			hidden_effect = {
				country_event = {
					id = projcrim_situation.11
					days = 1
				}
			}
	}
	option = {
		name = "projcrim_situation.10.b"
		custom_tooltip = projcrim_orbital_cleanser
		add_research_option = tech_projcrim_pk_orbital_cleanser
			add_tech_progress = {
				tech = tech_projcrim_pk_orbital_cleanser
				progress = 0.10
			}
		trigger = {
			host_has_dlc = "Apocalypse"
			NOT = { has_country_flag = colossus_project }
		}
			set_country_flag = projcrim_plague_cured
			remove_country_flag = plague_present
			add_modifier = {
				modifier = projcrim_plague_cured
				days = 1800
			}
			
			hidden_effect = {
				projcrim_remove_negative_effects = yes
				every_owned_pop = {
					limit = {
						pop_has_trait = trait_crimson_infected
						pop.planet = {
							is_controlled_by = root
						}
					}
					pop = {
						species = {
							if = {
								limit = {
									# Cured variant exists
									any_galaxy_species = {
										is_subspecies = prev
										has_trait = trait_crimson_recovered
									}
								}
								random_galaxy_species = {
									limit = {
										is_subspecies = prev
										has_trait = trait_crimson_recovered
									}
									prevprevprev.planet = {
										if = {
											limit = {
												root = {
													is_same_value = prev.controller
												}
											}
											create_pop = {
												species = prev
												ethos = random
											}
										}
									}
								}
							}
							else = {
								modify_species = {
									species = this
									base = auto
									add_trait = trait_crimson_recovered
									remove_trait = trait_crimson_infected
									add_traits_at_start_of_list = yes
									change_scoped_species = yes
									effect = {
										prevprevprev.planet = {
											if = {
												limit = {
													root = {
														is_same_value = prev.controller
													}
												}
												create_pop = {
													species = prev
													ethos = random
												}
											}
										}
									}
								}
							}
							prev.planet = {
								if = {
									limit = {
										root = {
											is_same_value = prev.controller
										}
									}
									random_owned_pop = {
										limit = {
											is_same_species = prevprev
											pop_has_trait = trait_crimson_infected
										}
										kill_pop = yes
									}
								}
							}
						}
					}
				}
				country_event = {
					id = projcrim_situation.11
					days = 1
				}
			}
	}
	option = {
		name = "projcrim_situation.10.b"
		custom_tooltip = projcrim_orbital_cleanser_desc
		trigger = {
			host_has_dlc = "Apocalypse"
			has_country_flag = colossus_project
		}
			add_research_option = tech_projcrim_pk_orbital_cleanser
			add_tech_progress = {
				tech = tech_projcrim_pk_orbital_cleanser
				progress = 0.10
			}
			set_country_flag = projcrim_plague_cured
			remove_country_flag = plague_present
			projcrim_remove_negative_effects = yes
			add_modifier = {
				modifier = projcrim_plague_cured
				days = 1800
			}
			every_owned_pop = {
				limit = {
					pop_has_trait = trait_crimson_infected
					pop.planet = {
						is_controlled_by = root
					}
				}
				pop = {
					species = {
						if = {
							limit = {
								# Cured variant exists
								any_galaxy_species = {
									is_subspecies = prev
									has_trait = trait_crimson_recovered
								}
							}
							random_galaxy_species = {
								limit = {
									is_subspecies = prev
									has_trait = trait_crimson_recovered
								}
								prevprevprev.planet = {
									if = {
										limit = {
											root = {
												is_same_value = prev.controller
											}
										}
										create_pop = {
											species = prev
											ethos = random
										}
									}
								}
							}
						}
						else = {
							modify_species = {
								species = this
								base = auto
								add_trait = trait_crimson_recovered
								remove_trait = trait_crimson_infected
								add_traits_at_start_of_list = yes
								change_scoped_species = yes
								effect = {
									prevprevprev.planet = {
										if = {
											limit = {
												root = {
													is_same_value = prev.controller
												}
											}
											create_pop = {
												species = prev
												ethos = random
											}
										}
									}
								}
							}
						}
						prev.planet = {
							if = {
								limit = {
									root = {
										is_same_value = prev.controller
									}
								}
								random_owned_pop = {
									limit = {
										is_same_species = prevprev
										pop_has_trait = trait_crimson_infected
									}
									kill_pop = yes
								}
							}
						}
					}
				}
			}
			hidden_effect = {
				country_event = {
					id = projcrim_situation.11
					days = 1
				}
			}
	}
}

# Share the Cure?
country_event = { 
	id = projcrim_situation.11
	title = "projcrim_situation.11.name"
	desc = "projcrim_situation.11.desc"
	picture = GFX_evt_galactic_community

	is_triggered_only = yes

	trigger = {
		has_country_flag = projcrim_plague_cured
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
		root = { save_global_event_target_as = crimson_plague_curer }
	}

	option = {
		name = "projcrim_situation.11.a" 	# Everyone gets it! Woo!
		set_country_flag = curer_shared
		custom_tooltip = projcrim_share_cure
		hidden_effect = {
			every_playable_country = {
				limit = {
					NOR = {
						has_country_flag = projcrim_plague_cured
						is_same_value = root
					}
				}
				add_opinion_modifier = {
					modifier = opinion_projcrim_shared_cure
					who = root
				}
				set_country_flag = cure_shared
				country_event = { id = projcrim_situation.12 }
			}
		}
	}
	option = {
		name = "projcrim_situation.11.b"	# Just our allies.
		set_country_flag = curer_discriminated
		custom_tooltip = projcrim_share_cure_kinda
		hidden_effect = {
			every_playable_country = {
				limit = {
					opinion_level = {
						who = root
						level >= good
					}
					NOT = { is_same_value = root }
				}
				add_opinion_modifier = {
					modifier = opinion_projcrim_shared_cure
					who = root
				}
				set_country_flag = cure_shared
				country_event = { id = projcrim_situation.12 }
			}
			every_playable_country = {
				limit = {
					NOT = { has_country_flag = projcrim_plague_cured }
					opinion_level = {
						who = root
						level <= neutral
					}
					NOT = { is_same_value = root }
				}
				add_opinion_modifier = {
					modifier = opinion_projcrim_guarded_cure
					who = root
				}
				country_event = { id = projcrim_situation.13 }
			}
		}
	}
	option = {
		name = "projcrim_situation.11.c"	# Nah, screw 'em.
		set_country_flag = curer_hoarded
		custom_tooltip = projcrim_hide_cure
		hidden_effect = {
			every_playable_country = {
				limit = {
					NOR = {
						has_country_flag = projcrim_plague_cured
						is_same_value = root
					}
				}
				add_opinion_modifier = {
					modifier = opinion_projcrim_hid_cure
					who = root
				}
				country_event = { id = projcrim_situation.14 }
			}
		}
	}
}

# Curers Share Cure
country_event = { 
	id = projcrim_situation.12
	title = "projcrim_situation.12.name"
	desc = "projcrim_situation.12.desc"
	picture = GFX_evt_galactic_community

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.12.a"
		custom_tooltip = projcrim_cure_boon
	}
}

# Curers Selectively Share Cure
country_event = { 
	id = projcrim_situation.13
	title = "projcrim_situation.13.name"
	desc = "projcrim_situation.13.desc"
	picture = GFX_evt_galactic_community

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.13.a"
		custom_tooltip = projcrim_cure_wg
	}
}

# Curers Hide Cure
country_event = { 
	id = projcrim_situation.14
	title = "projcrim_situation.14.name"
	desc = "projcrim_situation.14.desc"
	picture = GFX_evt_galactic_community

	is_triggered_only = yes

	trigger = {
		NOT = { has_global_flag = throng_parasite_boon }
	}

	immediate = {
	}

	option = {
		name = "projcrim_situation.14.a"
		custom_tooltip = projcrim_cure_wg
	}
}