namespace = ag_situation

@ag_ancient_shield_situation_stage_1 = 20
@ag_ancient_shield_situation_stage_2 = 45
@ag_ancient_shield_situation_stage_3 = 60
@ag_ancient_shield_situation_stage_4 = 80

@ag_common_situation_stage_1 = 20
@ag_common_situation_stage_2 = 40
@ag_common_situation_stage_3 = 60
@ag_common_situation_stage_4 = 80

@ag_theta_situation_stage_1 = 32
@ag_theta_situation_stage_2 = 64

situation_event = {
	id = ag_situation.1
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		set_variable = { which = ag_situation_random_progress value = 0 }
		ag_randomize_variable = { ag_which = ag_situation_random_progress ag_scale = 10 }
		change_variable = { which = ag_situation_random_progress value = value:ag_research_point_buff }
		if = {
			limit = { is_situation_type = "ag_ancient_shield_situation" }
			if = {
				limit = {
					NOT = { has_situation_flag = ag_situation_progress_locked }
					OR = {
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_1 owner = { NOT = { has_technology = "tech_ag_ancient_shield_1" } } }
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_2 owner = { NOT = { has_technology = "tech_ag_ancient_shield_2" } } }
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_3 NOT = { has_global_flag = ag_ancient_frozen_shield_unlocked } }
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_4 owner = { NOT = { has_country_flag = ag_theta_101_fired } } }
					}
				}
				set_situation_flag = ag_situation_progress_locked
			}
			else_if = {
				limit = {
					has_situation_flag = ag_situation_progress_locked
					NOR = {
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_1 owner = { NOT = { has_technology = "tech_ag_ancient_shield_1" } } }
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_2 owner = { NOT = { has_technology = "tech_ag_ancient_shield_2" } } }
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_3 NOT = { has_global_flag = ag_ancient_frozen_shield_unlocked } }
						AND = { situation_progress >= @ag_ancient_shield_situation_stage_4 owner = { NOT = { has_country_flag = ag_theta_101_fired } } }
					}
				}
				remove_situation_flag = ag_situation_progress_locked
			}
			if = {
				limit = { NOT = { current_situation_approach = ag_ancient_shield_situation_spproach_pause } }
				random_list = {
					280 = { }
					20 = {
						modifier = {
							factor = 0
							NOT = { current_situation_approach = ag_ancient_shield_situation_spproach_neutral }
						}
						if = {
							limit = { current_situation_approach = ag_ancient_shield_situation_spproach_neutral }
							owner = { country_event = { id = ag_theta.161 } }
						}
					}
					20 = {
						modifier = {
							factor = 0
							NOT = { current_situation_approach = ag_ancient_shield_situation_spproach_positive }
						}
						if = {
							limit = { current_situation_approach = ag_ancient_shield_situation_spproach_positive }
							random_list = {
								10 = { owner = { country_event = { id = ag_theta.161 } } }
								10 = { owner = { country_event = { id = ag_theta.162 } } }
								10 = { owner = { country_event = { id = ag_theta.163 } } }
								10 = { owner = { country_event = { id = ag_theta.164 } } }
								10 = { owner = { country_event = { id = ag_theta.165 } } }
								10 = { owner = { country_event = { id = ag_theta.166 } } }
							}
							reroll_random = yes
						}
					}
					300 = {
						modifier = {
							factor = 0
							owner = { OR = {
								has_country_flag = ag_ancient_shield_research_1_available
								NOT = { has_country_flag = ag_ancient_theta_megastructure_explored }
							} }
						}
						if = {
							limit = { NOT = {
								owner = { OR = {
									has_country_flag = ag_ancient_shield_research_1_available
									NOT = { has_country_flag = ag_ancient_theta_megastructure_explored }
								} }
							} }
							owner = { country_event = { id = ag_theta.4 } }
						}
					}
					300 = {
						modifier = {
							factor = 0
							OR = {
								situation_progress < @ag_ancient_shield_situation_stage_1
								owner = { OR = {
									has_country_flag = ag_ancient_shield_research_2_available
									NOT = { has_technology = "tech_ag_ancient_shield_1" }
								} }
							}
						}
						if = {
							limit = { NOR = {
								situation_progress < @ag_ancient_shield_situation_stage_1
								owner = { OR = {
									has_country_flag = ag_ancient_shield_research_2_available
									NOT = { has_technology = "tech_ag_ancient_shield_1" }
								} }
							} }
							owner = { if = {
								limit = { any_planet_within_border = {
									OR = {
										has_deposit = ag_ancient_shield_deposit_green
										has_deposit = ag_ancient_shield_deposit_blue
										has_deposit = ag_ancient_shield_deposit_red
									}
									has_research_station = yes
								} }
								country_event = { id = ag_theta.12 }
							} }
						}
					}
					300 = {
						modifier = {
							factor = 0
							OR = {
								situation_progress < @ag_ancient_shield_situation_stage_2
								owner = { OR = {
									has_country_flag = ag_has_research_project_801
									has_country_flag = ag_theta_21_mutex
									NOT = { has_technology = "tech_ag_ancient_shield_2" }
								} }
								has_global_flag = ag_ancient_frozen_shield_unlocked
							}
						}
						if = {
							limit = { NOR = {
								situation_progress < @ag_ancient_shield_situation_stage_2
								owner = { OR = {
									has_country_flag = ag_has_research_project_801
									has_country_flag = ag_theta_21_mutex
									NOT = { has_technology = "tech_ag_ancient_shield_2" }
								} }
								has_global_flag = ag_ancient_frozen_shield_unlocked
							} }
							owner = {
								set_country_flag = ag_theta_21_mutex
								country_event = { id = ag_theta.21 }
							}
						}
					}
					300 = {
						modifier = {
							factor = 0
							OR = {
								situation_progress < @ag_ancient_shield_situation_stage_3
								NOT = { has_global_flag = ag_ancient_primitive_country_destroyed }
								owner = { has_country_flag = ag_theta_101_fired }
							}
						}
						if = {
							limit = { NOR = {
								situation_progress < @ag_ancient_shield_situation_stage_3
								NOT = { has_global_flag = ag_ancient_primitive_country_destroyed }
								owner = { has_country_flag = ag_theta_101_fired }
							} }
							owner = { if = {
								limit = { any_system_within_border = {
									has_star_flag = ag_ancient_theta_system
									any_system_planet = {
										has_planet_flag = ag_ancient_theta_shielded_world
										has_research_station = yes
									}
								} }
								country_event = { id = ag_theta.101 }
							} }
						}
					}
				}
				reroll_random = yes
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_alpha_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_alpha_shielded_world
					exists = event_target:ag_ancient_alpha_shielded_world_2
					OR = {
						event_target:ag_ancient_alpha_shielded_world = {
							exists = owner
							owner = { is_same_value = root.owner }
							has_building = ag_ancient_alpha_archive
							has_ground_combat = no
							ag_has_researcher = yes
						}
						event_target:ag_ancient_alpha_shielded_world_2 = {
							exists = owner
							owner = { is_same_value = root.owner }
							has_building = ag_ancient_alpha_archive
							has_ground_combat = no
							ag_has_researcher = yes
						}
					}
				} }
				set_situation_flag = ag_alpha_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_alpha_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_alpha_situation_stage_4 } } situation_progress >= @ag_common_situation_stage_4 }
						owner = {
							set_country_flag = ag_alpha_situation_stage_4
							ag_alpha_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_alpha_situation_stage_3 } } situation_progress >= @ag_common_situation_stage_3 }
						owner = {
							set_country_flag = ag_alpha_situation_stage_3
							ag_alpha_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_alpha_situation_stage_2 } } situation_progress >= @ag_common_situation_stage_2 }
						owner = {
							set_country_flag = ag_alpha_situation_stage_2
							ag_alpha_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_alpha_situation_stage_1 } } situation_progress >= @ag_common_situation_stage_1 }
						owner = {
							set_country_flag = ag_alpha_situation_stage_1
							ag_alpha_situation_reward = yes
						}
					}
				}
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_beta_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_beta_shielded_world
					event_target:ag_ancient_beta_shielded_world = {
						exists = owner
						owner = { is_same_value = root.owner }
						has_building = ag_ancient_beta_archive
						has_ground_combat = no
						ag_has_researcher = yes
					}
				} }
				set_situation_flag = ag_beta_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_beta_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_beta_situation_stage_4 } } situation_progress >= @ag_common_situation_stage_4 }
						owner = {
							set_country_flag = ag_beta_situation_stage_4
							ag_beta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_beta_situation_stage_3 } } situation_progress >= @ag_common_situation_stage_3 }
						owner = {
							set_country_flag = ag_beta_situation_stage_3
							ag_beta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_beta_situation_stage_2 } } situation_progress >= @ag_common_situation_stage_2 }
						owner = {
							set_country_flag = ag_beta_situation_stage_2
							ag_beta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_beta_situation_stage_1 } } situation_progress >= @ag_common_situation_stage_1 }
						owner = {
							set_country_flag = ag_beta_situation_stage_1
							ag_beta_situation_reward = yes
						}
					}
				}
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_gamma_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_gamma_shielded_world
					event_target:ag_ancient_gamma_shielded_world = {
						exists = owner
						owner = { is_same_value = root.owner }
						OR = {
							has_building = ag_ancient_gamma_nexus_0
							has_building = ag_ancient_gamma_nexus_1
						}
						has_ground_combat = no
						ag_has_researcher = yes
					}
				} }
				set_situation_flag = ag_gamma_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_gamma_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_gamma_situation_stage_5 } } situation_progress >= @ag_common_situation_stage_4 }
						owner = {
							set_country_flag = ag_gamma_situation_stage_5
							ag_gamma_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_gamma_situation_stage_4 } } situation_progress >= @ag_common_situation_stage_3 }
						owner = {
							set_country_flag = ag_gamma_situation_stage_4
							ag_gamma_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_gamma_situation_stage_3 } } situation_progress >= @ag_common_situation_stage_2 }
						owner = {
							set_country_flag = ag_gamma_situation_stage_3
							ag_gamma_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_gamma_situation_stage_2 } } situation_progress >= @ag_common_situation_stage_1 }
						owner = {
							set_country_flag = ag_gamma_situation_stage_2
							ag_gamma_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_gamma_situation_stage_1 } } situation_progress >= 10 }
						owner = {
							set_country_flag = ag_gamma_situation_stage_1
							ag_gamma_situation_reward = yes
						}
					}
				}
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_delta_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_delta_shielded_world
					event_target:ag_ancient_delta_shielded_world = {
						exists = owner
						owner = { is_same_value = root.owner }
						has_building = ag_ancient_delta_archive
						has_ground_combat = no
						ag_has_researcher = yes
					}
				} }
				set_situation_flag = ag_delta_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_delta_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_delta_situation_stage_4 } } situation_progress >= @ag_common_situation_stage_4 }
						owner = {
							set_country_flag = ag_delta_situation_stage_4
							ag_delta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_delta_situation_stage_3 } } situation_progress >= @ag_common_situation_stage_3 }
						owner = {
							set_country_flag = ag_delta_situation_stage_3
							ag_delta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_delta_situation_stage_2 } } situation_progress >= @ag_common_situation_stage_2 }
						owner = {
							set_country_flag = ag_delta_situation_stage_2
							ag_delta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_delta_situation_stage_1 } } situation_progress >= @ag_common_situation_stage_1 }
						owner = {
							set_country_flag = ag_delta_situation_stage_1
							ag_delta_situation_reward = yes
						}
					}
				}
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_epsilon_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_epsilon_shielded_world
					exists = event_target:ag_ancient_epsilon_shielded_world_2
					exists = event_target:ag_ancient_epsilon_shielded_world_3
					OR = {
						event_target:ag_ancient_epsilon_shielded_world = {
							exists = owner
							owner = { is_same_value = root.owner }
							has_building = ag_epsilon_outpost_1
							has_ground_combat = no
							ag_has_researcher = yes
						}
						event_target:ag_ancient_epsilon_shielded_world_2 = {
							exists = owner
							owner = { is_same_value = root.owner }
							has_building = ag_epsilon_outpost_1
							has_ground_combat = no
							ag_has_researcher = yes
						}
						event_target:ag_ancient_epsilon_shielded_world_3 = {
							exists = owner
							owner = { is_same_value = root.owner }
							has_building = ag_epsilon_outpost_1
							has_ground_combat = no
							ag_has_researcher = yes
						}
					}
				} }
				set_situation_flag = ag_epsilon_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_epsilon_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_epsilon_situation_stage_4 } } situation_progress >= @ag_common_situation_stage_4 }
						owner = {
							set_country_flag = ag_epsilon_situation_stage_4
							ag_epsilon_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_epsilon_situation_stage_3 } } situation_progress >= @ag_common_situation_stage_3 }
						owner = {
							set_country_flag = ag_epsilon_situation_stage_3
							ag_epsilon_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_epsilon_situation_stage_2 } } situation_progress >= @ag_common_situation_stage_2 }
						owner = {
							set_country_flag = ag_epsilon_situation_stage_2
							ag_epsilon_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_epsilon_situation_stage_1 } } situation_progress >= @ag_common_situation_stage_1 }
						owner = {
							set_country_flag = ag_epsilon_situation_stage_1
							ag_epsilon_situation_reward = yes
						}
					}
				}
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_eta_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_eta_shielded_world
					event_target:ag_ancient_eta_shielded_world = {
						exists = owner
						owner = { is_same_value = root.owner }
						has_building = ag_ancient_eta_archive
						has_ground_combat = no
						ag_has_researcher = yes
					}
				} }
				set_situation_flag = ag_eta_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_eta_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_eta_situation_stage_4 } } situation_progress >= @ag_common_situation_stage_4 }
						owner = {
							set_country_flag = ag_eta_situation_stage_4
							ag_eta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_eta_situation_stage_3 } } situation_progress >= @ag_common_situation_stage_3 }
						owner = {
							set_country_flag = ag_eta_situation_stage_3
							ag_eta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_eta_situation_stage_2 } } situation_progress >= @ag_common_situation_stage_2 }
						owner = {
							set_country_flag = ag_eta_situation_stage_2
							ag_eta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_eta_situation_stage_1 } } situation_progress >= @ag_common_situation_stage_1 }
						owner = {
							set_country_flag = ag_eta_situation_stage_1
							ag_eta_situation_reward = yes
						}
					}
				}
			}
		}
		else_if = {
			limit = { is_situation_type = "ag_theta_situation" }
			if = {
				limit = { NAND = {
					exists = event_target:ag_ancient_theta_shielded_world
					event_target:ag_ancient_theta_shielded_world = {
						exists = owner
						owner = { is_same_value = root.owner }
						has_ground_combat = no
						ag_has_researcher = yes
					}
				} }
				set_situation_flag = ag_theta_situation_no_progress
			}
			else = {
				remove_situation_flag = ag_theta_situation_no_progress
				if = {
					limit = { NOT = { current_situation_approach = ag_ancient_situation_approach_pause } }
					if = {
						limit = { owner = { NOT = { has_country_flag = ag_theta_situation_stage_2 } } situation_progress >= @ag_theta_situation_stage_2 }
						owner = {
							set_country_flag = ag_theta_situation_stage_2
							ag_theta_situation_reward = yes
						}
					}
					else_if = {
						limit = { owner = { NOT = { has_country_flag = ag_theta_situation_stage_1 } } situation_progress >= @ag_theta_situation_stage_1 }
						owner = {
							set_country_flag = ag_theta_situation_stage_1
							ag_theta_situation_reward = yes
						}
					}
				}
			}
		}
	}
}

situation_event = {
	id = ag_situation.2
	hide_window = yes
	is_triggered_only = yes
	trigger = { owner = { is_country_type = global_event } }
	immediate = { owner = {
		set_variable = { which = ag_zeta_crisis_init_situation_progress value = 0 }
		if = {
			limit = { has_global_flag = ag_zeta_crisis_stage_2 NOT = { has_global_flag = ag_zeta_crisis_stage_3 } }
			ag_randomize_variable = { ag_which = ag_zeta_crisis_init_situation_progress ag_scale = 25 }
			subtract_variable = { which = ag_zeta_crisis_init_situation_progress value = 9.6 }
		}
		else_if = {
			limit = { has_global_flag = ag_zeta_crisis_stage_1 NOT = { has_global_flag = ag_zeta_crisis_stage_2 } }
			ag_randomize_variable = { ag_which = ag_zeta_crisis_init_situation_progress ag_scale = 1 }
			subtract_variable = { which = ag_zeta_crisis_init_situation_progress value = 1 }
		}
		else_if = {
			limit = { always = yes }
			ag_randomize_variable = { ag_which = ag_zeta_crisis_init_situation_progress ag_scale = 0.075 }
			subtract_variable = { which = ag_zeta_crisis_init_situation_progress value = 0.005 }
		}
		if = {
			limit = {
				exists = event_target:ag_ancient_zeta_star
				event_target:ag_ancient_zeta_star.solar_system = { exists = space_owner }
			}
			event_target:ag_ancient_zeta_star.solar_system.space_owner = {
				if = { limit = { NOT = { any_situation = { is_situation_type = ag_zeta_crisis_init_situation } } } country_event = { id = ag_zeta.39 } }
				set_variable = { which = ag_zeta_crisis_init_situation_progress value = root.owner.ag_zeta_crisis_init_situation_progress }
			}
		}
		# Go to Shroud Invader Crisis Stage 2.
		if = {
			limit = { prev = { situation_progress <= @ag_zeta_crisis_init_stage_change } }
			country_event = { id = ag_zeta_crisis.11 days = 5 random = 5 }
		}
	} }
}

situation_event = {
	id = ag_situation.3
	hide_window = yes
	is_triggered_only = yes
	immediate = { event_target:ag_psionic_conduit_megastructure = {
		set_variable = { which = ag_psionic_conduit_unstable_situation_progress value = ag_alpha_psionic_conduit_stability }
		divide_variable = { which = ag_psionic_conduit_unstable_situation_progress value = 50 }
		change_variable = { which = ag_psionic_conduit_unstable_situation_progress value = 1 }
		reroll_random = yes
		random_list = {
			25 = { }
			25 = { change_variable = { which = ag_psionic_conduit_unstable_situation_progress value = 0.1 } }
			25 = { change_variable = { which = ag_psionic_conduit_unstable_situation_progress value = 0.2 } }
			25 = { change_variable = { which = ag_psionic_conduit_unstable_situation_progress value = 0.3 } }
		}
		if = {
			limit = { check_variable = { which = ag_alpha_psionic_conduit_stability value >= 20 } }
			multiply_variable = { which = ag_psionic_conduit_unstable_situation_progress value = -1 }
		}
		else_if = {
			limit = { exists = event_target:ag_zeta_crisis_country }
			multiply_variable = { which = ag_psionic_conduit_unstable_situation_progress value = 1.5 }
		}
	} }
}
