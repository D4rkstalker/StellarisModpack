#Tooltips will be generated from these rules when they fail. Use of custom_tooltip is recommended
#There are still multiple hard-coded rules that apply in addition to these.
#If rules here evaluate to true, there might still be other rules that make the action unavailable.
#If a rule here evaluates to false the action will become unavailable

# Checks if a pop can procreate
# This = Species
# Root = Planet
can_species_procreate = {
	is_sapient = yes
	NOR = {
		has_trait = trait_machine_unit
		has_trait = trait_mechanical
		AND = {
			has_global_flag = expanded_events_active
			is_exp_memorex_comatos = yes
		}
		AND = {
			root = { owner = { has_origin = origin_hive_queen } }
			has_trait = trait_hive_mind
		}
		AND = {
			has_global_flag = expanded_megastructures_installed
			is_exp_clone = yes
			root = {
				owner = {
					OR = {
						has_country_flag = clone_infertility_5
						AND = {
							NOT = { has_origin = origin_clones }
							years_passed > 200
						}
					}
				}
			}
		}
	}
	NAND = {
		root = { has_modifier = slave_colony }
		NOT = { has_citizenship_type = { type = citizenship_slavery country = root.owner } }
	}
	if = {
		limit = {
			has_trait = trait_necrophage
		}
		NOT = {
			root = {
				any_owned_species = {
					species_can_be_necrophaged = yes
				}
			}
		}
	}
	if = {
		limit = {
			has_trait = trait_tree_caretaker
		}
		root = {
			OR = {
				has_deposit = d_tree_of_life_colony
				has_deposit = d_tree_of_life_home
			}
		}
	}
	NOT = { has_species_flag = nivlac_no_procreation }
}

# This = pop
can_resettle_pop = {
	# Self-modified Pops won't leave
	custom_tooltip = {
		fail_text = "self_modified_refuse"
		NOT = { has_trait = trait_self_modified }
	}
	custom_tooltip = {
		fail_text = "caretaker_refuse"
		NOT = { has_trait = trait_tree_caretaker }
	}
	IF = { #Done as an IF/ELSE so the tooltip isn't hideous and unreadable
		limit = { is_shackled_robot = yes }
		always = yes
	}
	ELSE_IF = {
		limit = {
			planet = {
				OR = {
					has_modifier = deteriorating_ecosystem
					has_modifier = catastrophe_approach
					has_modifier = apocalypse
					has_modifier = ravenous_locusts
					has_modifier = planet_active_worm
					is_doomsday_planet = yes
				}
			}
		}
		always = yes
	}
	ELSE_IF = {
		limit = {
			planet = {
				has_modifier = planet_culture_shock
			}
		}
		OR = {
			is_same_species = planet.owner
			planet = {
				NOT = { has_modifier = planet_culture_shock }
			}
		}
	}
	ELSE_IF = {
		limit = { is_enslaved = yes }
		is_enslaved = yes
	}
	else_if = {
		limit = {
			owner = {
				is_gestalt = yes
			}
		}
		always = yes
	}
	else = {
		custom_tooltip = {
			fail_text = RESETTLEMENT_POLICY_FAIL
			owner = {
				has_policy_flag = resettlement_allowed
			}
		}
	}
}

# This = Planet
can_resettle_planet = {
	is_controlled_by = owner
	has_ground_combat = no
	has_orbital_bombardment = no
	owner = {
		OR = {
			has_policy_flag = resettlement_allowed
			is_gestalt = yes
			any_owned_pop = {
				OR = {
					is_shackled_robot = yes
					is_enslaved = yes
				}
			}
			any_owned_planet = {
				OR = {
					has_modifier = deteriorating_ecosystem
					has_modifier = catastrophe_approach
					has_modifier = apocalypse
					has_modifier = ravenous_locusts
					has_modifier = planet_active_worm
					is_doomsday_planet = yes
				}
			}
		}
	}
	custom_tooltip = {
		text = "RESETTLE_PLANET_UNDER_COLONIZATION"
		exists = this
		is_under_colonization = no
	}
}

## If this returns true, the species will be set to decline even if it is not being purged
# This = species
# From = planet
## Note: success text tooltips are shown in alert_pops_declining alert.
should_force_decline_species = {
	OR = {
		AND = {
			# Infertile Clone Army pops should decline if in Country that can't have Vats, or there is a Vat shortage.
			custom_tooltip = {
				success_text = CLONE_ARMY_FORCE_DECLINE
				OR = {
					has_trait = trait_clone_soldier_infertile
					has_trait = trait_clone_soldier_infertile_full_potential
				}
				from = {
					OR = {
						# Check if country is unable to build Vats for this species.
						AND = {
							exists = owner
							owner = {
								OR = {
									NOT = { is_clone_army_empire = yes }					# Can't have Vats.
									has_country_flag = clone_army_fertility_unlocked			# Can't have Vats anymore.
									NOT = { owner_main_species = { is_same_species = root } }	# Our Vats can't build this species.
								}
							}
						}
						# Vats check out, but are there more pops than Vats support?
						check_variable = { which = clone_pops_missing value < 0 }
					}
				}
			}
		}
		AND = {
			# Caretakers die without the Tree of Life
			custom_tooltip = {
				success_text = TREEFOLK_FORCE_DECLINE
				has_trait = trait_tree_caretaker
				from = {
					NOR = {
						has_deposit = d_tree_of_life_colony
						has_deposit = d_tree_of_life_home
					}
				}
			}
		}
		AND = {
			has_global_flag = expanded_events_active
			is_exp_memorex_comatos = yes
		}
	}
}

can_planet_receive_auto_migration = {
	NOR = {
		planet_devastation >= 10
		has_modifier = planet_culture_shock
		has_modifier = deteriorating_ecosystem
		has_modifier = catastrophe_approach
		has_modifier = apocalypse
		has_modifier = ravenous_locusts
		has_modifier = planet_active_worm
		is_doomsday_planet = yes
	}
}