# Forerunner Megastructures
@phase_0_entity_x = -15
@phase_0_entity_y = -5
@entity_x = -15
@entity_y = -15


forerunner_ark = {
	entity = "no_ark_planet_entity"
	construction_entity = "no_ark_planet_entity"
	portrait = "GFX_forerunner_ark"
	place_entity_on_planet_plane = yes
	construction_blocks_others = no
	entity_offset = { x = 0 y = 0 }
	build_time = 7200
	resources = {
		category = megastructures
		produces = {
			minerals = 25
			alloys = 25
		}
	}
	station_modifier = {
		starbase_shipyard_capacity_add = 2
		starbase_shipyard_build_speed_mult = 0.15
	}
	country_modifier = {
		megastructure_build_speed_mult = 0.5
		country_megastructure_build_cap_add = 1
	}
	potential = {
		always = no
	}
}

forerunner_maethrillian = {
	entity = ""
	construction_entity = ""
	portrait = "GFX_forerunner_maethrillian"
	place_entity_on_planet_plane = yes
	construction_blocks_others = no
	entity_offset = { x = 0 y = 0 }
	build_time = 3000
	resources = {
		category = megastructures
		produces = {
		
		}
	}
	station_modifier = {
	}
	country_modifier = {
		country_admin_cap_mult = 0.10
		country_command_limit_add = 10
		country_naval_cap_add = 50
	}
	potential = {
		always = no
	}
}
forerunner_shield_world_0 = {
	entity = "construction_platform_entity"
	portrait = "GFX_forerunner_shield_world_yard"
	place_entity_on_planet_plane = no
	entity_offset = { x = @phase_0_entity_x y = @phase_0_entity_y }
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 300
		}
		
		upkeep = {
			energy = 20
		}
	}
	
	prerequisites = { "tech_shield_worlds" }
	
	possible = {
		exists = starbase
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_megastructure"
			has_no_non_gate_megastructure = yes
			NOR = {
				is_planet_class = pc_forerunner_halo
				is_planet_class = pc_forerunner_halo_activated
				is_planet_class = pc_forerunner_shield
				is_planet_class = pc_requiem_shield_world
			}
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_forerunner_structure"
			NOT = {
				has_star_flag = built_forerunner_structure
			}
		}
	}
		
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_survey_not_habitable"
				is_surveyed = {			# prevent leaking habitability information
					who = prev.from
					status = yes
				}
				colonizeable_planet = no
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = { has_anomaly = yes }
			}
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_star"
				is_star = no
			}
			custom_tooltip = {
				fail_text = "requires_not_ring_world"
				is_ringworld = no
			}
		} # use these for all non-star megastructures
	}
	ai_weight = {
		factor = 5
		
		modifier = {
			factor = 0.1
			starbase = { NOT = { has_starbase_size >= starbase_starfortress } }
		}
		
		modifier = {
			factor = 0.1
			any_neighbor_system = {
				exists = owner
				NOT = { 
					owner = { is_same_value = from } 
				}
			}
		}
	}
	on_build_start = {}
	on_build_cancel = {}
	on_build_complete = {
		set_star_flag = built_forerunner_structure
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
		from = { country_event = { id = ForerunnerShieldEvent.1 } }
	}
}
forerunner_shield_world_1 = {
	entity = "machine_planet_01_entity"
	construction_entity = "machine_planet_01_entity"
	portrait = "GFX_forerunner_shield_world"
	place_entity_on_planet_plane = yes
	construction_blocks_others = no
	entity_offset = { x = 0 y = 0 }
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 10000
			influence = 300
		}
	}
	upgrade_from = {
		forerunner_shield_world_0
	}
	
	station_modifier = {
	}
	country_modifier = {
	}
	construction_blocks_others = no
	construction_blocked_by_others = no
	
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_survey_not_habitable"
				is_surveyed = {			# prevent leaking habitability information
					who = prev.from
					status = yes
				}
				colonizeable_planet = no
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = { has_anomaly = yes }
			}
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_star"
				is_star = no
			}
			custom_tooltip = {
				fail_text = "requires_not_ring_world"
				is_ringworld = no
			}
		} # use these for all non-star megastructures
	}
	
	on_build_start = {}
	on_build_cancel = {}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
			set_star_flag = built_forerunner_structure
		}
		spawn_planet = {
			class = "pc_forerunner_shield"
			location = fromfrom
			orbit_angle_offset = -30
			orbit_distance_offset = 0
			size = 15
			init_effect = {
				set_planet_entity = {
					entity = "forerunner_shield_world_01_entity"
				}
				prevent_anomaly = yes
				clear_deposits = yes
				add_deposit = d_sw_apex_site
				add_deposit = d_sw_access_tunnels
				add_deposit = d_sw_surface
				set_name = "Shield Installation"
				surveyed = { set_surveyed = yes surveyor = FROM }
				add_building = "building_capital"
				add_modifier = {
					modifier = forerunner_artificial_star
					days = -1
				}
				set_planet_flag = megastructure
				trigger_megastructure_icon = yes
				set_all_comms_surveyed = yes
				clear_blockers = yes
			}
		}
		remove_megastructure = fromfrom
		from = { 
			country_event = { id = ForerunnerShieldEvent.2 }
		}
    }
}

requiem_shield_world_1 = {
	entity = "machine_planet_01_entity"
	construction_entity = "machine_planet_01_entity"
	portrait = "GFX_requiem_shield_world"
	place_entity_on_planet_plane = yes
	construction_blocks_others = no
	entity_offset = { x = 0 y = 0 }
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 5000
			influence = 100
		}
	}
	upgrade_from = {
		forerunner_shield_world_0
	}
	
	station_modifier = {
	}
	country_modifier = {
	}
	construction_blocks_others = no
	construction_blocked_by_others = no
	
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_survey_not_habitable"
				is_surveyed = {			# prevent leaking habitability information
					who = prev.from
					status = yes
				}
				colonizeable_planet = no
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = { has_anomaly = yes }
			}
			custom_tooltip = {
				fail_text = "requires_not_minor_planetary_body"
				NOR = {
					is_asteroid = yes
					is_moon = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_star"
				is_star = no
			}
			custom_tooltip = {
				fail_text = "requires_not_ring_world"
				is_ringworld = no
			}
		} # use these for all non-star megastructures
	}
	
	on_build_start = {}
	on_build_cancel = {}
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
			set_star_flag = built_forerunner_structure
		}
		spawn_planet = {
			class = "pc_requiem"
			location = fromfrom
			orbit_angle_offset = 30
			orbit_distance_offset = 0
			size = 15
			init_effect = {
				set_planet_entity = {
					entity = "requiem_planet_02_entity"
					picture = "pc_requiem_shield_world"
				}
				prevent_anomaly = yes
				clear_deposits = yes
				add_deposit = d_requiem_apex
				add_deposit = d_requiem_lockup
				add_deposit = d_requiem_ravine
				add_deposit = d_requiem_cauldron
				set_name = "Shield World"
				surveyed = { set_surveyed = yes surveyor = FROM }
				add_building = "building_capital"
				set_planet_flag = megastructure
				trigger_megastructure_icon = yes
				set_all_comms_surveyed = yes
				clear_blockers = yes
			}
		}
		remove_megastructure = fromfrom
		from = { 
			country_event = { id = ForerunnerShieldEvent.6 }
		}
    }
}
#HALO RINGS

forerunner_halo_ring_0 = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_forerunner_halo_ring_yard"
	place_entity_on_planet_plane = no
	entity_offset = { x = -7 y = -7 }
	build_time = 1800
	resources = {
		category = megastructures
		cost = {
			alloys = 10000
			influence = 300
		}

		upkeep = {
			energy = 5
		}
	}
	
	prerequisites = { 
		"tech_shield_worlds"
	}

	possible = {
		custom_tooltip = {
			fail_text = "requires_no_existing_megastructure"
			has_no_non_gate_megastructure = yes
			NOR = {
				is_planet_class = pc_forerunner_halo
				is_planet_class = pc_forerunner_halo_activated
				is_planet_class = pc_forerunner_shield
				is_planet_class = pc_requiem_shield_world
			}
		}
		custom_tooltip = {
			fail_text = "requires_surveyed_system"
			NOT = {
				any_system_planet = {
					is_surveyed = {
						who = prev.from
						status = no
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_no_black_hole"
			NOT = { is_star_class = sc_black_hole }
		}
		custom_tooltip = {
			fail_text = "requires_no_existing_forerunner_structure"
			NOT = {
				has_star_flag = built_forerunner_structure
			}
		}
	}
	
	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = { has_anomaly = yes }
			}
			custom_tooltip = {
				fail_text = "requires_not_star"
				is_star = no
			}
			custom_tooltip = {
				fail_text = "requires_not_ring_world"
				is_ringworld = no
			}
		}
		
	}
	
	ai_weight = {
		factor = 10		
		
		modifier = {
			factor = 0.1
			starbase = { NOT = { has_starbase_size >= starbase_starfortress } }
		}	

		modifier = {
			factor = 0.1
			any_neighbor_system = {
				exists = owner
				NOT = {
					owner = { is_same_value = from } 
				}
			}
		}	
	}
	
	on_build_start = {}
	on_build_cancel = {}
	on_build_complete = {
		set_star_flag = built_forerunner_structure
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
		from = { country_event = { id = ForerunnerShieldEvent.3 } }
	}
}

forerunner_halo_ring_1 = {
	entity = ""
	construction_entity = "halo_ring_01_entity"
	portrait = "GFX_forerunner_halo_ring"
	build_time = 3600
	resources = {
		category = megastructures
		cost = {
			alloys = 10000
		}
	}
	
	upgrade_from = {
		forerunner_halo_ring_0
	}
	
	prerequisites = { 
		"tech_shield_worlds"
	}
	show_prereqs = yes
	prereq_name = "RING_WORLD_SHOW_NAME"
	
	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
			set_star_flag = built_forerunner_structure
		}
		spawn_planet = {
			class = "pc_forerunner_halo"
			location = fromfrom
			orbit_angle_offset = 15
			size = 5
			init_effect = {
				prevent_anomaly = yes
				clear_deposits = yes
				add_deposit = d_hr_control_room
				add_deposit = d_hr_cartographer
				add_deposit = d_hr_library
				add_deposit = d_hr_beam_emitter
				add_deposit = d_arcane_generator
				set_name = "Halo Installation"
				set_planet_entity = {
					entity = "halo_ring_01_entity"
				}
				add_modifier = {
					modifier = halo_ring_monitor
					days = -1
				}
				surveyed ={
					set_surveyed = yes
					surveyor = FROM
				}
				set_planet_flag = megastructure
				set_all_comms_surveyed = yes
				clear_blockers = yes
				trigger_megastructure_icon = yes
			}
		}
		remove_megastructure = fromfrom
		from = {
			country_evenet = { id = ForerunnerShieldEvent.4 }
		}
	}
}