@makeshift_research_bonus	    = 50
@stage_1_research_bonus         = 100
@stage_1_research_mult          = 0.05
@stage_2_research_bonus	        = 200
@stage_2_research_mult          = 0.05
@stage_3_research_bonus 	    = 300
@stage_3_research_mult          = 0.05
@stage_4_research_bonus	        = 400
@stage_4_research_mult          = 0.20


# Think Tank Site
think_tank_0 = {
    entity = "construction_platform_entity"
    construction_entity = "construction_platform_entity"
    portrait = "GFX_megastructure_construction_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 1800
    resources = {
        category = megastructures
        cost = {
            alloys = 5000
            influence = 300
        }

        upkeep = {
            energy = 5
        }
    }

    prerequisites = { "tech_science_nexus" }

    possible = {
        exists = starbase
        custom_tooltip = {
            fail_text = "requires_inside_border"
            is_inside_border = from
        }
        custom_tooltip = {
            fail_text = "requires_surveyed_system"
            NOT = {
                any_system_planet = {
                    is_surveyed = {
                        who = prev.from
                        status = no
                    }
                }
            }
        }
    }

    placement_rules = {
        planet_possible = {
            custom_tooltip = {
                fail_text = "requires_survey_not_habitable"
                is_surveyed = {
                    who = prev.from
                    status = yes
                }
                colonizeable_planet = no
            }
            custom_tooltip = {
                fail_text = "requires_no_anomaly"
                NOT = { has_anomaly = yes }
            }
            custom_tooltip = {
                fail_text = "requires_no_orbital_station"
                has_orbital_station = no
            }
            custom_tooltip = {
                fail_text = "requires_not_minor_planetary_body"
                NOR = {
                    is_asteroid = yes
                    is_moon = yes
                }
            }
            custom_tooltip = {
                fail_text = "requires_not_ring_world"
                is_ringworld = no
            }
            custom_tooltip = {
                fail_text = "requires_no_existing_megastructure"
                NOR = {
                    has_planet_flag = has_megastructure
                    has_planet_flag = megastructure
                }
            }
        }
    }

    # root = system
    # from = country
    ai_weight = {
        factor = 10
        modifier = {
            factor = 0.1
            starbase = { NOT = { has_starbase_size >= starbase_starfortress } }
        }

        modifier = {
            factor = 0.1
            any_neighbor_system = {
                exists = owner
                NOT = {
                    owner = { is_same_value = from }
                }
            }
        }

        modifier = {
            factor = 2.0
            from = {
                OR = {
                    has_ethic = ethic_materialist
                    has_ethic = ethic_fanatic_materialist
                }
            }
        }
    }

    on_build_start = {
        fromfrom.planet = { set_planet_flag = has_megastructure }
    }
    on_build_cancel = {
        fromfrom.planet = { remove_planet_flag = has_megastructure }
    }
    on_build_complete = {
        fromfrom.planet = { set_planet_flag = has_megastructure }
        set_star_flag = think_tank_built
        from = { set_country_flag = built_think_tank }
    }
}

think_tank_1 = {
    entity = "thinktank_phase_01_entity"
    construction_entity = "thinktank_phase_01_entity"
    portrait = "GFX_megastructure_construction_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 3600
    resources = {
        category = megastructures
        cost = {
            alloys = 15000
        }

        upkeep = {
            energy = 25
        }

        produces = {
            society_research = @stage_1_research_bonus
            engineering_research = @stage_1_research_bonus
            physics_research = @stage_1_research_bonus
        }
    }

    upgrade_from = {
        think_tank_0
    }

    prerequisites = { "tech_science_nexus" }

    country_modifier = {
        all_technology_research_speed = @stage_1_research_mult
    }
}

think_tank_2 = {
    entity = "thinktank_phase_02_entity"
    construction_entity = "thinktank_phase_02_entity"
    portrait = "GFX_megastructure_construction_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 3600
    resources = {
        category = megastructures
        cost = {
            alloys = 15000
        }

        upkeep = {
            energy = 50
        }

        produces = {
            society_research = @stage_2_research_bonus
            engineering_research = @stage_2_research_bonus
            physics_research = @stage_2_research_bonus
        }
    }

    upgrade_from = {
        think_tank_1
    }

    prerequisites = { "tech_science_nexus" }

    country_modifier = {
        all_technology_research_speed = @stage_2_research_mult
    }
}

think_tank_3 = {
    entity = "thinktank_phase_03_entity"
    construction_entity = "thinktank_phase_03_entity"
    portrait = "GFX_megastructure_think_tank_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 3600
    resources = {
        category = megastructures
        cost = {
            alloys = 15000
        }

        upkeep = {
            energy = 75
        }

        produces = {
            society_research = @stage_3_research_bonus
            engineering_research = @stage_3_research_bonus
            physics_research = @stage_3_research_bonus
        }
    }

    upgrade_from = {
        think_tank_2
    }

    on_build_complete = {
        from = {
            set_country_flag = has_built_or_repaired_megastructure
        }
    }

    prerequisites = { "tech_science_nexus" }
    show_prereqs = yes

    country_modifier = {
        all_technology_research_speed = @stage_3_research_mult
    }
}

#Leader sacrifice boosted
think_tank_4 = {
    entity = "thinktank_phase_03_entity"
    construction_entity = "thinktank_phase_03_entity"
    portrait = "GFX_megastructure_think_tank_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 20
    resources = {
        category = megastructures
        upkeep = {
            energy = 100
        }

        produces = {
            society_research = @stage_4_research_bonus
            engineering_research = @stage_4_research_bonus
            physics_research = @stage_4_research_bonus
        }
    }
    upgrade_from = {
        think_tank_3
    }

    prerequisites = { "tech_science_nexus" }

    # used from script only
    upgrade_desc = hide
    potential = { always = no }

    country_modifier = {
        all_technology_research_speed = @stage_4_research_mult
    }
}

# Ruined Science Nexus
think_tank_ruined = {
    entity = "think_tank_destroyed_01_entity"
    portrait = "GFX_megastructure_construction_background"

    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }

    potential = {
        always = no
    }
}

# Makeshift Science Nexus
think_tank_makeshift = {
    entity = "think_tank_destroyed_01_entity"
    construction_entity = "think_tank_destroyed_01_entity"
    portrait = "GFX_megastructure_construction_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 1800
    resources = {
        category = megastructures
        cost = {
            alloys = 5000
        }

        upkeep = {
            energy = 75
        }

        produces = {
            society_research = @makeshift_research_bonus
            engineering_research = @makeshift_research_bonus
            physics_research = @makeshift_research_bonus
        }
    }

    upgrade_from = {
        think_tank_ruined
    }

    possible = {
        from = { has_technology = tech_starbase_4 }
    }

    on_build_start = {
        fromfrom = {
            set_graphical_culture = root.from
        }
    }
}

# Restored Science Nexus
think_tank_restored = {
    entity = "thinktank_phase_03_entity"
    construction_entity = "thinktank_phase_03_entity"
    portrait = "GFX_megastructure_think_tank_background"
    place_entity_on_planet_plane = no
    entity_offset = { x = 0 y = -20 }
    build_time = 3800
    resources = {
        category = megastructures
        cost = {
            alloys = 10000
        }

        upkeep = {
            energy = 75
        }

        produces = {
            society_research = @stage_3_research_bonus
            engineering_research = @stage_3_research_bonus
            physics_research = @stage_3_research_bonus
        }
    }

    upgrade_from = {
        think_tank_makeshift
    }

    possible = {
        from = { has_technology = tech_mega_engineering }
    }

    country_modifier = {
        all_technology_research_speed = @stage_4_research_mult
    }

    on_build_start = {
        fromfrom = {
            set_graphical_culture = root.from
        }
    }

    on_build_complete = {
        fromfrom.planet = { set_planet_flag = has_megastructure }
        every_system_ambient_object = { destroy_ambient_object = this }
        from = {
            set_country_flag = has_built_or_repaired_megastructure
            country_event = { id = utopia.2013 }
        }
    }
}
