divination_worm = {
	picture = GFX_evt_black_hole
	complete_icon_frame = GFX_situation_outcome_frame_blue
	complete_icon = GFX_situation_outcome_unknown
	abort_trigger = {
		OR = {
			NOT = { exists = event_target:shroudwalker_enclave_country }
			owner = { is_hostile = event_target:shroudwalker_enclave_country }
		}
	}
	modifier = {
		# pop_ethic_xenophile_attraction_mult = 0.1
	}
	stages = {
		stage_1 = {
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_blue
			end = 100
		}
	}
	on_monthly = {
		events = {
			leviathanexpanded.399
		}
		random_events = {
			# should be 10/19 chance of nothing happening
			31 = 0
			2 = enclave.5190 # Hero Redivivus
			1 = leviathanexpanded.218 # It Was Aliens
			1 = leviathanexpanded.219 # City of Bone
			1 = leviathanexpanded.220 # Asteroid Blast Door
			1 = leviathanexpanded.221 # Mutation Vats
			1 = leviathanexpanded.222 # Atomic Clock
			1 = leviathanexpanded.223 # Signs of Battle
			1 = leviathanexpanded.224 # Old Gods
			1 = leviathanexpanded.225 # Debris Field
			1 = leviathanexpanded.226 # Monoliths
			1 = leviathanexpanded.227 # Toxicity
			1 = leviathanexpanded.228 # Looking Down
			1 = leviathanexpanded.229 # Buried in the Sand
			1 = leviathanexpanded.230 # A Feel for Steel
			1 = leviathanexpanded.231 # Winter of the Fallen
			1 = leviathanexpanded.232 # Ship Fragments
			1 = leviathanexpanded.233 # Abandoned Settlements
			1 = leviathanexpanded.234 # Horizon Signal
			1 = leviathanexpanded.235 # Abandoned Terraforming
			1 = leviathanexpanded.236 # Submerged Cruiser
			1 = leviathanexpanded.238 # Blade of the Huntress
			1 = leviathanexpanded.240 # Déjà Vu Dig
			1 = leviathanexpanded.241 # Precursor Artifact
			1 = leviathanexpanded.350 # Ancient Robots
			1 = leviathanexpanded.352 # Charmak
			1 = leviathanexpanded.358 # Extinct Abductors
			1 = leviathanexpanded.360 # Strange Signal
		}
	}
	monthly_progress = {
		base = 2 #total: 100
		#Player actions & policies:
		modifier = {
			add = 2
			desc = divination_worm_embrace
			owner = {
				OR = {
					is_memorialist_empire = yes
					has_policy_flag = diplo_stance_isolationist
					has_policy_flag = first_contact_cautious
					has_edict = masters_writings_politics
					has_edict = masters_writings_diplomacy
					has_edict = masters_writings_philosophy
					has_edict = masters_writings_war
					has_edict = renewable_energy
					any_planet_within_border = {
						exists = archaeological_site 
						archaeological_site = { is_site_under_excavation = yes }
					}
				}
			}
		}
		modifier = {
			add = -2
			desc = divination_worm_denied
			owner = {
				OR = {
					has_policy_flag = diplo_stance_expansionist
					has_policy_flag = diplo_stance_supremacist
					has_edict = fleet_supremacy
					AND = {
						any_planet_within_border = {
							exists = archaeological_site
							archaeological_site = { is_site_completed = no }
						}
						NOT = {
							any_planet_within_border = {
								exists = archaeological_site 
								archaeological_site = { is_site_under_excavation = yes }
							}
						}
					}
				}
			}
		}
	}
	on_progress_complete = {
		custom_tooltip = divination_situation_end
		hidden_effect = {
			if = {
				limit = {
					has_situation_flag = divination_occurring
				}
				situation_event = { id = enclave.416 }
			}
			else = {
				situation_event = { id = enclave.5557 }
			}
		}
	}
	on_fail = {
		custom_tooltip = divination_situation_end
		hidden_effect = { destroy_situation = this }
	}
	approach = {
		name = into_the_unknown
		icon = GFX_situation_approach_unity
		icon_background = GFX_situation_approach_bg_green
		default = yes
		on_select = {
			custom_tooltip = deficit_approach_do_nothing_tooltip
		}
	}
}

situation_damaged_ecosystem = {
	picture = GFX_evt_metropolis
	complete_icon_frame = GFX_situation_outcome_frame_red
	complete_icon = GFX_situation_outcome_negative
	#category = negative
	on_progress_complete = {
		custom_tooltip = stage_ecosystem_fails
		hidden_effect = {
			situation_event = { id = countryexpanded.24 }
		}
	}
	stages = {
		stage_1 = {
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_red
			end = 600
			target_modifier = {
				pop_environment_tolerance = -0.25
				planet_jobs_food_produces_mult = -0.05
			}
		}
		stage_2 = {
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_red
			end = 900
			custom_tooltip = stage_ecosystem_damaged
			target_modifier = {
				pop_environment_tolerance = -0.33
				planet_jobs_food_produces_mult = -0.15
			}
		}
		stage_3 = {
			icon = GFX_situation_stage_3
			icon_background = GFX_situation_stage_frame_red
			end = 1000
			on_first_enter = {
				situation_event = { id = countryexpanded.23 }
			}
			custom_tooltip = stage_ecosystem_heavy_damaged
			target_modifier = {
				pop_environment_tolerance = -0.80
				planet_jobs_food_produces_mult = -0.5
			}
		}
	}
	approach = {
		name = approach_exploit
		on_select = {
			custom_tooltip = damaged_ecosystem_approach_exploit_effect
		}
		icon = GFX_situation_approach_whip
		icon_background = GFX_situation_approach_bg_red
		ai_weight = {
			base = 1
			modifier = {
				add = 5
				target = { owner = { is_civic_mining_guilds = yes } }
			}
			modifier = {
				add = 5
				target = { owner = { is_civic_expansionist = yes } }
			}
			modifier = {
				add = 5
				target = { owner = { is_authoritarian = yes } }
			}
			modifier = {
				add = 2
				target = { owner = { is_xenophobe = yes } }
			}
			modifier = {
				add = 0.5
				target = { owner = { is_anti_corp = yes } }
			}
		}
		triggered_target_modifier = {
			potential = { owner = { is_gestalt = no } }
			pop_environment_tolerance = -0.10
			planet_metallurgists_produces_mult = 0.15
			planet_artisans_produces_mult = 0.15
			planet_jobs_worker_produces_mult = 0.15
		}
		triggered_target_modifier = {
			potential = { owner = { is_gestalt = yes } }
			pop_environment_tolerance = -0.10
			planet_metallurgists_produces_mult = 0.15
			planet_artisans_produces_mult = 0.15
			planet_jobs_simple_drone_produces_mult = 0.15
		}
	}
	approach = {
		name = approach_default
		on_select = {
			custom_tooltip = deficit_approach_do_nothing_tooltip
		}
		icon = GFX_situation_approach_this_is_fine
		icon_background = GFX_situation_approach_bg_yellow
		ai_weight = {
			base = 1
		}
		default = yes
	}
	approach = {
		name = approach_conserve
		on_select = {
			custom_tooltip = damaged_ecosystem_approach_conserve_effect
		}
		icon = GFX_situation_approach_unity
		icon_background = GFX_situation_approach_bg_green
		ai_weight = {
			base = 1
			modifier = {
				add = 5
				target = { owner = { is_civic_environmentalist = yes } }
			}
			modifier = {
				add = 5
				target = { owner = { is_xenophile = yes } }
			}
			modifier = {
				add = 5
				target = { owner = { is_pacifist = yes } }
			}
			modifier = {
				add = 2
				target = { owner = { is_civic_terraformer = yes } }
			}
			modifier = {
				add = 2
				target = { owner = { is_civic_health = yes } }
			}
			modifier = {
				add = 0.5
				target = { owner = { is_capitalist = yes } }
			}
		}
		resources = {
			category = situations
			upkeep = {
				energy = 25
			}
		}
		target_modifier = {
			pop_environment_tolerance = 0.10
			planet_metallurgists_upkeep_mult = 0.10
			planet_artisans_upkeep_mult = 0.10
			planet_miners_produces_mult = -0.10
		}
	}
	approach = {
		name = approach_terraform
		on_select = {
			custom_tooltip = damaged_ecosystem_approach_terraform_effect
		}
		icon = GFX_situation_approach_research
		icon_background = GFX_situation_approach_bg_green
		allow = {
			target = { owner = { has_technology = tech_terrestrial_sculpting } }
		}
		ai_weight = {
			base = 1
			modifier = {
				add = 5
				target = { owner = { is_civic_terraformer = yes } }
			}
			modifier = {
				add = 5
				target = { owner = { is_xenophile = yes } }
			}
			modifier = {
				add = 2
				target = { owner = { is_pacifist = yes } }
			}
			modifier = {
				add = 2
				target = { owner = { is_civic_environmentalist = yes } }
			}
			modifier = {
				add = 0.5
				target = { owner = { is_capitalist = yes } }
			}
		}
		resources = {
			category = situations
			upkeep = {
				exotic_gases = 5
			}
		}
		target_modifier = {
			pop_environment_tolerance = 0.10
		}
	}
	monthly_progress = {
		base = 0.5
		modifier = {
			add = 0.25
			desc = string_current_approach
			current_situation_approach = approach_exploit
		}
		modifier = {
			subtract = 0.125
			desc = string_current_approach
			current_situation_approach = approach_conserve
		}
		modifier = {
			subtract = 0.25
			desc = string_current_approach
			current_situation_approach = approach_terraform
		}
	}
	abort_trigger = {
		OR = {
			NOT = { exists = target.owner }
			target.owner = { NOT = { is_same_value = root.owner } }
			target = { NOT = { has_planet_flag = damaged_homeworld } }
		}
	}
}

situation_worm_activated = {
	picture = GFX_evt_unspeakable_horror
	complete_icon_frame = GFX_situation_outcome_frame_red
	complete_icon = GFX_situation_outcome_negative
	category = negative
	on_progress_complete = {
		custom_tooltip = stage_planet_destroyed
		hidden_effect = {
			situation_event = { id = expandedrelics.10 }
		}
	}
	stages = {
		stage_1 = {
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_red
			end = 33
			target_modifier = {
				pop_environment_tolerance = -0.10
				planet_immigration_pull_mult = -1
				planet_emigration_push_add = 100
			}
		}
		stage_2 = {
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_red
			end = 66
			on_first_enter = {
				situation_event = { id = expandedrelics.8 }
			}
			target_modifier = {
				pop_environment_tolerance = -0.25
				planet_immigration_pull_mult = -10
				planet_emigration_push_add = 500
			}
		}
		stage_3 = {
			icon = GFX_situation_stage_3
			icon_background = GFX_situation_stage_frame_red
			end = 100
			on_first_enter = {
				situation_event = { id = expandedrelics.9 }
			}
			target_modifier = {
				pop_environment_tolerance = -0.50
				planet_immigration_pull_mult = -100
				planet_emigration_push_add = 1000
			}
		}
	}
	approach = {
		name = approach_attack
		on_select = {
			custom_tooltip = worm_activated_approach_attack_effect
		}
		icon = GFX_situation_approach_sword
		icon_background = GFX_situation_approach_bg_red
		potential = {
			target = {
				exists = owner
			}
		}
		ai_weight = {
			base = 1
			modifier = {
				add = 5
				owner = {
					OR = {
						is_honorbound_warriors = yes
						has_origin = origin_natural_hunters
						has_warrior_culture = yes
						has_valid_civic = civic_citizen_service
						is_despoiler_empire = yes
						has_valid_civic = civic_hive_strength_of_legions
						has_valid_civic = civic_machine_warbots
					}
				}
			}
			modifier = {
				add = 5
				owner = {
					is_militarist = yes
				}
			}
			modifier = {
				add = 2
				owner = {
					is_xenophobe = yes
				}
			}
		}
		resources = {
			category = situations
			upkeep = {
				energy = 25
			}
		}
		triggered_target_modifier = {
			potential = { owner = { is_gestalt = no } }
			job_soldier_add = @b1_jobs
		}
		triggered_target_modifier = {
			potential = { owner = { is_gestalt = yes } }
			job_warrior_drone_add = @b1_jobs
		}
	}
	approach = {
		name = approach_default
		on_select = {
			custom_tooltip = deficit_approach_do_nothing_tooltip
		}
		icon = GFX_situation_approach_this_is_fine
		icon_background = GFX_situation_approach_bg_yellow
		ai_weight = {
			base = 1
		}
		default = yes
	}
	approach = {
		name = approach_flee
		on_select = {
			custom_tooltip = worm_activated_approach_flee_effect
		}
		icon = GFX_situation_approach_pop
		icon_background = GFX_situation_approach_bg_green
		potential = {
			target = {
				exists = owner
			}
		}
		ai_weight = {
			base = 1
			modifier = {
				add = 5
				owner = {
					OR = {
						is_civic_free_haven = yes
						has_valid_civic = civic_corvee_system
						has_valid_civic = civic_corvee_system_megacorp
					}
				}
			}
			modifier = {
				add = 5
				owner = {
					is_pacifist = yes
				}
			}
			modifier = {
				add = 2
				owner = {
					is_xenophile = yes
				}
			}
		}
		resources = {
			category = situations
			upkeep = {
				energy = 10
			}
		}
		target_modifier = {
			pop_resettlement_cost_mult = -0.5
		}
	}
	on_monthly = {
		random_events = {
			120 = 0
			10 = expandedrelics.11
			5 = expandedrelics.12
			5 = expandedrelics.13
		}
	}
	monthly_progress = {
		base = 1
		modifier = {
			add = 0.2
			desc = string_planet_size
			target = { planet_size < 12 }
		}
		modifier = {
			subtract = 0.2
			desc = string_planet_size
			target = { planet_size > 18 }
		}
		modifier = {
			subtract = 0.3
			desc = string_current_approach
			current_situation_approach = approach_attack
		}
	}
	abort_trigger = {
		OR = {
			NOT = { exists = target }
			target = { NOT = { has_planet_flag = worm_on_the_attack } }
			target = { NOT = { has_modifier = planet_active_worm } }
		}
	}
}