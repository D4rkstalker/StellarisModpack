
situation_exomycosis_infestation = {
	picture = GFX_evt_disease_outbreak
	category = negative

	desc = situation_exomycosis_infestation_desc

	fail_icon = GFX_situation_outcome_positive
	fail_icon_frame = GFX_situation_outcome_frame_green
	complete_icon = GFX_situation_outcome_biohazard
	complete_icon_frame = GFX_situation_outcome_frame_red

	on_start = {
		hidden_effect = {
			target = {
				add_deposit = d_exofungus_contamination
				add_modifier = {
					modifier = "exomycosis_infestation"
					days = -1
				}
				random_owned_pop = {
					limit = {
						NOR = {
							pop_has_trait = trait_molded
							pop_has_trait = trait_exomycosis_infected
							pop_has_trait = trait_exomycosis_corrupted
						}
					}
					if = {
						limit = { is_robot_pop = yes }
						modify_species = {
							species = this
							add_trait = trait_exomycosis_corrupted
						}
					}
					else = {
						modify_species = {
							species = this
							add_trait = trait_exomycosis_infected
						}
					}
				}
			}
		}
	}

	on_progress_complete = {
		custom_tooltip = situation_exomycosis_infestation_finish_tooltip
		hidden_effect = {
			situation_event = { id = theinfestation_exomycosis_event.5 }
			target = { remove_modifier = "exomycosis_infestation" }
			destroy_situation = this
		}
	}

	on_fail = {
		custom_tooltip = situation_exomycosis_infestation_fail_tooltip
		hidden_effect = {
			target = { 
				remove_modifier = "exomycosis_infestation"
				if = { 
					limit = { has_planet_flag = sample_17_planet }
					remove_planet_flag = sample_17_planet
					owner = { country_event = { id = theinfestation_exomycosis_event.50 days = 1 } }
				}
			}
			destroy_situation = this
		}
	}

	on_abort = {
		hidden_effect = {
			target = { remove_modifier = "exomycosis_infestation" }
			destroy_situation = this
		}
	}

	abort_trigger = {
		target.owner = { has_origin = origin_exomycosis }
	}

	start_value = 1

	stages = {
		harmful_mold_1 = {
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_red
			target_modifier = { planet_jobs_society_research_produces_mult = 0.10 }
			end = 25
		}
		harmful_mold_2 = {
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_red
			target_modifier = {
				planet_jobs_society_research_produces_mult = 0.15
				pop_environment_tolerance = -0.10
				pop_happiness = -0.25
				planet_stability_add = -20
			}
			end = 50
		}
		harmful_mold_3 = {
			icon = GFX_situation_stage_3
			icon_background = GFX_situation_stage_frame_red
			on_first_enter = {
				situation_event = { id = theinfestation_exomycosis_event.48 }
			}
			target_modifier = {
				pop_environment_tolerance = -0.25
				planet_jobs_produces_mult = -0.15
				planet_pops_robotics_upkeep_mult = 0.50
			}
			end = 75
		}
		harmful_mold_4 = {
			icon = GFX_situation_stage_4
			icon_background = GFX_situation_stage_frame_red
			target_modifier = { 
				pop_environment_tolerance = -0.50
				planet_jobs_produces_mult = -0.25
				planet_pops_robotics_upkeep_mult = 1.00
			}
			end = 100
		}
	}

	approach = {
		name = approach_exomycosis_do_nothing
		icon = GFX_situation_approach_biohazard
		icon_background = GFX_situation_approach_bg_yellow
		default = yes
		on_select = {
			custom_tooltip = deficit_approach_do_nothing_tooltip
		}
		ai_weight = {
			base = 1
		}
	}

	approach = {
		name = approach_exomycosis_lockdown
		icon = GFX_situation_approach_lockdown
		icon_background = GFX_situation_approach_bg_yellow
		on_select = {
			custom_tooltip = approach_exomycosis_lockdown_tooltip
		}
		target_modifier = {
			planet_jobs_produces_mult = -0.25
		}
		allow = {
			if = {
				limit = { target.owner = { is_gestalt = yes } }
				target = {
					num_assigned_jobs = {
						job = patrol_drone
						value >= 2
					}
				}
			}
			else = {
				target = {
					num_assigned_jobs = {
						job = enforcer
						value >= 2
					}
				}
			}
		}
		resources = {
			category = situations
			upkeep = {
				unity = 10
				energy = 15
			}
		}
		ai_weight = {
			base = 5
		}
	}

	approach = {
		name = approach_exomycosis_liquidation
		icon = GFX_situation_approach_purge
		icon_background = GFX_situation_approach_bg_red
		on_select = {
			custom_tooltip = approach_exomycosis_liquidation_tooltip
			hidden_effect = {
				target.owner = {
					if = {
						limit = {
							NOR = {
								has_modifier = terrible_measures_1
								has_modifier = terrible_measures_2
								has_modifier = terrible_measures_3
								has_modifier = terrible_measures_4
								has_modifier = terrible_measures_5
								has_modifier = terrible_measures_6
								has_modifier = terrible_measures_7
								has_modifier = terrible_measures_8
							}
						}
						add_modifier = {
							modifier = terrible_measures_1
							days = 360
						}
					}
					if = {
						limit = { has_modifier = terrible_measures_2 }
						add_modifier = {
							modifier = terrible_measures_3
							days = 360
						}
					}
					if = {
						limit = { has_modifier = terrible_measures_3 }
						add_modifier = {
							modifier = terrible_measures_4
							days = 360
						}
					}
					if = {
						limit = { has_modifier = terrible_measures_4 }
						add_modifier = {
							modifier = terrible_measures_5
							days = 360
						}
					}
					if = {
						limit = { has_modifier = terrible_measures_5 }
						add_modifier = {
							modifier = terrible_measures_6
							days = 360
						}
					}
					if = {
						limit = { has_modifier = terrible_measures_6 }
						add_modifier = {
							modifier = terrible_measures_7
							days = 360
						}
					}
					if = {
						limit = { has_modifier = terrible_measures_7 }
						add_modifier = {
							modifier = terrible_measures_8
							days = 360
						}
					}
				}
			}
		}
		potential = {
			target = {
				exists = owner
				owner = { is_gestalt = no }
			}
		}
		allow = {
			target = {
				num_assigned_jobs = {
					job = soldier
					value >= 2
				}
			}
		}
		target_modifier = {
			planet_stability_add = -30
		}
		resources = {
			category = situations
			upkeep = {
				unity = 15
			}
		}
		ai_weight = {
			base = 0
			modifier = {
				add = 3
				owner = {
					OR = {
						is_militarist = yes
						is_authoritarian = yes
					}
				}
			}
		}
	}
	
	approach = {
		name = approach_exomycosis_purge
		icon = GFX_situation_approach_purge
		icon_background = GFX_situation_approach_bg_red
		on_select = {
			custom_tooltip = approach_exomycosis_purge_tooltip
		}
		potential = {
			target = {
				exists = owner
				owner = { has_authority = auth_hive_mind }
			}
		}
		allow = {
			target = {
				num_assigned_jobs = {
					job = warrior_drone
					value >= 2
				}
			}
		}
		target_modifier = {
			planet_stability_add = -30
		}
		resources = {
			category = situations
			upkeep = {
				energy = 20
			}
		}
		ai_weight = {
			base = 2
		}
	}
	
	approach = {
		name = approach_exomycosis_rejection
		icon = GFX_situation_approach_purge
		icon_background = GFX_situation_approach_bg_red
		on_select = {
			custom_tooltip = approach_exomycosis_rejection_tooltip
		}
		potential = {
			target = {
				exists = owner
				owner = { has_authority = auth_machine_intelligence }
			}
		}
		allow = {
			target = {
				num_assigned_jobs = {
					job = warrior_drone
					value >= 2
				}
			}
		}
		target_modifier = {
			planet_stability_add = -30
		}
		resources = {
			category = situations
			upkeep = {
				energy = 20
			}
		}
		ai_weight = {
			base = 2
		}
	}
	
	approach = {
		name = approach_exomycosis_vaccination
		icon = GFX_situation_approach_medical
		icon_background = GFX_situation_approach_bg_green
		on_select = {
			custom_tooltip = approach_exomycosis_vaccination_tooltip
		}
		potential = {
			target = {
				exists = owner
				owner = { 
					NOT = { has_authority = auth_machine_intelligence }
					has_country_flag = exomycosis_research_complete
				}
			}
		}
		resources = {
			category = situations
			upkeep = {
				energy = 20
			}
		}
		ai_weight = {
			base = 100
		}
	}
	
	approach = {
		name = approach_exomycosis_sterilization_process
		icon = GFX_situation_approach_medical
		icon_background = GFX_situation_approach_bg_green
		on_select = {
			custom_tooltip = approach_exomycosis_sterilization_process_tooltip
		}
		potential = {
			target = {
				exists = owner
				owner = { 
					has_authority = auth_machine_intelligence
					has_country_flag = exomycosis_research_complete
				}
			}
		}
		resources = {
			category = situations
			upkeep = {
				food = 20
			}
		}
		ai_weight = {
			base = 100
		}
	}

	on_monthly = {
		random_events = {
			200 = 0
			15 = theinfestation_exomycosis_event.6
			10 = theinfestation_exomycosis_event.7
			5 = theinfestation_exomycosis_event.8
			20 = theinfestation_exomycosis_event.9
			20 = theinfestation_exomycosis_event.13
		}
	}

	monthly_progress = {
		base = 0
		modifier = {
			desc = exomycosis_infected_pop_proportion
			add = target.value:exomycosis_infected_pop_proportion
		}
		modifier = {
			add = 0.2
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 1 } }
		}
		modifier = {
			add = 0.4
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 2 } }
		}
		modifier = {
			add = 0.6
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 3 } }
		}
		modifier = {
			add = 0.8
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 4 } }
		}
		modifier = {
			add = 1
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 5 } }
		}
		modifier = {
			add = 1.2
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 6 } }
		}
		modifier = {
			add = 1.4
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 7 } }
		}
		modifier = {
			add = 1.6
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 8 } }
		}
		modifier = {
			add = 1.8
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 9 } }
		}
		modifier = {
			add = 2
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count >= 10 } }
		}
		modifier = {
			subtract = 1
			desc = no_exomycosis_contamination
			target = { 
				count_deposits = { type = d_exofungus_contamination count = 0 }
				check_variable_arithmetic = { which = value:exomycosis_infected_pop_count value = 0 }
			}
		}
	}
}

situation_exomycosis_assimilation = {
	picture = GFX_evt_disease_outbreak
	category = positive

	desc = situation_exomycosis_assimilation_desc

	fail_icon = GFX_situation_outcome_resort_planet
	fail_icon_frame = GFX_situation_outcome_frame_blue
	complete_icon = GFX_situation_outcome_infestation
	complete_icon_frame = GFX_situation_outcome_frame_green

	on_start = {
	}

	on_progress_complete = {
		custom_tooltip = situation_exomycosis_assimilation_finish_tooltip
		hidden_effect = {
			target = { 
				if = {
					limit = { is_artificial = yes }
					add_modifier = {
						modifier = "mold_contaminated"
						days = -1
					}
				}
				else = {
					change_pc = pc_mycelium
					reset_planet = yes
				}
			}
			situation_event = { id = theinfestation_exomycosis_event.102 }
			destroy_situation = this
		}
	}

	on_fail = {
		custom_tooltip = situation_exomycosis_assimilation_fail_tooltip
		hidden_effect = {
			destroy_situation = this
		}
	}

	on_abort = {
		hidden_effect = {
			destroy_situation = this
		}
	}

	abort_trigger = {
		target.owner = { NOT = { has_origin = origin_exomycosis } }
	}

	start_value = 0

	stages = {
		assimilation_stage_1 = {
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_blue
			target_modifier = { pop_environment_tolerance = 0.20 }
			end = 30
		}
		assimilation_stage_2 = {
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_blue
			target_modifier = { pop_environment_tolerance = 0.50 }
			end = 70
		}
		assimilation_stage_3 = {
			icon = GFX_situation_stage_3
			icon_background = GFX_situation_stage_frame_blue
			target_modifier = { pop_environment_tolerance = 0.80 }
			end = 100
		}
	}

	approach = {
		name = approach_exomycosis_do_nothing
		icon = GFX_situation_approach_exomycosis
		icon_background = GFX_situation_approach_bg_yellow
		default = yes
		on_select = {
			custom_tooltip = deficit_approach_do_nothing_tooltip
		}
		ai_weight = {
			base = 1
		}
	}

	approach = {
		name = approach_growth_acceleration
		icon = GFX_situation_approach_exomycosis
		icon_background = GFX_situation_approach_bg_green
		on_select = {
			custom_tooltip = approach_growth_acceleration_tooltip
		}
		target_modifier = {
			planet_jobs_produces_mult = -0.25
		}
		resources = {
			category = situations
			upkeep = {
				unity = 10
				food = 50
			}
		}
		ai_weight = {
			base = 2
		}
	}

	on_monthly = {
		random_events = {
			200 = 0
			2 = theinfestation_exomycosis_event.7
		}
	}

	monthly_progress = {
		base = 0.5
		modifier = {
			desc = assimilation_pop_proportion
			add = target.value:assimilation_pop_proportion
		}
		modifier = {
			add = 0.2
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 1 } }
		}
		modifier = {
			add = 0.4
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 2 } }
		}
		modifier = {
			add = 0.6
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 3 } }
		}
		modifier = {
			add = 0.8
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 4 } }
		}
		modifier = {
			add = 1
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 5 } }
		}
		modifier = {
			add = 1.2
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 6 } }
		}
		modifier = {
			add = 1.4
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 7 } }
		}
		modifier = {
			add = 1.6
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 8 } }
		}
		modifier = {
			add = 1.8
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count = 9 } }
		}
		modifier = {
			add = 2
			desc = exomycosis_contamination_grows
			target = { count_deposits = { type = d_exofungus_contamination count >= 10 } }
		}
		modifier = {
			add = 2
			desc = string_current_approach
			current_situation_approach = situation_snow_hostile
		}
	}
}