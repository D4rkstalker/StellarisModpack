@CmtConstTotalWarCrisisActivateBackup = yes
@Orbital_deposit_boosted = 1
country_event = {
	id = CrisisManagerControl.0210
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = event_target:CmtTargetTransferSystem
		event_target:CmtTargetTransferSystem = {
			NAND = {
				exists = starbase
				exists = starbase.owner
				starbase.owner = { is_same_value = root }
			}
		}
	}

	immediate = {


		if = {
			limit = {
				NAND = {
					exists = event_target:CmtGlobalVar
					event_target:CmtGlobalVar = { check_variable = { which = CmtVarTotalWarPriority value = 1 } }
				}
			}
			if = {
				limit = { CmtTriggerIsCrisisStarbaseCountry = yes }

				if = {
					limit = {
						exists = event_target:CmtTargetSystemStarbaseLoser
						event_target:CmtTargetSystemStarbaseLoser = { CmtTriggerIsStandardStarbaseCountry = yes }
					}
					every_country = {
						limit = { has_country_flag = CmtFlagSystemFormerOwner@event_target:CmtTargetTransferSystem }
						remove_country_flag = CmtFlagSystemFormerOwner@event_target:CmtTargetTransferSystem
					}
					event_target:CmtTargetSystemStarbaseLoser = {
						set_country_flag = CmtFlagSystemFormerOwner@event_target:CmtTargetTransferSystem
					}
				}
			}
		}
	}
}

ship_event = {
	id = CrisisManagerControl.0211
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		is_ship_class = shipclass_starbase
		exists = owner
		exists = from.owner

		OR = {
			AND = {
				owner = { CmtTriggerIsCrisisStarbaseCountry = yes }
				from.owner = { CmtTriggerIsStarbaseCountry = yes }
			}
			from.owner = { CmtTriggerIsTotalWarCountry = yes }
		}
	}

	immediate = {
		solar_system = { save_event_target_as = CmtTargetTransferSystem }
		owner = { save_event_target_as = CmtTargetSystemStarbaseLoser }
		from.owner = { country_event = { id = CrisisManagerControl.0210  } }
	}
}

country_event = {
	id = CrisisManagerControl.0212
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		fromfrom = { is_ship_class = shipclass_starbase }
		OR = {
			AND = {
				CmtTriggerIsCrisisStarbaseCountry = yes
				from = { CmtTriggerIsStarbaseCountry = yes }
			}
			from = { CmtTriggerIsTotalWarCountry = yes }
		}
	}

	immediate = {
		fromfrom.solar_system = { save_event_target_as = CmtTargetTransferSystem }
		save_event_target_as = CmtTargetSystemStarbaseLoser
		from = { country_event = { id = CrisisManagerControl.0210 } }
	}
}

fleet_event = {
	id = CrisisManagerControl.0221
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		always = @CmtConstTotalWarCrisisActivateBackup

		exists = owner
		exists = from.starbase
		exists = from.starbase.owner
		from.starbase.fleet = { is_disabled = yes }

		OR = {
			owner = { CmtTriggerIsTotalWarCountry = yes }
			AND = {
				owner = { CmtTriggerIsStarbaseCountry = yes }
				from.starbase.owner = { CmtTriggerIsCrisisStarbaseCountry = yes }
			}
		}

		from = {
			any_ship_in_system = {
				exists = owner
				NOT = { owner = { is_same_value = prevprev.starbase.owner } }
				is_ship_class = shipclass_military
			}
		}
	}

	immediate = {
		from = { save_event_target_as = CmtTargetTransferSystem }
		from.starbase.owner = { save_event_target_as = CmtTargetSystemStarbaseLoser }
		owner = { country_event = { id = CrisisManagerControl.0210 } }
	}
}

event = {
	id = CrisisManagerControl.0222
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		always = @CmtConstTotalWarCrisisActivateBackup
	}

	immediate = {
		every_system = {
			limit = { exists = starbase }
			random_system_planet = {
				limit = { is_star = yes }
				planet_event = { id = CrisisManagerControl.0223 days =  5 }
				planet_event = { id = CrisisManagerControl.0223 days = 15 }
				planet_event = { id = CrisisManagerControl.0223 days = 25 }
			}
		}
	}
}

planet_event = {
	id = CrisisManagerControl.0223
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		always = @CmtConstTotalWarCrisisActivateBackup


		exists = starbase.fleet
		starbase.fleet = {
			is_ship_class = shipclass_starbase
			is_disabled = yes
		}

		solar_system = {

			NOT = {
				any_ship_in_system = {
					exists = owner
					owner = { is_same_value = root.solar_system.starbase.owner }
					is_ship_class = shipclass_military
				}
			}


			any_ship_in_system = {
				exists = owner
				owner = { CmtTriggerIsCrisisStarbaseCountry = yes }
				OR = {
					is_ship_class = shipclass_starbase
					is_ship_class = shipclass_military
				}
			}
		}


		count_country = {
			limit = {
				OR = {
					CmtTriggerIsStarbaseCountry = yes
					CmtTriggerIsCrisisKillerCountry = yes
				}
				NOT = { is_same_value = root.solar_system.starbase.owner }
				any_owned_fleet = {
					is_ship_class = shipclass_military
					any_owned_ship = { solar_system = { is_same_value = root.solar_system } }
				}
			}
			count = 1
		}
	}

	immediate = {
		solar_system = {
			save_event_target_as = CmtTargetTransferSystem
			starbase.owner = { save_event_target_as = CmtTargetSystemStarbaseLoser }
		}
		random_country = {
			limit = {
				OR = {
					CmtTriggerIsStarbaseCountry = yes
					CmtTriggerIsCrisisKillerCountry = yes
				}
				NOT = { is_same_value = root.solar_system.starbase.fleet.owner }
				any_owned_fleet = {
					is_ship_class = shipclass_military
					solar_system = { is_same_value = root.solar_system }
				}
			}
			country_event = { id = CrisisManagerControl.0210 }
		}
	}
}

fleet_event = {
	id = CrisisManagerControl.0231
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOT = { exists = from.starbase }
		exists = owner
		owner = { CmtTriggerIsCrisisStarbaseCountry = yes }

		OR = {
			AND = {
				OR = {
					is_ship_class = shipclass_military
					is_ship_class = shipclass_constructor
				}
				NAND = {
					exists = event_target:CmtGlobalVar
					event_target:CmtGlobalVar = {
						OR = {
							check_variable = { which = CmtVarTotalWarAutoBuild value = 1 }
							check_variable = { which = CmtVarTotalWarAutoBuild value = 2 }
						}
					}
				}
			}
			AND = {
				is_ship_class = shipclass_constructor
				exists = event_target:CmtGlobalVar
				event_target:CmtGlobalVar = { check_variable = { which = CmtVarTotalWarAutoBuild value = 2 } }
			}
		}
	}

	immediate = {
		from = { save_event_target_as = CmtTargetTransferSystem }
		if = {
			limit = { exists = owner }
			owner = { CmtEffectCreateStarbase = yes }
		}
	}
}

fleet_event = {
	id = CrisisManagerControl.0240
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		is_ship_class = shipclass_starbase
		has_fleet_flag = CmtFlagTotalWarLockedStarbase
	}

	immediate = {
		if = {
			limit = { CmtTriggerStarbaseShouldLocked = yes }
			fleet_event = { id = CrisisManagerControl.0240 days = 3 }
		} else = {
			set_event_locked = no
			remove_fleet_flag = CmtFlagTotalWarLockedStarbase
			remove_modifier = CmtModifierDisabledStarbase
		}
	}
}

