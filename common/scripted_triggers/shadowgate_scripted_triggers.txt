listed_as_shadowgate_target = {
    root = {
        switch = {
            trigger = has_planet_flag
            shadowgate_a = {
                prev = {
                    switch = {
                        trigger = is_scope_type
                        country = { has_country_flag = shadowgate_listed_a }
                        galactic_object = { has_star_flag = shadowgate_listed_a }
                        fleet = { has_fleet_flag = shadowgate_listed_a }
                        ship = { has_ship_flag = shadowgate_listed_a }
                        planet = { has_planet_flag = shadowgate_listed_a }
                    }
                }
            }
            shadowgate_b = {
                prev = {
                    switch = {
                        trigger = is_scope_type
                        country = { has_country_flag = shadowgate_listed_b }
                        galactic_object = { has_star_flag = shadowgate_listed_b }
                        fleet = { has_fleet_flag = shadowgate_listed_b }
                        ship = { has_ship_flag = shadowgate_listed_b }
                        planet = { has_planet_flag = shadowgate_listed_b }
                    }
                }
            }
            shadowgate_c = {
                prev = {
                    switch = {
                        trigger = is_scope_type
                        country = { has_country_flag = shadowgate_listed_c }
                        galactic_object = { has_star_flag = shadowgate_listed_c }
                        fleet = { has_fleet_flag = shadowgate_listed_c }
                        ship = { has_ship_flag = shadowgate_listed_c }
                        planet = { has_planet_flag = shadowgate_listed_c }
                    }
                }
            }
            shadowgate_d = {
                prev = {
                    switch = {
                        trigger = is_scope_type
                        country = { has_country_flag = shadowgate_listed_d }
                        galactic_object = { has_star_flag = shadowgate_listed_d }
                        fleet = { has_fleet_flag = shadowgate_listed_d }
                        ship = { has_ship_flag = shadowgate_listed_d }
                        planet = { has_planet_flag = shadowgate_listed_d }
                    }
                }
            }
            shadowgate_e = {
                prev = {
                    switch = {
                        trigger = is_scope_type
                        country = { has_country_flag = shadowgate_listed_e }
                        galactic_object = { has_star_flag = shadowgate_listed_e }
                        fleet = { has_fleet_flag = shadowgate_listed_e }
                        ship = { has_ship_flag = shadowgate_listed_e }
                        planet = { has_planet_flag = shadowgate_listed_e }
                    }
                }
            }
        }
    }
}

is_colonized_shadowgate = {
    AND = {
        is_planet_class = pc_shadowgate
        OR = { num_pops > 0 has_planet_flag = shadowgate_ashen_pilgrimage }
    }
}

shadowgate_explorers_greater_equal = {
    OR = {
        num_assigned_jobs = { job = shadowgate_researcher value >= $NUM$ }
        num_assigned_jobs = { job = shadowgate_researcher_drone value >= $NUM$ }
    }
}

has_any_shadowrift = {
    has_star_flag = has_shadowrift
}

has_any_shadowrift_respect_owner = {
    switch = {
        trigger = has_star_flag
        default = { always = no }
        has_shadowrift_a = { root = { has_planet_flag = shadowgate_a } }
        has_shadowrift_b = { root = { has_planet_flag = shadowgate_b } }
        has_shadowrift_c = { root = { has_planet_flag = shadowgate_c } }
        has_shadowrift_d = { root = { has_planet_flag = shadowgate_d } }
        has_shadowrift_e = { root = { has_planet_flag = shadowgate_e } }
    }
}

has_any_shadowrift_foreign_owner = {
    switch = {
        trigger = has_star_flag
        default = { always = no }
        has_shadowrift_a = { root = { NOT = { has_planet_flag = shadowgate_a } } }
        has_shadowrift_b = { root = { NOT = { has_planet_flag = shadowgate_b } } }
        has_shadowrift_c = { root = { NOT = { has_planet_flag = shadowgate_c } } }
        has_shadowrift_d = { root = { NOT = { has_planet_flag = shadowgate_d } } }
        has_shadowrift_e = { root = { NOT = { has_planet_flag = shadowgate_e } } }
    }
}

shadowgate_is_currently_mooring = {
    exists = owner
    OR = {
        owner = { NOT = { any_system_within_border = { has_star_flag = has_shadow_mooring_rift } } }
        switch = {
            trigger = has_planet_flag
            shadowgate_a = { owner = { any_system_within_border = { has_star_flag = has_shadowrift_a has_star_flag = has_shadow_mooring_rift } } }
            shadowgate_b = { owner = { any_system_within_border = { has_star_flag = has_shadowrift_b has_star_flag = has_shadow_mooring_rift } } }
            shadowgate_c = { owner = { any_system_within_border = { has_star_flag = has_shadowrift_c has_star_flag = has_shadow_mooring_rift } } }
            shadowgate_d = { owner = { any_system_within_border = { has_star_flag = has_shadowrift_d has_star_flag = has_shadow_mooring_rift } } }
            shadowgate_e = { owner = { any_system_within_border = { has_star_flag = has_shadowrift_e has_star_flag = has_shadow_mooring_rift } } }
        }
    }
}

shadowgate_is_military_fleet = {
    OR = {
        has_fleet_flag = shadowgate_military_fleet
        any_owned_ship = { OR = { is_ship_class = shipclass_military is_ship_class = shipclass_military_special is_ship_class = shipclass_transport AND = { is_ship_class = shipclass_starbase fleet = { is_mobile = yes } } } }
    }
}

shadowgate_is_civilian_ship = {
    OR = { has_ship_flag = shadowgate_civilian_ship is_ship_class = shipclass_colonizer is_ship_class = shipclass_constructor is_ship_class = shipclass_science_ship }
}

is_current_shadowgate_owner = {
    exists = event_target:shadowgate_owner
    event_target:shadowgate_owner = { has_country_flag = shadowgate_accessed }
    exists = controller
    controller = {
        OR = {
            is_same_value = event_target:shadowgate_owner
            AND = { is_country_type = shadowgate_ap event_target:shadowgate_owner = { has_country_flag = shadowgate_ap_accessed } }
        }
    }
}

shadowgate_is_disabled = {
    has_modifier = pm_shadowgate_disabled
}

need_allied_shadowgate = {
    OR = {
        AND = { exists = event_target:shadowgate_ap_country event_target:shadowgate_ap_country = { has_communications = prev NOT = { is_hostile = prev } } }
        any_owned_planet = { is_colonized_shadowgate = yes controller = { is_same_value = prevprev } }
        count_federation_ally = { count > 0 limit = { any_owned_planet = { is_colonized_shadowgate = yes controller = { is_same_value = prevprev } } } }
    }
}

shadowgate_system_is_not_sealed = {
    if = { limit = { exists = space_owner }
        space_owner = {
            OR = {
                check_variable = { which = ShadowgateSeal value = 0 }
                is_same_value = event_target:shadowgate_owner
                is_in_federation_with = event_target:shadowgate_owner
                AND = { check_variable = { which = ShadowgateSeal value > 0 } NOR = { is_hostile = event_target:shadowgate_owner has_closed_borders = event_target:shadowgate_owner } }
            }
        }
    }
    else = { always = yes }
}

shadowgate_is_hidden_country = {
    NOT = { is_same_value = event_target:shadowgate_owner }
    has_country_flag = shadowgate_hidden_country
}

system_is_valid_shadowrift_target = {
    NOR = { has_star_flag = shadowgate_hidden_system has_star_flag = wild_space_system }
    if = { limit = { exists = event_target:shadowgate_owner NOT = { has_star_flag = shadow_anchor } } event_target:shadowgate_owner = { intel_level = { system = prev level > none } } }
    if = { limit = { exists = space_owner } space_owner = { NOT = { shadowgate_is_hidden_country = yes } } }
    if = { limit = { root = { NOT = { has_planet_flag = shadowgate_vc_effect } } } NOT = { has_star_flag = shadowgate_shadow_remnant } }
    if = { limit = { root = { OR = { event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } has_planet_flag = shadowgate_placing_shadow_anchor } } }
        NOT = { has_star_flag = shadowgate_solar_system }
    }
    else_if = { limit = { has_star_flag = shadowgate_solar_system root = { NOT = { has_planet_flag = shadowgate_placing_shadow_anchor } } }
        any_system_planet = {
            switch = {
                trigger = has_planet_flag
                shadowgate_a = { root = { has_planet_flag = shadowgate_a } }
                shadowgate_b = { root = { has_planet_flag = shadowgate_b } }
                shadowgate_c = { root = { has_planet_flag = shadowgate_c } }
                shadowgate_d = { root = { has_planet_flag = shadowgate_d } }
                shadowgate_e = { root = { has_planet_flag = shadowgate_e } }
            }
        }
    }
    else = { always = yes }
}

shadowgate_antiresonant_void_check = {
    OR = {
        if = { limit = { exists = space_owner }
            space_owner = { has_relic = r_shadowgate_crwt_active }
        }
        else = { always = no }
        if = { limit = { has_global_flag = ai_invasion_happened NOT = { has_global_flag = ai_invasion_defeated } }
            OR = {
                if = { limit = { exists = space_owner } space_owner = { is_country_type = ai_empire } }
                any_system = {
                    distance = { source = prev max_jumps <= 5 }
                    exists = space_owner
                    space_owner = { is_country_type = ai_empire }
                    OR = { has_star_flag = AI_hub has_star_flag = AI_lair }
                    any_system_planet = { is_planet_class = pc_ai NOT = { has_planet_flag = shadowgate_crwt_removed } }
                }
            }
        }
        else = { always = no }
    }
}

system_is_valid_random_shadowrift_target = {
    count_system_planet = { count >= 1 limit = { NOR = { is_star = yes is_colonizable = yes is_colony = yes is_planet_class = pc_black_hole } } }
    if = { limit = { exists = event_target:shadowgate_owner } shadowgate_system_is_not_sealed = yes }
    system_is_valid_shadowrift_target = yes
    NOR = {
        has_any_shadowrift = yes
        is_same_value = event_target:shadowgate_origin_system
        has_star_flag = shadowgate_solar_system
        has_star_flag = shadowgate_shadow_remnant
        has_star_flag = shadowgate_unique_system_sealed
        has_star_flag = shadowgate_blocked_system
        shadowgate_antiresonant_void_check = yes
    }
}

system_has_stabilized_shadowrift = {
    any_system_megastructure = { has_megastructure_flag = shadowrift }
}

system_has_active_shadow_anchor = {
    if = { limit = { NOT = { event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } } }
        event_target:shadowgate_origin_system = { has_star_flag = active_shadow_anchor any_system_megastructure = { is_megastructure_type = shadow_anchor } }
    }
    if = { limit = { NOT = { event_target:shadowgate_destination_system = { has_star_flag = shadowgate_solar_system } } }
        event_target:shadowgate_destination_system = { has_star_flag = active_shadow_anchor any_system_megastructure = { is_megastructure_type = shadow_anchor } }
    }
}

system_has_shadow_remnant = {
    if = { limit = { NOT = { event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } } }
        event_target:shadowgate_origin_system = { has_star_flag = shadowgate_shadow_remnant }
    }
    if = { limit = { NOT = { event_target:shadowgate_destination_system = { has_star_flag = shadowgate_solar_system } } }
        event_target:shadowgate_destination_system = { has_star_flag = shadowgate_shadow_remnant }
    }
}

shadowgate_shadowrift_is_under_assault = {
    if = { limit = { has_planet_flag = shadowrift_active }
        switch = {
            trigger = has_planet_flag
            shadowgate_a = { event_target:shadowrift_country_a = { any_owned_fleet = { is_in_combat = yes } } }
            shadowgate_b = { event_target:shadowrift_country_b = { any_owned_fleet = { is_in_combat = yes } } }
            shadowgate_c = { event_target:shadowrift_country_c = { any_owned_fleet = { is_in_combat = yes } } }
            shadowgate_d = { event_target:shadowrift_country_d = { any_owned_fleet = { is_in_combat = yes } } }
            shadowgate_e = { event_target:shadowrift_country_e = { any_owned_fleet = { is_in_combat = yes } } }
        }
    }
    else = { always = no }
}

shadowgate_check_for_system_shadow_anchor_placement = {
    if = { limit = { root = { has_planet_flag = shadowgate_placing_shadow_anchor } }
        OR = { has_star_flag = allow_shadow_anchor NOR = { has_star_flag = shadow_anchor has_star_flag = prevent_shadow_anchor any_system_planet = { has_planet_flag = shadowgate_anchor_target } } }
        is_within_borders_of = event_target:shadowgate_owner
    }
}

shadowgate_is_purifier = {
    OR = {
        has_country_flag = shadowgate_ap_restricted
        has_valid_civic = civic_fanatic_purifiers
        has_valid_civic = civic_machine_terminator
        has_valid_civic = civic_hive_devouring_swarm
    }
}

shadowgate_is_fe = {
    is_country_type = fallen_empire
}

shadowgate_is_ae = {
    is_country_type = awakened_fallen_empire
}

all_shadowgate_event_targets_exist = {
    exists = event_target:shadowgate_origin_system
    exists = event_target:shadowgate_destination_system
}

shadowgate_summon_normal_allow_check = {
    hidden_trigger = {
        NOT = { has_global_flag = shadowgate_opening }
        if = { limit = { NOT = { has_planet_flag = shadowgate_sp_effect } } event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } }
        event_target:shadowgate_origin_system = { if = { limit = { NOT = { has_star_flag = shadowgate_solar_system } } system_is_valid_shadowrift_target = yes } NOT = { shadowgate_antiresonant_void_check = yes } }
        event_target:shadowgate_destination_system = { system_is_valid_shadowrift_target = yes NOT = { shadowgate_antiresonant_void_check = yes } }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.cost.energy
        if = { limit = { has_planet_flag = shadowgate_ashen_pilgrimage }
            event_target:shadowgate_owner = {
                if = { limit = { NOT = { has_country_flag = shadowgate_ap_rift_gifted } }
                    if = { limit = { has_origin = origin_shadow_remnant }
                        has_resource = { type = energy amount >= @shadowgate_ap_summon_cost_origin_en_p }
                    }
                    else = { has_resource = { type = energy amount >= @shadowgate_ap_summon_cost_en_p } }
                }
            }
        }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.cost.ether
        if = { limit = { NOT = { has_planet_flag = shadowgate_ashen_pilgrimage } }
            check_variable_arithmetic = { which = ShadowgateEther subtract = ShadowgateEtherCost value >= 0 }
        }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.no.planet.fail
        event_target:shadowgate_origin_system = { any_system_planet = { OR = { has_planet_flag = shadowgate_planet has_planet_flag = shadowgate_shadow_remnant NOR = { is_star = yes is_colonizable = yes is_colony = yes is_planet_class = pc_black_hole } } } }
        event_target:shadowgate_destination_system = { any_system_planet = { OR = { has_planet_flag = shadowgate_planet has_planet_flag = shadowgate_shadow_remnant NOR = { is_star = yes is_colonizable = yes is_colony = yes is_planet_class = pc_black_hole } } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.sp.remnant.fail
        event_target:shadowgate_origin_system = { NOT = { has_star_flag = shadowgate_shadow_remnant } }
    }
    # Common Tooltips
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rch.minimum
        if = { limit = { has_planet_flag = shadowgate_rch_effect } check_variable = { which = ShadowgateRPProjected value >= ShadowgateRPMin } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.origin
        event_target:shadowgate_origin_system = { if = { limit = { has_any_shadowrift = yes } has_any_shadowrift_respect_owner = yes } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.destination
        event_target:shadowgate_destination_system = { if = { limit = { has_any_shadowrift = yes NOR = { is_same_value = event_target:shadowgate_origin_system has_any_shadowrift_respect_owner = yes } } NOT = { has_any_shadowrift = yes } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.destination.owned
        event_target:shadowgate_destination_system = { if = { limit = { NOT = { is_same_value = event_target:shadowgate_origin_system } } NOT = { has_any_shadowrift_respect_owner = yes } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.error.all
        NOT = { shadowgate_is_disabled = yes }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.ownership
        is_current_shadowgate_owner = yes
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.system.sealed
        event_target:shadowgate_origin_system = { shadowgate_system_is_not_sealed = yes }
        event_target:shadowgate_destination_system = { shadowgate_system_is_not_sealed = yes }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.queued.tooltip
        NOT = { has_planet_flag = shadowrift_queued }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.summoning.tooltip
        NOT = { has_modifier = pm_shadowgate_summoning }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.cooldown.tooltip
        NOT = { has_modifier = pm_shadowgate_cooldown }
    }
    custom_tooltip = {
        fail_text = shadowgate.shadowrift.same.as.origin.fail
        event_target:shadowgate_destination_system = { NOT = { is_same_value = event_target:shadowgate_origin_system } }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.blocked
        all_shadowgate_event_targets_exist = yes
        event_target:shadowgate_destination_system = { NOT = { has_star_flag = shadowgate_blocked_system } }
    }
}


shadowgate_summon_remnant_allow_check = {
    hidden_trigger = {
        has_planet_flag = shadowgate_vc_effect
        NOT = { has_global_flag = shadowgate_opening }
        if = { limit = { NOT = { has_planet_flag = shadowgate_sp_effect } } event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } }
        system_has_shadow_remnant = yes
        event_target:shadowgate_origin_system = { if = { limit = { NOT = { has_star_flag = shadowgate_solar_system } } system_is_valid_shadowrift_target = yes } NOT = { shadowgate_antiresonant_void_check = yes } }
        event_target:shadowgate_destination_system = { system_is_valid_shadowrift_target = yes NOT = { shadowgate_antiresonant_void_check = yes } }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.cost.ether
        check_variable_arithmetic = { which = ShadowgateEther subtract = ShadowgateEtherCost value >= 0 }
    }
    custom_tooltip = {
        if = { limit = { has_planet_flag = shadowgate_sp_effect NOR = { event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } event_target:shadowgate_destination_system = { has_star_flag = shadowgate_solar_system } } }
            event_target:shadowgate_origin_system = { has_star_flag = shadowgate_shadow_remnant }
            event_target:shadowgate_destination_system = { has_star_flag = shadowgate_shadow_remnant }
        }
        fail_text = shadowgate.sp.remnant.fail
    }
    # Common Tooltips
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rch.minimum
        if = { limit = { has_planet_flag = shadowgate_rch_effect } check_variable = { which = ShadowgateRPProjected value >= ShadowgateRPMin } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.origin
        event_target:shadowgate_origin_system = { if = { limit = { has_any_shadowrift = yes } has_any_shadowrift_respect_owner = yes } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.destination
        event_target:shadowgate_destination_system = { if = { limit = { has_any_shadowrift = yes NOR = { is_same_value = event_target:shadowgate_origin_system has_any_shadowrift_respect_owner = yes } } NOT = { has_any_shadowrift = yes } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.destination.owned
        event_target:shadowgate_destination_system = { if = { limit = { NOT = { is_same_value = event_target:shadowgate_origin_system } } NOT = { has_any_shadowrift_respect_owner = yes } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.error.all
        NOT = { shadowgate_is_disabled = yes }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.ownership
        is_current_shadowgate_owner = yes
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.system.sealed
        event_target:shadowgate_origin_system = { shadowgate_system_is_not_sealed = yes }
        event_target:shadowgate_destination_system = { shadowgate_system_is_not_sealed = yes }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.queued.tooltip
        NOT = { has_planet_flag = shadowrift_queued }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.summoning.tooltip
        NOT = { has_modifier = pm_shadowgate_summoning }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.cooldown.tooltip
        NOT = { has_modifier = pm_shadowgate_cooldown }
    }
    custom_tooltip = {
        fail_text = shadowgate.shadowrift.same.as.origin.fail
        event_target:shadowgate_destination_system = { NOT = { is_same_value = event_target:shadowgate_origin_system } }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.blocked
        all_shadowgate_event_targets_exist = yes
        event_target:shadowgate_destination_system = { NOT = { has_star_flag = shadowgate_blocked_system } }
    }
}

shadowgate_summon_anchor_allow_check = {
    hidden_trigger = {
        NOT = { has_global_flag = shadowgate_opening }
        if = { limit = { NOT = { has_planet_flag = shadowgate_sp_effect } } event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } }
        system_has_active_shadow_anchor = yes
        event_target:shadowgate_origin_system = { if = { limit = { NOT = { has_star_flag = shadowgate_solar_system } } system_is_valid_shadowrift_target = yes } NOT = { shadowgate_antiresonant_void_check = yes } }
        event_target:shadowgate_destination_system = { system_is_valid_shadowrift_target = yes NOT = { shadowgate_antiresonant_void_check = yes } }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.cost.energy
        if = { limit = { has_planet_flag = shadowgate_ashen_pilgrimage }
            event_target:shadowgate_owner = {
                if = { limit = { has_origin = origin_shadow_remnant }
                    has_resource = { type = energy amount >= @shadowgate_ap_summon_cost_origin_en_p }
                }
                else = { has_resource = { type = energy amount >= @shadowgate_ap_summon_cost_en_p } }
            }
        }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.cost.ether
        if = { limit = { NOT = { has_planet_flag = shadowgate_ashen_pilgrimage } }
            check_variable_arithmetic = { which = ShadowgateEther subtract = ShadowgateEtherCost value >= 0 }
        }
    }
    custom_tooltip = {
        if = { limit = { OR = { event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } event_target:shadowgate_destination_system = { has_star_flag = shadowgate_solar_system } } }
            OR = { event_target:shadowgate_origin_system = { has_star_flag = active_shadow_anchor } event_target:shadowgate_destination_system = { has_star_flag = active_shadow_anchor } }
        }
        fail_text = shadowgate.open.shadowrift.fail.anchor.inactive
    }
    custom_tooltip = {
        if = { limit = { has_planet_flag = shadowgate_sp_effect NOR = { event_target:shadowgate_origin_system = { has_star_flag = shadowgate_solar_system } event_target:shadowgate_destination_system = { has_star_flag = shadowgate_solar_system } } }
            event_target:shadowgate_origin_system = { has_star_flag = active_shadow_anchor }
            event_target:shadowgate_destination_system = { has_star_flag = active_shadow_anchor }
        }
        fail_text = shadowgate.sp.anchor.fail
    }
    # Common Tooltips
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rch.minimum
        if = { limit = { has_planet_flag = shadowgate_rch_effect } check_variable = { which = ShadowgateRPProjected value >= ShadowgateRPMin } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.origin
        event_target:shadowgate_origin_system = { if = { limit = { has_any_shadowrift = yes } has_any_shadowrift_respect_owner = yes } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.destination
        event_target:shadowgate_destination_system = { if = { limit = { has_any_shadowrift = yes NOR = { is_same_value = event_target:shadowgate_origin_system has_any_shadowrift_respect_owner = yes } } NOT = { has_any_shadowrift = yes } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.rift.destination.owned
        event_target:shadowgate_destination_system = { if = { limit = { NOT = { is_same_value = event_target:shadowgate_origin_system } } NOT = { has_any_shadowrift_respect_owner = yes } } }
    }
    custom_tooltip = {
        fail_text = shadowgate.error.all
        NOT = { shadowgate_is_disabled = yes }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.ownership
        is_current_shadowgate_owner = yes
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.system.sealed
        event_target:shadowgate_origin_system = { shadowgate_system_is_not_sealed = yes }
        event_target:shadowgate_destination_system = { shadowgate_system_is_not_sealed = yes }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.queued.tooltip
        NOT = { has_planet_flag = shadowrift_queued }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.summoning.tooltip
        NOT = { has_modifier = pm_shadowgate_summoning }
    }
    custom_tooltip = {
        fail_text = shadowgate.open.shadowrift.fail.cooldown.tooltip
        NOT = { has_modifier = pm_shadowgate_cooldown }
    }
    custom_tooltip = {
        fail_text = shadowgate.shadowrift.same.as.origin.fail
        event_target:shadowgate_destination_system = { NOT = { is_same_value = event_target:shadowgate_origin_system } }
    }
    custom_tooltip = {
        fail_text = shadowgate.fail.blocked
        all_shadowgate_event_targets_exist = yes
        event_target:shadowgate_destination_system = { NOT = { has_star_flag = shadowgate_blocked_system } }
    }
}

shadowgate_is_valid_lodestone_recipient = {
    OR = {
        NOT = { exists = event_target:shadowgate_planet_$SHADOWGATE$ }
        event_target:shadowgate_planet_$SHADOWGATE$ = {
            OR = {
                NOT = { exists = owner }
                has_planet_flag = shadowgate_dl_cooldown
                shadowgate_is_disabled = yes
                has_planet_flag = shadowgate_ashen_pilgrimage
                owner = {
                    OR = {
                        has_country_flag = shadowgate_dl_cooldown
                        has_country_flag = shadowgate_refused_dl
                        NOT = { has_country_flag = shadowgate_dl_knowledge }
                    }
                }
            }
        }
    } 
}

shadowgate_d_compass_outer_limit_values = {
    OR = {
        AND = {
            if = { limit = { has_planet_flag = shadowgate_dc } check_variable = { which = ShadowgateLodestonesActive value < 3 } }
            else_if = { limit = { owner = { has_relic = r_shadowgate_shadowforge } } check_variable = { which = ShadowgateLodestonesActive value < 2 } }
            else = { always = yes }
        }
        AND = { has_planet_flag = shadowgate_dc owner = { has_relic = r_shadowgate_shadowforge } check_variable = { which = ShadowgateLodestonesActive value < 4 } }
    }
}

shadowgate_d_compass_outer_limit = {
    from = {
        if = { limit = { NOR = { has_country_flag = shadowgate_d_compass_saved has_country_flag = shadowgate_d_compass_finalized } }
            switch = {
                trigger = has_country_flag
                shadowgate_a_accessed = { event_target:shadowgate_planet_a = { shadowgate_d_compass_outer_limit_values = yes } }
                shadowgate_b_accessed = { event_target:shadowgate_planet_b = { shadowgate_d_compass_outer_limit_values = yes } }
                shadowgate_c_accessed = { event_target:shadowgate_planet_c = { shadowgate_d_compass_outer_limit_values = yes } }
                shadowgate_d_accessed = { event_target:shadowgate_planet_d = { shadowgate_d_compass_outer_limit_values = yes } }
                shadowgate_e_accessed = { event_target:shadowgate_planet_e = { shadowgate_d_compass_outer_limit_values = yes } }
            }
        }
        else = { always = yes }
    }
}

shadowgate_d_compass_dc_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { OR = { AND = { num_districts = { type = district_harmonic_subspace_resonator value = 3 } num_districts = { type = district_shadow_pulse_condenser value = 3 } num_districts = { type = district_spectral_projection_array value = 3 } } } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { OR = { AND = { num_districts = { type = district_harmonic_subspace_resonator value = 3 } num_districts = { type = district_shadow_pulse_condenser value = 3 } num_districts = { type = district_spectral_projection_array value = 3 } } } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { OR = { AND = { num_districts = { type = district_harmonic_subspace_resonator value = 3 } num_districts = { type = district_shadow_pulse_condenser value = 3 } num_districts = { type = district_spectral_projection_array value = 3 } } } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { OR = { AND = { num_districts = { type = district_harmonic_subspace_resonator value = 3 } num_districts = { type = district_shadow_pulse_condenser value = 3 } num_districts = { type = district_spectral_projection_array value = 3 } } } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { OR = { AND = { num_districts = { type = district_harmonic_subspace_resonator value = 3 } num_districts = { type = district_shadow_pulse_condenser value = 3 } num_districts = { type = district_spectral_projection_array value = 3 } } } } }
        }
    }
}

shadowgate_d_compass_rch_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { num_districts = { type = district_shadow_pulse_condenser value >= 2 } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { num_districts = { type = district_shadow_pulse_condenser value >= 2 } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { num_districts = { type = district_shadow_pulse_condenser value >= 2 } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { num_districts = { type = district_shadow_pulse_condenser value >= 2 } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { num_districts = { type = district_shadow_pulse_condenser value >= 2 } } }
        }
    }
}

shadowgate_d_compass_dup_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { num_districts = { type = district_spectral_projection_array value >= 2 } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { num_districts = { type = district_spectral_projection_array value >= 2 } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { num_districts = { type = district_spectral_projection_array value >= 2 } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { num_districts = { type = district_spectral_projection_array value >= 2 } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { num_districts = { type = district_spectral_projection_array value >= 2 } } }
        }
    }
}

shadowgate_d_compass_sp_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { num_districts = { type = district_harmonic_subspace_resonator value >= 2 } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { num_districts = { type = district_harmonic_subspace_resonator value >= 2 } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { num_districts = { type = district_harmonic_subspace_resonator value >= 2 } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { num_districts = { type = district_harmonic_subspace_resonator value >= 2 } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { num_districts = { type = district_harmonic_subspace_resonator value >= 2 } } }
        }
    }
}

shadowgate_d_compass_vc_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { num_districts = { type = district_spectral_projection_array value >= 1 } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { num_districts = { type = district_spectral_projection_array value >= 1 } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { num_districts = { type = district_spectral_projection_array value >= 1 } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { num_districts = { type = district_spectral_projection_array value >= 1 } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { num_districts = { type = district_spectral_projection_array value >= 1 } } }
        }
    }
}

shadowgate_d_compass_asp_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { num_districts = { type = district_shadow_pulse_condenser value >= 1 } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { num_districts = { type = district_shadow_pulse_condenser value >= 1 } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { num_districts = { type = district_shadow_pulse_condenser value >= 1 } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { num_districts = { type = district_shadow_pulse_condenser value >= 1 } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { num_districts = { type = district_shadow_pulse_condenser value >= 1 } } }
        }
    }
}

shadowgate_d_compass_sm_unlocked = {
    from = {
        switch = {
            trigger = has_country_flag
            shadowgate_a_accessed = { event_target:shadowgate_planet_a = { num_districts = { type = district_harmonic_subspace_resonator value >= 1 } } }
            shadowgate_b_accessed = { event_target:shadowgate_planet_b = { num_districts = { type = district_harmonic_subspace_resonator value >= 1 } } }
            shadowgate_c_accessed = { event_target:shadowgate_planet_c = { num_districts = { type = district_harmonic_subspace_resonator value >= 1 } } }
            shadowgate_d_accessed = { event_target:shadowgate_planet_d = { num_districts = { type = district_harmonic_subspace_resonator value >= 1 } } }
            shadowgate_e_accessed = { event_target:shadowgate_planet_e = { num_districts = { type = district_harmonic_subspace_resonator value >= 1 } } }
        }
    }
}

is_available_target_for_shadowrift = {
    NOT = { has_planet_flag = invalid_shadowrift_planet } # Place on planets you want excluded when a random system planet is selected for shadowrift placement.
    OR = { NOR = { is_star = yes is_colony = yes is_colonizable = yes is_asteroid = yes is_moon = yes } has_planet_flag = has_shadow_anchor has_planet_flag = valid_shadowrift_planet } # Place on planets you want included when a random system planet is selected for shadowrift placement.
}

shadowgate_megastructure_build_inclusion = { # Any megastructure listed here is buildable inside shadowgate and shadow remnant systems.
    OR = {
        is_constructing = gateway_0
        is_constructing = hyper_relay
    }
}

shadowgate_aggressor_is_valid_cb_target = {
    NOR = { is_in_federation_with = root.from is_hostile = root.from has_casus_belli = { type = cb_shadowrift_attacked target = root.from } }
    root.from = { OR = { is_country_type = default shadowgate_is_fe = yes shadowgate_is_ae = yes } }
    OR = { is_subject = no overlord = { NOT = { is_same_value = root.from } } }
    root.fromfrom.solar_system = { has_access_fleet = event_target:shadowgate_assaulted_owner }
    has_communications = root.from
}

shadowgate_dl_excluded = {
    NOR = {
        has_planet_flag = megastructure
        has_planet_flag = has_megastructure
        solar_system = {
            OR = {
                has_star_flag = shadowgate_solar_system
                has_star_flag = shadowgate_shadow_remnant
                has_star_flag = shadowgate_unique_system_sealed
                has_star_flag = shadowgate_dl_exclude
            }
        }
    }
}

shadowgate_global_buff_check = {
    OR = {
        has_global_flag = activate_shadowgate_global_buff
        has_global_flag = acot_activated
        has_global_flag = giga_has_host
    }
}