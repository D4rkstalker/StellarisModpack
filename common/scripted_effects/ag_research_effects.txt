# All effects hera are in Country Scope.

# ag_give_research_project
# Parameters:
# ag_project_id
# ag_progress, default is 5

# ag_save_current_progress
# Parameters:
# clear_current_research: yes, no(default)

# ag_modify_research_project_elem
# Parameters:
# ag_research_project_id
# ag_operation: set, change, subtract, multiply, divide
# ag_variable: difficulty, required_progress, total_progress
# ag_value

# ag_finish_research_project
# Parameters:
# ag_project_id

ag_calculate_research_progress = {
	optimize_memory
	# formula: 10 * ag_skill_bonus / ag_difficulty * ag_random_factor

	# Scientist leader skill bonus
	set_variable = { which = ag_skill_bonus value = 5 }
	if = {
		limit = { any_owned_leader = { OR = { is_councilor_type = councilor_research is_councilor_type = councilor_gestalt_scientist } } }
		random_owned_leader = {
			limit = { OR = { is_councilor_type = councilor_research is_councilor_type = councilor_gestalt_scientist } }
			ag_set_leader_skill_variable = { ag_which = ag_skill_bonus ag_scale = 10 }
			# Interaction event.
			if = {
				limit = {
					has_global_flag = has_StellarRegulator_Array_mod
					has_trait = leader_trait_SRA_ag_StarLightII_sci1
					prevprev = { exists = leader leader = {
						has_trait = leader_trait_SRA_ag_StarLightII_sci1
					} }
				}
				prev = {
					set_variable = { which = ag_skill_bonus value = @ag_SRA_interaction_skill_bonus }
					random_list = {
						10 = { }
						10 = { change_variable = { which = ag_skill_bonus value = 5 } }
						10 = { change_variable = { which = ag_skill_bonus value = 10 } }
						10 = { change_variable = { which = ag_skill_bonus value = 15 } }
						10 = { change_variable = { which = ag_skill_bonus value = 20 } }
						10 = { change_variable = { which = ag_skill_bonus value = 25 } }
					}
					reroll_random = yes
				}
			}
		}
	}

	# Difficulty
	set_variable = { which = ag_difficulty value = ag_current_difficulty }
	multiply_variable = { which = ag_difficulty value = 20 }
	ag_randomize_variable = { ag_which = ag_difficulty ag_scale = 100 }

	# Random factor
	set_variable = { which = ag_random_factor value = 1.0 }
	ag_randomize_variable = { ag_which = ag_random_factor ag_scale = 10 }

	# ag_set_research_project_progress = yes
	set_variable = { which = ag_currently_progress value = value:ag_research_project_round_progress }
}
# ag_set_research_project_progress = {
	# optimize_memory
	# set_variable = { which = ag_currently_progress value = 10 }
	# multiply_variable = { which = ag_currently_progress value = ag_skill_bonus }
	# divide_variable = { which = ag_currently_progress value = ag_difficulty }
	# multiply_variable = { which = ag_currently_progress value = ag_random_factor }
	# multiply_variable = { which = ag_currently_progress value = value:ag_modifier_mult_multiplier|ag_modifier|ag_research_progress_mult| }
	# # if = {
		# # limit = { has_modifier = "ag_ancient_knowledge_projects_buff" }
		# # multiply_variable = { which = ag_currently_progress value = 1.15 }
	# # }
	# if = {
		# limit = { has_modifier = "ag_debug_modifier_buff_common" }
		# set_variable = { which = ag_currently_progress value = 1000.0 }
	# }
# }
ag_completed_research_project_effect = {
	optimize_memory
	create_message = {
		type = "message_ag_research_project_completed"
		localization = "message_ag_research_project_completed_message_desc"
		days = 20
		target = this
		variable = {
			type = name
			localization = "ag_location"
			scope = prev.from
		}
		variable = {
			type = name
			localization = "ag_science_ship"
			scope = prev
		}
	}
	set_country_flag = ag_current_research_completed
	country_event = { id = ag_research.4 days = 1 }
}
ag_continue_research_project_effect = {
	optimize_memory
	create_message = {
		type = "message_ag_research_project_in_progress"
		localization = "message_ag_research_project_in_progress_message_desc"
		days = 20
		target = this
		variable = {
			type = name
			localization = "ag_location"
			scope = prev.from
		}
		variable = {
			type = name
			localization = "ag_science_ship"
			scope = prev
		}
		variable = {
			type = variable
			varname = ag_currently_progress
			localization = "ag_currently_progress"
			scope = this
		}
	}
	begin_event_chain = { event_chain = $ag_event_chain$ target = this }
	if = {
		limit = { OR = {
			has_country_flag = ag_current_area_phy
			has_country_flag = ag_current_area_soc
			has_country_flag = ag_current_area_eng
		} }
		prev.from = { enable_special_project = { name = $ag_project$ location = this owner = prev } }
		prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$ target = prevprev.from } }
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_soc }
		random_list = {
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_phy location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_phy target = prevprev.from } }
			}
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_soc location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_soc target = prevprev.from } }
			}
		}
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_eng }
		random_list = {
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_phy location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_phy target = prevprev.from } }
			}
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_eng location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_eng target = prevprev.from } }
			}
		}
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_soc_eng }
		random_list = {
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_soc location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_soc target = prevprev.from } }
			}
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_eng location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_eng target = prevprev.from } }
			}
		}
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_soc_eng }
		random_list = {
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_phy location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_phy target = prevprev.from } }
			}
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_soc location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_soc target = prevprev.from } }
			}
			50 = {
				prev.from = { enable_special_project = { name = $ag_project$_eng location = this owner = prev } }
				prev.fleet = { fleet_action_research_special_project = { special_project = $ag_project$_eng target = prevprev.from } }
			}
		}
	}
}
ag_finished_research_round = {
	optimize_memory
	end_event_chain = $ag_event_chain$
	change_variable = { which = ag_total_progress value = ag_currently_progress }
	if = {
		limit = { check_variable = { which = ag_total_progress value >= ag_required_progress } }
		set_variable = { which = ag_total_progress value = ag_required_progress }
		set_variable = { which = ag_research_project_counter value = 0 }
		ag_completed_research_project_effect = yes
	}
	else = { change_variable = { which = ag_research_project_counter value = 1 } }
	if = {
		limit = { check_variable = { which = ag_research_project_counter value > @ag_research_project_round_special_projects } }
		set_country_flag = ag_current_research_abort
		set_variable = { which = ag_research_project_counter value = 0 }
		set_variable = { which = ag_research_progress_reserve_var value = 0 }
		if = {
			limit = { check_modifier_value = { modifier = ag_research_progress_reserve value != 0 } }
			change_variable = { which = ag_research_progress_reserve_var value = modifier:ag_research_progress_reserve }
			multiply_variable = { which = ag_research_progress_reserve_var value = 100 }
		}
		random_list = {
			100 = {
				modifier = { add = value:ag_negative_variable|ag_which|ag_research_progress_reserve_var| }
				if = {
					limit = { prev = { NOR = {
						is_ship_class = shipclass_constructor
						is_ship_class = shipclass_colonizer
					} } }

					set_variable = { which = ag_current_progress_lvl value = ag_total_progress }
					divide_variable = { which = ag_current_progress_lvl value = ag_required_progress }

					if = {
						limit = { check_variable = { which = ag_current_progress_lvl value >= 0.8 } }
						set_variable = { which = ag_current_progress_lvl value = 4 }
					}
					else_if = {
						limit = { check_variable = { which = ag_current_progress_lvl value >= 0.6 } }
						set_variable = { which = ag_current_progress_lvl value = 3 }
					}
					else_if = {
						limit = { check_variable = { which = ag_current_progress_lvl value >= 0.4 } }
						set_variable = { which = ag_current_progress_lvl value = 2 }
					}
					else_if = {
						limit = { check_variable = { which = ag_current_progress_lvl value >= 0.2 } }
						set_variable = { which = ag_current_progress_lvl value = 1 }
					}
					else_if = { limit = { always = yes } set_variable = { which = ag_current_progress_lvl value = 0 } }

					# Scientist on ship decides how many progress will be saved.
					if = {
						limit = { prev = { exists = leader } }
						prev.leader = {
							# Set leader bonus.
							prev = {
								set_variable = { which = ag_skill_bonus_alt value = prev.trigger:has_skill }
								if = {
									limit = { check_variable = { which = ag_skill_bonus_alt value > 10 } }
									subtract_variable = { which = ag_skill_bonus_alt value = 10 }
									multiply_variable = { which = ag_skill_bonus_alt value = 0.05 }
									change_variable = { which = ag_skill_bonus_alt value = 10 }
								}
								ag_randomize_variable = { ag_which = ag_skill_bonus_alt ag_scale = 10 }
								multiply_variable = { which = ag_skill_bonus_alt value = 10 }
							}

							# Interaction event.
							if = {
								limit = {
									has_global_flag = has_StellarRegulator_Array_mod
									OR = {
										has_trait = leader_trait_SRA_ag_StarLightII_sci1
										prev = { has_country_flag = ag_SRA_interaction_scientist_effect }
									}
								}
								if = {
									limit = { prev = { has_country_flag = ag_SRA_interaction_scientist_effect } }
									prev = { remove_country_flag = ag_SRA_interaction_scientist_effect }
								}
								prev = {
									set_variable = { which = ag_skill_bonus_alt value = @ag_SRA_interaction_skill_bonus }
									random_list = {
										10 = { }
										10 = { change_variable = { which = ag_skill_bonus_alt value = 5 } }
										10 = { change_variable = { which = ag_skill_bonus_alt value = 10 } }
										10 = { change_variable = { which = ag_skill_bonus_alt value = 15 } }
										10 = { change_variable = { which = ag_skill_bonus_alt value = 20 } }
										10 = { change_variable = { which = ag_skill_bonus_alt value = 25 } }
									}
									reroll_random = yes
								}
							}
						}
					}
					else = {
						set_variable = { which = ag_skill_bonus_alt value = 5 }
						ag_randomize_variable = { ag_which = ag_skill_bonus_alt ag_scale = 10 }
					}

					set_variable = { which = ag_difficulty_alt value = ag_current_difficulty }
					multiply_variable = { which = ag_difficulty_alt value = 20 }
					ag_randomize_variable = { ag_which = ag_difficulty_alt ag_scale = 100 }

					ag_save_research_project_progress_value = yes
					# set_variable = { which = ag_saved_progress value = value:ag_research_project_progress_saved }
					if = {
						limit = { check_variable = { which = ag_saved_progress value < 0 } }
						set_variable = { which = ag_total_progress_reduce_perc value = 0.5 }
						change_variable = { which = ag_total_progress_reduce_perc value = ag_saved_progress }
						ag_randomize_variable = { ag_which = ag_total_progress_reduce_perc }

						if = {
							limit = { check_variable = { which = ag_total_progress_reduce_perc value < 0.5 } }
							set_variable = { which = ag_total_progress_reduce_perc value = 0.5 }
						}
						else_if = {
							limit = { check_variable = { which = ag_total_progress_reduce_perc value > 1.0 } }
							set_variable = { which = ag_total_progress_reduce_perc value = 1.0 }
						}

						multiply_variable = { which = ag_total_progress value = ag_total_progress_reduce_perc }
					}
					else = {
						set_variable = { which = ag_total_progress_reduce_perc value = 0 }
						change_variable = { which = ag_total_progress_reduce_perc value = ag_saved_progress }
						ag_randomize_variable = { ag_which = ag_total_progress_reduce_perc }

						if = {
							limit = { check_variable = { which = ag_total_progress_reduce_perc value < 0.5 } }
							set_variable = { which = ag_total_progress_reduce_perc value = 0.5 }
						}
						else_if = {
							limit = { check_variable = { which = ag_total_progress_reduce_perc value > 1.0 } }
							set_variable = { which = ag_total_progress_reduce_perc value = 1.0 }
						}

						multiply_variable = { which = ag_total_progress value = ag_total_progress_reduce_perc }

						set_variable = { which = ag_saved_progress value = ag_required_progress }

						if = {
							limit = { check_variable = { which = ag_current_progress_lvl value = 4 } }
							multiply_variable = { which = ag_saved_progress value = 0.8 }
							if = {
								limit = { check_variable = { which = ag_total_progress value < ag_saved_progress } }
								set_variable = { which = ag_total_progress value = ag_saved_progress }
							}
						}
						else_if = {
							limit = { check_variable = { which = ag_current_progress_lvl value = 3 } }
							multiply_variable = { which = ag_saved_progress value = 0.6 }
							if = {
								limit = { check_variable = { which = ag_total_progress value < ag_saved_progress } }
								set_variable = { which = ag_total_progress value = ag_saved_progress }
							}
						}
						else_if = {
							limit = { check_variable = { which = ag_current_progress_lvl value = 2 } }
							multiply_variable = { which = ag_saved_progress value = 0.4 }
							if = {
								limit = { check_variable = { which = ag_total_progress value < ag_saved_progress } }
								set_variable = { which = ag_total_progress value = ag_saved_progress }
							}
						}
						else_if = {
							limit = { check_variable = { which = ag_current_progress_lvl value = 1 } }
							multiply_variable = { which = ag_saved_progress value = 0.2 }
							if = {
								limit = { check_variable = { which = ag_total_progress value < ag_saved_progress } }
								set_variable = { which = ag_total_progress value = ag_saved_progress }
							}
						}
						else_if = {
							limit = { check_variable = { which = ag_total_progress value < 0.001 } }
							set_variable = { which = ag_total_progress value = 0.001 }
						}
					}
					clear_variable = ag_saved_progress
				}
				else = {
					random_list = {
						10 = { multiply_variable = { which = ag_total_progress value = 0.50 } }
						10 = { multiply_variable = { which = ag_total_progress value = 0.55 } }
						12 = { multiply_variable = { which = ag_total_progress value = 0.60 } }
						12 = { multiply_variable = { which = ag_total_progress value = 0.65 } }
						16 = { multiply_variable = { which = ag_total_progress value = 0.70 } }
						16 = { multiply_variable = { which = ag_total_progress value = 0.75 } }
						12 = { multiply_variable = { which = ag_total_progress value = 0.80 } }
						12 = { multiply_variable = { which = ag_total_progress value = 0.85 } }
						10 = { multiply_variable = { which = ag_total_progress value = 0.90 } }
						10 = { multiply_variable = { which = ag_total_progress value = 0.95 } }
					}
					reroll_random = yes
				}
			}
			0 = { modifier = { add = ag_research_progress_reserve_var } }
		}
		remove_country_flag = ag_research_project_ongoing
		create_message = {
			type = "message_ag_research_project_abort"
			localization = "message_ag_research_project_abort_message_desc"
			days = 20
			target = prev.from
			variable = {
				type = name
				localization = "ag_location"
				scope = prev.from
			}
			variable = {
				type = name
				localization = "ag_science_ship"
				scope = prev
			}
			variable = {
				type = variable
				varname = ag_total_progress
				localization = "ag_total_progress"
				scope = this
			}
			variable = {
				type = variable
				varname = ag_required_progress
				localization = "ag_required_progress"
				scope = this
			}
		}
		if = { limit = { has_country_flag = ag_research_reopen_flag } country_event = { id = ag_research.1 days = 1 } }
	}
	else_if = {
		limit = { NOT = { has_country_flag = ag_current_research_completed } }
		ag_continue_research_project_effect = { ag_event_chain = $ag_event_chain$ ag_project = $ag_project$ }
	}
	if = {
		limit = {
			OR = {
				has_country_flag = ag_current_research_completed
				has_country_flag = ag_current_research_abort
			}
		}
		ag_save_current_progress = { clear_current_research = yes }
		remove_country_flag = ag_current_research_abort
	}
	else = { ag_save_current_progress = { clear_current_research = no } }
	clear_variable = ag_research_progress_reserve_var
}
ag_save_research_project_progress_value = {
	optimize_memory
	set_variable = { which = ag_temp_progress_var value = ag_skill_bonus_alt }
	change_variable = { which = ag_temp_progress_var value = ag_difficulty_alt }
	multiply_variable = { which = ag_temp_progress_var value = 2.0 }
	set_variable = { which = ag_saved_progress value = ag_skill_bonus_alt }
	subtract_variable = { which = ag_saved_progress value = ag_difficulty_alt }
	divide_variable = { which = ag_saved_progress value = ag_temp_progress_var }
	clear_variable = ag_temp_progress_var
}

ag_give_research_project = {
	optimize_memory
	hidden_effect = {
		ag_initialize_research_variables = yes
		if = {
			limit = { NOT = { has_country_flag = ag_has_research_project_$ag_project_id$ } }
			set_country_flag = ag_has_research_project_$ag_project_id$
			change_variable = { which = ag_num_research_projects value = 1 }
			change_variable = { which = ag_page_counter value = 1 }
			if = {
				limit = { check_variable = { which = ag_page_counter value = 4 } }
				set_variable = { which = ag_page_counter value = 0 }
			}
			if = {
				limit = { check_variable = { which = ag_page_counter value = 1 } }
				change_variable = { which = ag_research_total_pages value = 1 }
			}
			if = {
				limit = { check_variable = { which = ag_num_research_projects value = 16 } }
				ag_set_research_project_variables = { ag_seq = 16 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
			}
			else_if = {
				limit = { check_variable = { which = ag_num_research_projects value < 16 } }
				if = {
					limit = { check_variable = { which = ag_num_research_projects value = 8 } }
					ag_set_research_project_variables = { ag_seq = 8 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_num_research_projects value < 8 } }
					if = {
						limit = { check_variable = { which = ag_num_research_projects value = 4 } }
						ag_set_research_project_variables = { ag_seq = 4 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
					}
					else_if = {
						limit = { check_variable = { which = ag_num_research_projects value < 4 } }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 2 } }
							ag_set_research_project_variables = { ag_seq = 2 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 2 } }
							country_event = { id = ag_research.2 days = 1 }
							ag_set_research_project_variables = { ag_seq = 1 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 3 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
					else_if = {
						limit = { always = yes }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 6 } }
							ag_set_research_project_variables = { ag_seq = 6 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 6 } }
							ag_set_research_project_variables = { ag_seq = 5 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 7 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
				}
				else_if = {
					limit = { always = yes }
					if = {
						limit = { check_variable = { which = ag_num_research_projects value = 12 } }
						ag_set_research_project_variables = { ag_seq = 12 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
					}
					else_if = {
						limit = { check_variable = { which = ag_num_research_projects value < 12 } }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 10 } }
							ag_set_research_project_variables = { ag_seq = 10 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 10 } }
							ag_set_research_project_variables = { ag_seq = 9 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 11 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
					else_if = {
						limit = { always = yes }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 14 } }
							ag_set_research_project_variables = { ag_seq = 14 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 14 } }
							ag_set_research_project_variables = { ag_seq = 13 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 15 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
				}
			}
			else_if = {
				limit = { always = yes }
				if = {
					limit = { check_variable = { which = ag_num_research_projects value = 24 } }
					ag_set_research_project_variables = { ag_seq = 24 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_num_research_projects value < 24 } }
					if = {
						limit = { check_variable = { which = ag_num_research_projects value = 20 } }
						ag_set_research_project_variables = { ag_seq = 20 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
					}
					else_if = {
						limit = { check_variable = { which = ag_num_research_projects value < 20 } }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 18 } }
							ag_set_research_project_variables = { ag_seq = 18 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 18 } }
							ag_set_research_project_variables = { ag_seq = 17 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 19 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
					else_if = {
						limit = { always = yes }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 22 } }
							ag_set_research_project_variables = { ag_seq = 22 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 22 } }
							ag_set_research_project_variables = { ag_seq = 21 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 23 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
				}
				else_if = {
					limit = { always = yes }
					if = {
						limit = { check_variable = { which = ag_num_research_projects value = 28 } }
						ag_set_research_project_variables = { ag_seq = 28 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
					}
					else_if = {
						limit = { check_variable = { which = ag_num_research_projects value < 28 } }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 26 } }
							ag_set_research_project_variables = { ag_seq = 26 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 26 } }
							ag_set_research_project_variables = { ag_seq = 25 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 27 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
					else_if = {
						limit = { always = yes }
						if = {
							limit = { check_variable = { which = ag_num_research_projects value = 30 } }
							ag_set_research_project_variables = { ag_seq = 30 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { check_variable = { which = ag_num_research_projects value < 30 } }
							ag_set_research_project_variables = { ag_seq = 29 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
						else_if = {
							limit = { always = yes }
							ag_set_research_project_variables = { ag_seq = 31 ag_project_id = $ag_project_id$ ag_progress = $ag_progress|5$ }
						}
					}
				}
			}
		}
	}
}
ag_set_research_project_variables = {
	optimize_memory
	set_variable = { which = ag_research_project_$ag_seq$ value = $ag_project_id$ }
	set_variable = { which = ag_research_project_id_temp value = $ag_project_id$ }
	##############################################################################################################
	# New Research Project: (7) Create initialization effect in scripted effect.
	##############################################################################################################
	if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_locate_ancient_system ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_ship_hull_upgrade_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_ship_hull_upgrade ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_ship_bow_upgrade_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_ship_bow_upgrade ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_advanced_fortress_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_advanced_fortress ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_advanced_auras_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_advanced_auras ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_construction_sections_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_construction_sections ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_alpha_psionic_container_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_alpha_psionic_container ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_alpha_psionic_star_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_alpha_psionic_star ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_beta_psionic_source_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_beta_psionic_source ag_progress = $ag_progress$ }
		ag_modify_research_project_variables = {
			ag_use_country_flag = yes
			ag_condition = ag_ancient_beta_data_flag
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = no
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_beta_psionic_station_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_beta_psionic_station ag_progress = $ag_progress$ }
		ag_modify_research_project_variables = {
			ag_use_country_flag = yes
			ag_condition = ag_ancient_beta_data_flag
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = no
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_epsilon_first_building_unlock_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_epsilon_first_building_unlock ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_eta_control_station_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_eta_control_station ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_eta_gateway_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_eta_gateway ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_disable_ancient_shield_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_disable_ancient_shield ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_repair_starfish_ship_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_repair_starfish_ship ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_repair_starlight_2_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_repair_starlight_2 ag_progress = $ag_progress$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_reverse_engineering_wandering_ship_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_reverse_engineering_wandering_ship ag_progress = $ag_progress$ }
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_beta_station_type1
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_beta_station_type2
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_gamma_station
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_delta_titan
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_delta_platform
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_reverse_engineering_anchor_station_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_reverse_engineering_anchor_station ag_progress = $ag_progress$ }
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_beta_station_type1
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_beta_station_type2
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_gamma_station
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_delta_titan
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
		ag_modify_research_project_variables = {
			ag_use_technology = yes
			ag_condition = tech_ag_delta_platform
			ag_seq = $ag_seq$
			ag_no_modify_difficulty = yes
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_project_id_temp value = @ag_kag_annihilator_project_id } }
		ag_set_research_project_variables_1 = { ag_seq = $ag_seq$ ag_project_key = ag_kag_annihilator ag_progress = $ag_progress$ }
	}

	
	##############################################################################################################
	##############################################################################################################
	##############################################################################################################
	clear_variable = ag_research_project_id_temp
}
# Partial key makes game loading time longer than full key.(100% progress, 1s~3s)
ag_set_research_project_variables_1 = {
	optimize_memory
	set_variable = { which = ag_research_project_$ag_seq$_status value = 1 }
	set_variable = { which = ag_research_project_$ag_seq$_difficulty value = @$ag_project_key$_project_base_difficulty }
	set_variable = { which = ag_research_project_$ag_seq$_requirement value = @$ag_project_key$_requirements }
	set_variable = { which = ag_research_project_$ag_seq$_area value = @$ag_project_key$_area }
	set_variable = { which = ag_research_project_$ag_seq$_required_progress value = @$ag_project_key$_base_required_progress }
	set_variable = { which = ag_research_project_$ag_seq$_total_progress value = $ag_progress$ }
	set_variable = { which = ag_research_project_$ag_seq$_research_counter value = 0 }
}

ag_modify_research_project_variables = {
	optimize_memory
	[[ag_use_country_flag]
		if = {
			limit = { has_country_flag = $ag_condition$ }
			random_list = {
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 30 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 25 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 20 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 15 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 10 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 30 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 25 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 20 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 15 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 10 } }
				1 = { modifier = { factor = 0 always = $ag_no_modify_difficulty|yes$ } subtract_variable = { which = ag_research_project_$ag_seq$_difficulty value = 1 } }
			}
		}
	]
	[[ag_use_technology]
		if = {
			limit = { has_technology = $ag_condition$ }
			random_list = {
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 30 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 25 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 20 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 15 } }
				10 = { subtract_variable = { which = ag_research_project_$ag_seq$_required_progress value = 10 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 30 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 25 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 20 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 15 } }
				10 = { change_variable = { which = ag_research_project_$ag_seq$_total_progress value = 10 } }
				1 = { modifier = { factor = 0 always = $ag_no_modify_difficulty|yes$ } subtract_variable = { which = ag_research_project_$ag_seq$_difficulty value = 1 } }
			}
		}
	]
}

ag_select_project_tooltip = {
	optimize_memory
	##############################################################################################################
	# New Research Project: (8) Create research project's extra requirements fail texts in scripted effect.
	##############################################################################################################
	if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_locate_ancient_system_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { has_technology = tech_sensors_4 }
			custom_tooltip = "ag_locate_ancient_system_project_extra_1_success"
		}
		else = { custom_tooltip = "ag_locate_ancient_system_project_extra_1_failed" }
		if = {
			limit = { NOT = { ag_all_ancient_system_exists_or_known = yes } }
			custom_tooltip = "ag_locate_ancient_system_project_extra_2_success"
		}
		else = { custom_tooltip = "ag_locate_ancient_system_project_extra_2_failed" }
		if = {
			limit = {
				exists = event_target:ag_ancient_theta_shielded_world
				event_target:ag_ancient_theta_shielded_world = {
					exists = owner
					owner = { is_same_value = prevprev }
					exists = controller
					controller = { is_same_value = prevprev }
				}
			}
			custom_tooltip = "ag_locate_ancient_system_project_extra_3_success"
		}
		else = { custom_tooltip = "ag_locate_ancient_system_project_extra_3_failed" }
		if = {
			limit = {
				NOT = { has_country_flag = ag_locate_ancient_system_project_actived }
				resource_stockpile_compare = { resource = minor_artifacts value >= 5 }
			}
			custom_tooltip = "ag_require_5_artifacts_success"
		}
		else_if = {
			limit = { NOT = { has_country_flag = ag_locate_ancient_system_project_actived } }
			custom_tooltip = "ag_require_5_artifacts_failed"
		}
	}

	else_if = {
		limit = { OR = {
			check_variable = { which = ag_research_$ag_research_number$_id value = @ag_ship_hull_upgrade_project_id }
			check_variable = { which = ag_research_$ag_research_number$_id value = @ag_ship_bow_upgrade_project_id }
		} }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { resource_stockpile_compare = { resource = minor_artifacts value >= 1 } }
			custom_tooltip = "ag_require_1_artifacts_success"
		}
		else = { custom_tooltip = "ag_require_1_artifacts_failed" }
		if = {
			limit = {
				any_controlled_ship = {
					OR = {
						ag_is_ancient_ship_locked = yes
						ag_is_ancient_ship_unlocked = yes
					}
					exists = fleet
					fleet = { is_in_combat = no }
				}
			}
			custom_tooltip = "ag_ship_hull_upgrade_project_extra_1_success"
		}
		else = { custom_tooltip = "ag_ship_hull_upgrade_project_extra_1_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_advanced_fortress_project_id } }
		custom_tooltip = "ag_research_no_extra_requirement"
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_advanced_auras_project_id } }
		custom_tooltip = "ag_research_no_extra_requirement"
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_construction_sections_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { any_owned_megastructure = { ag_megashipyard_can_recv_construction_section = yes } }
			custom_tooltip = "ag_requires_megashipyard_success"
		}
		else = { custom_tooltip = "ag_requires_megashipyard_failed" }
		if = {
			limit = { any_planet_within_border = { has_planet_flag = ag_ancient_construction_section } }
			custom_tooltip = "ag_requires_construction_section_success"
		}
		else = { custom_tooltip = "ag_requires_construction_section_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_alpha_psionic_container_project_id } }
		custom_tooltip = "ag_research_no_extra_requirement"
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_alpha_psionic_star_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { NOT = { exists = event_target:ag_alpha_station_system_1_star } }
			custom_tooltip = "ag_forced_triggers_failed"
		}
		else = {
			if = {
				limit = { has_technology = "tech_ag_adv_psionic_control" }
				custom_tooltip = "ag_requires_tech_ag_adv_psionic_control_success"
			}
			else = { custom_tooltip = "ag_requires_tech_ag_adv_psionic_control_failed" }
			if = {
				limit = { event_target:ag_alpha_station_system_1_star = { exists = space_owner space_owner = { is_same_value = prevprev } } }
				custom_tooltip = "ag_requires_control_psionic_star_success"
			}
			else = { custom_tooltip = "ag_requires_control_psionic_star_failed" }
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_beta_psionic_source_project_id } }
		custom_tooltip = "ag_research_no_extra_requirement"
		if = {
			limit = { NOT = { exists = event_target:ag_ancient_beta_shielded_world } }
			custom_tooltip = "ag_forced_triggers_failed"
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_beta_psionic_station_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { any_owned_megastructure = { is_megastructure_type = ag_beta_station_type2_megastructure } }
			custom_tooltip = "ag_control_beta_psionic_station_success"
		}
		else = { custom_tooltip = "ag_control_beta_psionic_station_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_epsilon_first_building_unlock_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = {
				exists = event_target:ag_epsilon_first_ringworld
				event_target:ag_epsilon_first_ringworld = {
					exists = owner
					owner = { is_same_value = prevprev }
					OR = {
						has_building = ag_epsilon_outpost_0
						has_building = ag_epsilon_outpost_1
					}
				}
			}
			custom_tooltip = "ag_control_epsilon_target_world_success"
		}
		else = { custom_tooltip = "ag_control_epsilon_target_world_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_eta_control_station_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = {
				exists = event_target:ag_ancient_eta_star
				event_target:ag_ancient_eta_star.solar_system = {
					exists = space_owner
					space_owner = { is_same_value = prevprev }
				}
			}
			custom_tooltip = "ag_control_eta_area_success"
		}
		else = { custom_tooltip = "ag_control_eta_area_failed" }
		if = {
			limit = {
				exists = event_target:ag_ancient_eta_star
				event_target:ag_ancient_eta_star.solar_system = { OR = {
					any_system_ambient_object = {
						is_ambient_object_type = ag_eta_damaged_gateway_control_station
						has_ambient_object_flag = ag_eta_damaged_gateway_control_station
					}
					any_system_megastructure = { OR = {
						is_megastructure_type = ag_ancient_eta_gateway_control_megastructure_3
						is_megastructure_type = ag_ancient_eta_gateway_control_damaged
						is_megastructure_type = ag_ancient_eta_gateway_control_restored
					} }
				} }
			}
			custom_tooltip = "ag_eta_control_station_exists_success"
		}
		else = { custom_tooltip = "ag_eta_control_station_exists_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_eta_gateway_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { any_owned_megastructure = { ag_is_ancient_gateway_megastructure = yes } }
			custom_tooltip = "ag_control_eta_gateway_frame_success"
		}
		else = { custom_tooltip = "ag_control_eta_gateway_frame_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_disable_ancient_shield_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = { NOT = { exists = event_target:ag_primitive_shielded_moon } }
			custom_tooltip = "ag_forced_triggers_failed"
		}
		if = {
			limit = {
				exists = event_target:ag_primitive_shielded_moon
				event_target:ag_primitive_shielded_moon = {
					is_planet_class = pc_shielded
				}
			}
			custom_tooltip = "ag_required_ancient_shield_success"
		}
		else = { custom_tooltip = "ag_required_ancient_shield_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_repair_starfish_ship_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = {
				exists = event_target:ag_ancient_starfish_ship
				event_target:ag_ancient_starfish_ship = {
					exists = owner
					owner = { is_same_value = prevprev }
				}
			}
			custom_tooltip = "ag_repair_starfish_ship_project_extra_1_success"
		}
		else = { custom_tooltip = "ag_repair_starfish_ship_project_extra_1_failed" }
		if = {
			limit = {
				exists = event_target:ag_ancient_starfish_ship
				event_target:ag_ancient_starfish_ship = { is_in_combat = no }
			}
			custom_tooltip = "ag_not_in_combat_success"
		}
		else = { custom_tooltip = "ag_not_in_combat_failed" }
		if = {
			limit = {
				exists = event_target:ag_ancient_starfish_ship
				event_target:ag_ancient_starfish_ship = {
					has_ship_flag = ag_experiment_ship_damaged
				}
			}
			custom_tooltip = "ag_repair_starfish_ship_project_extra_2_success"
		}
		else = { custom_tooltip = "ag_repair_starfish_ship_project_extra_2_failed" }
		if = {
			limit = {
				NOT = { has_country_flag = ag_repair_starfish_ship_project_actived }
				resource_stockpile_compare = { resource = minor_artifacts value >= 30 }
			}
			custom_tooltip = "ag_require_30_artifacts_success"
		}
		else_if = {
			limit = { NOT = { has_country_flag = ag_repair_starfish_ship_project_actived } }
			custom_tooltip = "ag_require_30_artifacts_failed"
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_repair_starlight_2_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		if = {
			limit = {
				exists = event_target:ag_starlight_2_ship
				event_target:ag_starlight_2_ship = {
					exists = owner
					owner = { is_same_value = prevprev }
				}
			}
			custom_tooltip = "ag_repair_starlight_2_project_extra_1_success"
		}
		else = { custom_tooltip = "ag_repair_starlight_2_project_extra_1_failed" }
		if = {
			limit = {
				exists = event_target:ag_starlight_2_ship
				event_target:ag_starlight_2_ship = { OR = {
					AND = { is_scope_type = ship is_in_combat = no }
					AND = {
						is_scope_type = leader
						OR = {
							NOR = { exists = fleet exists = planet }
							AND = { exists = planet planet = { has_ground_combat = no is_occupied_flag = no } }
							AND = { exists = fleet fleet = { is_in_combat = no } }
						}
					}
				} }
			}
			custom_tooltip = "ag_not_in_combat_success"
		}
		else = { custom_tooltip = "ag_not_in_combat_failed" }
		if = {
			limit = { NOT = { has_country_flag = ag_lost_ancient_ship_restored } }
			custom_tooltip = "ag_repair_starlight_2_project_extra_2_success"
		}
		else = { custom_tooltip = "ag_repair_starlight_2_project_extra_2_failed" }
		if = {
			limit = {
				NOT = { has_country_flag = ag_repair_starlight_2_project_actived }
				resource_stockpile_compare = { resource = minor_artifacts value >= 30 }
			}
			custom_tooltip = "ag_require_30_artifacts_success"
		}
		else_if = {
			limit = { NOT = { has_country_flag = ag_repair_starlight_2_project_actived } }
			custom_tooltip = "ag_require_30_artifacts_failed"
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_reverse_engineering_wandering_ship_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		random_controlled_ship = {
			limit = { has_ship_flag =  ag_ancient_wandering_ship_player }
			save_event_target_as = ag_ancient_wandering_ship_player
		}
		if = {
			limit = {
				exists = event_target:ag_ancient_wandering_ship_player
				event_target:ag_ancient_wandering_ship_player = {
					exists = owner
					owner = { is_same_value = prevprev }
				}
			}
			custom_tooltip = "ag_reverse_engineering_wandering_ship_project_extra_1_success"
		}
		else = { custom_tooltip = "ag_reverse_engineering_wandering_ship_project_extra_1_failed" }
		if = {
			limit = {
				exists = event_target:ag_ancient_wandering_ship_player
				event_target:ag_ancient_wandering_ship_player = { is_in_combat = no }
			}
			custom_tooltip = "ag_not_in_combat_success"
		}
		else = { custom_tooltip = "ag_not_in_combat_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_reverse_engineering_anchor_station_project_id } }
		custom_tooltip = "ag_research_has_extra_requirement"
		random_owned_megastructure = {
			limit = { OR = {
				is_megastructure_type = ag_ancient_anchor_station_0
				is_megastructure_type = ag_ancient_anchor_station_1
				is_megastructure_type = ag_ancient_anchor_station_2
				is_megastructure_type = ag_ancient_anchor_station_player
			} }
			save_event_target_as = ag_anchor_station_player
		}
		if = {
			limit = { NOT = { has_global_flag = ag_ancient_wandering_ship_destroyed } }
			custom_tooltip = "ag_forced_triggers_failed"
		}
		if = {
			limit = { exists = event_target:ag_anchor_station_player }
			custom_tooltip = "ag_reverse_engineering_anchor_station_project_extra_1_success"
		}
		else = { custom_tooltip = "ag_reverse_engineering_anchor_station_project_extra_1_failed" }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_kag_annihilator_project_id } }
		if = {
			limit = { has_global_flag = install_kuat_mod }
			custom_tooltip = "ag_research_has_extra_requirement"
			if = {
				limit = {
					any_system_within_border = {
						OR = {
							has_star_flag = Kuat_system
							has_star_flag = Kuat_system_1
							has_star_flag = Kuat_system_2
							has_star_flag = Kuat_system_3
						}
						any_system_planet = {
							NOT = { is_planet_class = pc_ringworld_habitable_damaged }
							OR = {
								has_planet_flag = kuat_system_ring_3
								has_planet_flag = kuat_system_ring_6
								has_planet_flag = kuat_system_ring_9
								has_planet_flag = kuat_system_ring_12
							}
						}
					}
				}
				custom_tooltip = "ag_kag_annihilator_project_extra_1_success"
			}
			else = { custom_tooltip = "ag_kag_annihilator_project_extra_1_failed" }
		}
		else = { custom_tooltip = "ag_requires_kag_mod" }
	}
	
	##############################################################################################################
	##############################################################################################################
	##############################################################################################################
}
# Selected a research project, create its event chain, load variables
ag_select_research_project = {
	optimize_memory
	set_variable = { which = ag_current_research value = ag_research_$ag_research_number$_id }
	set_variable = { which = ag_current_seq value = ag_research_$ag_research_number$_seq }
	if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_area value = 1 } }
		set_country_flag = ag_current_area_phy
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_area value = 2 } }
		set_country_flag = ag_current_area_soc
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_area value = 3 } }
		set_country_flag = ag_current_area_eng
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_area value = 4 } }
		set_country_flag = ag_current_area_phy_soc
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_area value = 5 } }
		set_country_flag = ag_current_area_phy_eng
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_area value = 6 } }
		set_country_flag = ag_current_area_soc_eng
	}
	else_if = { limit = { always = yes } set_country_flag = ag_current_area_phy_soc_eng }
	set_variable = { which = ag_current_difficulty value = ag_research_$ag_research_number$_difficulty }
	set_variable = { which = ag_research_$ag_research_number$_status value = 2 }
	set_variable = { which = ag_difficulty value = ag_research_$ag_research_number$_difficulty }
	set_variable = { which = ag_required_progress value = ag_research_$ag_research_number$_required_progress }
	set_variable = { which = ag_total_progress value = ag_research_$ag_research_number$_total_progress }
	set_variable = { which = ag_research_project_counter value = ag_research_$ag_research_number$_research_counter }
	##############################################################################################################
	# New Research Project: (9) Create Begin event chain effect in scripted effect.
	##############################################################################################################
	if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_locate_ancient_system_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_locate_ancient_system_project_chain
			ag_project = ag_locate_ancient_system_project
			ag_location = event_target:ag_ancient_theta_shielded_world
		}
		if = {
			limit = { NOT = { has_country_flag = ag_locate_ancient_system_project_actived } }
			set_country_flag = ag_locate_ancient_system_project_actived
			add_resource = { minor_artifacts = -5 }
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_ship_hull_upgrade_project_id } }
		random_controlled_ship = {
			limit = {
				OR = { ag_is_ancient_ship_locked = yes ag_is_ancient_ship_unlocked = yes }
				exists = fleet fleet = { is_in_combat = no }
			}
			save_event_target_as = ag_ship_hull_upgrade_project_target
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_ship_hull_upgrade_project_chain
			ag_project = ag_ship_hull_upgrade_project
			ag_location = event_target:ag_ship_hull_upgrade_project_target
		}
		add_resource = { minor_artifacts = -1 }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_ship_bow_upgrade_project_id } }
		random_controlled_ship = {
			limit = {
				OR = { ag_is_ancient_ship_locked = yes ag_is_ancient_ship_unlocked = yes }
				exists = fleet fleet = { is_in_combat = no }
			}
			save_event_target_as = ag_ship_bow_upgrade_project_target
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_ship_bow_upgrade_project_chain
			ag_project = ag_ship_bow_upgrade_project
			ag_location = event_target:ag_ship_bow_upgrade_project_target
		}
		add_resource = { minor_artifacts = -1 }
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_advanced_fortress_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_advanced_fortress_project_chain
			ag_project = ag_advanced_fortress_project
			ag_location = capital_scope
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_advanced_auras_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_advanced_auras_project_chain
			ag_project = ag_advanced_auras_project
			ag_location = capital_scope
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_construction_sections_project_id } }
		random_list = {
			50 = { random_owned_megastructure = {
				limit = { ag_megashipyard_can_recv_construction_section = yes }
				save_event_target_as = ag_construction_sections_project_target
			} }
			50 = { random_planet_within_border = {
				limit = { has_planet_flag = ag_ancient_construction_section }
				save_event_target_as = ag_construction_sections_project_target
			} }
		}
		reroll_random = yes
		ag_select_research_project_1 = {
			ag_event_chain = ag_construction_sections_project_chain
			ag_project = ag_construction_sections_project
			ag_location = event_target:ag_construction_sections_project_target
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_alpha_psionic_container_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_alpha_psionic_container_project_chain
			ag_project = ag_alpha_psionic_container_project
			ag_location = capital_scope
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_alpha_psionic_star_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_alpha_psionic_star_project_chain
			ag_project = ag_alpha_psionic_star_project
			ag_location = event_target:ag_alpha_station_system_1_star
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_beta_psionic_source_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_beta_psionic_source_project_chain
			ag_project = ag_beta_psionic_source_project
			ag_location = event_target:ag_ancient_beta_shielded_world
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_beta_psionic_station_project_id } }
		random_owned_megastructure = {
			limit = { is_megastructure_type = ag_beta_station_type2_megastructure }
			save_event_target_as = ag_beta_psionic_station_project_target
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_beta_psionic_station_project_chain
			ag_project = ag_beta_psionic_station_project
			ag_location = event_target:ag_beta_psionic_station_project_target
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_epsilon_first_building_unlock_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_epsilon_first_building_unlock_project_chain
			ag_project = ag_epsilon_first_building_unlock_project
			ag_location = event_target:ag_epsilon_first_ringworld
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_eta_control_station_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_eta_control_station_project_chain
			ag_project = ag_eta_control_station_project
			ag_location = event_target:ag_ancient_eta_star
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_eta_gateway_project_id } }
		random_owned_megastructure = {
			limit = { ag_is_ancient_gateway_megastructure = yes }
			save_event_target_as = ag_eta_target_gateway
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_eta_gateway_project_chain
			ag_project = ag_eta_gateway_project
			ag_location = event_target:ag_eta_target_gateway
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_disable_ancient_shield_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_disable_ancient_shield_project_chain
			ag_project = ag_disable_ancient_shield_project
			ag_location = event_target:ag_primitive_shielded_moon
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_repair_starfish_ship_project_id } }
		ag_select_research_project_1 = {
			ag_event_chain = ag_repair_starfish_ship_project_chain
			ag_project = ag_repair_starfish_ship_project
			ag_location = event_target:ag_ancient_starfish_ship
		}
		if = {
			limit = { NOT = { has_country_flag = ag_repair_starfish_ship_project_actived } }
			set_country_flag = ag_repair_starfish_ship_project_actived
			add_resource = { minor_artifacts = -30 }
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_repair_starlight_2_project_id } }
		if = {
			limit = { event_target:ag_starlight_2_ship = { is_scope_type = ship } }
			ag_select_research_project_1 = {
				ag_event_chain = ag_repair_starlight_2_project_chain
				ag_project = ag_repair_starlight_2_project
				ag_location = event_target:ag_starlight_2_ship
			}
		}
		else_if = {
			limit = { event_target:ag_starlight_2_ship = { is_scope_type = leader exists = planet } }
			ag_select_research_project_1 = {
				ag_event_chain = ag_repair_starlight_2_project_chain
				ag_project = ag_repair_starlight_2_project
				ag_location = event_target:ag_starlight_2_ship.planet
			}
		}
		else_if = {
			limit = { event_target:ag_starlight_2_ship = { is_scope_type = leader exists = fleet } }
			ag_select_research_project_1 = {
				ag_event_chain = ag_repair_starlight_2_project_chain
				ag_project = ag_repair_starlight_2_project
				ag_location = event_target:ag_starlight_2_ship.fleet
			}
		}
		else_if = {
			limit = { always = yes }
			ag_select_research_project_1 = {
				ag_event_chain = ag_repair_starlight_2_project_chain
				ag_project = ag_repair_starlight_2_project
				ag_location = capital_scope
			}
		}
		if = {
			limit = { NOT = { has_country_flag = ag_repair_starlight_2_project_actived } }
			set_country_flag = ag_repair_starlight_2_project_actived
			add_resource = { minor_artifacts = -30 }
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_reverse_engineering_wandering_ship_project_id } }
		random_controlled_ship = {
			limit = { has_ship_flag =  ag_ancient_wandering_ship_player is_in_combat = no }
			save_event_target_as = ag_ancient_wandering_ship_player
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_reverse_engineering_wandering_ship_project_chain
			ag_project = ag_reverse_engineering_wandering_ship_project
			ag_location = event_target:ag_ancient_wandering_ship_player
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_reverse_engineering_anchor_station_project_id } }
		random_owned_megastructure = {
			limit = { OR = {
				is_megastructure_type = ag_ancient_anchor_station_0
				is_megastructure_type = ag_ancient_anchor_station_1
				is_megastructure_type = ag_ancient_anchor_station_2
				is_megastructure_type = ag_ancient_anchor_station_player
			} }
			save_event_target_as = ag_anchor_station_player
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_reverse_engineering_anchor_station_project_chain
			ag_project = ag_reverse_engineering_anchor_station_project
			ag_location = event_target:ag_anchor_station_player
		}
	}

	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_number$_id value = @ag_kag_annihilator_project_id } }
		random_system = {
			limit = {
				OR = {
					has_star_flag = Kuat_system
					has_star_flag = Kuat_system_1
					has_star_flag = Kuat_system_2
					has_star_flag = Kuat_system_3
				}
			}
			random_system_planet = {
				limit = {
					NOT = { is_planet_class = pc_ringworld_habitable_damaged }
					OR = {
						has_planet_flag = kuat_system_ring_3
						has_planet_flag = kuat_system_ring_6
						has_planet_flag = kuat_system_ring_9
						has_planet_flag = kuat_system_ring_12
					}
				}
				save_event_target_as = ag_kag_annihilator_project_loc
			}
		}
		ag_select_research_project_1 = {
			ag_event_chain = ag_kag_annihilator_project_chain
			ag_project = ag_kag_annihilator_project
			ag_location = event_target:ag_kag_annihilator_project_loc
		}
	}
	
	##############################################################################################################
	##############################################################################################################
	##############################################################################################################
}
ag_select_research_project_1 = {
	optimize_memory
	begin_event_chain = { event_chain = $ag_event_chain$ target = this }
	if = {
		limit = {
			OR = {
				has_country_flag = ag_current_area_phy
				has_country_flag = ag_current_area_soc
				has_country_flag = ag_current_area_eng
			}
		}
		$ag_location$ = { enable_special_project = { name = $ag_project$ location = this owner = prev } }
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_soc }
		random_list = {
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_phy location = this owner = prev } } }
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_soc location = this owner = prev } } }
		}
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_eng }
		random_list = {
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_phy location = this owner = prev } } }
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_eng location = this owner = prev } } }
		}
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_soc_eng }
		random_list = {
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_soc location = this owner = prev } } }
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_eng location = this owner = prev } } }
		}
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_soc_eng }
		random_list = {
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_phy location = this owner = prev } } }
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_soc location = this owner = prev } } }
			50 = { $ag_location$ = { enable_special_project = { name = $ag_project$_eng location = this owner = prev } } }
		}
	}
}

# Load a page when refreshed
ag_load_page = {
	optimize_memory
	if = {
		limit = { check_variable = { which = ag_research_current_page value = 1 } }
		ag_load_page_1 = { ag_research_1 = 1 ag_research_2 = 2 ag_research_3 = 3 ag_research_4 = 4 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 2 } }
		ag_load_page_1 = { ag_research_1 = 5 ag_research_2 = 6 ag_research_3 = 7 ag_research_4 = 8 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 3 } }
		ag_load_page_1 = { ag_research_1 = 9 ag_research_2 = 10 ag_research_3 = 11 ag_research_4 = 12 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 4 } }
		ag_load_page_1 = { ag_research_1 = 13 ag_research_2 = 14 ag_research_3 = 15 ag_research_4 = 16 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 5 } }
		ag_load_page_1 = { ag_research_1 = 17 ag_research_2 = 18 ag_research_3 = 19 ag_research_4 = 20 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 6 } }
		ag_load_page_1 = { ag_research_1 = 21 ag_research_2 = 22 ag_research_3 = 23 ag_research_4 = 24 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 7 } }
		ag_load_page_1 = { ag_research_1 = 25 ag_research_2 = 26 ag_research_3 = 27 ag_research_4 = 28 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_current_page value = 8 } }
		ag_load_page_1 = { ag_research_1 = 29 ag_research_2 = 30 ag_research_3 = 31 ag_research_4 = 32 }
	}
}
ag_load_page_1 = {
	optimize_memory
	if = {
		limit = {
			is_variable_set = ag_research_project_$ag_research_1$
			NOT = { check_variable = { which = ag_research_project_$ag_research_1$ value = 0 } }
		}
		set_variable = { which = ag_research_1 value = 1 }
		set_variable = { which = ag_research_1_id value = ag_research_project_$ag_research_1$ }
		set_variable = { which = ag_research_1_seq value = $ag_research_1$ }
		set_variable = { which = ag_research_1_status value = ag_research_project_$ag_research_1$_status }
		set_variable = { which = ag_research_1_difficulty value = ag_research_project_$ag_research_1$_difficulty }
		set_variable = { which = ag_research_1_requirement value = ag_research_project_$ag_research_1$_requirement }
		set_variable = { which = ag_research_1_area value = ag_research_project_$ag_research_1$_area }
		set_variable = { which = ag_research_1_required_progress value = ag_research_project_$ag_research_1$_required_progress }
		set_variable = { which = ag_research_1_total_progress value = ag_research_project_$ag_research_1$_total_progress }
		set_variable = { which = ag_research_1_research_counter value = ag_research_project_$ag_research_1$_research_counter }
		set_variable = { which = ag_research_1_progress value = ag_research_1_total_progress }
		divide_variable = { which = ag_research_1_progress value = ag_research_1_required_progress }
		multiply_variable = { which = ag_research_1_progress value = 100 }
		if = {
			limit = {
				check_variable = { which = ag_current_research value = ag_research_1_id }
				NOT = { check_variable = { which = ag_research_1_status value = 2 } }
			}
			set_variable = { which = ag_research_1_status value = 2 }
		}
	}
	else = {
		set_variable = { which = ag_research_1 value = 0 }
		set_variable = { which = ag_research_1_id value = 0 }
		set_variable = { which = ag_research_1_seq value = 0 }
		set_variable = { which = ag_research_1_status value = 0 }
		set_variable = { which = ag_research_1_difficulty value = 0 }
		set_variable = { which = ag_research_1_requirement value = 0 }
		set_variable = { which = ag_research_1_area value = 0 }
		set_variable = { which = ag_research_1_required_progress value = 0 }
		set_variable = { which = ag_research_1_total_progress value = 0 }
		set_variable = { which = ag_research_1_research_counter value = 0 }
		set_variable = { which = ag_research_1_progress value = 0 }
	}
	if = {
		limit = {
			is_variable_set = ag_research_project_$ag_research_2$
			NOT = { check_variable = { which = ag_research_project_$ag_research_2$ value = 0 } }
		}
		set_variable = { which = ag_research_2 value = 1 }
		set_variable = { which = ag_research_2_id value = ag_research_project_$ag_research_2$ }
		set_variable = { which = ag_research_2_seq value = $ag_research_2$ }
		set_variable = { which = ag_research_2_status value = ag_research_project_$ag_research_2$_status }
		set_variable = { which = ag_research_2_difficulty value = ag_research_project_$ag_research_2$_difficulty }
		set_variable = { which = ag_research_2_requirement value = ag_research_project_$ag_research_2$_requirement }
		set_variable = { which = ag_research_2_area value = ag_research_project_$ag_research_2$_area }
		set_variable = { which = ag_research_2_required_progress value = ag_research_project_$ag_research_2$_required_progress }
		set_variable = { which = ag_research_2_total_progress value = ag_research_project_$ag_research_2$_total_progress }
		set_variable = { which = ag_research_2_research_counter value = ag_research_project_$ag_research_2$_research_counter }
		set_variable = { which = ag_research_2_progress value = ag_research_2_total_progress }
		divide_variable = { which = ag_research_2_progress value = ag_research_2_required_progress }
		multiply_variable = { which = ag_research_2_progress value = 100 }
		if = {
			limit = {
				check_variable = { which = ag_current_research value = ag_research_2_id }
				NOT = { check_variable = { which = ag_research_2_status value = 2 } }
			}
			set_variable = { which = ag_research_2_status value = 2 }
		}
	}
	else = {
		set_variable = { which = ag_research_2 value = 0 }
		set_variable = { which = ag_research_2_id value = 0 }
		set_variable = { which = ag_research_2_seq value = 0 }
		set_variable = { which = ag_research_2_status value = 0 }
		set_variable = { which = ag_research_2_difficulty value = 0 }
		set_variable = { which = ag_research_2_requirement value = 0 }
		set_variable = { which = ag_research_2_area value = 0 }
		set_variable = { which = ag_research_2_required_progress value = 0 }
		set_variable = { which = ag_research_2_total_progress value = 0 }
		set_variable = { which = ag_research_2_research_counter value = 0 }
		set_variable = { which = ag_research_2_progress value = 0 }
	}
	if = {
		limit = {
			is_variable_set = ag_research_project_$ag_research_3$
			NOT = { check_variable = { which = ag_research_project_$ag_research_3$ value = 0 } }
		}
		set_variable = { which = ag_research_3 value = 1 }
		set_variable = { which = ag_research_3_id value = ag_research_project_$ag_research_3$ }
		set_variable = { which = ag_research_3_seq value = $ag_research_3$ }
		set_variable = { which = ag_research_3_status value = ag_research_project_$ag_research_3$_status }
		set_variable = { which = ag_research_3_difficulty value = ag_research_project_$ag_research_3$_difficulty }
		set_variable = { which = ag_research_3_requirement value = ag_research_project_$ag_research_3$_requirement }
		set_variable = { which = ag_research_3_area value = ag_research_project_$ag_research_3$_area }
		set_variable = { which = ag_research_3_required_progress value = ag_research_project_$ag_research_3$_required_progress }
		set_variable = { which = ag_research_3_total_progress value = ag_research_project_$ag_research_3$_total_progress }
		set_variable = { which = ag_research_3_research_counter value = ag_research_project_$ag_research_3$_research_counter }
		set_variable = { which = ag_research_3_progress value = ag_research_3_total_progress }
		divide_variable = { which = ag_research_3_progress value = ag_research_3_required_progress }
		multiply_variable = { which = ag_research_3_progress value = 100 }
		if = {
			limit = {
				check_variable = { which = ag_current_research value = ag_research_3_id }
				NOT = { check_variable = { which = ag_research_3_status value = 2 } }
			}
			set_variable = { which = ag_research_3_status value = 2 }
		}
	}
	else = {
		set_variable = { which = ag_research_3 value = 0 }
		set_variable = { which = ag_research_3_id value = 0 }
		set_variable = { which = ag_research_3_seq value = 0 }
		set_variable = { which = ag_research_3_status value = 0 }
		set_variable = { which = ag_research_3_difficulty value = 0 }
		set_variable = { which = ag_research_3_requirement value = 0 }
		set_variable = { which = ag_research_3_area value = 0 }
		set_variable = { which = ag_research_3_required_progress value = 0 }
		set_variable = { which = ag_research_3_total_progress value = 0 }
		set_variable = { which = ag_research_3_research_counter value = 0 }
		set_variable = { which = ag_research_3_progress value = 0 }
	}
	if = {
		limit = {
			is_variable_set = ag_research_project_$ag_research_4$
			NOT = { check_variable = { which = ag_research_project_$ag_research_4$ value = 0 } }
		}
		set_variable = { which = ag_research_4 value = 1 }
		set_variable = { which = ag_research_4_id value = ag_research_project_$ag_research_4$ }
		set_variable = { which = ag_research_4_seq value = $ag_research_4$ }
		set_variable = { which = ag_research_4_status value = ag_research_project_$ag_research_4$_status }
		set_variable = { which = ag_research_4_difficulty value = ag_research_project_$ag_research_4$_difficulty }
		set_variable = { which = ag_research_4_requirement value = ag_research_project_$ag_research_4$_requirement }
		set_variable = { which = ag_research_4_area value = ag_research_project_$ag_research_4$_area }
		set_variable = { which = ag_research_4_required_progress value = ag_research_project_$ag_research_4$_required_progress }
		set_variable = { which = ag_research_4_total_progress value = ag_research_project_$ag_research_4$_total_progress }
		set_variable = { which = ag_research_4_research_counter value = ag_research_project_$ag_research_4$_research_counter }
		set_variable = { which = ag_research_4_progress value = ag_research_4_total_progress }
		divide_variable = { which = ag_research_4_progress value = ag_research_4_required_progress }
		multiply_variable = { which = ag_research_4_progress value = 100 }
		if = {
			limit = {
				check_variable = { which = ag_current_research value = ag_research_4_id }
				NOT = { check_variable = { which = ag_research_4_status value = 2 } }
			}
			set_variable = { which = ag_research_4_status value = 2 }
		}
	}
	else = {
		set_variable = { which = ag_research_4 value = 0 }
		set_variable = { which = ag_research_4_id value = 0 }
		set_variable = { which = ag_research_4_seq value = 0 }
		set_variable = { which = ag_research_4_status value = 0 }
		set_variable = { which = ag_research_4_difficulty value = 0 }
		set_variable = { which = ag_research_4_requirement value = 0 }
		set_variable = { which = ag_research_4_area value = 0 }
		set_variable = { which = ag_research_4_required_progress value = 0 }
		set_variable = { which = ag_research_4_total_progress value = 0 }
		set_variable = { which = ag_research_4_research_counter value = 0 }
		set_variable = { which = ag_research_4_progress value = 0 }
	}
}

# Save urrent research project's variables, abort it if needed.
ag_save_current_progress = {
	optimize_memory
	##############################################################################################################
	# New Research Project: (10) Create context switch effect in scripted effect.
	##############################################################################################################
	if = {
		limit = { check_variable = { which = ag_current_research value = @ag_locate_ancient_system_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_locate_ancient_system_project_chain
				ag_project = ag_locate_ancient_system_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_locate_ancient_system_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_ship_hull_upgrade_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_ship_hull_upgrade_project_chain
				ag_project = ag_ship_hull_upgrade_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_ship_hull_upgrade_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_ship_bow_upgrade_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_ship_bow_upgrade_project_chain
				ag_project = ag_ship_bow_upgrade_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_ship_bow_upgrade_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_advanced_fortress_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_advanced_fortress_project_chain
				ag_project = ag_advanced_fortress_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_advanced_fortress_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_advanced_auras_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_advanced_auras_project_chain
				ag_project = ag_advanced_auras_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_advanced_auras_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_construction_sections_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_construction_sections_project_chain
				ag_project = ag_construction_sections_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_construction_sections_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_alpha_psionic_container_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_alpha_psionic_container_project_chain
				ag_project = ag_alpha_psionic_container_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_alpha_psionic_container_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_alpha_psionic_star_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_alpha_psionic_star_project_chain
				ag_project = ag_alpha_psionic_star_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_alpha_psionic_star_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_beta_psionic_source_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_beta_psionic_source_project_chain
				ag_project = ag_beta_psionic_source_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_beta_psionic_source_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_beta_psionic_station_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_beta_psionic_station_project_chain
				ag_project = ag_beta_psionic_station_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_beta_psionic_station_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_epsilon_first_building_unlock_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_epsilon_first_building_unlock_project_chain
				ag_project = ag_epsilon_first_building_unlock_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_epsilon_first_building_unlock_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_eta_control_station_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_eta_control_station_project_chain
				ag_project = ag_eta_control_station_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_eta_control_station_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_eta_gateway_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_eta_gateway_project_chain
				ag_project = ag_eta_gateway_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_eta_gateway_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_disable_ancient_shield_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_disable_ancient_shield_project_chain
				ag_project = ag_disable_ancient_shield_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_disable_ancient_shield_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_repair_starfish_ship_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_repair_starfish_ship_project_chain
				ag_project = ag_repair_starfish_ship_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_repair_starfish_ship_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_repair_starlight_2_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_repair_starlight_2_project_chain
				ag_project = ag_repair_starlight_2_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_repair_starlight_2_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_reverse_engineering_wandering_ship_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_reverse_engineering_wandering_ship_project_chain
				ag_project = ag_reverse_engineering_wandering_ship_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_reverse_engineering_wandering_ship_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_reverse_engineering_anchor_station_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_reverse_engineering_anchor_station_project_chain
				ag_project = ag_reverse_engineering_anchor_station_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_reverse_engineering_anchor_station_project_id clear_current_research = $clear_current_research|no$ }
	}

	else_if = {
		limit = { check_variable = { which = ag_current_research value = @ag_kag_annihilator_project_id } }
		if = {
			limit = { always = $clear_current_research|no$ }
			ag_clean_event_chains = {
				ag_evnet_chain = ag_kag_annihilator_project_chain
				ag_project = ag_kag_annihilator_project
			}
		}
		ag_save_current_progress_1 = { ag_current_research = @ag_kag_annihilator_project_id clear_current_research = $clear_current_research|no$ }
	}
	
	##############################################################################################################
	##############################################################################################################
	##############################################################################################################
}
ag_clean_event_chains = {
	optimize_memory
	if = {
		limit = {
			OR = {
				has_country_flag = ag_current_area_phy
				has_country_flag = ag_current_area_soc
				has_country_flag = ag_current_area_eng
			}
		}
		if = { limit = { has_special_project = $ag_project$ } abort_special_project = { type = $ag_project$ } }
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_soc }
		if = { limit = { has_special_project = $ag_project$_phy } abort_special_project = { type = $ag_project$_phy } }
		if = { limit = { has_special_project = $ag_project$_soc } abort_special_project = { type = $ag_project$_soc } }
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_eng }
		if = { limit = { has_special_project = $ag_project$_phy } abort_special_project = { type = $ag_project$_phy } }
		if = { limit = { has_special_project = $ag_project$_eng } abort_special_project = { type = $ag_project$_eng } }
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_soc_eng }
		if = { limit = { has_special_project = $ag_project$_soc } abort_special_project = { type = $ag_project$_soc } }
		if = { limit = { has_special_project = $ag_project$_eng } abort_special_project = { type = $ag_project$_eng } }
	}
	else_if = {
		limit = { has_country_flag = ag_current_area_phy_soc_eng }
		if = { limit = { has_special_project = $ag_project$_phy } abort_special_project = { type = $ag_project$_phy } }
		if = { limit = { has_special_project = $ag_project$_soc } abort_special_project = { type = $ag_project$_soc } }
		if = { limit = { has_special_project = $ag_project$_eng } abort_special_project = { type = $ag_project$_eng } }
	}
	if = { limit = { has_event_chain = $ag_evnet_chain$ } end_event_chain = $ag_evnet_chain$ }
}
ag_save_current_progress_1 = {
	optimize_memory
	# Update if project in loaded page.
	if = {
		limit = { check_variable = { which = ag_research_1_id value = $ag_current_research$ } }
		set_variable = { which = ag_research_1_total_progress value = ag_total_progress }
		set_variable = { which = ag_research_1_progress value = ag_total_progress }
		divide_variable = { which = ag_research_1_progress value = ag_research_1_required_progress }
		multiply_variable = { which = ag_research_1_progress value = 100 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_2_id value = $ag_current_research$ } }
		set_variable = { which = ag_research_2_total_progress value = ag_total_progress }
		set_variable = { which = ag_research_2_progress value = ag_total_progress }
		divide_variable = { which = ag_research_2_progress value = ag_research_2_required_progress }
		multiply_variable = { which = ag_research_2_progress value = 100 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_3_id value = $ag_current_research$ } }
		set_variable = { which = ag_research_3_total_progress value = ag_total_progress }
		set_variable = { which = ag_research_3_progress value = ag_total_progress }
		divide_variable = { which = ag_research_3_progress value = ag_research_3_required_progress }
		multiply_variable = { which = ag_research_3_progress value = 100 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_4_id value = $ag_current_research$ } }
		set_variable = { which = ag_research_4_total_progress value = ag_total_progress }
		set_variable = { which = ag_research_4_progress value = ag_total_progress }
		divide_variable = { which = ag_research_4_progress value = ag_research_4_required_progress }
		multiply_variable = { which = ag_research_4_progress value = 100 }
	}
	# Save variables.
	if = {
		limit = { check_variable = { which = ag_current_seq value = 16 } }
		ag_save_current_progress_2 = { ag_seq = 16 clear_current_research = $clear_current_research$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_current_seq value < 16 } }
		if = {
			limit = { check_variable = { which = ag_current_seq value = 8 } }
			ag_save_current_progress_2 = { ag_seq = 8 clear_current_research = $clear_current_research$ }
		}
		else_if = {
			limit = { check_variable = { which = ag_current_seq value < 8 } }
			if = {
				limit = { check_variable = { which = ag_current_seq value = 4 } }
				ag_save_current_progress_2 = { ag_seq = 4 clear_current_research = $clear_current_research$ }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_seq value < 4 } }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 2 } }
					ag_save_current_progress_2 = { ag_seq = 2 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 2 } }
					ag_save_current_progress_2 = { ag_seq = 1 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 3 clear_current_research = $clear_current_research$ }
				}
			}
			else_if = {
				limit = { always = yes }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 6 } }
					ag_save_current_progress_2 = { ag_seq = 6 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 6 } }
					ag_save_current_progress_2 = { ag_seq = 5 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 7 clear_current_research = $clear_current_research$ }
				}
			}
		}
		else_if = {
			limit = { always = yes }
			if = {
				limit = { check_variable = { which = ag_current_seq value = 12 } }
				ag_save_current_progress_2 = { ag_seq = 12 clear_current_research = $clear_current_research$ }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_seq value < 12 } }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 10 } }
					ag_save_current_progress_2 = { ag_seq = 10 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 10 } }
					ag_save_current_progress_2 = { ag_seq = 9 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 11 clear_current_research = $clear_current_research$ }
				}
			}
			else_if = {
				limit = { always = yes }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 14 } }
					ag_save_current_progress_2 = { ag_seq = 14 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 14 } }
					ag_save_current_progress_2 = { ag_seq = 13 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 15 clear_current_research = $clear_current_research$ }
				}
			}
		}
	}
	else_if = {
		limit = { always = yes }
		if = {
			limit = { check_variable = { which = ag_current_seq value = 24 } }
			ag_save_current_progress_2 = { ag_seq = 24 clear_current_research = $clear_current_research$ }
		}
		else_if = {
			limit = { check_variable = { which = ag_current_seq value < 24 } }
			if = {
				limit = { check_variable = { which = ag_current_seq value = 20 } }
				ag_save_current_progress_2 = { ag_seq = 20 clear_current_research = $clear_current_research$ }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_seq value < 20 } }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 18 } }
					ag_save_current_progress_2 = { ag_seq = 18 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 18 } }
					ag_save_current_progress_2 = { ag_seq = 17 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 19 clear_current_research = $clear_current_research$ }
				}
			}
			else_if = {
				limit = { always = yes }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 22 } }
					ag_save_current_progress_2 = { ag_seq = 22 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 22 } }
					ag_save_current_progress_2 = { ag_seq = 21 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 23 clear_current_research = $clear_current_research$ }
				}
			}
		}
		else_if = {
			limit = { always = yes }
			if = {
				limit = { check_variable = { which = ag_current_seq value = 28 } }
				ag_save_current_progress_2 = { ag_seq = 28 clear_current_research = $clear_current_research$ }
			}
			else_if = {
				limit = { check_variable = { which = ag_current_seq value < 28 } }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 26 } }
					ag_save_current_progress_2 = { ag_seq = 26 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 26 } }
					ag_save_current_progress_2 = { ag_seq = 25 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 27 clear_current_research = $clear_current_research$ }
				}
			}
			else_if = {
				limit = { always = yes }
				if = {
					limit = { check_variable = { which = ag_current_seq value = 30 } }
					ag_save_current_progress_2 = { ag_seq = 30 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { check_variable = { which = ag_current_seq value < 30 } }
					ag_save_current_progress_2 = { ag_seq = 29 clear_current_research = $clear_current_research$ }
				}
				else_if = {
					limit = { always = yes }
					ag_save_current_progress_2 = { ag_seq = 31 clear_current_research = $clear_current_research$ }
				}
			}
		}
	}
}
ag_save_current_progress_2 = {
	optimize_memory
	set_variable = { which = ag_research_project_$ag_seq$_total_progress value = ag_total_progress }
	set_variable = { which = ag_research_project_$ag_seq$_research_counter value = ag_research_project_counter }
	if = {
		limit = {
			check_variable = {
				which = ag_research_project_$ag_seq$_total_progress
				value >= ag_research_project_$ag_seq$_required_progress
			}
		}
		set_variable = { which = ag_research_project_$ag_seq$_status value = 3 }
		if = {
			limit = { check_variable = { which = ag_research_project_$ag_seq$ value = ag_research_1_id } }
			set_variable = { which = ag_research_1_status value = 3 }
		}
		if = {
			limit = { check_variable = { which = ag_research_project_$ag_seq$ value = ag_research_2_id } }
			set_variable = { which = ag_research_2_status value = 3 }
		}
		if = {
			limit = { check_variable = { which = ag_research_project_$ag_seq$ value = ag_research_3_id } }
			set_variable = { which = ag_research_3_status value = 3 }
		}
		if = {
			limit = { check_variable = { which = ag_research_project_$ag_seq$ value = ag_research_4_id } }
			set_variable = { which = ag_research_4_status value = 3 }
		}
	}
	# Clear current variable if needed.
	if = {
		limit = { always = $clear_current_research$ }
		set_variable = { which = ag_current_research value = 0 }
		set_variable = { which = ag_total_progress value = 0 }
		set_variable = { which = ag_required_progress value = 0 }
		set_variable = { which = ag_research_project_counter value = 0 }
		set_variable = { which = ag_current_difficulty value = 0 }
		set_variable = { which = ag_difficulty value = 0 }
		set_variable = { which = ag_difficulty_alt value = 0 }
		remove_country_flag = ag_current_area_phy
		remove_country_flag = ag_current_area_soc
		remove_country_flag = ag_current_area_eng
		remove_country_flag = ag_current_area_phy_soc
		remove_country_flag = ag_current_area_phy_eng
		remove_country_flag = ag_current_area_soc_eng
		remove_country_flag = ag_current_area_phy_soc_eng
	}
}

# ag_modify_research_project_elem
# Parameters
# ag_research_project_id
# ag_operation: set, add, subtract, multiply, divide
# ag_variable: difficulty, required_progress, total_progress
# ag_value
ag_modify_research_project_elem = {
	optimize_memory
	if = { limit = { check_variable = { which = ag_research_project_1 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_1_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_2 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_2_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_3 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_3_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_4 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_4_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_5 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_5_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_6 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_6_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_7 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_7_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_8 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_8_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_9 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_9_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_10 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_10_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_11 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_11_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_12 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_12_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_13 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_13_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_14 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_14_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_15 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_15_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_16 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_16_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_17 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_17_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_18 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_18_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_19 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_19_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_20 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_20_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_21 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_21_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_22 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_22_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_23 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_23_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_24 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_24_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_25 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_25_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_26 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_26_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_27 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_27_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_28 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_28_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_29 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_29_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_30 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_30_$ag_variable$ value = $ag_value$ } }
	else_if = { limit = { check_variable = { which = ag_research_project_31 value = $ag_research_project_id$ } } $ag_operation$_variable = { which = ag_research_project_31_$ag_variable$ value = $ag_value$ } }
	if = {
		limit = { check_variable = { which = ag_research_1_id value = $ag_research_project_id$ } }
		$ag_operation$_variable = { which = ag_research_1_$ag_variable$ value = $ag_value$ }
		set_variable = { which = ag_research_1_progress value = ag_research_1_total_progress }
		divide_variable = { which = ag_research_1_progress value = ag_research_1_required_progress }
		multiply_variable = { which = ag_research_1_progress value = 100 }
		if = {
			limit = { check_variable = { which = ag_current_research value = $ag_research_project_id$ } }
			set_variable = { which = ag_$ag_variable$ value = ag_research_1_$ag_variable$ }
			set_variable = { which = ag_current_difficulty value = ag_research_1_difficulty }
		}
	}
	else_if = {
		limit = { check_variable = { which = ag_research_2_id value = $ag_research_project_id$ } }
		$ag_operation$_variable = { which = ag_research_2_$ag_variable$ value = $ag_value$ }
		set_variable = { which = ag_research_2_progress value = ag_research_2_total_progress }
		divide_variable = { which = ag_research_2_progress value = ag_research_2_required_progress }
		multiply_variable = { which = ag_research_2_progress value = 100 }
		if = {
			limit = { check_variable = { which = ag_current_research value = $ag_research_project_id$ } }
			set_variable = { which = ag_$ag_variable$ value = ag_research_2_$ag_variable$ }
			set_variable = { which = ag_current_difficulty value = ag_research_2_difficulty }
		}
	}
	else_if = {
		limit = { check_variable = { which = ag_research_3_id value = $ag_research_project_id$ } }
		$ag_operation$_variable = { which = ag_research_3_$ag_variable$ value = $ag_value$ }
		set_variable = { which = ag_research_3_progress value = ag_research_3_total_progress }
		divide_variable = { which = ag_research_3_progress value = ag_research_3_required_progress }
		multiply_variable = { which = ag_research_3_progress value = 100 }
		if = {
			limit = { check_variable = { which = ag_current_research value = $ag_research_project_id$ } }
			set_variable = { which = ag_$ag_variable$ value = ag_research_3_$ag_variable$ }
			set_variable = { which = ag_current_difficulty value = ag_research_3_difficulty }
		}
	}
	else_if = {
		limit = { check_variable = { which = ag_research_4_id value = $ag_research_project_id$ } }
		$ag_operation$_variable = { which = ag_research_4_$ag_variable$ value = $ag_value$ }
		set_variable = { which = ag_research_4_progress value = ag_research_4_total_progress }
		divide_variable = { which = ag_research_4_progress value = ag_research_4_required_progress }
		multiply_variable = { which = ag_research_4_progress value = 100 }
		if = {
			limit = { check_variable = { which = ag_current_research value = $ag_research_project_id$ } }
			set_variable = { which = ag_$ag_variable$ value = ag_research_4_$ag_variable$ }
			set_variable = { which = ag_current_difficulty value = ag_research_4_difficulty }
		}
	}
}
ag_iota_data_research_buff = {
	optimize_memory
	random_list = {
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = subtract
				ag_variable = required_progress
				ag_value = 30
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = subtract
				ag_variable = required_progress
				ag_value = 25
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = subtract
				ag_variable = required_progress
				ag_value = 20
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = subtract
				ag_variable = required_progress
				ag_value = 15
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = subtract
				ag_variable = required_progress
				ag_value = 10
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = change
				ag_variable = total_progress
				ag_value = 30
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = change
				ag_variable = total_progress
				ag_value = 25
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = change
				ag_variable = total_progress
				ag_value = 20
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = change
				ag_variable = total_progress
				ag_value = 15
			}
		}
		10 = {
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = change
				ag_variable = total_progress
				ag_value = 10
			}
		}
		1 = {
			modifier = {
				factor = 0
				always = $ag_no_change_difficulty|yes$
			}
			ag_modify_research_project_elem = {
				ag_research_project_id = $ag_project_id$
				ag_operation = subtract
				ag_variable = difficulty
				ag_value = 1
			}
		}
	}
}
ag_reset_locate_ancient_system_project = {
	optimize_memory
	if = {
		limit = { check_variable = { which = ag_research_project_1 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 1 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_2 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 2 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_3 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 3 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_4 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 4 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_5 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 5 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_6 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 6 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_7 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 7 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_8 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 8 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_9 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 9 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_10 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 10 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_11 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 11 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_12 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 12 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_13 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 13 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_14 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 14 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_15 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 15 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_16 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 16 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_17 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 17 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_18 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 18 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_19 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 19 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_20 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 20 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_21 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 21 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_22 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 22 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_23 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 23 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_24 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 24 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_25 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 25 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_26 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 26 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_27 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 27 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_28 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 28 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_29 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 29 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_30 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 30 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_project_31 value = @ag_locate_ancient_system_project_id } }
		ag_set_research_project_variables = { ag_seq = 31 ag_project_id = @ag_locate_ancient_system_project_id ag_progress = $ag_progress|5$ }
	}
}
ag_set_research_lvl = {
	optimize_memory
	set_variable = { which = ag_current_progress_lvl value = 0 }
	if = {
		limit = { check_variable = { which = ag_research_$ag_research_frame$_progress value < 40 } }
		set_variable = { which = ag_current_progress_lvl value = 1 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_frame$_progress value < 60 } }
		set_variable = { which = ag_current_progress_lvl value = 2 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_frame$_progress value < 80 } }
		set_variable = { which = ag_current_progress_lvl value = 3 }
	}
	else_if = {
		limit = { check_variable = { which = ag_research_$ag_research_frame$_progress value < 100 } }
		set_variable = { which = ag_current_progress_lvl value = 4 }
	}
}
ag_check_locate_ancient_system_project_state = {
	optimize_memory
	if = {
		limit = {
			check_variable = { which = ag_research_1_id value = @ag_locate_ancient_system_project_id }
			check_variable = { which = ag_research_1_status value = 3 }
		}
		ag_reset_locate_ancient_system_project = yes
	}
	if = {
		limit = {
			check_variable = { which = ag_research_2_id value = @ag_locate_ancient_system_project_id }
			check_variable = { which = ag_research_2_status value = 3 }
		}
		ag_reset_locate_ancient_system_project = yes
	}
	if = {
		limit = {
			check_variable = { which = ag_research_3_id value = @ag_locate_ancient_system_project_id }
			check_variable = { which = ag_research_3_status value = 3 }
		}
		ag_reset_locate_ancient_system_project = yes
	}
	if = {
		limit = {
			check_variable = { which = ag_research_4_id value = @ag_locate_ancient_system_project_id }
			check_variable = { which = ag_research_4_status value = 3 }
		}
		ag_reset_locate_ancient_system_project = yes
	}
}

ag_initialize_research_variables = {
	optimize_memory
	if = {
		limit = { NOT = { has_country_flag = ag_research_variables_initialized } }
		set_country_flag = ag_research_variables_initialized
		set_variable = { which = ag_debug_mode_counter value = 0 }
		set_variable = { which = ag_current_research value = 0 }
		set_variable = { which = ag_total_progress value = 0 }
		set_variable = { which = ag_required_progress value = 0 }
		set_variable = { which = ag_research_project_counter value = 0 }
		set_variable = { which = ag_current_difficulty value = 0 }
		set_variable = { which = ag_difficulty value = 0 }
		set_variable = { which = ag_difficulty_alt value = 0 }
		set_variable = { which = ag_num_research_projects value = 0 }
		set_variable = { which = ag_page_counter value = 1 }
		set_variable = { which = ag_research_total_pages value = 1 }
		set_variable = { which = ag_research_current_page value = 0 }
		set_variable = { which = ag_research_1 value = 0 }
		set_variable = { which = ag_research_1_status value = 0 }
		set_variable = { which = ag_research_1_id value = 0 }
		set_variable = { which = ag_research_1_difficulty value = 0 }
		set_variable = { which = ag_research_1_requirement value = 0 }
		set_variable = { which = ag_research_1_area value = 0 }
		set_variable = { which = ag_research_1_progress value = 0 }
		set_variable = { which = ag_research_2 value = 0 }
		set_variable = { which = ag_research_2_status value = 0 }
		set_variable = { which = ag_research_2_id value = 0 }
		set_variable = { which = ag_research_2_difficulty value = 0 }
		set_variable = { which = ag_research_2_requirement value = 0 }
		set_variable = { which = ag_research_2_area value = 0 }
		set_variable = { which = ag_research_2_progress value = 0 }
		set_variable = { which = ag_research_3 value = 0 }
		set_variable = { which = ag_research_3_status value = 0 }
		set_variable = { which = ag_research_3_id value = 0 }
		set_variable = { which = ag_research_3_difficulty value = 0 }
		set_variable = { which = ag_research_3_requirement value = 0 }
		set_variable = { which = ag_research_3_area value = 0 }
		set_variable = { which = ag_research_3_progress value = 0 }
		set_variable = { which = ag_research_4 value = 0 }
		set_variable = { which = ag_research_4_status value = 0 }
		set_variable = { which = ag_research_4_id value = 0 }
		set_variable = { which = ag_research_4_difficulty value = 0 }
		set_variable = { which = ag_research_4_requirement value = 0 }
		set_variable = { which = ag_research_4_area value = 0 }
		set_variable = { which = ag_research_4_progress value = 0 }
	}
}

ag_finish_research_project = {
	optimize_memory
	if = {
		limit = { NOT = { has_country_flag = ag_has_research_project_$ag_project_id$ } }
		ag_give_research_project = { ag_project_id = $ag_project_id$ ag_progress = 1 }
	}
	else_if = {
		limit = { check_variable = { which = ag_current_research value = $ag_project_id$ } }
		remove_country_flag = ag_research_project_ongoing
		ag_save_current_progress = { clear_current_research = yes }
	}
	ag_finish_research_project_1 = { ag_project_id = $ag_project_id$ }
	set_country_flag = ag_research_project_$ag_project_id$_completed
	country_event = { id = ag_research.4 days = 1 }
}
ag_finish_research_project_1 = {
	optimize_memory
	if = { limit = { check_variable = { which = ag_research_project_1 value = $ag_project_id$ } } set_variable = { which = ag_research_project_1_status value = 3 } set_variable = { which = ag_research_project_1_total_progress value = ag_research_project_1_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_2 value = $ag_project_id$ } } set_variable = { which = ag_research_project_2_status value = 3 } set_variable = { which = ag_research_project_2_total_progress value = ag_research_project_2_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_3 value = $ag_project_id$ } } set_variable = { which = ag_research_project_3_status value = 3 } set_variable = { which = ag_research_project_3_total_progress value = ag_research_project_3_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_4 value = $ag_project_id$ } } set_variable = { which = ag_research_project_4_status value = 3 } set_variable = { which = ag_research_project_4_total_progress value = ag_research_project_4_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_5 value = $ag_project_id$ } } set_variable = { which = ag_research_project_5_status value = 3 } set_variable = { which = ag_research_project_5_total_progress value = ag_research_project_5_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_6 value = $ag_project_id$ } } set_variable = { which = ag_research_project_6_status value = 3 } set_variable = { which = ag_research_project_6_total_progress value = ag_research_project_6_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_7 value = $ag_project_id$ } } set_variable = { which = ag_research_project_7_status value = 3 } set_variable = { which = ag_research_project_7_total_progress value = ag_research_project_7_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_8 value = $ag_project_id$ } } set_variable = { which = ag_research_project_8_status value = 3 } set_variable = { which = ag_research_project_8_total_progress value = ag_research_project_8_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_9 value = $ag_project_id$ } } set_variable = { which = ag_research_project_9_status value = 3 } set_variable = { which = ag_research_project_9_total_progress value = ag_research_project_9_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_10 value = $ag_project_id$ } } set_variable = { which = ag_research_project_10_status value = 3 } set_variable = { which = ag_research_project_10_total_progress value = ag_research_project_10_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_11 value = $ag_project_id$ } } set_variable = { which = ag_research_project_11_status value = 3 } set_variable = { which = ag_research_project_11_total_progress value = ag_research_project_11_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_12 value = $ag_project_id$ } } set_variable = { which = ag_research_project_12_status value = 3 } set_variable = { which = ag_research_project_12_total_progress value = ag_research_project_12_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_13 value = $ag_project_id$ } } set_variable = { which = ag_research_project_13_status value = 3 } set_variable = { which = ag_research_project_13_total_progress value = ag_research_project_13_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_14 value = $ag_project_id$ } } set_variable = { which = ag_research_project_14_status value = 3 } set_variable = { which = ag_research_project_14_total_progress value = ag_research_project_14_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_15 value = $ag_project_id$ } } set_variable = { which = ag_research_project_15_status value = 3 } set_variable = { which = ag_research_project_15_total_progress value = ag_research_project_15_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_16 value = $ag_project_id$ } } set_variable = { which = ag_research_project_16_status value = 3 } set_variable = { which = ag_research_project_16_total_progress value = ag_research_project_16_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_17 value = $ag_project_id$ } } set_variable = { which = ag_research_project_17_status value = 3 } set_variable = { which = ag_research_project_17_total_progress value = ag_research_project_17_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_18 value = $ag_project_id$ } } set_variable = { which = ag_research_project_18_status value = 3 } set_variable = { which = ag_research_project_18_total_progress value = ag_research_project_18_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_19 value = $ag_project_id$ } } set_variable = { which = ag_research_project_19_status value = 3 } set_variable = { which = ag_research_project_19_total_progress value = ag_research_project_19_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_20 value = $ag_project_id$ } } set_variable = { which = ag_research_project_20_status value = 3 } set_variable = { which = ag_research_project_20_total_progress value = ag_research_project_20_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_21 value = $ag_project_id$ } } set_variable = { which = ag_research_project_21_status value = 3 } set_variable = { which = ag_research_project_21_total_progress value = ag_research_project_21_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_22 value = $ag_project_id$ } } set_variable = { which = ag_research_project_22_status value = 3 } set_variable = { which = ag_research_project_22_total_progress value = ag_research_project_22_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_23 value = $ag_project_id$ } } set_variable = { which = ag_research_project_23_status value = 3 } set_variable = { which = ag_research_project_23_total_progress value = ag_research_project_23_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_24 value = $ag_project_id$ } } set_variable = { which = ag_research_project_24_status value = 3 } set_variable = { which = ag_research_project_24_total_progress value = ag_research_project_24_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_25 value = $ag_project_id$ } } set_variable = { which = ag_research_project_25_status value = 3 } set_variable = { which = ag_research_project_25_total_progress value = ag_research_project_25_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_26 value = $ag_project_id$ } } set_variable = { which = ag_research_project_26_status value = 3 } set_variable = { which = ag_research_project_26_total_progress value = ag_research_project_26_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_27 value = $ag_project_id$ } } set_variable = { which = ag_research_project_27_status value = 3 } set_variable = { which = ag_research_project_27_total_progress value = ag_research_project_27_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_28 value = $ag_project_id$ } } set_variable = { which = ag_research_project_28_status value = 3 } set_variable = { which = ag_research_project_28_total_progress value = ag_research_project_28_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_29 value = $ag_project_id$ } } set_variable = { which = ag_research_project_29_status value = 3 } set_variable = { which = ag_research_project_29_total_progress value = ag_research_project_29_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_30 value = $ag_project_id$ } } set_variable = { which = ag_research_project_30_status value = 3 } set_variable = { which = ag_research_project_30_total_progress value = ag_research_project_30_required_progress } }
	else_if = { limit = { check_variable = { which = ag_research_project_31 value = $ag_project_id$ } } set_variable = { which = ag_research_project_31_status value = 3 } set_variable = { which = ag_research_project_31_total_progress value = ag_research_project_31_required_progress } }
}

ag_research_project_after_event_effect = {
	optimize_memory
	remove_country_flag = ag_research_project_$ag_project_id$_completed
	remove_country_flag = ag_research_project_ongoing
}
