
ag_create_zeta_criris_country = {
	optimize_memory
	if = {
		limit = { NOT = { exists = event_target:ag_zeta_crisis_country } }
		if = {
			limit = { NOT = { exists = event_target:ag_zeta_crisis_leader_species } }
			create_species = {
				name = "NAME_ag_zeta_crisis_country"
				class = "ag_shroud_invader_class"
				portrait = "ag_shroud_invader"
				immortal = yes
				traits = random
				effect = { save_global_event_target_as = ag_zeta_crisis_leader_species }
			}
		}
		set_update_modifiers_batch = begin
		create_country = {
			name = "NAME_ag_zeta_crisis_country"
			type = ag_zeta_crisis_country
			flag = {
				icon = {
					category = "special"
					file = "the_shroud.dds"
				}
				background = {
					category = "backgrounds"
					file = "circle.dds"
				}
				colors={
					"black"
					"dark_purple"
					"null"
					"null"
				}
			}
			species = event_target:ag_zeta_crisis_leader_species
		}
		last_created_country = {
			set_country_flag = ag_ancient_empire_mod_country
			save_global_event_target_as = ag_zeta_crisis_country
			set_country_flag = ag_zeta_crisis_country
			set_graphical_culture = fallen_empire_01
			
			create_ship_design = { design = "NAME_ag_zeta_crisis_small_ship" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_medium_ship" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_large_ship" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_support_ship" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_construction_ship" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_starbase_design" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_defensive_platform" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_avatar_t1" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_avatar_t2" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_avatar_t3" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_avatar_t4" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_avatar_t5" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_portal" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_psionic_storm_small" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_psionic_storm_large" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_ag_zeta_crisis_psionic_singularity" }
			add_ship_design = last_created_design

			set_variable = { which = ag_scaled_difficulty_temp value = event_target:global_event_country.ag_scaled_difficulty }
			remove_modifier = "ag_zeta_crisis_army_modifier"
			add_modifier = { modifier = "ag_zeta_crisis_army_modifier" multiplier = ag_scaled_difficulty_temp days = -1 }
			clear_variable = ag_scaled_difficulty_temp
		}
		set_update_modifiers_batch = end
	}
	every_country = {
		limit = { NOR = { is_same_value = event_target:ag_zeta_crisis_country has_communications = event_target:ag_zeta_crisis_country } }
		establish_communications_no_message = event_target:ag_zeta_crisis_country
	}
}

ag_zeta_crisis_core_system_ship_debuff_effect = {
	optimize_memory
	if = {
		limit = {
			NOR = {
				has_global_flag = ag_zeta_crisis_stage_2
				has_global_flag = ag_zeta_crisis_stage_3
			}
		}
		while = {
			limit = {
				any_controlled_ship = {
					NOR = {
						has_ship_flag = ag_zeta_ship_has_modifier
						ag_is_ancient_ship = yes
						ag_is_ancient_ship_unlocked = yes
					}
				}
			}
			random_controlled_ship = {
				limit = {
					NOR = {
						has_ship_flag = ag_zeta_ship_has_modifier
						ag_is_ancient_ship = yes
						ag_is_ancient_ship_unlocked = yes
					}
				}
				set_timed_ship_flag = {
					flag = ag_zeta_ship_has_modifier
					days = 2
				}
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_1"
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_2"
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_3"
				add_modifier = {
					modifier = "ag_zeta_crisis_core_system_debuff_stage_1"
					days = 30
				}
			}
		}
	}
	if = {
		limit = {
			has_global_flag = ag_zeta_crisis_stage_2
			NOT = {
				has_global_flag = ag_zeta_crisis_stage_3
			}
		}
		while = {
			limit = {
				any_controlled_ship = {
					NOR = {
						has_ship_flag = ag_zeta_ship_has_modifier
						ag_is_ancient_ship = yes
						ag_is_ancient_ship_unlocked = yes
					}
				}
			}
			random_controlled_ship = {
				limit = {
					NOR = {
						has_ship_flag = ag_zeta_ship_has_modifier
						ag_is_ancient_ship = yes
						ag_is_ancient_ship_unlocked = yes
					}
				}
				set_timed_ship_flag = {
					flag = ag_zeta_ship_has_modifier
					days = 2
				}
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_1"
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_2"
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_3"
				add_modifier = {
					modifier = "ag_zeta_crisis_core_system_debuff_stage_2"
					days = 30
				}
			}
		}
	}
	if = {
		limit = {
			has_global_flag = ag_zeta_crisis_stage_2
			has_global_flag = ag_zeta_crisis_stage_3
		}
		while = {
			limit = {
				any_controlled_ship = {
					NOR = {
						has_ship_flag = ag_zeta_ship_has_modifier
						ag_is_ancient_ship = yes
						ag_is_ancient_ship_unlocked = yes
					}
				}
			}
			random_controlled_ship = {
				limit = {
					NOR = {
						has_ship_flag = ag_zeta_ship_has_modifier
						ag_is_ancient_ship = yes
						ag_is_ancient_ship_unlocked = yes
					}
				}
				set_timed_ship_flag = {
					flag = ag_zeta_ship_has_modifier
					days = 2
				}
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_1"
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_2"
				remove_modifier = "ag_zeta_crisis_core_system_debuff_stage_3"
				add_modifier = {
					modifier = "ag_zeta_crisis_core_system_debuff_stage_3"
					days = 30
				}
			}
		}
	}
}

ag_zeta_crisis_controlled_planet_effect = {
	optimize_memory
	remove_all_armies = yes
	add_planet_devastation = -100
	# if = { limit = { num_pops > 0 } every_owned_pop = { kill_pop = yes } }
	if = { limit = { has_modifier = "holy_planet" } set_planet_flag = ag_holy_planet }
	clear_planet_modifiers = yes
	remove_all_buildings = yes
	remove_all_districts = yes
	clear_deposits = yes
	if = { limit = { has_branch_office = yes } close_branch_office = yes }
	ag_destroy_orbital_ring = { ag_spawn_debris = yes }
	destroy_colony = yes
	# if = { limit = { is_colony = yes } destroy_colony = yes }
	# if = { limit = { has_modifier = "ag_zeta_crisis_ship_in_system" } remove_modifier = "ag_zeta_crisis_ship_in_system" }
	# ag_remove_all_modifier_common = yes
	if = {
		limit = { event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value <= 2 } } }
		random_list = {
			20 = { ag_zeta_crisis_avatar_t1_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 } }
			20 = {
				ag_zeta_crisis_avatar_t1_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t1_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
			20 = { ag_zeta_crisis_avatar_t2_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 } }
			20 = {
				ag_zeta_crisis_avatar_t1_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t2_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
			20 = { }
		}
		reroll_random = yes
	}
	else = {
		random_list = {
			20 = {
				ag_zeta_crisis_avatar_t1_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t2_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
			20 = {
				ag_zeta_crisis_avatar_t2_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t2_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
			20 = {
				ag_zeta_crisis_avatar_t2_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t3_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
			20 = {
				ag_zeta_crisis_avatar_t3_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t3_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
			20 = {
				ag_zeta_crisis_avatar_t3_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 15 }
				ag_zeta_crisis_avatar_t4_fleet_spawn = { ag_target_name = prev ag_distance_to_target = 20 }
			}
		}
		reroll_random = yes
	}
	planet_event = { id = ag_zeta_crisis.46 days = 180 random = 30 }
	if = {
		limit = { NOR = {
			ag_is_habitat = yes
			AND = { ag_is_ringworld = yes ag_is_unhabitable_ringworld = no }
			has_planet_flag = ag_holy_planet
		} }
		ag_change_pc = { ag_planet_class = pc_ag_shrouded }
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		if = {
			limit = { has_global_flag = ag_zeta_crisis_stage_3 }
			set_owner = event_target:ag_zeta_crisis_country
			set_controller = event_target:ag_zeta_crisis_country
			set_colony_type = col_ag_zeta_crisis
			set_planet_flag = ag_zeta_crisis_controlled_world
			every_country = {
				limit = { has_event_chain = "ag_zeta_crisis_chain" }
				add_event_chain_counter = {
					event_chain = "ag_zeta_crisis_chain"
					counter = "ag_zeta_crisis_psionic_worlds"
					amount = 1
				}
			}
		}
		else = {
			set_planet_flag = ag_zeta_crisis_core_planet
			add_modifier = { modifier = "ag_zeta_crisis_core_planet" days = -1 }
			solar_system = { set_star_flag = ag_zeta_crisis_core_system }
			event_target:ag_zeta_crisis_country = { change_variable = { which = ag_zeta_crisis_core_planet value = 1 } }
		}
	}
	else_if = {
		limit = { ag_is_ringworld = yes ag_is_unhabitable_ringworld = no }
		ag_destroy_habitable_ringworld_psionics = yes
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		if = {
			limit = { has_global_flag = ag_zeta_crisis_stage_3 }
			set_owner = event_target:ag_zeta_crisis_country
			set_controller = event_target:ag_zeta_crisis_country
			set_colony_type = col_ag_zeta_crisis
			set_planet_flag = ag_zeta_crisis_controlled_world
			every_country = {
				limit = { has_event_chain = "ag_zeta_crisis_chain" }
				add_event_chain_counter = {
					event_chain = "ag_zeta_crisis_chain"
					counter = "ag_zeta_crisis_psionic_worlds"
					amount = 1
				}
			}
		}
		else = {
			set_planet_flag = ag_zeta_crisis_core_planet
			add_modifier = { modifier = "ag_zeta_crisis_core_planet" days = -1 }
			solar_system = { set_star_flag = ag_zeta_crisis_core_system }
			event_target:ag_zeta_crisis_country = { change_variable = { which = ag_zeta_crisis_core_planet value = 1 } }
		}
	}
	else_if = {
		limit = { has_planet_flag = ag_holy_planet }
		ag_change_pc = { ag_planet_class = pc_shattered }
		remove_planet_flag = ag_holy_planet
		remove_modifier = "holy_planet"
		add_modifier = { modifier = "ag_shattered_holy_planet" days = -1 }
	}
	else_if = {
		limit = { ag_is_habitat = yes }
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		ag_remove_planet = yes
	}
}

ag_zeta_crisis_gate_portal_spawn = {
	optimize_memory
	if = {
		limit = {
			any_galaxy_planet = {
				is_planet_class = pc_ag_shrouded
				has_planet_flag = ag_zeta_crisis_core_planet
				NOR = {
					has_planet_flag = ag_zeta_crisis_portal_1_planet
					has_planet_flag = ag_zeta_crisis_portal_2_planet
					has_planet_flag = ag_zeta_crisis_portal_3_planet
					has_planet_flag = ag_zeta_crisis_portal_4_planet
					has_planet_flag = ag_zeta_crisis_portal_5_planet
					has_planet_flag = ag_zeta_crisis_portal_6_planet
				}
			}
		}
		random_galaxy_planet = {
			limit = {
				is_planet_class = pc_ag_shrouded
				has_planet_flag = ag_zeta_crisis_core_planet
				NOR = {
					has_planet_flag = ag_zeta_crisis_portal_1_planet
					has_planet_flag = ag_zeta_crisis_portal_2_planet
					has_planet_flag = ag_zeta_crisis_portal_3_planet
					has_planet_flag = ag_zeta_crisis_portal_4_planet
					has_planet_flag = ag_zeta_crisis_portal_5_planet
					has_planet_flag = ag_zeta_crisis_portal_6_planet
				}
			}
			save_event_target_as = $ag_portal_event_target_name$
			ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
			set_planet_flag = $ag_portal_planet_flag$
			ag_change_pc = { ag_planet_class = pc_ag_void_planet }
			set_planet_size = 1
			remove_modifier = "ag_zeta_crisis_core_planet"
			every_moon = { limit = { exists = this } ag_remove_planet = yes }
			create_fleet = {
				name = "NAME_ag_zeta_crisis_portal_fleet"
				settings = {
					is_boss = yes
					spawn_debris = no
				}
				effect = {
					set_fleet_flag = ag_zeta_crisis_gate_portal
					set_fleet_flag = $ag_portal_fleet_flag$
					set_fleet_flag = ag_zeta_crisis_portal
					set_owner = event_target:ag_zeta_crisis_country
					create_ship = {
						name = "NAME_ag_zeta_crisis_portal_ship"
						design = "NAME_ag_zeta_crisis_portal"
						prefix = no
						effect = {
							ag_difficulty_bonus = yes
							ag_set_disable_at_health = { ag_value = 0.05 ag_disable_type = event }
						}
					}
					set_location = { target = prev distance = 0 angle = 0 }
				}
			}
			ag_spawn_zeta_crisis_guardian_fleet = yes
			ag_spawn_zeta_crisis_assault_fleet = yes
			ag_spawn_zeta_crisis_construction_ship = yes
			ag_spawn_zeta_crisis_protector_fleet = yes
			if = {
				limit = { event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } }
				ag_spawn_zeta_crisis_assault_fleet = yes
				random_list = { 50 = { } 50 = { ag_spawn_zeta_crisis_assault_fleet = yes } } reroll_random = yes
				random_list = { 75 = { } 25 = { ag_spawn_zeta_crisis_assault_fleet = yes } } reroll_random = yes
			}
			solar_system = {
				set_timed_star_flag = { flag = ag_zeta_crisis_gate_portal_spawned days = 60 }
				ag_create_zeta_crisis_special_ships = yes
				every_fleet_in_system = {
					limit = {
						exists = owner
						owner = { NOR = { is_country_type = ag_zeta_crisis_country is_country_type = ag_zeta_crisis_portal_holder } }
					}
					destroy_fleet = this
				}
				spawn_megastructure = {
					type = ag_psionic_portal_megastructure
					orbit_angle = 233
					orbit_distance = 0
					coords_from = event_target:$ag_portal_event_target_name$
				}
				ag_create_zeta_crisis_starbase = yes
				if = {
					limit = {
						OR = { has_galactic_custodian = yes has_galactic_emperor = yes }
						any_neighbor_system = {
							exists = space_owner
							space_owner = {
								is_ai = yes
								is_galactic_community_member = yes
								is_galactic_custodian = no
								is_galactic_emperor = no
							}
						}
					}
					save_event_target_as = ag_psionic_portal_spawn_system
					random_neighbor_system = {
						limit = {
							exists = space_owner
							space_owner = {
								is_ai = yes
								is_galactic_community_member = yes
								is_galactic_custodian = no
								is_galactic_emperor = no
							}
						}
						space_owner = { save_event_target_as = ag_target_community_member }
					}
					if = {
						limit = { has_galactic_custodian = yes }
						random_playable_country = {
							limit = { is_galactic_custodian = yes }
							country_event = { id = ag_zeta_psionics.105 }
						}
					}
					else = { if = {
						limit = { has_galactic_emperor = yes }
						random_playable_country = {
							limit = { is_galactic_emperor = yes }
							country_event = { id = ag_zeta_psionics.106 }
						}
					} }
				}
			}
		}
	}
	else = {
		if = {
			limit = { any_system = { ag_zeta_crisis_fallback_system_spawn_trigger = yes } }
			random_system = {
				limit = { ag_zeta_crisis_fallback_system_spawn_trigger = yes }
				spawn_system = {
					min_distance >= 20
					max_distance <= 50
					initializer = ag_zeta_crisis_fallback_init
					hyperlane = yes
				}
			}
		}
		else = {
			if = {
				limit = { any_system = { ag_zeta_crisis_fallback_system_spawn_trigger_fallback = yes } }
				random_system = {
					limit = { ag_zeta_crisis_fallback_system_spawn_trigger_fallback = yes }
					spawn_system = {
						min_distance >= 20
						max_distance <= 50
						initializer = ag_zeta_crisis_fallback_init
						hyperlane = yes
					}
				}
			}
			else = { random_system = {
				spawn_system = {
					min_distance >= 20
					max_distance <= 50
					initializer = ag_zeta_crisis_fallback_init
					hyperlane = yes
				}
			} }
		}
		random_system = {
			limit = {
				has_star_flag = ag_zeta_crisis_core_system
				any_system_planet = {
					has_planet_flag = ag_zeta_crisis_core_planet
					is_planet_class = pc_ag_void_planet
				}
				NOT = {
					any_ship_in_system = {
						is_ship_size = ag_zeta_crisis_portal
					}
				}
			}
			ag_spawned_system_hyperlane_fixup = yes
			random_system_planet = {
				limit = {
					has_planet_flag = ag_zeta_crisis_core_planet
					is_planet_class = pc_ag_void_planet
				}
				save_event_target_as = $ag_portal_event_target_name$
				ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
				set_planet_flag = $ag_portal_planet_flag$
				create_fleet = {
					name = "NAME_ag_zeta_crisis_portal_fleet"
					settings = {
						is_boss = yes
						spawn_debris = no
					}
					effect = {
						set_fleet_flag = ag_zeta_crisis_gate_portal
						set_fleet_flag = $ag_portal_fleet_flag$
						set_fleet_flag = ag_zeta_crisis_portal
						set_owner = event_target:ag_zeta_crisis_country
						create_ship = {
							name = "NAME_ag_zeta_crisis_portal_ship"
							design = "NAME_ag_zeta_crisis_portal"
							prefix = no
							effect = {
								ag_difficulty_bonus = yes
								ag_set_disable_at_health = { ag_value = 0.05 ag_disable_type = event }
							}
						}
						set_location = {
							target = prev
							distance = 0
							angle = 0
						}
					}
				}
				ag_spawn_zeta_crisis_guardian_fleet = yes
				ag_spawn_zeta_crisis_assault_fleet = yes
				ag_spawn_zeta_crisis_construction_ship = yes
				ag_spawn_zeta_crisis_protector_fleet = yes
				if = {
					limit = { event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } }
					ag_spawn_zeta_crisis_assault_fleet = yes
					random_list = {
						50 = { }
						50 = { ag_spawn_zeta_crisis_assault_fleet = yes }
					}
					random_list = {
						75 = { }
						25 = { ag_spawn_zeta_crisis_assault_fleet = yes }
					}
				}
				solar_system = {
					set_timed_star_flag = { flag = ag_zeta_crisis_gate_portal_spawned days = 60 }
					ag_create_zeta_crisis_special_ships = yes
					spawn_megastructure = {
						type = ag_psionic_portal_megastructure
						orbit_angle = 233
						orbit_distance = 0
						coords_from = event_target:$ag_portal_event_target_name$
					}
					ag_create_zeta_crisis_starbase = yes
				}
			}
		}
	}
	every_country = {
		limit = { NOT = { is_country_type = ag_zeta_crisis_country } }
		country_event = { id = $ag_portal_notification_event$ }
	}
	event_target:ag_zeta_crisis_country = { change_variable = { which = ag_zeta_crisis_total_psionic_portals_spawned value = 1 } }
}

ag_zeta_crisis_avatar_upgrade_flag_effect = {
	optimize_memory
	switch = {
		trigger = is_ship_size
		ag_zeta_crisis_avatar_t1 = {
			random_list = {
				50 = {
					if = {
						limit = {
							NOR = {
								has_ship_flag = ag_1_to_2
								has_ship_flag = ag_1_to_3
								has_ship_flag = ag_1_to_4
								has_ship_flag = ag_1_to_5
							}
						}
						set_ship_flag = ag_1_to_2
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_1_to_2
						}
						remove_ship_flag = ag_1_to_2
						set_ship_flag = ag_1_to_3
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_1_to_3
						}
						remove_ship_flag = ag_1_to_3
						set_ship_flag = ag_1_to_4
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_1_to_4
						}
						remove_ship_flag = ag_1_to_4
						set_ship_flag = ag_1_to_5
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_1_to_5
						}
						add_modifier = {
							modifier = "ag_zeta_crisis_avatar_ship_kill_buff"
							days = 30
						}
						break = yes
					}
				}
				50 = {
				}
			}
		}
		ag_zeta_crisis_avatar_t2 = {
			random_list = {
				50 = {
					if = {
						limit = {
							NOR = {
								has_ship_flag = ag_2_to_3
								has_ship_flag = ag_2_to_4
								has_ship_flag = ag_2_to_5
							}
						}
						set_ship_flag = ag_2_to_3
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_2_to_3
						}
						remove_ship_flag = ag_2_to_3
						set_ship_flag = ag_2_to_4
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_2_to_4
						}
						remove_ship_flag = ag_2_to_4
						set_ship_flag = ag_2_to_5
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_2_to_5
						}
						add_modifier = {
							modifier = "ag_zeta_crisis_avatar_ship_kill_buff"
							days = 30
						}
						break = yes
					}
				}
				50 = {
				}
			}
		}
		ag_zeta_crisis_avatar_t3 = {
			random_list = {
				50 = {
					if = {
						limit = {
							NOR = {
								has_ship_flag = ag_3_to_4
								has_ship_flag = ag_3_to_5
							}
						}
						set_ship_flag = ag_3_to_4
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_3_to_4
						}
						remove_ship_flag = ag_3_to_4
						set_ship_flag = ag_3_to_5
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_3_to_5
						}
						add_modifier = {
							modifier = "ag_zeta_crisis_avatar_ship_kill_buff"
							days = 30
						}
						break = yes
					}
				}
				50 = {
				}
			}
		}
		ag_zeta_crisis_avatar_t4 = {
			random_list = {
				50 = {
					if = {
						limit = {
							NOR = {
								has_ship_flag = ag_4_to_5
							}
						}
						set_ship_flag = ag_4_to_5
						break = yes
					}
					else_if = {
						limit = {
							has_ship_flag = ag_4_to_5
						}
						add_modifier = {
							modifier = "ag_zeta_crisis_avatar_ship_kill_buff"
							days = 30
						}
						break = yes
					}
				}
				50 = {
				}
			}
		}
		ag_zeta_crisis_avatar_t5 = {
			random_list = {
				50 = {
					add_modifier = {
						modifier = "ag_zeta_crisis_avatar_ship_kill_buff"
						days = 30
					}
					set_ship_flag = ag_zeta_crisis_avatar_t5_charged
					break = yes
				}
				50 = {
					add_modifier = {
						modifier = "ag_zeta_crisis_avatar_ship_kill_buff"
						days = 30
					}
					break = yes
				}
			}
		}
	}
}

ag_zeta_t1_class_target_effect = {
	optimize_memory
	root.fromfrom = {
		if = {
			limit = {
				fleet = {
					has_fleet_flag = ag_zeta_crisis_avatar_fleet
				}
			}
			fleet = {
				change_variable = {
					which = ag_zeta_crisis_ship_charge
					value = 1
				}
			}
			set_ship_flag = ag_zeta_crisis_avatar_kill_locked
			if = {
				limit = {
					fleet = {
						check_variable = {
							which = ag_zeta_crisis_ship_charge
							value >= 5
						}
					}
				}
				fleet = {
					set_variable = {
						which = ag_zeta_crisis_ship_charge
						value = 0
					}
				}
				ag_zeta_crisis_avatar_upgrade_flag_effect = yes
			}
		}
		random_list = {
			23 = {
				modifier = { add = -13 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t1_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
			}
			2 = {
				modifier = { add = 8 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t1_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t1_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
			}
			0 = {
				modifier = { add = 5 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t1_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t1_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
				ag_zeta_crisis_avatar_t1_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 50
				}
			}
			75 = {
				modifier = {
					factor = 0.85
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
		random_list = {
			50 = {
				root.fromfromfrom.fleet = {
					if = {
						limit = { exists = this }
						while = {
							count = 5
							random_controlled_ship = {
								limit = {
									NOR = {
										ag_is_ancient_ship = yes
										ag_is_ancient_ship_unlocked = yes
										has_ship_flag = ag_zeta_crisis_damaged
									}
								}
								random_list = {
									50 = {
										ag_reduce_hp_percent = { ag_value = 1 }
										ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
									}
									50 = {
										modifier = {
											factor = 0.2
											event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
										}
									}
								}
								set_timed_ship_flag = {
									flag = ag_zeta_crisis_damaged
									days = 2
								}
							}
						}
					}
				}
			}
			100 = {
				modifier = {
					factor = 0.5
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
	}
}
ag_zeta_t2_class_target_effect = {
	optimize_memory
	root.fromfrom = {
		if = {
			limit = {
				fleet = {
					has_fleet_flag = ag_zeta_crisis_avatar_fleet
				}
			}
			fleet = {
				change_variable = {
					which = ag_zeta_crisis_ship_charge
					value = 1
				}
			}
			set_ship_flag = ag_zeta_crisis_avatar_kill_locked
			if = {
				limit = {
					fleet = {
						check_variable = {
							which = ag_zeta_crisis_ship_charge
							value >= 5
						}
					}
				}
				fleet = {
					set_variable = {
						which = ag_zeta_crisis_ship_charge
						value = 0
					}
				}
				ag_zeta_crisis_avatar_upgrade_flag_effect = yes
			}
		}
		random_list = {
			23 = {
				modifier = { add = -13 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t2_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
			}
			2 = {
				modifier = { add = 8 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t2_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t2_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
			}
			0 = {
				modifier = { add = 5 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t2_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t2_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
				ag_zeta_crisis_avatar_t2_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 50
				}
			}
			75 = {
				modifier = {
					factor = 0.8
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
		random_list = {
			50 = {
				root.fromfromfrom.fleet = {
					if = {
						limit = { exists = this }
						while = {
							count = 5
							random_controlled_ship = {
								limit = {
									NOR = {
										ag_is_ancient_ship = yes
										ag_is_ancient_ship_unlocked = yes
										has_ship_flag = ag_zeta_crisis_damaged
									}
								}
								random_list = {
									33 = {
										ag_reduce_hp_percent = { ag_value = 2 }
										ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
									}
									33 = {
										ag_reduce_hp_percent = { ag_value = 1 }
										ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
									}
									33 = {
										modifier = {
											factor = 0.4
											event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
										}
									}
								}
								set_timed_ship_flag = {
									flag = ag_zeta_crisis_damaged
									days = 2
								}
							}
						}
					}
				}
			}
			100 = {
				modifier = {
					factor = 0.5
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
	}
}
ag_zeta_t3_class_target_effect = {
	optimize_memory
	root.fromfrom = {
		if = {
			limit = {
				fleet = {
					has_fleet_flag = ag_zeta_crisis_avatar_fleet
				}
			}
			fleet = {
				change_variable = {
					which = ag_zeta_crisis_ship_charge
					value = 1
				}
			}
			set_ship_flag = ag_zeta_crisis_avatar_kill_locked
			if = {
				limit = {
					fleet = {
						check_variable = {
							which = ag_zeta_crisis_ship_charge
							value >= 5
						}
					}
				}
				fleet = {
					set_variable = {
						which = ag_zeta_crisis_ship_charge
						value = 0
					}
				}
				ag_zeta_crisis_avatar_upgrade_flag_effect = yes
			}
		}
		random_list = {
			23 = {
				modifier = { add = -13 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t3_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
			}
			2 = {
				modifier = { add = 8 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t3_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t3_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
			}
			0 = {
				modifier = { add = 5 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t3_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t3_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
				ag_zeta_crisis_avatar_t3_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 50
				}
			}
			75 = {
				modifier = {
					factor = 0.8
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
		random_list = {
			50 = {
				root.fromfromfrom.fleet = {
					if = {
						limit = { exists = this }
						while = {
							count = 5
							random_controlled_ship = {
								limit = {
									NOR = {
										ag_is_ancient_ship = yes
										ag_is_ancient_ship_unlocked = yes
										has_ship_flag = ag_zeta_crisis_damaged
									}
								}
								random_list = {
									33 = {
										ag_reduce_hp_percent = { ag_value = 3 }
										ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
									}
									33 = {
										ag_reduce_hp_percent = { ag_value = 1 }
										ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
									}
									33 = {
										modifier = {
											factor = 0.4
											event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
										}
									}
								}
								set_timed_ship_flag = {
									flag = ag_zeta_crisis_damaged
									days = 2
								}
							}
						}
					}
				}
			}
			100 = {
				modifier = {
					factor = 0.5
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
	}
}
ag_zeta_t4_class_target_effect = {
	optimize_memory
	root.fromfrom = {
		if = {
			limit = {
				fleet = {
					has_fleet_flag = ag_zeta_crisis_avatar_fleet
				}
			}
			fleet = {
				change_variable = {
					which = ag_zeta_crisis_ship_charge
					value = 1
				}
			}
			set_ship_flag = ag_zeta_crisis_avatar_kill_locked
			if = {
				limit = {
					fleet = {
						check_variable = {
							which = ag_zeta_crisis_ship_charge
							value >= 5
						}
					}
				}
				fleet = {
					set_variable = {
						which = ag_zeta_crisis_ship_charge
						value = 0
					}
				}
				ag_zeta_crisis_avatar_upgrade_flag_effect = yes
			}
		}
		random_list = {
			23 = {
				modifier = { add = -13 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t4_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
			}
			2 = {
				modifier = { add = 8 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t4_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t4_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
			}
			0 = {
				modifier = { add = 5 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t4_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t4_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
				ag_zeta_crisis_avatar_t4_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 50
				}
			}
			75 = {
				modifier = {
					factor = 0.8
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
		random_list = {
			50 = {
				root.fromfromfrom.fleet = {
					if = {
						limit = { exists = this }
						while = {
							count = 5
							random_controlled_ship = {
								limit = {
									NOR = {
										ag_is_ancient_ship = yes
										ag_is_ancient_ship_unlocked = yes
										has_ship_flag = ag_zeta_crisis_damaged
									}
								}
								random_list = {
									33 = { ag_reduce_hp_percent = { ag_value = 4 } }
									33 = { ag_reduce_hp_percent = { ag_value = 2 } }
									33 = {
										modifier = {
											factor = 0.4
											event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
										}
										ag_reduce_hp_percent = { ag_value = 1 }
									}
								}
								ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
								set_timed_ship_flag = {
									flag = ag_zeta_crisis_damaged
									days = 2
								}
							}
						}
					}
				}
			}
			100 = {
				modifier = {
					factor = 0.5
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
	}
}
ag_zeta_t5_class_target_effect = {
	optimize_memory
	root.fromfrom = {
		if = {
			limit = {
				fleet = {
					has_fleet_flag = ag_zeta_crisis_avatar_fleet
				}
			}
			fleet = {
				change_variable = {
					which = ag_zeta_crisis_ship_charge
					value = 1
				}
			}
			set_ship_flag = ag_zeta_crisis_avatar_kill_locked
			if = {
				limit = {
					fleet = {
						check_variable = {
							which = ag_zeta_crisis_ship_charge
							value >= 5
						}
					}
				}
				fleet = {
					set_variable = {
						which = ag_zeta_crisis_ship_charge
						value = 0
					}
				}
				ag_zeta_crisis_avatar_upgrade_flag_effect = yes
			}
		}
		random_list = {
			23 = {
				modifier = { add = -13 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t5_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
			}
			2 = {
				modifier = { add = 8 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t5_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t5_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
			}
			0 = {
				modifier = { add = 5 root.fromfrom.fleet = { has_fleet_flag = ag_zeta_crisis_leader_12 } }
				ag_zeta_crisis_avatar_t5_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 15
				}
				ag_zeta_crisis_avatar_t5_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 25
				}
				ag_zeta_crisis_avatar_t5_fleet_spawn = {
					ag_target_name = event_target:ag_zeta_crisis_avatar_spawn_loc
					ag_distance_to_target = 50
				}
			}
			75 = {
				modifier = {
					factor = 0.8
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
		random_list = {
			50 = {
				root.fromfromfrom.fleet = {
					if = {
						limit = { exists = this }
						while = {
							count = 5
							random_controlled_ship = {
								limit = {
									NOR = {
										ag_is_ancient_ship = yes
										ag_is_ancient_ship_unlocked = yes
										has_ship_flag = ag_zeta_crisis_damaged
									}
								}
								random_list = {
									33 = {
										ag_reduce_hp_percent = { ag_value = 5 }
									}
									33 = {
										ag_reduce_hp_percent = { ag_value = 3 }
									}
									33 = {
										modifier = {
											factor = 0.4
											event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
										}
										ag_reduce_hp_percent = { ag_value = 1 }
									}
								}
								ag_spawn_buff_effect = { ag_type = 4 ag_color = violet ag_scale = s }
								set_timed_ship_flag = {
									flag = ag_zeta_crisis_damaged
									days = 2
								}
							}
						}
					}
				}
			}
			100 = {
				modifier = {
					factor = 0.5
					event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
				}
			}
		}
	}
}

ag_zeta_crisis_starbase_split_effect = {
	optimize_memory
	random_list = {
		0 = {
			modifier = {
				add = 10
				event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
			}
			ag_zeta_crisis_avatar_t5_fleet_spawn = {
				ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
				ag_distance_to_target = 15
			}
			ag_zeta_crisis_avatar_t5_fleet_spawn = {
				ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
				ag_distance_to_target = 25
			}
			ag_zeta_crisis_avatar_t4_fleet_spawn = {
				ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
				ag_distance_to_target = 30
			}
		}
		33 = {
			ag_zeta_crisis_avatar_t5_fleet_spawn = {
				ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
				ag_distance_to_target = 15
			}
		}
		33 = {
			ag_zeta_crisis_avatar_t4_fleet_spawn = {
				ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
				ag_distance_to_target = 15
			}
			ag_zeta_crisis_avatar_t4_fleet_spawn = {
				ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
				ag_distance_to_target = 25
			}
		}
		33 = {
			modifier = {
				add = -10
				event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } }
			}
		}
	}
}

ag_zeta_crisis_ship_split_effect = {
	optimize_memory
	switch = {
		trigger = is_ship_size
		ag_zeta_crisis_small_ship = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						25 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 3 ag_zeta_crisis_avatar_t1_spawn = yes }
						}
						25 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 2 ag_zeta_crisis_avatar_t1_spawn = yes }
						}
						25 = {
							while = { count = 1 ag_zeta_crisis_avatar_t1_spawn = yes }
						}
						25 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					25 = {
						while = {
							count = 3
							ag_zeta_crisis_avatar_t1_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					25 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t1_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					25 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t1_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					25 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_medium_ship = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 4 ag_zeta_crisis_small_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 3 ag_zeta_crisis_small_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 2 ag_zeta_crisis_small_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 1 ag_zeta_crisis_small_ship_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 3 ag_zeta_crisis_avatar_t2_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 2 ag_zeta_crisis_avatar_t2_spawn = yes }
						}
						20 = {
							while = { count = 1 ag_zeta_crisis_avatar_t2_spawn = yes }
						}
						20 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					20 = {
						while = {
							count = 6
							ag_zeta_crisis_avatar_t1_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 3
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_large_ship = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 4 ag_zeta_crisis_medium_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 3 ag_zeta_crisis_medium_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 2 ag_zeta_crisis_medium_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 10 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 1 ag_zeta_crisis_medium_ship_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 3 ag_zeta_crisis_avatar_t3_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 2 ag_zeta_crisis_avatar_t3_spawn = yes }
						}
						20 = {
							while = { count = 1 ag_zeta_crisis_avatar_t3_spawn = yes }
						}
						20 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					20 = {
						while = {
							count = 6
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 3
							ag_zeta_crisis_avatar_t3_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t3_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t3_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_support_ship = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						0 = {
							modifier = { add = 20 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 1 ag_zeta_crisis_large_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 20 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 4 ag_zeta_crisis_medium_ship_spawn = yes }
						}
						0 = {
							modifier = { add = 20 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 3 ag_zeta_crisis_medium_ship_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 1 ag_zeta_crisis_avatar_t5_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 1 ag_zeta_crisis_avatar_t4_spawn = yes }
						}
						20 = {
							modifier = { factor = 1.5 has_fleet_flag = ag_zeta_crisis_leader_12 }
							while = { count = 2 ag_zeta_crisis_avatar_t3_spawn = yes }
						}
						20 = {
							while = { count = 4 ag_zeta_crisis_avatar_t2_spawn = yes }
						}
						20 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					20 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t5_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t4_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t3_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = {
						while = {
							count = 4
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					20 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_avatar_t2 = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						33 = { while = { count = 2 ag_zeta_crisis_avatar_t1_spawn = yes } }
						33 = { while = { count = 1 ag_zeta_crisis_avatar_t1_spawn = yes } }
						33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					33 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t1_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t1_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_avatar_t3 = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						33 = { while = { count = 2 ag_zeta_crisis_avatar_t2_spawn = yes } }
						33 = { while = { count = 1 ag_zeta_crisis_avatar_t2_spawn = yes } }
						33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					33 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t2_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_avatar_t4 = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						33 = { while = { count = 2 ag_zeta_crisis_avatar_t3_spawn = yes } }
						33 = { while = { count = 1 ag_zeta_crisis_avatar_t3_spawn = yes } }
						33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					33 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t3_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t3_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
		ag_zeta_crisis_avatar_t5 = {
			if = {
				limit = { exists = fleet }
				fleet = {
					random_list = {
						33 = { while = { count = 2 ag_zeta_crisis_avatar_t4_spawn = yes } }
						33 = { while = { count = 1 ag_zeta_crisis_avatar_t4_spawn = yes } }
						33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
					}
				}
			}
			else = {
				random_list = {
					33 = {
						while = {
							count = 2
							ag_zeta_crisis_avatar_t4_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = {
						while = {
							count = 1
							ag_zeta_crisis_avatar_t4_fleet_spawn = {
								ag_target_name = event_target:ag_zeta_crisis_split_avatar_spawn_loc
								ag_distance_to_target = 15
							}
						}
					}
					33 = { modifier = { add = -10 event_target:global_event_country = { check_variable = { which = ag_scaled_difficulty value > 2 } } } }
				}
			}
		}
	}
}

ag_zeta_crisis_gate_portal_destroyed_effect = {
	optimize_memory
	event_target:global_event_country = { change_variable = { which = ag_num_psionic_portals_destroyed value = 1 } }
	fleet = {
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		solar_system = {
			system_event = { id = ag_zeta_crisis.502 days = 30 random = 30 }
			random_system_megastructure = {
				limit = {
					is_megastructure_type = ag_psionic_portal_megastructure
				}
				upgrade_megastructure_to = ag_psionic_portal_stabled_megastructure
				finish_upgrade = yes
			}
			random_system_ambient_object = {
				limit = { has_ambient_object_flag = ag_zeta_crisis_system_effect_thick }
				destroy_ambient_object = this
			}
			every_system_planet = {
				limit = {
					has_planet_flag = ag_zeta_crisis_core_planet
				}
				remove_planet_flag = ag_zeta_crisis_core_planet
			}
		}
		create_ambient_object = {
			type = ag_psionic_portal_stabled_object
			location = this

			use_3d_location = yes
			
			entity_offset = { min = 0 max = 0 }
			entity_offset_angle = { min = 0 max = 0 }
			entity_offset_height = { min = 0 max = 0 }
			
			entity_scale_to_size = yes
			scale = 1.0
		}
		owner = {
			change_variable = {
				which = ag_zeta_crisis_gate_portal_destroyed
				value = 1
			}
			if = {
				limit = {
					has_global_flag = ag_zeta_crisis_all_portal_spawned
					check_variable = {
						which = ag_zeta_crisis_gate_portal_destroyed
						value = 6
					}
				}
				event_target:ag_zeta_crisis_portal_holder = {
					every_controlled_fleet = {
						limit = {
							has_fleet_flag = ag_zeta_crisis_home_portal
						}
						set_owner = event_target:ag_zeta_crisis_country
						set_event_locked = no
					}
					random_controlled_fleet = {
						limit = {
							has_fleet_flag = ag_zeta_area_inhibitor
						}
						delete_fleet = this
					}
					destroy_country = yes
				}
				random_system = {
					limit = {
						has_star_flag = ag_ancient_zeta_system
					}
					random_system_megastructure = {
						limit = {
							is_megastructure_type = ag_psionic_portal_megastructure
						}
						upgrade_megastructure_to = ag_psionic_portal_stabled_megastructure
						finish_upgrade = yes
					}
					# remove_modifier = ag_zeta_area_no_entrance
				}
				every_country = {
					limit = {
						NOT = {
							is_country_type = ag_zeta_crisis_country
						}
					}
					country_event = { id = ag_zeta_crisis.1021 }
				}
			}
			else = {
				every_country = {
					limit = {
						NOT = {
							is_country_type = ag_zeta_crisis_country
						}
					}
					country_event = { id = ag_zeta_crisis.1020 }
				}
			}
		}
		switch = {
			trigger = has_fleet_flag
			ag_zeta_crisis_portal_1_fleet = {
				every_country = {
					limit = {
						has_event_chain = "ag_zeta_crisis_chain"
					}
					remove_point_of_interest = ag_zeta_crisis_gate_portal_1
					add_event_chain_counter = {
						event_chain = "ag_zeta_crisis_chain"
						counter = "ag_zeta_crisis_core_portal"
						amount = -1
					}
				}
				if = {
					limit = { has_global_flag = ag_zeta_crisis_all_portal_spawned }
					event_target:ag_zeta_crisis_country = {
						random_list = {
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										days = 360
									}
								}
							}
						}
					}
				}
			}
			ag_zeta_crisis_portal_2_fleet = {
				every_country = {
					limit = {
						has_event_chain = "ag_zeta_crisis_chain"
					}
					remove_point_of_interest = ag_zeta_crisis_gate_portal_2
					add_event_chain_counter = {
						event_chain = "ag_zeta_crisis_chain"
						counter = "ag_zeta_crisis_core_portal"
						amount = -1
					}
				}
				if = {
					limit = { has_global_flag = ag_zeta_crisis_all_portal_spawned }
					event_target:ag_zeta_crisis_country = {
						random_list = {
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										days = 360
									}
								}
							}
						}
					}
				}
			}
			ag_zeta_crisis_portal_3_fleet = {
				every_country = {
					limit = {
						has_event_chain = "ag_zeta_crisis_chain"
					}
					remove_point_of_interest = ag_zeta_crisis_gate_portal_3
					add_event_chain_counter = {
						event_chain = "ag_zeta_crisis_chain"
						counter = "ag_zeta_crisis_core_portal"
						amount = -1
					}
				}
				if = {
					limit = { has_global_flag = ag_zeta_crisis_all_portal_spawned }
					event_target:ag_zeta_crisis_country = {
						random_list = {
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										days = 360
									}
								}
							}
						}
					}
				}
			}
			ag_zeta_crisis_portal_4_fleet = {
				every_country = {
					limit = {
						has_event_chain = "ag_zeta_crisis_chain"
					}
					remove_point_of_interest = ag_zeta_crisis_gate_portal_4
					add_event_chain_counter = {
						event_chain = "ag_zeta_crisis_chain"
						counter = "ag_zeta_crisis_core_portal"
						amount = -1
					}
				}
				if = {
					limit = { has_global_flag = ag_zeta_crisis_all_portal_spawned }
					event_target:ag_zeta_crisis_country = {
						random_list = {
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										days = 360
									}
								}
							}
						}
					}
				}
			}
			ag_zeta_crisis_portal_5_fleet = {
				every_country = {
					limit = {
						has_event_chain = "ag_zeta_crisis_chain"
					}
					remove_point_of_interest = ag_zeta_crisis_gate_portal_5
					add_event_chain_counter = {
						event_chain = "ag_zeta_crisis_chain"
						counter = "ag_zeta_crisis_core_portal"
						amount = -1
					}
				}
				if = {
					limit = { has_global_flag = ag_zeta_crisis_all_portal_spawned }
					event_target:ag_zeta_crisis_country = {
						random_list = {
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										days = 360
									}
								}
							}
						}
					}
				}
			}
			ag_zeta_crisis_portal_6_fleet = {
				every_country = {
					limit = {
						has_event_chain = "ag_zeta_crisis_chain"
					}
					remove_point_of_interest = ag_zeta_crisis_gate_portal_6
					add_event_chain_counter = {
						event_chain = "ag_zeta_crisis_chain"
						counter = "ag_zeta_crisis_core_portal"
						amount = -1
					}
				}
				if = {
					limit = { has_global_flag = ag_zeta_crisis_all_portal_spawned }
					event_target:ag_zeta_crisis_country = {
						random_list = {
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_1"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_2"
										days = 360
									}
								}
							}
							33 = {
								if = {
									limit = {
										NOT = {
											has_modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										}
									}
									add_modifier = {
										modifier = "ag_zeta_crisis_gate_portal_destroyed_debuff_3"
										days = 360
									}
								}
							}
						}
					}
				}
			}
		}
		delete_fleet = this
	}
}
ag_zeta_crisis_home_portal_destroyed_effect = {
	optimize_memory
	fleet = {
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		create_ambient_object = {
			type = ag_psionic_portal_stabled_object
			location = this

			use_3d_location = yes
			
			entity_offset = { min = 0 max = 0 }
			entity_offset_angle = { min = 0 max = 0 }
			entity_offset_height = { min = 0 max = 0 }
			
			entity_scale_to_size = yes
			scale = 1.0
		}
		delete_fleet = this
	}
	every_country = {
		limit = { has_event_chain = "ag_zeta_crisis_chain" }
		remove_point_of_interest = ag_zeta_crisis_home_portal
		add_event_chain_counter = {
			event_chain = "ag_zeta_crisis_chain"
			counter = "ag_zeta_crisis_core_portal"
			amount = -1
		}
		add_event_chain_counter = {
			event_chain = "ag_zeta_crisis_chain"
			counter = "ag_zeta_crisis_psionic_worlds"
			amount = -1
		}
		add_event_chain_counter = {
			event_chain = "ag_zeta_crisis_chain"
			counter = "ag_zeta_crisis_psionic_worlds_cleansed"
			amount = 1
		}
		country_event = { id = ag_zeta_crisis.1022 }
		country_event = { id = ag_zeta_crisis.1025 }
	}
	set_global_flag = ag_zeta_crisis_all_portal_destroyed
	event_target:ag_zeta_crisis_country = {
		every_controlled_fleet = {
			limit = {
				exists = this
				any_controlled_ship = {
					OR = {
						is_ship_size = starbase_ag_zeta_crisis
						is_ship_size = ag_zeta_crisis_construction_ship
						is_ship_size = ag_zeta_crisis_defensive_platform
						is_ship_size = ag_zeta_crisis_psionic_storm
						is_ship_size = ag_zeta_crisis_psionic_singularity
					}
				}
			}
			destroy_fleet = this
		}
		every_controlled_fleet = {
			limit = {
				exists = this
			}
			clear_orders = yes
			clear_fleet_actions = this
		}
		add_modifier = {
			modifier = "ag_zeta_crisis_no_portal_buff"
			days = -1
		}
	}
	event_target:ag_ancient_zeta_shielded_world = {
		solar_system = {
			system_event = { id = ag_zeta_crisis.502 days = 30 random = 30 }
			random_system_ambient_object = {
				limit = { has_ambient_object_flag = ag_zeta_crisis_system_effect_thick }
				destroy_ambient_object = this
			}
			every_system_planet = {
				limit = {
					has_planet_flag = ag_zeta_crisis_core_planet
				}
				remove_planet_flag = ag_zeta_crisis_core_planet
			}
		}
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		ag_destroy_habitable_ringworld = yes
		remove_modifier = "ag_zeta_crisis_core_planet"
		destroy_colony = yes
	}
	event_target:ag_zeta_shrouded_planet = {
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		remove_modifier = "ag_zeta_crisis_core_planet"
		destroy_colony = yes
		ag_change_pc = { ag_planet_class = pc_nuked }
		reroll_planet = yes
		add_deposit = ag_zeta_crisis_nuked_planet_deposit
		add_deposit = ag_zeta_crisis_nuked_planet_deposit
	}
}
ag_psionic_singularity_explode_fleet_effect = {
	optimize_memory
	every_owned_ship = {
		random_list = {
			30 = { ag_reduce_hp_percent = { ag_value = 60 } }
			30 = { ag_reduce_hp_percent = { ag_value = 50 } }
			30 = { ag_reduce_hp_percent = { ag_value = 40 } }
			10 = { ag_set_ship_hull_locked = { ag_days = 3 ag_value = 1024 } }
		}
		reroll_random = yes
		random_list = {
			75 = { }
			25 = {
				export_modifier_to_variable = { modifier = ship_hull_damage_mult variable = ag_ship_hull_damage_var }
				multiply_variable = { which = ag_ship_hull_damage_var value = -1 }
				subtract_variable = { which = ag_ship_hull_damage_var value = 1 }
				random_list = {
					80 = { add_modifier = { modifier = "ag_ship_hull_damage_mult_buff" multiplier = ag_ship_hull_damage_var days = 5 } }
					20 = { add_modifier = { modifier = "ag_ship_hull_damage_mult_buff" multiplier = ag_ship_hull_damage_var days = 15 } }
				}
				clear_variable = ag_ship_hull_damage_var
			}
		}
		reroll_random = yes
	}
}
ag_zeta_crisis_relic_country_ckeck = {
	optimize_memory
	if = {
		limit = { NOT = { exists = event_target:ag_zeta_crisis_relic_country } }
		create_country = {
			name = "NAME_Creatures_of_the_Shroud"
			type = ag_zeta_crisis_relic_country
			flag = {
				icon = {
					category = "special"
					file = "the_shroud.dds"
				}
				background = {
					category = "backgrounds"
					file = "circle.dds"
				}
				colors={
					"black"
					"dark_purple"
					"null"
					"null"
				}
			}
		}
		last_created_country = {
			set_country_flag = ag_ancient_empire_mod_country
			save_global_event_target_as = ag_zeta_crisis_relic_country
			set_graphical_culture = fallen_empire_01
		}
	}
	every_country = {
		limit = {
			NOR = {
				is_same_value = event_target:ag_zeta_crisis_relic_country
				is_country_type = ag_zeta_crisis_country
				is_country_type = ag_zeta_crisis_portal_holder
			}
		}
		if = {
			limit = {
				NOT = {
					has_communications = event_target:ag_zeta_crisis_relic_country
				}
			}
			establish_communications_no_message = event_target:ag_zeta_crisis_relic_country
		}
		if = {
			limit = {
				NOT = {
					is_hostile = event_target:ag_zeta_crisis_relic_country
				}
			}
			set_faction_hostility = {
				target = event_target:ag_zeta_crisis_relic_country
				set_hostile = yes
				set_neutral = no
				set_friendly = no
			}
		}
	}
	if = {
		limit = {
			exists = event_target:ag_zeta_crisis_country
			event_target:ag_zeta_crisis_country = { is_hostile = event_target:ag_zeta_crisis_relic_country }
		}
		event_target:ag_zeta_crisis_country = {
			set_faction_hostility = {
				target = event_target:ag_zeta_crisis_relic_country
				set_hostile = no
				set_neutral = yes
				set_friendly = no
			}
		}
	}
	if = {
		limit = {
			exists = event_target:ag_zeta_crisis_portal_holder
			event_target:ag_zeta_crisis_portal_holder = { is_hostile = event_target:ag_zeta_crisis_relic_country }
		}
		event_target:ag_zeta_crisis_portal_holder = {
			set_faction_hostility = {
				target = event_target:ag_zeta_crisis_relic_country
				set_hostile = no
				set_neutral = yes
				set_friendly = no
			}
		}
	}
}

ag_psionic_storm_system_side_effect = {
	optimize_memory
	ag_destroy_ambient_object = yes
	ag_destroy_megastructure = yes
}

ag_zeta_crisis_relic_psionic_storm_destroy_planet_effect = {
	optimize_memory
	if = {
		limit = {
			exists = owner
			owner = { is_same_value = event_target:ag_source_country }
		}
		if = {
			limit = { owner = { is_gestalt = no } }
			owner = {
				remove_modifier = "ag_psionic_storm_destroyed_self_planet_debuff"
				add_modifier = {
					modifier = "ag_psionic_storm_destroyed_self_planet_debuff"
					days = 7200
				}
			}
		}
		every_country = {
			limit = {
				NOR = {
					is_same_value = event_target:ag_source_country
					is_country_type = fallen_empire
				}
			}
			add_opinion_modifier = {
				modifier = ag_opinion_psionic_storm_destroyed_self_planet
				who = event_target:ag_source_country
			}
		}
	}
	else_if = {
		limit = {
			exists = owner
			owner = {
				ag_is_common_country = yes
				NOT = { is_same_value = event_target:ag_source_country }
			}
		}
		every_country = {
			limit = {
				NOR = {
					is_same_value = event_target:ag_source_country
					is_same_value = prev.owner
					is_country_type = fallen_empire
				}
			}
			add_opinion_modifier = {
				modifier = ag_opinion_psionic_storm_destroyed_planet
				who = event_target:ag_source_country
			}
		}
		owner = {
			if = {
				limit = {
					is_gestalt = no
				}
				remove_modifier = "ag_psionic_storm_destroyed_planet_debuff"
				add_modifier = {
					modifier = "ag_psionic_storm_destroyed_planet_debuff"
					days = 7200
				}
			}
			create_message = {
				type = "PLANET_DESTROYED"
				localization = "ag_planet_destroyed_by_psionic_storm_desc"
				days = 30
				target = prev
				variable = {
					type = name
					localization = "ag_attacker"
					scope = event_target:ag_source_country
				}
				variable = {
					type = name
					localization = "ag_victim_system"
					scope = prev.solar_system
				}
				variable = {
					type = name
					localization = "ag_victim_planet"
					scope = prev
				}
			}
			add_opinion_modifier = {
				modifier = ag_opinion_psionic_storm_destroyed_my_planet
				who = event_target:ag_source_country
			}
			add_static_war_exhaustion = {
				attacker = event_target:ag_source_country
				location = prev
				value_for_planet_destruction = 1.0
			}
		}
		add_threat = { who = event_target:ag_source_country amount = 3 }
	}
	else_if = {
		limit = {
			exists = owner
			owner = { is_country_type = primitive }
		}
		every_country = {
			limit = {
				NOT = {
					is_country_type = fallen_empire
				}
			}
			if = {
				limit = {
					OR = {
						has_ethic = ethic_xenophile
						has_ethic = ethic_fanatic_xenophile
					}
				}
				add_opinion_modifier = {
					modifier = ag_opinion_psionic_storm_destroyed_primitive_xenophile
					who = event_target:ag_source_country
				}
			}
			else_if = {
				limit = {
					NOR = {
						has_ethic = ethic_xenophobe
						has_ethic = ethic_fanatic_xenophobe
					}
				}
				add_opinion_modifier = {
					modifier = ag_opinion_psionic_storm_destroyed_primitive
					who = event_target:ag_source_country
				}
			}
		}
		add_threat = { who = event_target:ag_source_country amount = 2 }
	}
	# Contingency Machine World
	if = {
		limit = { is_planet_class = pc_ai NOT = { has_planet_flag = machine_lair } }
		set_planet_flag = destroyed_by_colossus
		set_planet_flag = planet_godrayed
		planet_event = { id = crisis.2040 }
	}
	# Contingency Final Machine World
	if = {
		limit = { is_planet_class = pc_ai has_planet_flag = machine_lair }
		set_planet_flag = destroyed_by_colossus
		set_planet_flag = planet_godrayed
		root.owner = { save_event_target_as = final_machine_world_destroyer }
		stop_crisis_sound = yes
		planet_event = { id = crisis.2046 }
	}
	# Swarm Situation Log counter
	if = {
		limit = { exists = owner owner = { is_country_type = swarm } }
		every_country = {
			limit = { has_event_chain = "prethoryn_scourge_chain" }
			add_event_chain_counter = {
				event_chain = "prethoryn_scourge_chain"
				counter = "infested_worlds"
				amount = -1
			}
			add_event_chain_counter = {
				event_chain = "prethoryn_scourge_chain"
				counter = "infested_worlds_cleansed"
				amount = 1
			}
		}
	}
	if = {
		limit = {
			OR = {
				is_active_resolution = "resolution_rulesofwar_reverence_for_life"
				is_active_resolution = "resolution_rulesofwar_independent_tribunals"
				is_active_resolution = "resolution_rulesofwar_last_resort_doctrine"
				is_active_resolution = "resolution_rulesofwar_demobilization_initiative"
			}
		}
		root.owner = { set_timed_country_flag = { flag = resolution_breached_fired_cracker days = 3600 } }
	}
	if = { limit = { has_modifier = "holy_planet" } set_planet_flag = ag_holy_planet }
	clear_planet_modifiers = yes
	remove_all_buildings = yes
	remove_all_districts = yes
	clear_deposits = yes
	if = { limit = { has_branch_office = yes } close_branch_office = yes }
	if = { limit = { is_colony = yes } destroy_colony = yes }
	ag_remove_all_modifier_common = yes
	if = {
		limit = {
			NOR = {
				is_planet_class = pc_ai
				AND = { ag_is_ringworld = yes ag_is_unhabitable_ringworld = no }
				ag_is_habitat = yes
				has_planet_flag = ag_holy_planet
			}
		}
		ag_change_pc = { ag_planet_class = pc_ag_shrouded }
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
	}
	else_if = {
		limit = { AND = { ag_is_ringworld = yes ag_is_unhabitable_ringworld = no } }
		ag_destroy_habitable_ringworld_psionics = yes
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
	}
	else_if = {
		limit = { ag_is_habitat = yes }
		ag_spawn_explosion_effect = { ag_scale = xl ag_color = violet }
		ag_remove_planet = yes
	}
	else_if = {
		limit = { has_planet_flag = ag_holy_planet }
		ag_change_pc = { ag_planet_class = pc_shattered }
		remove_planet_flag = ag_holy_planet
		remove_modifier = "holy_planet"
		add_modifier = { modifier = "ag_shattered_holy_planet" days = -1 }
		if = {
			limit = {
				NOT = {
					has_global_flag = ag_holy_guardian_to_awaken
				}
				any_country = {
					has_ai_personality_behaviour = holy_planets
					NOT = {
						is_at_war_with = event_target:ag_source_country
					}
				}
			}
			save_event_target_as = ag_destroyed_holy_planet
			set_global_flag = ag_holy_guardian_to_awaken
			random_country = {
				limit = {
					has_ai_personality_behaviour = holy_planets
					NOT = {
						is_at_war_with = event_target:ag_source_country
					}
				}
				save_event_target_as = ag_holy_guardian_empire
				add_opinion_modifier = {
					modifier = ag_opinion_destroyed_holy_planet
					who = event_target:ag_source_country
				}
			}
			event_target:ag_source_country = {
				country_event = { id = ag_ancient.1000 days = 2 random = 5 }
			}
		}
	}
}
