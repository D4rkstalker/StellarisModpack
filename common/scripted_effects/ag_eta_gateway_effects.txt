
ag_eta_upgrade_gateway_frame = {
	optimize_memory
	if = {
		limit = { has_megastructure_flag = ag_eta_gateway_working }
		solar_system = { spawn_megastructure = {
			type = ag_ancient_eta_gateway_megastructure[[ag_target_level]_$ag_target_level$]
			coords_from = prev
			init_effect = {
				set_megastructure_flag = ag_eta_gateway_working
				if = {
					limit = { solar_system = { exists = space_owner } }
					set_owner = solar_system.space_owner
				}
			}
		} }
	}
	else = {
		solar_system = { spawn_megastructure = {
			type = ag_ancient_eta_gateway_megastructure[[ag_target_level]_$ag_target_level$]
			coords_from = prev
			init_effect = {
				if = {
					limit = { solar_system = { exists = space_owner } }
					set_owner = solar_system.space_owner
				}
			}
		} }
	}
	remove_megastructure = this
}
ag_eta_create_gateway_portal = {
	optimize_memory
	if = {
		limit = { exists = owner } owner = { save_event_target_as = ag_target_megastructure_owner }
		solar_system = { spawn_megastructure = {
			type = ag_ancient_eta_gateway[[ag_type]_$ag_type$]
			coords_from = prev
			owner = event_target:ag_target_megastructure_owner
			init_effect = {
				if = {
					limit = { OR = {
						is_megastructure_type = ag_ancient_eta_gateway_galactic_gateway
						is_megastructure_type = ag_ancient_eta_gateway_lgate
					} }
					activate_gateway = this
				}
			}
		} }
	}
	else = {
		solar_system = { spawn_megastructure = {
			type = ag_ancient_eta_gateway[[ag_type]_$ag_type$]
			coords_from = prev
			init_effect = {
				if = {
					limit = { OR = {
						is_megastructure_type = ag_ancient_eta_gateway_galactic_gateway
						is_megastructure_type = ag_ancient_eta_gateway_lgate
					} }
					activate_gateway = this
				}
			}
		} }
	}
	solar_system = { set_star_flag = ag_ancient_eta_gateway[[ag_type]_$ag_type$]_enabled }
}
ag_eta_remove_gateway_portal = {
	optimize_memory
	solar_system = {
		every_system_megastructure = {
			limit = { is_megastructure_type = ag_ancient_eta_gateway[[ag_type]_$ag_type$] }
			ag_spawn_explosion_effect = { ag_color = red ag_scale = m }
			if = {
				limit = { is_megastructure_type = ag_ancient_eta_gateway_lgate }
				prev = { remove_star_flag = lcluster1 remove_star_flag = lgate }
			}
			else_if = {
				limit = { is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary }
				if = {
					limit = { exists = event_target:ag_eta_gateway_controller event_target:ag_eta_gateway_controller = { has_country_flag = ag_ship_subsystem_enabled_601_31 } }
					set_timed_global_flag = { flag = ag_eta_gateway_wormhole_cooldown days = @ag_eta_gateway_wormhole_cooldown_time }
				}
				else = { set_timed_global_flag = { flag = ag_eta_gateway_wormhole_cooldown days = @ag_eta_gateway_wormhole_cooldown_time_extended } }
				every_system = {
					limit = { any_system_megastructure = { is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary_alt } }
					every_system_megastructure = {
						limit = { is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary_alt }
						ag_spawn_explosion_effect = { ag_color = red ag_scale = m }
						remove_megastructure = this
					}
				}
			}
			remove_megastructure = this
		}
		remove_star_flag = ag_ancient_eta_gateway[[ag_type]_$ag_type$]_enabled
	}
}
ag_eta_remove_all_gateway_portal = {
	optimize_memory
	solar_system = {
		every_system_megastructure = {
			limit = { OR = {
				AND = { always = $ag_galactic_gateway|yes$ is_megastructure_type = ag_ancient_eta_gateway_galactic_gateway }
				AND = { always = $ag_lgate|yes$ is_megastructure_type = ag_ancient_eta_gateway_lgate }
				AND = { always = $ag_ancient_gateway|yes$ is_megastructure_type = ag_ancient_eta_gateway_ancient_gateway }
				AND = { always = $ag_wormhole_temporary|yes$ is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary }
			} }
			ag_spawn_explosion_effect = { ag_color = red ag_scale = m }
			if = {
				limit = { is_megastructure_type = ag_ancient_eta_gateway_lgate }
				prev = { remove_star_flag = lcluster1 remove_star_flag = lgate }
			}
			else_if = {
				limit = { is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary }
				if = {
					limit = { exists = event_target:ag_eta_gateway_controller event_target:ag_eta_gateway_controller = { has_country_flag = ag_ship_subsystem_enabled_601_31 } }
					set_timed_global_flag = { flag = ag_eta_gateway_wormhole_cooldown days = @ag_eta_gateway_wormhole_cooldown_time }
				}
				else = { set_timed_global_flag = { flag = ag_eta_gateway_wormhole_cooldown days = @ag_eta_gateway_wormhole_cooldown_time_extended } }
				every_system = {
					limit = { any_system_megastructure = { is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary_alt } }
					every_system_megastructure = {
						limit = { is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary_alt }
						ag_spawn_explosion_effect = { ag_color = red ag_scale = m }
						remove_megastructure = this
					}
				}
			}
			remove_megastructure = this
		}
		remove_star_flag = ag_ancient_eta_gateway_galactic_gateway_enabled
		remove_star_flag = ag_ancient_eta_gateway_lgate_enabled
		remove_star_flag = ag_ancient_eta_gateway_ancient_gateway_enabled
		remove_star_flag = ag_ancient_eta_gateway_wormhole_temporary_enabled
	}
}
ag_eta_gateway_flags_cleans_up_effect = {
	optimize_memory
	remove_country_flag = ag_ancient_eta_gateway_policy_white
	remove_country_flag = ag_ancient_eta_gateway_policy_black
	remove_country_flag = ag_ancient_eta_gateway_close_when_change_owner
	every_country = { prev = {
		if = { limit = { has_country_flag = ag_ancient_eta_gateway_allows_@prev } remove_country_flag = ag_ancient_eta_gateway_allows_@prev }
		if = { limit = { has_country_flag = ag_ancient_eta_gateway_disallows_@prev } remove_country_flag = ag_ancient_eta_gateway_disallows_@prev }
	} }
	if = { limit = { always = $ag_clear_global_event_target|yes$ } clear_global_event_target = event_target:ag_eta_gateway_controller }
}

ag_eta_gateway_opening_effect = {
	optimize_memory
	set_megastructure_flag = ag_eta_gateway_working
	if = {
		limit = { is_megastructure_type = ag_ancient_eta_gateway_megastructure_4 }
		ag_eta_upgrade_gateway_frame = { ag_target_level = opening }
		solar_system = { system_event = { id = ag_eta.1031 days = @ag_eta_gateway_opening_anim_time } }
		[[ag_galactic_gateway] if = { limit = { always = $ag_galactic_gateway$ } solar_system = { system_event = { id = ag_eta.1041 days = @ag_eta_gateway_portal_spawn_time } } }]
		[[ag_lgate] if = { limit = { always = $ag_lgate$ } solar_system = { system_event = { id = ag_eta.1042 days = @ag_eta_gateway_portal_spawn_time } } }]
		[[ag_ancient_gateway] if = { limit = { always = $ag_ancient_gateway$ } solar_system = { system_event = { id = ag_eta.1043 days = @ag_eta_gateway_portal_spawn_time } } }]
		[[ag_wormhole_temporary] if = { limit = { always = $ag_wormhole_temporary$ } solar_system = { system_event = { id = ag_eta.1044 days = @ag_eta_gateway_wormhole_spawn_time } } }]
	}
	else = {
		[[ag_galactic_gateway] if = { limit = { always = $ag_galactic_gateway$ } solar_system = { system_event = { id = ag_eta.1041 days = @ag_eta_gateway_portal_spawn_time_instant } } }]
		[[ag_lgate] if = { limit = { always = $ag_lgate$ } solar_system = { system_event = { id = ag_eta.1042 days = @ag_eta_gateway_portal_spawn_time_instant } } }]
		[[ag_ancient_gateway] if = { limit = { always = $ag_ancient_gateway$ } solar_system = { system_event = { id = ag_eta.1043 days = @ag_eta_gateway_portal_spawn_time_instant } } }]
		[[ag_wormhole_temporary] if = { limit = { always = $ag_wormhole_temporary$ } solar_system = { system_event = { id = ag_eta.1044 days = @ag_eta_gateway_wormhole_spawn_time_instant } } }]
	}
}
ag_eta_gateway_closing_effect = {
	optimize_memory
	if = {
		limit = { solar_system = { NOT = { any_system_megastructure = { OR = {
			is_megastructure_type = ag_ancient_eta_gateway_galactic_gateway
			is_megastructure_type = ag_ancient_eta_gateway_lgate
			is_megastructure_type = ag_ancient_eta_gateway_ancient_gateway
			is_megastructure_type = ag_ancient_eta_gateway_wormhole_temporary
		} } } } }
		set_megastructure_flag = ag_eta_gateway_working
		ag_eta_upgrade_gateway_frame = { ag_target_level = closing }
		solar_system = { system_event = { id = ag_eta.1032 days = @ag_eta_gateway_closing_anim_time } }
	}
}
ag_set_eta_gateway_deployed = {
	optimize_memory
	if = {
		limit = { any_controlled_ship = { is_ship_size = ag_eta_gateway_0 } }
		solar_system = {
			spawn_megastructure = {
				type = ag_ancient_eta_gateway_megastructure_opening_blue
				coords_from = root
				owner = root.owner
			}
			system_event = { id = ag_eta.1033 days = @ag_eta_gateway_opening_anim_time }
		}
	}
	else = {
		if = {
			limit = { owner = {
				has_country_flag = ag_eta_gateway_default_settings_enabled
				OR = {
					has_country_flag = ag_eta_gateway_galactic_gateway
					has_country_flag = ag_eta_gateway_lgate
					has_country_flag = ag_eta_gateway_ancient_gateway
				}
			} }
			solar_system = {
				spawn_megastructure = {
					type = ag_ancient_eta_gateway_megastructure_opening
					coords_from = root
					owner = root.owner
				}
				system_event = { id = ag_eta.1031 days = @ag_eta_gateway_opening_anim_time }
				if = { limit = { root.owner = { has_country_flag = ag_eta_gateway_galactic_gateway } } system_event = { id = ag_eta.1041 days = @ag_eta_gateway_portal_spawn_time } }
				if = { limit = { root.owner = { has_country_flag = ag_eta_gateway_lgate } } system_event = { id = ag_eta.1042 days = @ag_eta_gateway_portal_spawn_time } }
				if = { limit = { root.owner = { has_country_flag = ag_eta_gateway_ancient_gateway } } system_event = { id = ag_eta.1043 days = @ag_eta_gateway_portal_spawn_time } }
			}
		}
		else = { solar_system = { spawn_megastructure = {
			type = ag_ancient_eta_gateway_megastructure_4
			coords_from = root
			owner = root.owner
		} } }
	}
	delete_fleet = this
}
